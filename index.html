<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EHR Simulator for Medical Billing Practice</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }
        input[type="text"], input[type="date"], input[type="number"], textarea, select {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
            padding: 8px 14px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.875rem; /* text-sm */
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .message-box {
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
            display: none; /* Hidden by default */
        }
        .message-box.success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .message-box.error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .flex-grow-1 { /* Custom utility to make item grow */
            flex-grow: 1;
        }
        .hidden {
            display: none;
        }
        .walkthrough-step-content, .quiz-content, .balance-calculator-content, .modifier-challenge-content, .matching-game-content, .scrubber-challenge-content, .denial-challenge-content, .soap-challenge-content, .code-lookup-content, .ar-aging-content, .form-repository-content {
            background-color: #f8fafc; /* bg-blue-50 alternative */
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0; /* border-gray-200 alternative */
            margin-top: 1rem;
        }
        .walkthrough-step-title, .quiz-question-title, .balance-scenario-title, .modifier-challenge-title, .matching-game-title, .scrubber-challenge-title, .denial-challenge-title, .soap-challenge-title, .code-lookup-title, .ar-aging-title, .form-repository-title {
            font-weight: 600; /* font-semibold */
            color: #1a202c; /* text-gray-900 */
            margin-bottom: 0.5rem;
        }
        .walkthrough-instructions, .quiz-instructions, .quiz-feedback-text, .balance-scenario-text, .balance-feedback-text, .modifier-scenario-text, .modifier-feedback-text, .matching-game-text, .scrubber-scenario-text, .scrubber-feedback-text, .denial-scenario-text, .denial-feedback-text, .soap-scenario-text, .soap-feedback-text, .code-lookup-text, .ar-aging-text, .form-repository-text {
            font-size: 0.875rem; /* text-sm */
            color: #4a5568; /* text-gray-700 */
        }
        .quiz-option, .denial-option {
            display: block;
            padding: 8px 0;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 4px;
        }
        .quiz-option:hover, .denial-option:hover {
            background-color: #f0f4f8;
        }
        .quiz-option input[type="radio"], .denial-option input[type="radio"] {
            margin-right: 8px;
        }
        .match-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* Responsive grid */
            gap: 10px;
            margin-top: 20px;
        }
        .match-card {
            background-color: #cbd5e0; /* gray-300 */
            border-radius: 8px;
            padding: 15px;
            height: 120px; /* Fixed height for consistency */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: 600;
            color: #2d3748; /* gray-800 */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
            transform-style: preserve-3d;
            position: relative;
        }
        .match-card.flipped {
            background-color: #fff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .match-card.matched {
            background-color: #a7f3d0; /* green-200 */
            color: #065f46; /* green-800 */
            cursor: default;
            pointer-events: none; /* Disable clicks on matched cards */
        }
        .match-card.incorrect {
            background-color: #fca5a5; /* red-300 */
            color: #991b1b; /* red-800 */
        }
        .card-inner {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            backface-visibility: hidden;
            position: absolute;
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            backface-visibility: hidden;
            border-radius: 8px;
            padding: 15px;
            box-sizing: border-box;
            font-size: 0.9em;
        }
        .card-front {
            background-color: #cbd5e0; /* gray-300 */
            color: #2d3748; /* gray-800 */
            font-weight: 600;
        }
        .card-back {
            background-color: #fff;
            color: #2d3748;
            transform: rotateY(180deg);
        }
        .match-card.is-flipped .card-front {
            transform: rotateY(180deg);
        }
        .match-card.is-flipped .card-back {
            transform: rotateY(360deg);
        }
        #soapNoteDisplay {
            background-color: #f0f4f8; /* Light blue-gray */
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 15px;
            white-space: pre-wrap; /* Preserves formatting */
            font-family: monospace; /* Monospace for code-like text */
            font-size: 0.85rem;
            max-height: 400px; /* Limit height */
            overflow-y: auto; /* Enable scrolling */
            margin-bottom: 20px;
        }
        .ar-claim-item {
            background-color: #f0f4f8;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .ar-claim-details {
            font-size: 0.9rem;
            color: #4a5568;
            margin-bottom: 10px;
        }
        .ar-claim-feedback {
            margin-top: 10px;
            padding: 8px;
            border-radius: 6px;
            font-weight: 500;
        }
        .ar-claim-feedback.correct {
            background-color: #d1fae5;
            color: #065f46;
        }
        .ar-claim-feedback.incorrect {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .form-item {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        .form-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container">
        <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-8">EHR Practice System</h1>

        <!-- Message Box for user feedback -->
        <div id="messageBox" class="message-box"></div>

        <!-- Patient Registration Section -->
        <section class="mb-8 p-6 bg-blue-50 rounded-lg">
            <h2 class="section-title text-blue-800">1. Patient Registration üìù</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="patientName" class="block text-gray-700 text-sm font-bold mb-2">Patient Name:</label>
                    <input type="text" id="patientName" name="patientName" placeholder="John Doe" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="patientDOB" class="block text-gray-700 text-sm font-bold mb-2">Date of Birth:</label>
                    <input type="date" id="patientDOB" name="patientDOB" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label for="insuranceID" class="block text-gray-700 text-sm font-bold mb-2">Insurance ID:</label>
                    <input type="text" id="insuranceID" name="insuranceID" placeholder="ABC123456789" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <button id="registerPatientBtn" class="btn-primary w-full">Register Patient</button>
        </section>

        <!-- Encounter Documentation Section -->
        <section class="mb-8 p-6 bg-green-50 rounded-lg">
            <h2 class="section-title text-green-800">2. Encounter Documentation ü©∫</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="encounterDate" class="block text-gray-700 text-sm font-bold mb-2">Encounter Date:</label>
                    <input type="date" id="encounterDate" name="encounterDate" class="focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="md:col-span-2">
                    <label for="chiefComplaint" class="block text-gray-700 text-sm font-bold mb-2">Chief Complaint:</label>
                    <input type="text" id="chiefComplaint" name="chiefComplaint" placeholder="Patient reports sore throat and fever" class="focus:ring-green-500 focus:border-green-500">
                </div>
            </div>

            <div id="diagnosisList" class="mb-4 space-y-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Diagnoses (ICD Codes):</label>
                <div class="flex items-center gap-2">
                    <input type="text" class="diagnosis-code flex-grow-1 focus:ring-green-500 focus:border-green-500" name="diagnosisCode" placeholder="e.g., J02.9 (Acute pharyngitis)">
                    <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                </div>
            </div>
            <button id="addDiagnosisBtn" class="btn-primary mb-6 w-full bg-green-600 hover:bg-green-700">Add Another Diagnosis</button>

            <div id="procedureList" class="mb-4 space-y-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Procedures (CPT/HCPCS Codes):</label>
                <div class="flex items-center gap-2">
                    <input type="text" class="procedure-code flex-grow-1 focus:ring-green-500 focus:border-green-500" name="procedureCode" placeholder="e.g., 99213 (Office visit)">
                    <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                </div>
            </div>
            <button id="addProcedureBtn" class="btn-primary w-full bg-green-600 hover:bg-green-700">Add Another Procedure</button>
        </section>

        <!-- Charge Entry Section -->
        <section class="mb-8 p-6 bg-purple-50 rounded-lg">
            <h2 class="section-title text-purple-800">3. Charge Entry & Services üí≤</h2>
            <div id="chargeList" class="mb-4 space-y-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Services Rendered:</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 service-item">
                    <input type="text" class="service-description col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500" name="serviceDescription" placeholder="Service Description">
                    <input type="text" class="service-cpt-code col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500" name="serviceCptCode" placeholder="CPT Code">
                    <div class="flex gap-2 col-span-1 md:col-span-1">
                        <input type="number" class="service-price flex-grow-1 focus:ring-purple-500 focus:border-purple-500" name="servicePrice" placeholder="Price ($)" min="0" step="0.01">
                        <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                    </div>
                </div>
            </div>
            <button id="addChargeBtn" class="btn-primary w-full bg-purple-600 hover:bg-purple-700">Add Another Service</button>
        </section>

        <!-- Generate Claim Section -->
        <section class="p-6 bg-red-50 rounded-lg mb-8">
            <h2 class="section-title text-red-800">4. Generate & View Claim üìÑ</h2>
            <button id="generateClaimBtn" class="btn-primary w-full mb-6 bg-red-600 hover:bg-red-700">Generate Simulated Claim</button>

            <div id="claimOutput" class="bg-gray-50 p-4 border border-gray-200 rounded-lg min-h-[150px] overflow-auto text-sm text-gray-800 whitespace-pre-wrap">
                <!-- Claim data will appear here -->
                <p class="text-gray-500">Your simulated claim details will appear here after generation.</p>
            </div>
            <button id="clearAllBtn" class="btn-secondary w-full mt-4">Clear All Data</button>
        </section>

        <!-- Medical Billing Walkthrough Section -->
        <section class="p-6 bg-indigo-50 rounded-lg mb-8">
            <h2 class="section-title text-indigo-800">5. Medical Billing Process Walkthrough üö∂‚Äç‚ôÄÔ∏è</h2>
            <p class="text-gray-700 mb-4">Click "Start Step" or "Next Step" to walk through the revenue cycle.</p>

            <div id="billingWalkthroughContent" class="hidden">
                <h3 id="walkthroughStepTitle" class="walkthrough-step-title text-indigo-700"></h3>
                <div id="walkthroughStepInstructions" class="walkthrough-instructions"></div>
            </div>
           
            <button id="startBillingWalkthroughBtn" class="btn-primary w-full mb-4 bg-indigo-600 hover:bg-indigo-700">Start Billing Walkthrough</button>
            <button id="nextBillingWalkthroughBtn" class="btn-primary w-full mb-4 bg-indigo-600 hover:bg-indigo-700 hidden">Next Step</button>
            <button id="resetBillingWalkthroughBtn" class="btn-secondary w-full hidden">Reset Walkthrough</button>
        </section>

        <!-- Prior Authorization Walkthrough Section -->
        <section class="p-6 bg-orange-50 rounded-lg mb-8">
            <h2 class="section-title text-orange-800">6. Prior Authorization (PA) Walkthrough üö¶</h2>
            <p class="text-gray-700 mb-4">Follow the steps to understand a PA scenario.</p>

            <div id="paWalkthroughContent" class="hidden">
                <h3 id="paWalkthroughStepTitle" class="walkthrough-step-title text-orange-700"></h3>
                <div id="paWalkthroughStepInstructions" class="walkthrough-instructions"></div>
            </div>
           
            <button id="startPaWalkthroughBtn" class="btn-primary w-full mb-4 bg-orange-600 hover:bg-orange-700">Start PA Walkthrough</button>
            <button id="nextPaWalkthroughBtn" class="btn-primary w-full mb-4 bg-orange-600 hover:bg-orange-700 hidden">Next Step</button>
            <button id="resetPaWalkthroughBtn" class="btn-secondary w-full hidden">Reset PA Walkthrough</button>
        </section>

        <!-- Knowledge Quizzes Section -->
        <section class="p-6 bg-pink-50 rounded-lg mb-8">
            <h2 class="section-title text-pink-800">7. Knowledge Quizzes! üìö</h2>
            <p class="text-gray-700 mb-4">Test your understanding of coding guidelines, healthcare laws, ethics, and denials & appeals!</p>

            <div class="flex flex-wrap gap-3 mb-6">
                <button id="quizGuidelinesBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Coding Guidelines</button>
                <button id="quizLawsBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Healthcare Laws</button>
                <button id="quizEthicsBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Coding Ethics</button>
                <button id="quizDenialsBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Denials & Appeals</button>
                <button id="quizInsuranceNuanceBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Insurance Nuances</button>
            </div>

            <div id="quizContent" class="quiz-content hidden">
                <h3 id="quizQuestionTitle" class="quiz-question-title text-pink-700"></h3>
                <div id="quizOptions" class="mb-4">
                    <!-- Options will be dynamically inserted here -->
                </div>
                
                <button id="submitAnswerBtn" class="btn-primary bg-pink-600 hover:bg-pink-700 mb-4">Submit Answer</button>
                <button id="nextQuestionBtn" class="btn-secondary hidden">Next Question</button>
                <button id="resetQuizBtn" class="btn-secondary hidden">Reset Quiz</button>

                <div id="quizFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 quiz-feedback-text">Your feedback will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Patient Balance Calculator Section -->
        <section class="p-6 bg-teal-50 rounded-lg mb-8">
            <h2 class="section-title text-teal-800">8. Patient Balance Calculator üí∞</h2>
            <p class="text-gray-700 mb-4">Practice calculating patient responsibility based on common scenarios.</p>

            <button id="loadBalanceScenarioBtn" class="btn-primary w-full mb-6 bg-teal-600 hover:bg-teal-700">Load New Scenario</button>

            <div id="balanceCalculatorContent" class="balance-calculator-content hidden">
                <h3 id="balanceScenarioTitle" class="balance-scenario-title text-teal-700"></h3>
                <div id="balanceScenarioDetails" class="balance-scenario-text mb-4"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="userCopay" class="block text-gray-700 text-sm font-bold mb-2">Your Calculated Copay ($):</label>
                        <input type="number" id="userCopay" name="userCopay" placeholder="0.00" min="0" step="0.01" class="focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="userDeductibleInput" class="block text-gray-700 text-sm font-bold mb-2">Your Calculated Deductible Applied ($):</label>
                        <input type="number" id="userDeductibleInput" name="userDeductibleInput" placeholder="0.00" min="0" step="0.01" class="focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="userCoinsurance" class="block text-gray-700 text-sm font-bold mb-2">Your Calculated Coinsurance ($):</label>
                        <input type="number" id="userCoinsurance" name="userCoinsurance" placeholder="0.00" min="0" step="0.01" class="focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="userTotalBalance" class="block text-gray-700 text-sm font-bold mb-2">Your Calculated Total Patient Balance ($):</label>
                        <input type="number" id="userTotalBalance" name="userTotalBalance" placeholder="0.00" min="0" step="0.01" class="font-bold focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                
                <button id="checkBalanceBtn" class="btn-primary bg-teal-600 hover:bg-teal-700 mb-4">Check My Calculation</button>
                <button id="resetBalanceBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="balanceFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 balance-feedback-text">Feedback on your calculation will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Advanced Modifier Application Challenge Section -->
        <section class="p-6 bg-yellow-50 rounded-lg mb-8">
            <h2 class="section-title text-yellow-800">9. Advanced Modifier Application Challenge üåü</h2>
            <p class="text-gray-700 mb-4">Analyze the scenario and apply the appropriate CPT code and modifier.</p>

            <button id="loadModifierScenarioBtn" class="btn-primary w-full mb-6 bg-yellow-600 hover:bg-yellow-700">Load New Scenario</button>

            <div id="modifierChallengeContent" class="modifier-challenge-content hidden">
                <h3 id="modifierScenarioTitle" class="modifier-challenge-title text-yellow-700"></h3>
                <div id="modifierScenarioDetails" class="modifier-scenario-text mb-4"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="userModifierCPT" class="block text-gray-700 text-sm font-bold mb-2">Your CPT Code:</label>
                        <input type="text" id="userModifierCPT" name="userModifierCPT" placeholder="e.g., 99213" class="focus:ring-yellow-500 focus:border-yellow-500 uppercase">
                    </div>
                    <div>
                        <label for="userModifier" class="block text-gray-700 text-sm font-bold mb-2">Your Modifier(s) (e.g., 25, 59):</label>
                        <input type="text" id="userModifier" name="userModifier" placeholder="e.g., 25" class="focus:ring-yellow-500 focus:border-yellow-500 uppercase">
                    </div>
                </div>
                
                <button id="checkModifierBtn" class="btn-primary bg-yellow-600 hover:bg-yellow-700 mb-4">Check My Modifier</button>
                <button id="resetModifierBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="modifierFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 modifier-feedback-text">Feedback on your modifier application will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Medical Terminology Matching Game -->
        <section class="p-6 bg-blue-50 rounded-lg mb-8">
            <h2 class="section-title text-blue-800">10. Medical Terminology Matching Game üß†</h2>
            <p class="text-gray-700 mb-4">Match the medical billing terms/acronyms with their correct definitions.</p>

            <button id="startGameBtn" class="btn-primary w-full mb-6 bg-blue-600 hover:bg-blue-700">Start New Game</button>

            <div id="matchingGameContent" class="matching-game-content hidden">
                <p id="gameMessage" class="text-center text-lg font-bold mb-4"></p>
                <div id="cardGrid" class="match-card-grid">
                    <!-- Cards will be dynamically inserted here -->
                </div>
                <button id="resetGameBtn" class="btn-secondary w-full mt-6 hidden">Reset Game</button>
            </div>
        </section>

        <!-- Claim Scrubber / Error Finder Challenge Section -->
        <section class="p-6 bg-orange-100 rounded-lg mb-8">
            <h2 class="section-title text-orange-800">11. Claim Scrubber / Error Finder Challenge üîç</h2>
            <p class="text-gray-700 mb-4">Review the presented claim scenario and identify/correct the errors.</p>

            <button id="loadScrubberScenarioBtn" class="btn-primary w-full mb-6 bg-orange-600 hover:bg-orange-700">Load New Scenario</button>

            <div id="scrubberChallengeContent" class="scrubber-challenge-content hidden">
                <h3 id="scrubberScenarioTitle" class="scrubber-challenge-title text-orange-700"></h3>
                <div id="scrubberScenarioDetails" class="scrubber-scenario-text mb-4"></div>
                
                <p class="font-bold text-gray-700 mb-2">Presented Claim Details:</p>
                <pre id="presentedClaimOutput" class="bg-gray-50 p-3 rounded-lg border border-gray-200 text-sm whitespace-pre-wrap mb-4"></pre>

                <p class="font-bold text-gray-700 mb-2">Your Corrected Codes/Modifiers:</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="userScrubberICD" class="block text-gray-700 text-sm font-bold mb-2">Corrected ICD-10:</label>
                        <input type="text" id="userScrubberICD" name="userScrubberICD" placeholder="e.g., I10" class="focus:ring-orange-500 focus:border-orange-500 uppercase">
                    </div>
                    <div>
                        <label for="userScrubberCPT" class="block text-gray-700 text-sm font-bold mb-2">Corrected CPT:</label>
                        <input type="text" id="userScrubberCPT" name="userScrubberCPT" placeholder="e.g., 99213" class="focus:ring-orange-500 focus:border-orange-500 uppercase">
                    </div>
                    <div>
                        <label for="userScrubberModifier" class="block text-gray-700 text-sm font-bold mb-2">Corrected Modifier(s):</label>
                        <input type="text" id="userScrubberModifier" name="userScrubberModifier" placeholder="e.g., 25, 59 (or 'None')" class="focus:ring-orange-500 focus:border-orange-500 uppercase">
                    </div>
                </div>
                
                <button id="checkScrubberBtn" class="btn-primary bg-orange-600 hover:bg-orange-700 mb-4">Check My Corrections</button>
                <button id="resetScrubberBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="scrubberFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 scrubber-feedback-text">Feedback on your corrections will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Denial Code Interpreter & Action Plan Simulator Section -->
        <section class="p-6 bg-purple-100 rounded-lg mb-8">
            <h2 class="section-title text-purple-800">12. Denial Code Interpreter & Action Plan Simulator üö´</h2>
            <p class="text-gray-700 mb-4">Interpret the denial code and plan your next steps to resolve the claim.</p>

            <button id="loadDenialScenarioBtn" class="btn-primary w-full mb-6 bg-purple-600 hover:bg-purple-700">Load New Denial Scenario</button>

            <div id="denialChallengeContent" class="denial-challenge-content hidden">
                <h3 id="denialScenarioTitle" class="denial-challenge-title text-purple-700"></h3>
                <div id="denialScenarioDetails" class="denial-scenario-text mb-4"></div>
                
                <p class="font-bold text-gray-700 mb-2">Interpret the Denial Code:</p>
                <div id="denialInterpretationOptions" class="mb-4">
                    <!-- Options for interpretation will be dynamically inserted here -->
                </div>

                <p class="font-bold text-gray-700 mb-2">Your Action Plan (be specific):</p>
                <textarea id="userActionPlan" name="userActionPlan" rows="4" placeholder="e.g., Research payer policy, appeal with medical records, bill patient..." class="focus:ring-purple-500 focus:border-purple-500 mb-4"></textarea>
                
                <button id="checkDenialBtn" class="btn-primary bg-purple-600 hover:bg-purple-700 mb-4">Check My Plan</button>
                <button id="resetDenialBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="denialFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 denial-feedback-text">Feedback on your denial resolution plan will appear here.</p>
                </div>
            </div>
        </section>

        <!-- SOAP Note Coder & Extractor Challenge Section -->
        <section class="p-6 bg-teal-100 rounded-lg mb-8">
            <h2 class="section-title text-teal-800">13. SOAP Note Coder & Extractor Challenge üìã</h2>
            <p class="text-gray-700 mb-4">Review the SOAP note below and extract the relevant coding and plan information.</p>

            <button id="loadSoapScenarioBtn" class="btn-primary w-full mb-6 bg-teal-600 hover:bg-teal-700">Load New SOAP Note Scenario</button>

            <div id="soapChallengeContent" class="soap-challenge-content hidden">
                <h3 id="soapScenarioTitle" class="soap-challenge-title text-teal-700"></h3>
                <p id="soapScenarioDescription" class="soap-scenario-text mb-4"></p>
                
                <div id="soapNoteDisplay" class="mb-4">
                    <!-- SOAP note content will be loaded here -->
                </div>

                <p class="font-bold text-gray-700 mb-2">Your Extracted Information:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="md:col-span-2">
                        <label for="userSoapChiefComplaint" class="block text-gray-700 text-sm font-bold mb-2">Chief Complaint:</label>
                        <input type="text" id="userSoapChiefComplaint" name="userSoapChiefComplaint" placeholder="Patient's main reason for visit" class="focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="userSoapICD" class="block text-gray-700 text-sm font-bold mb-2">Primary ICD-10 Code(s):</label>
                        <input type="text" id="userSoapICD" name="userSoapICD" placeholder="e.g., J02.0 (comma-separated if multiple)" class="focus:ring-teal-500 focus:border-teal-500 uppercase">
                    </div>
                    <div>
                        <label for="userSoapCPT" class="block text-gray-700 text-sm font-bold mb-2">Primary CPT Code(s):</label>
                        <input type="text" id="userSoapCPT" name="userSoapCPT" placeholder="e.g., 99213, 87880 (comma-separated if multiple)" class="focus:ring-teal-500 focus:border-teal-500 uppercase">
                    </div>
                    <div class="md:col-span-2">
                        <label for="userSoapModifier" class="block text-gray-700 text-sm font-bold mb-2">Modifier(s) (if any):</label>
                        <input type="text" id="userSoapModifier" name="userSoapModifier" placeholder="e.g., 25 (or 'None')" class="focus:ring-teal-500 focus:border-teal-500 uppercase">
                    </div>
                    <div class="md:col-span-2">
                        <label for="userSoapPlan" class="block text-gray-700 text-sm font-bold mb-2">Key Elements of the Plan:</label>
                        <textarea id="userSoapPlan" name="userSoapPlan" rows="4" placeholder="Summarize medication, follow-up, education etc." class="focus:ring-teal-500 focus:border-teal-500"></textarea>
                    </div>
                </div>
                
                <button id="checkSoapBtn" class="btn-primary bg-teal-600 hover:bg-teal-700 mb-4">Check My Extraction</button>
                <button id="resetSoapBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="soapFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 soap-feedback-text">Feedback on your extraction will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Code Lookup Tool Section -->
        <section class="p-6 bg-yellow-100 rounded-lg mb-8">
            <h2 class="section-title text-yellow-800">14. Code Lookup Tool üìö</h2>
            <p class="text-gray-700 mb-4">Search for common ICD-10 or CPT codes to see their descriptions.</p>

            <div id="codeLookupContent" class="code-lookup-content">
                <div class="mb-4">
                    <label for="codeLookupInput" class="block text-gray-700 text-sm font-bold mb-2">Enter Code (e.g., J02.0, 99213):</label>
                    <input type="text" id="codeLookupInput" name="codeLookupInput" placeholder="Enter ICD-10 or CPT code" class="focus:ring-yellow-500 focus:border-yellow-500 uppercase">
                </div>
                <button id="lookupCodeBtn" class="btn-primary w-full mb-4 bg-yellow-600 hover:bg-yellow-700">Lookup Code</button>
                <div id="codeLookupResult" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500">Code description will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Accounts Receivable (A/R) Aging Simulation Section -->
        <section class="p-6 bg-red-100 rounded-lg mb-8">
            <h2 class="section-title text-red-800">15. Accounts Receivable (A/R) Aging Simulation üìà</h2>
            <p class="text-gray-700 mb-4">Practice analyzing aging claims and determining the correct follow-up action. Select an action for each claim.</p>

            <button id="loadArScenarioBtn" class="btn-primary w-full mb-6 bg-red-600 hover:bg-red-700">Load New A/R Scenario</button>

            <div id="arAgingContent" class="ar-aging-content hidden">
                <div id="arClaimList">
                    <!-- A/R claims will be dynamically inserted here -->
                </div>
                <button id="checkArActionsBtn" class="btn-primary w-full mt-4 bg-red-600 hover:bg-red-700">Check My Actions</button>
                <button id="resetArScenarioBtn" class="btn-secondary w-full mt-2 hidden">Reset A/R Scenario</button>
                <div id="arFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500">Feedback on your A/R actions will appear here.</p>
                </div>
            </div>
        </section>

        <!-- NEW: Medical Billing Form Repository Section -->
        <section class="p-6 bg-blue-100 rounded-lg mb-8">
            <h2 class="section-title text-blue-800">16. Medical Billing Form Repository üìÇ</h2>
            <p class="text-gray-700 mb-4">Explore descriptions of common forms used in medical billing and where to find their blank templates online for practice.</p>

            <div id="formRepositoryContent" class="form-repository-content">
                <div class="form-item">
                    <h3 class="form-repository-title text-blue-700">CMS-1500 Claim Form</h3>
                    <p class="form-repository-text">This is the universal claim form for professional (physician and non-institutional) services. It captures patient demographics, insurance information, diagnoses (ICD-10), procedures (CPT/HCPCS), and charges. It's the most common form you'll encounter for outpatient billing.</p>
                    <p class="form-repository-text mt-1 text-xs italic">You can find blank CMS-1500 templates by searching online for "CMS-1500 form fillable PDF" or "NUCC CMS-1500 form".</p>
                </div>
                <div class="form-item">
                    <h3 class="form-repository-title text-blue-700">UB-04 Claim Form (CMS-1450)</h3>
                    <p class="form-repository-text">This is the claim form used by institutional providers (like hospitals, skilled nursing facilities, ambulatory surgical centers) for inpatient and outpatient services. It captures facility charges, revenue codes, and patient stay details.</p>
                    <p class="form-repository-text mt-1 text-xs italic">You can find blank UB-04 templates by searching online for "UB-04 form fillable PDF" or "NUBC UB-04 form".</p>
                </div>
                <div class="form-item">
                    <h3 class="form-repository-title text-blue-700">Advance Beneficiary Notice of Noncoverage (ABN)</h3>
                    <p class="form-repository-text">A form given to Medicare beneficiaries when a service may not be covered by Medicare. It informs the patient they may be responsible for payment if Medicare denies the service, requiring their signature before service delivery. This protects the provider's right to bill the patient.</p>
                    <p class="form-repository-text mt-1 text-xs italic">You can find blank ABN forms (CMS-R-131) on the CMS website or by searching for "CMS ABN form".</p>
                </div>
                 <div class="form-item">
                    <h3 class="form-repository-title text-blue-700">Explanation of Benefits (EOB) / Electronic Remittance Advice (ERA)</h3>
                    <p class="form-repository-text">These are not "forms" you fill out, but rather documents generated by insurance companies. The EOB is sent to the patient and provider, detailing how a claim was processed (what was paid, denied, applied to deductible, etc.). The ERA is the electronic version sent to the provider, allowing for automated payment posting.</p>
                    <p class="form-repository-text mt-1 text-xs italic">Practice interpreting EOBs/ERAs by requesting sample EOBs from your insurance provider (if they offer them) or by searching online for "sample EOB Medicare" or "sample ERA medical billing".</p>
                </div>
            </div>
        </section>

    </div>

    <footer class="text-center text-gray-600 text-sm mt-10 pb-5">
        &copy; 2025 Chandra M Harris
    </footer>

    <script type="module">
        // Import the functions you need from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, addDoc, getDocs, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration (provided by Canvas environment)
        // Make sure to parse it as it comes in as a string
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null; // Changed to null if undefined
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Fallback for local testing if not in Canvas

        // Initialize Firebase ONLY if config is available
        let app;
        let db;
        let auth;
        let userId = null;

        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Listen for auth state changes and sign in
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in.
                    userId = user.uid;
                    console.log("User signed in:", userId);
                } else {
                    // User is signed out or not authenticated yet.
                    // Attempt to sign in with custom token if available, otherwise anonymously.
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            const userCredential = await signInWithCustomToken(auth, __initial_auth_token);
                            userId = userCredential.user.uid;
                            console.log("Signed in with custom token:", userId);
                        } catch (error) {
                            console.error("Error signing in with custom token:", error);
                            // Fallback to anonymous if custom token fails
                            try {
                                const userCredential = await signInAnonymously(auth);
                                userId = userCredential.user.uid;
                                console.log("Signed in anonymously (fallback):", userId);
                            } catch (anonError) {
                                console.error("Error signing in anonymously:", anonError);
                                // If all auth fails, generate a random ID
                                userId = crypto.randomUUID();
                                console.warn("Could not authenticate, using random ID:", userId);
                            }
                        }
                    } else {
                        // If no initial token, sign in anonymously
                        try {
                            const userCredential = await signInAnonymously(auth);
                            userId = userCredential.user.uid;
                            console.log("Signed in anonymously:", userId);
                        } catch (error) {
                            console.error("Error signing in anonymously:", error);
                            // If anonymous auth fails, generate a random ID
                            userId = crypto.randomUUID();
                            console.warn("Could not authenticate, using random ID:", userId);
                        }
                    }
                }
                // Now that auth is ready, you can start interacting with Firestore
                console.log("Firebase Auth and Firestore services initialized. User ID:", userId);
            });
        } else {
            console.warn("Firebase configuration not found. Firebase services will not be initialized.");
            // If Firebase config is not available, provide a fallback userId
            userId = crypto.randomUUID();
            console.warn("Using a random ID as Firebase config is missing:", userId);
        }

        // You can also expose db, auth, and userId globally if needed for your existing script,
        // but better practice is to pass them to functions or encapsulate logic.
        // For simplicity in this direct integration, we'll use them directly within this script block.
        // window.db = db; // Not recommended for large apps, but can simplify initial integration
        // window.auth = auth;
        // window.userId = userId;


        // DOM Element References (existing sections)
        const patientNameInput = document.getElementById('patientName');
        const patientDOBInput = document.getElementById('patientDOB');
        const insuranceIDInput = document.getElementById('insuranceID');
        const registerPatientBtn = document.getElementById('registerPatientBtn');

        const encounterDateInput = document.getElementById('encounterDate');
        const chiefComplaintInput = document.getElementById('chiefComplaint');
        const diagnosisList = document.getElementById('diagnosisList');
        const addDiagnosisBtn = document.getElementById('addDiagnosisBtn');
        const procedureList = document.getElementById('procedureList');
        const addProcedureBtn = document.getElementById('addProcedureBtn');

        const chargeList = document.getElementById('chargeList');
        const addChargeBtn = document.getElementById('addChargeBtn');

        const generateClaimBtn = document.getElementById('generateClaimBtn');
        const claimOutput = document.getElementById('claimOutput');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const messageBox = document.getElementById('messageBox');

        // DOM Element References (Medical Billing Walkthrough)
        const billingWalkthroughContent = document.getElementById('billingWalkthroughContent');
        const walkthroughStepTitle = document.getElementById('walkthroughStepTitle');
        const walkthroughStepInstructions = document.getElementById('walkthroughStepInstructions');
        const startBillingWalkthroughBtn = document.getElementById('startBillingWalkthroughBtn');
        const nextBillingWalkthroughBtn = document.getElementById('nextBillingWalkthroughBtn');
        const resetBillingWalkthroughBtn = document.getElementById('resetBillingWalkthroughBtn');

        // DOM Element References (Prior Authorization Walkthrough)
        const paWalkthroughContent = document.getElementById('paWalkthroughContent');
        const paWalkthroughStepTitle = document.getElementById('paWalkthroughStepTitle');
        const paWalkthroughStepInstructions = document.getElementById('paWalkthroughStepInstructions');
        const startPaWalkthroughBtn = document.getElementById('startPaWalkthroughBtn');
        const nextPaWalkthroughBtn = document.getElementById('nextPaWalkthroughBtn');
        const resetPaWalkthroughBtn = document.getElementById('resetPaWalkthroughBtn');

        // DOM Element References (Knowledge Quizzes)
        const quizGuidelinesBtn = document.getElementById('quizGuidelinesBtn');
        const quizLawsBtn = document.getElementById('quizLawsBtn');
        const quizEthicsBtn = document.getElementById('quizEthicsBtn');
        const quizDenialsBtn = document.getElementById('quizDenialsBtn');
        const quizInsuranceNuanceBtn = document.getElementById('quizInsuranceNuanceBtn');
        const quizContent = document.getElementById('quizContent');
        const quizQuestionTitle = document.getElementById('quizQuestionTitle');
        const quizOptions = document.getElementById('quizOptions');
        const submitAnswerBtn = document.getElementById('submitAnswerBtn');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const resetQuizBtn = document.getElementById('resetQuizBtn');
        const quizFeedback = document.getElementById('quizFeedback');

        // DOM Element References (Patient Balance Calculator)
        const loadBalanceScenarioBtn = document.getElementById('loadBalanceScenarioBtn');
        const balanceCalculatorContent = document.getElementById('balanceCalculatorContent');
        const balanceScenarioTitle = document.getElementById('balanceScenarioTitle');
        const balanceScenarioDetails = document.getElementById('balanceScenarioDetails');
        const userCopayInput = document.getElementById('userCopay');
        const userDeductibleInput = document.getElementById('userDeductibleInput'); // Corrected ID
        const userCoinsuranceInput = document.getElementById('userCoinsurance');
        const userTotalBalanceInput = document.getElementById('userTotalBalance');
        const checkBalanceBtn = document.getElementById('checkBalanceBtn');
        const resetBalanceBtn = document.getElementById('resetBalanceBtn');
        const balanceFeedback = document.getElementById('balanceFeedback');

        // DOM Element References (Modifier Application Challenge)
        const loadModifierScenarioBtn = document.getElementById('loadModifierScenarioBtn');
        const modifierChallengeContent = document.getElementById('modifierChallengeContent');
        const modifierScenarioTitle = document.getElementById('modifierScenarioTitle');
        const modifierScenarioDetails = document.getElementById('modifierScenarioDetails');
        const userModifierCPTInput = document.getElementById('userModifierCPT');
        const userModifierInput = document.getElementById('userModifier');
        const checkModifierBtn = document.getElementById('checkModifierBtn');
        const resetModifierBtn = document.getElementById('resetModifierBtn');
        const modifierFeedback = document.getElementById('modifierFeedback');

        // DOM Element References (Matching Game)
        const startGameBtn = document.getElementById('startGameBtn');
        const matchingGameContent = document.getElementById('matchingGameContent');
        const cardGrid = document.getElementById('cardGrid');
        const gameMessage = document.getElementById('gameMessage');
        const resetGameBtn = document.getElementById('resetGameBtn');

        // DOM Element References (Claim Scrubber)
        const loadScrubberScenarioBtn = document.getElementById('loadScrubberScenarioBtn');
        const scrubberChallengeContent = document.getElementById('scrubberChallengeContent');
        const scrubberScenarioTitle = document.getElementById('scrubberScenarioTitle');
        const scrubberScenarioDetails = document.getElementById('scrubberScenarioDetails');
        const presentedClaimOutput = document.getElementById('presentedClaimOutput');
        const userScrubberICDInput = document.getElementById('userScrubberICD');
        const userScrubberCPTInput = document.getElementById('userScrubberCPT');
        const userScrubberModifierInput = document.getElementById('userScrubberModifier');
        const checkScrubberBtn = document.getElementById('checkScrubberBtn');
        const resetScrubberBtn = document.getElementById('resetScrubberBtn');
        const scrubberFeedback = document.getElementById('scrubberFeedback');

        // DOM Element References (Denial Code Interpreter)
        const loadDenialScenarioBtn = document.getElementById('loadDenialScenarioBtn');
        const denialChallengeContent = document.getElementById('denialChallengeContent');
        const denialScenarioTitle = document.getElementById('denialScenarioTitle');
        const denialScenarioDetails = document.getElementById('denialScenarioDetails');
        const denialInterpretationOptions = document.getElementById('denialInterpretationOptions');
        const userActionPlanInput = document.getElementById('userActionPlan');
        const checkDenialBtn = document.getElementById('checkDenialBtn');
        const resetDenialBtn = document.getElementById('resetDenialBtn');
        const denialFeedback = document.getElementById('denialFeedback');

        // DOM Element References (SOAP Note Challenge)
        const loadSoapScenarioBtn = document.getElementById('loadSoapScenarioBtn');
        const soapChallengeContent = document.getElementById('soapChallengeContent');
        const soapScenarioTitle = document.getElementById('soapScenarioTitle');
        const soapScenarioDescription = document.getElementById('soapScenarioDescription');
        const soapNoteDisplay = document.getElementById('soapNoteDisplay');
        const userSoapChiefComplaintInput = document.getElementById('userSoapChiefComplaint');
        const userSoapICDInput = document.getElementById('userSoapICD');
        const userSoapCPTInput = document.getElementById('userSoapCPT');
        const userSoapModifierInput = document.getElementById('userSoapModifier');
        const userSoapPlanInput = document.getElementById('userSoapPlan');
        const checkSoapBtn = document.getElementById('checkSoapBtn');
        const resetSoapBtn = document.getElementById('resetSoapBtn');
        const soapFeedback = document.getElementById('soapFeedback');

        // Code Lookup Tool DOM Elements
        const codeLookupInput = document.getElementById('codeLookupInput');
        const lookupCodeBtn = document.getElementById('lookupCodeBtn');
        const codeLookupResult = document.getElementById('codeLookupResult');
        const codeLookupContent = document.getElementById('codeLookupContent');

        // NEW: A/R Aging Simulation DOM Elements
        const loadArScenarioBtn = document.getElementById('loadArScenarioBtn');
        const arAgingContent = document.getElementById('arAgingContent');
        const arClaimList = document.getElementById('arClaimList');
        const checkArActionsBtn = document.getElementById('checkArActionsBtn');
        const resetArScenarioBtn = document.getElementById('resetArScenarioBtn');
        const arFeedback = document.getElementById('arFeedback');

        // NEW: Form Repository DOM Elements (no dynamic parts, just content)
        const formRepositoryContent = document.getElementById('formRepositoryContent');


        // --- Global Data Storage (for existing simulation) ---
        let patientData = {};
        let diagnoses = [];
        let procedures = [];
        let charges = [];

        // --- Global Data Storage (Medical Billing Walkthrough) ---
        let currentBillingStep = 0;
        const billingSteps = [
            {
                title: "Step 1: Patient Registration & Insurance Verification",
                instructions: `**Action:** Begin by gathering the patient's full demographics and insurance details. **On the simulator:** Fill in the 'Patient Registration' section (Name, DOB, Insurance ID) and click 'Register Patient'. In a real scenario, you'd also call the payer to verify eligibility and benefits.`,
            },
            {
                title: "Step 2: Patient Encounter Documentation",
                instructions: `**Action:** This is where the provider records the visit details. **On the simulator:** Fill in the 'Encounter Documentation' section (Encounter Date, Chief Complaint, and add at least one Diagnosis and one Procedure). This mirrors the clinical notes that inform coding.`,
            },
            {
                title: "Step 3: Medical Coding",
                instructions: `**Action:** Translate the documentation into standardized ICD-10 and CPT codes. **On the simulator:** Ensure your Diagnosis and Procedure inputs in Section 2 are correctly formatted codes. This is a critical skill for accurate billing.`,
            },
            {
                title: "Step 4: Charge Entry & Superbill Creation",
                instructions: `**Action:** Enter the charges for the services provided. **On the simulator:** Go to 'Charge Entry & Services', add descriptions, CPT codes (ensure they match your procedures from step 2), and prices for the services. This creates the financial record.`,
            },
            {
                title: "Step 5: Claim Generation & Submission",
                instructions: `**Action:** Compile all data into a standardized claim (CMS-1500 for professional, UB-04 for institutional) and send it to the payer. **On the simulator:** Click 'Generate Simulated Claim' in Section 4. This is the official request for payment.`,
            },
            {
                title: "Step 6: Claim Adjudication",
                instructions: `**Understanding:** The insurance company reviews the claim. They'll either pay, deny, or reject it, sending an EOB (for patient) or ERA (for provider). **Think:** What common reasons lead to denials at this stage? (e.g., medical necessity, timely filing)`,
            },
            {
                title: "Step 7: Payment Posting",
                instructions: `**Action:** Once paid, the payment is recorded in the billing system. **Understanding:** This updates the patient's balance and the provider's accounts. Accurate posting prevents overbilling or outstanding balances.`,
            },
            {
                title: "Step 8: Patient Billing & Collections",
                instructions: `**Action:** If a balance remains after insurance pays, the patient is billed. **Understanding:** This involves sending statements and following up on overdue payments. Clear communication with patients is key.`,
            },
            {
                title: "Step 9: Reporting & Analysis",
                instructions: `**Understanding:** Continuously analyze billing data to identify trends, improve efficiency, and reduce denials. This step helps optimize the entire revenue cycle. **You've completed the walkthrough!**`,
            },
        ];

        // --- Global Data Storage (Prior Authorization Walkthrough) ---
        let currentPaStep = 0;
        const paSteps = [
            {
                title: "PA Step 1: Identify Need for Prior Authorization",
                instructions: `**Scenario:** A patient needs an MRI of the knee.
                **Action:** The first step is to check the patient's insurance plan and the specific CPT code (e.g., CPT 73721 for MRI knee without contrast) against the payer's policy to determine if a Prior Authorization (PA) is required. Many high-cost imaging services or specialty medications require PA.`,
            },
            {
                title: "PA Step 2: Gather Necessary Information",
                instructions: `**Action:** If PA is required, you must collect all relevant clinical and administrative information.
                **Required Info:** Patient demographics, insurance details, referring and rendering provider NPIs, **exact CPT code(s) with modifiers**, **supporting ICD-10 diagnosis code(s) demonstrating medical necessity**, date of service, and any clinical notes (e.g., physician's order, previous treatments tried and failed).`,
            },
            {
                title: "PA Step 3: Submit the Request",
                instructions: `**Action:** Submit the PA request to the insurance company. This is usually done online via a payer portal, fax, or phone.
                **Key Point:** Ensure all fields are accurately completed and all required supporting documentation is attached. Incomplete requests are a common cause of delays or denials.`,
            },
            {
                title: "PA Step 4: Follow-up and Await Decision",
                instructions: `**Action:** After submission, monitor the status of the request. Payers have specific turnaround times (e.g., 7-14 business days for routine, 24-72 hours for urgent).
                **Outcome:** The PA will either be **Approved**, **Denied**, or sent back for **More Information**.`,
            },
            {
                title: "PA Step 5: Handle Approved Authorization",
                instructions: `**Action:** If approved, carefully note the **authorization number**, the **approved CPT codes**, the **number of units/visits approved**, and the **valid date range**.
                **Next:** Ensure this authorization number is included on the claim when submitted to prevent denials. Inform the patient and scheduling department.`,
            },
            {
                title: "PA Step 6: Handle Denied Authorization",
                instructions: `**Action:** If denied, review the denial reason code carefully (often found on an EOB/ERA from the PA department). Common reasons include 'not medically necessary' or 'incorrect information'.
                **Next:** If denied for medical necessity, discuss with the provider if an appeal (with additional clinical documentation or a peer-to-peer review) is warranted. If denied for administrative reasons, correct and resubmit. **You've completed the PA walkthrough!**`,
            },
        ];

        // --- Global Data Storage (Knowledge Quizzes) ---
        let selectedQuizModule = null; // Stores the array of questions for the current module
        let currentQuizQuestionIndex = 0; // Tracks the current question in the module

        const quizModules = {
            "Coding Guidelines": [
                {
                    question: "What does a CPT code modifier indicate?",
                    options: ["A. A new diagnosis", "B. The code has been altered in some way", "C. The patient has insurance", "D. The service was performed in a hospital"],
                    answer: "B",
                    explanation: "A CPT modifier is a two-digit code appended to a CPT code to provide additional information about the procedure or service, such as that it was altered or performed by more than one physician."
                },
                {
                    question: "Which coding system is used for diagnosis codes?",
                    options: ["A. CPT", "B. HCPCS Level II", "C. ICD-10-CM", "D. E&M"],
                    answer: "C",
                    explanation: "ICD-10-CM (International Classification of Diseases, 10th Revision, Clinical Modification) is the standard system for diagnosis codes in the U.S."
                },
                // Add more Coding Guidelines questions here
            ],
            "Healthcare Laws": [
                {
                    question: "What is the primary purpose of HIPAA for medical coders?",
                    options: ["A. To ensure patients get timely appointments", "B. To protect the privacy and security of patient health information (PHI)", "C. To set reimbursement rates for services", "D. To standardize coding manuals"],
                    answer: "B",
                    explanation: "HIPAA's Privacy Rule and Security Rule mandate that Protected Health Information (PHI) is kept confidential and secure."
                },
                {
                    question: "Submitting a claim with codes that you know are wrong to get a higher payment is a violation of which law?",
                    options: ["A. Stark Law", "B. Anti-Kickback Statute", "C. False Claims Act (FCA)", "D. OIG Exclusions"],
                    answer: "C",
                    explanation: "The False Claims Act (FCA) imposes liability on persons and companies who knowingly submit false claims to the government."
                },
                // Add more Healthcare Laws questions here
            ],
            "Coding Ethics": [
                {
                    question: "Your boss tells you to change a code to one that provides higher reimbursement, even though the documentation doesn't support it. What is the most ethical action?",
                    options: ["A. Do what your boss says to avoid conflict", "B. Report the incident to a compliance officer", "C. Change the code but make a note in your personal records", "D. Tell the patient to file a complaint"],
                    answer: "B",
                    explanation: "The most ethical and legally compliant action is to report fraudulent activities, such as upcoding, to a designated compliance officer or legal department. This protects you and the organization."
                },
                // Add more Coding Ethics questions here
            ],
            "Denials & Appeals": [
                {
                    question: "A claim is denied because the diagnosis code does not justify the procedure code. What is this denial reason called?",
                    options: ["A. Medical necessity denial", "B. Bundling issue", "C. Payer policy change", "D. Inconsistent patient information"],
                    answer: "A",
                    explanation: "A denial for 'lack of medical necessity' means the payer believes the procedure performed was not necessary to treat the patient's documented diagnosis. The diagnosis code must support the procedure code."
                },
                {
                    question: "What is the first step in appealing a denied claim?",
                    options: ["A. Resubmit the claim with a new code", "B. Send a letter of protest to the payer's legal department", "C. Review the patient's chart and the denial reason", "D. Bill the patient directly for the full amount"],
                    answer: "C",
                    explanation: "The crucial first step in any appeal is to thoroughly review the patient‚Äôs documentation and compare it against the denial reason provided by the payer. This helps you identify if the issue is a simple coding error or a more complex medical necessity dispute."
                },
                // Add more Denials & Appeals questions here
            ],
            // Insurance Nuances Quiz Module
            "Insurance Nuances": [
                {
                    question: "Which type of insurance plan typically requires a referral from a Primary Care Provider (PCP) to see a specialist?",
                    options: ["A. PPO", "B. HMO", "C. Medicare Part B", "D. Fee-for-Service"],
                    answer: "B",
                    explanation: "HMO (Health Maintenance Organization) plans generally require a referral from a PCP to see a specialist, as they focus on managed care within a network."
                },
                {
                    question: "When a patient has both active Medicare and Medicaid, which payer is usually considered primary?",
                    options: ["A. Medicaid", "B. Medicare", "C. The patient's choice", "D. Whichever plan has been active longer"],
                    answer: "B",
                    explanation: "Medicare is almost always the primary payer when a patient has both Medicare and Medicaid. Medicaid then acts as the payer of last resort, covering what Medicare doesn't."
                },
                {
                    question: "Medicare Part B typically covers what percentage of approved physician services after the deductible is met?",
                    options: ["A. 100%", "B. 50%", "C. 80%", "D. 20%"],
                    answer: "C",
                    explanation: "Medicare Part B covers 80% of approved physician services after the annual deductible is met, with the patient responsible for the remaining 20% (coinsurance)."
                }
            ]
        };

        // --- Global Data Storage (Patient Balance Calculator) ---
        let currentBalanceScenarioData = null;

        loadBalanceScenarioBtn.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * patientBalanceScenarios.length);
            currentBalanceScenarioData = patientBalanceScenarios[randomIndex];
            
            balanceCalculatorContent.classList.remove('hidden');
            balanceScenarioTitle.textContent = `Scenario for ${currentBalanceScenarioData.patient}:`;
            balanceScenarioDetails.innerHTML = `
                <p><strong>Plan Details:</strong></p>
                <ul>
                    <li>Copay: $${currentBalanceScenarioData.plan.copay.toFixed(2)}</li>
                    <li>Deductible: $${currentBalanceScenarioData.plan.deductible.toFixed(2)}</li>
                    <li>Deductible Met to Date: $${currentBalanceScenarioData.plan.deductibleMetToDate.toFixed(2)}</li>
                    <li>Coinsurance: ${(currentBalanceScenarioData.plan.coinsurance * 100).toFixed(0)}%</li>
                </ul>
                <p><strong>Visit Details:</strong></p>
                <ul>
                    <li>Service: ${currentBalanceScenarioData.visit.service}</li>
                    <li>Total Allowed Amount by Insurance: $${currentBalanceScenarioData.visit.allowedAmount.toFixed(2)}</li>
                </ul>
                <p class="font-bold mt-2">Calculate the Patient's Responsibility:</p>
            `;
            resetBalanceCalculator(); // Reset inputs and feedback
            checkBalanceBtn.classList.remove('hidden');
            resetBalanceBtn.classList.remove('hidden');
        });

        checkBalanceBtn.addEventListener('click', () => {
            if (!currentBalanceScenarioData) {
                balanceFeedback.innerHTML = '<p class="text-red-700 balance-feedback-text">Please load a scenario first!</p>';
                return;
            }

            const userCopay = parseFloat(userCopayInput.value);
            // Ensure the correct input element is referenced
            const userDeductibleApplied = parseFloat(document.getElementById('userDeductibleInput').value); 
            const userCoinsurance = parseFloat(userCoinsuranceInput.value);
            const userTotalBalance = parseFloat(userTotalBalanceInput.value);

            let feedbackHtml = '';
            let allCorrect = true;

            // Check Copay
            if (userCopay === currentBalanceScenarioData.correct.copay) {
                feedbackHtml += `<p class="text-green-700">Copay: Correct! ($${currentBalanceScenarioData.correct.copay.toFixed(2)})</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Copay: Incorrect. Expected $${currentBalanceScenarioData.correct.copay.toFixed(2)}.</p>`;
                allCorrect = false;
            }

            // Check Deductible Applied
            if (userDeductibleApplied === currentBalanceScenarioData.correct.deductibleApplied) {
                feedbackHtml += `<p class="text-green-700">Deductible Applied: Correct! ($${currentBalanceScenarioData.correct.deductibleApplied.toFixed(2)})</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Deductible Applied: Incorrect. Expected $${currentBalanceScenarioData.correct.deductibleApplied.toFixed(2)}.</p>`;
                allCorrect = false;
            }

            // Check Coinsurance
            if (userCoinsurance === currentBalanceScenarioData.correct.coinsurance) {
                feedbackHtml += `<p class="text-green-700">Coinsurance: Correct! ($${currentBalanceScenarioData.correct.coinsurance.toFixed(2)})</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Coinsurance: Incorrect. Expected $${currentBalanceScenarioData.correct.coinsurance.toFixed(2)}.</p>`;
                allCorrect = false;
            }

            // Check Total Patient Balance
            if (userTotalBalance === currentBalanceScenarioData.correct.totalBalance) {
                feedbackHtml += `<p class="text-green-700 font-bold mt-2">Total Patient Balance: Correct! ($${currentBalanceScenarioData.correct.totalBalance.toFixed(2)})</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700 font-bold mt-2">Total Patient Balance: Incorrect. Expected $${currentBalanceScenarioData.correct.totalBalance.toFixed(2)}.</p>`;
                allCorrect = false;
            }

            // Overall feedback and detailed steps if incorrect
            if (!allCorrect) {
                feedbackHtml += `<p class="text-gray-700 mt-4 font-bold">Here's a breakdown of the correct calculation:</p>`;
                feedbackHtml += `<pre class="bg-gray-100 p-2 rounded text-xs mt-1 whitespace-pre-wrap">${currentBalanceScenarioData.calculationSteps.trim()}</pre>`;
                balanceFeedback.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
            } else {
                 balanceFeedback.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
            }
            
            balanceFeedback.innerHTML = feedbackHtml;
        });

        resetBalanceBtn.addEventListener('click', resetBalanceCalculator);

        function resetBalanceCalculator() {
            userCopayInput.value = '';
            document.getElementById('userDeductibleInput').value = ''; // Corrected ID
            userCoinsuranceInput.value = '';
            userTotalBalanceInput.value = '';
            balanceFeedback.innerHTML = '<p class="text-gray-500 balance-feedback-text">Feedback on your calculation will appear here.</p>';
            balanceFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
        }

        // --- Modifier Application Challenge Logic ---
        // 'currentModifierChallenge' is already declared globally at the top of the script.
        // The original error was due to redeclaring it with 'let' here.
        let currentModifierChallenge = null; // Initialize it without 'let' or 'const'

        loadModifierScenarioBtn.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * modifierScenarios.length);
            currentModifierChallenge = modifierScenarios[randomIndex];
            
            modifierChallengeContent.classList.remove('hidden');
            modifierScenarioTitle.textContent = `Scenario: ${currentModifierChallenge.id}`;
            modifierScenarioDetails.innerHTML = `<p class="text-sm text-yellow-800 italic">${currentModifierChallenge.scenario}</p>
                <p class="mt-2"><strong>Required CPT Code to Input:</strong> ${currentModifierChallenge.cptCodeToInput}</p>
                <p class="font-bold mt-2">Enter the CPT Code (if different from the required) and the appropriate Modifier(s).</p>
            `;
            userModifierCPTInput.value = '';
            userModifierInput.value = '';
            modifierFeedback.innerHTML = '<p class="text-gray-500 modifier-feedback-text">Feedback on your modifier application will appear here.</p>';
            modifierFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
            checkModifierBtn.classList.remove('hidden');
            resetModifierBtn.classList.remove('hidden');
        });

        checkModifierBtn.addEventListener('click', () => {
            if (!currentModifierChallenge) {
                modifierFeedback.innerHTML = '<p class="text-red-700 modifier-feedback-text">Please load a scenario first!</p>';
                return;
            }

            const userCPT = userModifierCPTInput.value.trim().toUpperCase();
            const userMod = userModifierInput.value.trim().toUpperCase();

            let feedbackHtml = '';
            let isCorrect = true;

            // Check CPT code
            if (userCPT !== currentModifierChallenge.cptCodeToInput.trim().toUpperCase()) {
                feedbackHtml += `<p class="text-red-700">CPT Code: Incorrect. Expected "${currentModifierChallenge.cptCodeToInput}".</p>`;
                isCorrect = false;
            } else {
                feedbackHtml += `<p class="text-green-700">CPT Code: Correct! ("${currentModifierChallenge.cptCodeToInput}")</p>`;
            }

            // Check Modifier
            if (userMod !== currentModifierChallenge.correctModifier.trim().toUpperCase()) {
                feedbackHtml += `<p class="text-red-700">Modifier: Incorrect. Expected "${currentModifierChallenge.correctModifier}".</p>`;
                isCorrect = false;
            } else {
                feedbackHtml += `<p class="text-green-700">Modifier: Correct! ("${currentModifierChallenge.correctModifier}")</p>`;
            }

            if (isCorrect) {
                modifierFeedback.innerHTML = `<p class="text-green-700 font-bold">Excellent! Your CPT code and modifier application are correct.</p>`;
            } else {
                modifierFeedback.innerHTML += `<p class="text-gray-700 mt-4 font-bold">Explanation:</p><p class="modifier-feedback-text">${currentModifierChallenge.explanation}</p>`;
            }
            modifierFeedback.className = isCorrect ? 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]' : 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
        });

        resetModifierBtn.addEventListener('click', () => {
            userModifierCPTInput.value = '';
            userModifierInput.value = '';
            modifierFeedback.innerHTML = '<p class="text-gray-500 modifier-feedback-text">Feedback on your modifier application will appear here.</p>';
            modifierFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
            checkModifierBtn.classList.remove('hidden');
            resetModifierBtn.classList.remove('hidden');
        });

        // --- Matching Game Logic ---

        startGameBtn.addEventListener('click', startGame);
        resetGameBtn.addEventListener('click', resetGame);

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function createCards() {
            cardGrid.innerHTML = ''; // Clear previous cards
            gameMessage.textContent = '';
            flippedCards = [];
            matchedPairs = 0;
            gameActive = true;

            cards = [];
            termPairs.forEach((pair, index) => {
                cards.push({ id: `term-${index}`, type: 'term', value: pair.term, pairId: index });
                cards.push({ id: `def-${index}`, type: 'definition', value: pair.definition, pairId: index });
            });

            shuffle(cards);

            cards.forEach(cardData => {
                const cardElement = document.createElement('div');
                cardElement.classList.add('match-card');
                cardElement.dataset.id = cardData.id;
                cardElement.dataset.pairId = cardData.pairId;
                cardElement.dataset.type = cardData.type;

                const cardFront = document.createElement('div');
                cardFront.classList.add('card-front');
                cardFront.textContent = '?'; // Placeholder for the back of the card

                const cardBack = document.createElement('div');
                cardBack.classList.add('card-back');
                cardBack.textContent = cardData.value;

                cardElement.appendChild(cardFront);
                cardElement.appendChild(cardBack);
                cardGrid.appendChild(cardElement);

                cardElement.addEventListener('click', () => flipCard(cardElement, cardData));
            });
        }

        function flipCard(cardElement, cardData) {
            if (!gameActive || flippedCards.length === 2 || cardElement.classList.contains('is-flipped') || cardElement.classList.contains('matched')) {
                return; // Do nothing if game not active, two cards already flipped, or card already flipped/matched
            }

            cardElement.classList.add('is-flipped');
            flippedCards.push({ element: cardElement, data: cardData });

            if (flippedCards.length === 2) {
                checkForMatch();
            }
        }

        function checkForMatch() {
            const [card1, card2] = flippedCards;
            const isMatch = card1.data.pairId === card2.data.pairId;

            if (isMatch) {
                card1.element.classList.add('matched');
                card2.element.classList.add('matched');
                gameMessage.textContent = 'Match found!';
                matchedPairs++;
                if (matchedPairs === termPairs.length) {
                    gameMessage.textContent = 'Congratulations! You matched all pairs!';
                    gameActive = false;
                }
                flippedCards = []; // Clear flipped cards for next turn
            } else {
                gameMessage.textContent = 'No match. Try again!';
                // Add incorrect class temporarily for visual feedback
                card1.element.classList.add('incorrect');
                card2.element.classList.add('incorrect');

                setTimeout(() => {
                    card1.element.classList.remove('is-flipped', 'incorrect');
                    card2.element.classList.remove('is-flipped', 'incorrect');
                    flippedCards = []; // Clear flipped cards
                    gameMessage.textContent = ''; // Clear message
                }, 1000); // Flip back after 1 second
            }
        }

        function startGame() {
            matchingGameContent.classList.remove('hidden');
            startGameBtn.classList.add('hidden');
            resetGameBtn.classList.remove('hidden');
            createCards();
            gameMessage.textContent = 'Find the matching pairs!';
        }

        function resetGame() {
            matchingGameContent.classList.add('hidden');
            startGameBtn.classList.remove('hidden');
            resetGameBtn.classList.add('hidden');
            cardGrid.innerHTML = '';
            gameMessage.textContent = '';
            flippedCards = [];
            matchedPairs = 0;
            gameActive = false;
            showMessage('Matching Game Reset.', 'success');
        }

        // --- Claim Scrubber Logic ---
        let currentScrubberScenarioData = null;

        loadScrubberScenarioBtn.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * claimScrubberScenarios.length);
            currentScrubberScenarioData = claimScrubberScenarios[randomIndex];
            
            scrubberChallengeContent.classList.remove('hidden');
            scrubberScenarioTitle.textContent = `Claim Scrubber: ${currentScrubberScenarioData.title}`;
            scrubberScenarioDetails.innerHTML = `<p class="text-sm text-orange-800 italic">${currentScrubberScenarioData.description}</p>
                <p class="mt-2 font-bold">Your Task: Correct the errors in the presented claim details below.</p>
            `;
            presentedClaimOutput.textContent = `
Patient Notes: ${currentScrubberScenarioData.presentedClaim.notes}
Diagnosis: ${currentScrubberScenarioData.presentedClaim.diagnosis}
CPT Code(s): ${currentScrubberScenarioData.presentedClaim.cpt}
Modifier(s): ${currentScrubberScenarioData.presentedClaim.modifier}
            `.trim();
            
            resetScrubberInputsAndFeedback(); // Reset inputs and feedback
            checkScrubberBtn.classList.remove('hidden');
            resetScrubberBtn.classList.remove('hidden');
        });

        checkScrubberBtn.addEventListener('click', () => {
            if (!currentScrubberScenarioData) {
                scrubberFeedback.innerHTML = '<p class="text-red-700 scrubber-feedback-text">Please load a scenario first!</p>';
                return;
            }

            const userICD = userScrubberICDInput.value.trim().toUpperCase();
            const userCPT = userScrubberCPTInput.value.trim().toUpperCase();
            const userModifier = userScrubberModifierInput.value.trim().toUpperCase();

            let feedbackHtml = '';
            let allCorrect = true;

            // Helper to compare inputs, treating "NONE" or empty as the same for modifiers
            const compareInput = (userInput, expectedValue) => {
                if (expectedValue.toLowerCase() === 'none' || expectedValue.toLowerCase() === '') {
                    return userInput === '' || userInput.toLowerCase() === 'none';
                }
                // For ICDs, allow comma-separated and check if all expected are present.
                if (expectedValue.includes(',')) {
                    const expectedParts = expectedValue.split(',').map(p => p.trim());
                    const userParts = userInput.split(',').map(p => p.trim());
                    // Check if all expected parts are in user's input, regardless of order
                    const allExpectedFound = expectedParts.every(part => userParts.includes(part));
                    // Check if user didn't add extra unexpected parts
                    const noExtraParts = userParts.every(part => expectedParts.includes(part));
                    return allExpectedFound && noExtraParts;
                }
                return userInput === expectedValue;
            };

            // Check ICD
            if (!compareInput(userICD, currentScrubberScenarioData.expectedInputs.correctedICD.toUpperCase())) {
                const error = currentScrubberScenarioData.errors.find(e => e.type === 'diagnosis' || e.type === 'diagnosis-medical-necessity');
                feedbackHtml += `<p class="text-red-700">ICD-10 Code: Incorrect. Expected "${currentScrubberScenarioData.expectedInputs.correctedICD}".</p>`;
                if (error) feedbackHtml += `<p class="text-gray-700 text-sm mt-1">${error.explanation}</p>`;
                allCorrect = false;
            } else {
                feedbackHtml += `<p class="text-green-700">ICD-10 Code: Correct! ("${currentScrubberScenarioData.expectedInputs.correctedICD}")</p>`;
            }

            // Check CPT
            if (!compareInput(userCPT, currentScrubberScenarioData.expectedInputs.correctedCPT.toUpperCase())) {
                const error = currentScrubberScenarioData.errors.find(e => e.type === 'cpt');
                feedbackHtml += `<p class="text-red-700">CPT Code: Incorrect. Expected "${currentScrubberScenarioData.expectedInputs.correctedCPT}".</p>`;
                if (error) feedbackHtml += `<p class="text-gray-700 text-sm mt-1">${error.explanation}</p>`;
                allCorrect = false;
            } else {
                feedbackHtml += `<p class="text-green-700">CPT Code: Correct! ("${currentScrubberScenarioData.expectedInputs.correctedCPT}")</p>`;
            }

            // Check Modifier
            if (!compareInput(userModifier, currentScrubberScenarioData.expectedInputs.correctedModifier.toUpperCase())) {
                const error = currentScrubberScenarioData.errors.find(e => e.type === 'modifier');
                 feedbackHtml += `<p class="text-red-700">Modifier(s): Incorrect. Expected "${currentScrubberScenarioData.expectedInputs.correctedModifier}".</p>`;
                 if (error) feedbackHtml += `<p class="text-gray-700 text-sm mt-1">${error.explanation}</p`;
                 allCorrect = false;
            } else {
                feedbackHtml += `<p class="text-green-700">Modifier(s): Correct! ("${currentScrubberScenarioData.expectedInputs.correctedModifier}")</p>`;
            }

            if (allCorrect) {
                scrubberFeedback.innerHTML = `<p class="text-green-700 font-bold">Excellent! You found and corrected all errors in this claim.</p>`;
                scrubberFeedback.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
            } else {
                // If there were specific error explanations, they are already added to feedbackHtml
                scrubberFeedback.innerHTML = `<p class="text-red-700 font-bold">Not quite right. Review the feedback:</p>` + feedbackHtml;
                scrubberFeedback.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
            }
        });

        resetScrubberBtn.addEventListener('click', resetScrubberInputsAndFeedback);

        function resetScrubberInputsAndFeedback() {
            userScrubberICDInput.value = '';
            userScrubberCPTInput.value = '';
            userScrubberModifierInput.value = '';
            scrubberFeedback.innerHTML = '<p class="text-gray-500 scrubber-feedback-text">Feedback on your corrections will appear here.</p>';
            scrubberFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
        }

        // --- Denial Code Interpreter Logic ---
        let currentDenialScenarioData = null;

        loadDenialScenarioBtn.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * denialScenarios.length);
            currentDenialScenarioData = denialScenarios[randomIndex];
            
            denialChallengeContent.classList.remove('hidden');
            denialScenarioTitle.textContent = `Denial Challenge: ${currentDenialScenarioData.denialCode}`;
            denialScenarioDetails.innerHTML = `<p class="text-sm text-purple-800 italic">Context: ${currentDenialScenarioData.context}</p>
            `;
            
            denialInterpretationOptions.innerHTML = ''; // Clear previous options
            currentDenialScenarioData.interpretations.forEach((interpretation, index) => {
                const label = document.createElement('label');
                label.className = 'denial-option';
                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'denialInterpretation';
                input.id = `denialOption${index}`; // Add unique ID for the radio button
                input.value = index; // Use index to map back to the interpretation object
                label.setAttribute('for', `denialOption${index}`); // Link label to input via 'for'
                label.appendChild(input);
                label.appendChild(document.createTextNode(interpretation.text));
                denialInterpretationOptions.appendChild(label);
            });

            resetDenialInputsAndFeedback();
            checkDenialBtn.classList.remove('hidden');
            resetDenialBtn.classList.remove('hidden');
        });

        checkDenialBtn.addEventListener('click', () => {
            if (!currentDenialScenarioData) {
                denialFeedback.innerHTML = '<p class="text-red-700 denial-feedback-text">Please load a scenario first!</p>';
                return;
            }

            const selectedInterpretationOption = document.querySelector('input[name="denialInterpretation"]:checked');
            const userActionPlan = userActionPlanInput.value.trim().toUpperCase();

            let feedbackHtml = '';
            let allCorrect = true;

            // Check Interpretation
            if (!selectedInterpretationOption) {
                feedbackHtml += `<p class="text-red-700">Interpretation: Please select an interpretation.</p>`;
                allCorrect = false;
            } else {
                const selectedInterpretationIndex = parseInt(selectedInterpretationOption.value);
                const isInterpretationCorrect = currentDenialScenarioData.interpretations[selectedInterpretationIndex].correct;
                
                if (isInterpretationCorrect) {
                    feedbackHtml += `<p class="text-green-700">Interpretation: Correct! ("${currentDenialScenarioData.interpretations[selectedInterpretationIndex].text}")</p>`;
                } else {
                    const correctText = currentDenialScenarioData.interpretations.find(i => i.correct).text;
                    feedbackHtml += `<p class="text-red-700">Interpretation: Incorrect. The correct interpretation is: "${correctText}".</p>`;
                    allCorrect = false;
                }
            }

            // Check Action Plan (using keywords)
            const correctActionKeywords = currentDenialScenarioData.correctActionPlanKeywords.map(k => k.toUpperCase());
            const userActionWords = userActionPlan.split(/\s|,\s*/).filter(word => word !== '').map(word => word.toUpperCase());
            
            let actionPlanCorrect = true;
            let missingKeywords = [];
            let extraKeywords = [];

            correctActionKeywords.forEach(keyword => {
                if (!userActionWords.includes(keyword)) {
                    missingKeywords.push(keyword);
                    actionPlanCorrect = false;
                }
            });

            // Check for extraneous words that are not expected for a perfectly correct answer
            userActionWords.forEach(word => {
                if (!correctActionKeywords.includes(word)) {
                    extraKeywords.push(word);
                }
            });

            if (actionPlanCorrect && extraKeywords.length === 0) { // All correct keywords present, no extra unexpected ones
                feedbackHtml += `<p class="text-green-700 mt-2">Action Plan: Well done! Your action plan is comprehensive.</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700 mt-2">Action Plan: Review your action plan.</p>`;
                if (missingKeywords.length > 0) {
                    feedbackHtml += `<p class="text-red-700 text-sm">Missing key elements: ${missingKeywords.join(', ')}.</p>`;
                }
                if (extraKeywords.length > 0) {
                    feedbackHtml += `<p class="text-red-700 text-sm">You included some unexpected elements: ${extraKeywords.join(', ')}.</p>`;
                }
                allCorrect = false;
            }

            // Overall feedback
            if (allCorrect) {
                denialFeedback.innerHTML = `<p class="text-green-700 font-bold">Excellent! You correctly interpreted the denial and formulated the ideal action plan.</p>`;
                denialFeedback.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
            } else {
                denialFeedback.innerHTML = `<p class="text-red-700 font-bold">Not quite perfect. Review the feedback and explanation:</p>` + feedbackHtml;
                denialFeedback.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
            }
            denialFeedback.innerHTML += `<p class="text-gray-700 mt-4 font-bold">Detailed Explanation for Resolution:</p><p class="denial-feedback-text">${currentDenialScenarioData.explanation}</p>`;

            // Disable inputs after checking
            denialInterpretationOptions.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = true);
            userActionPlanInput.disabled = true;
        });

        resetDenialBtn.addEventListener('click', resetDenialInputsAndFeedback);

        function resetDenialInputsAndFeedback() {
            denialInterpretationOptions.innerHTML = '<p class="text-gray-500 denial-scenario-text">Select an interpretation.</p>'; // Reset radio buttons
            userActionPlanInput.value = '';
            userActionPlanInput.disabled = false;
            denialInterpretationOptions.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = false);
            denialFeedback.innerHTML = '<p class="text-gray-500 denial-feedback-text">Feedback on your denial resolution plan will appear here.</p>';
            denialFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
        }

        // --- SOAP Note Coder & Extractor Logic ---
        // currentSoapScenarioData is already declared globally, no 'let' here.
        let currentSoapScenarioData = null;

        loadSoapScenarioBtn.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * soapNoteScenarios.length);
            currentSoapScenarioData = soapNoteScenarios[randomIndex];
            
            soapChallengeContent.classList.remove('hidden');
            soapScenarioTitle.textContent = `SOAP Note Challenge: ${currentSoapScenarioData.title}`;
            soapScenarioDescription.textContent = currentSoapScenarioData.description;
            soapNoteDisplay.textContent = currentSoapScenarioData.soapNote;
            
            resetSoapInputsAndFeedback();
            checkSoapBtn.classList.remove('hidden');
            resetSoapBtn.classList.remove('hidden');
        });

        checkSoapBtn.addEventListener('click', () => {
            if (!currentSoapScenarioData) {
                soapFeedback.innerHTML = '<p class="text-red-700 soap-feedback-text">Please load a scenario first!</p>';
                return;
            }

            const userChiefComplaint = userSoapChiefComplaintInput.value.trim();
            const userICD = userSoapICDInput.value.trim().toUpperCase().split(',').map(s => s.trim()).filter(s => s !== '');
            const userCPT = userSoapCPTInput.value.trim().toUpperCase().split(',').map(s => s.trim()).filter(s => s !== '');
            const userModifier = userSoapModifierInput.value.trim().toUpperCase();
            const userPlan = userSoapPlanInput.value.trim().toUpperCase();

            let feedbackHtml = '';
            let allCorrect = true;

            // Helper to compare arrays of codes, ignoring order
            const compareCodeArrays = (userArray, expectedArray) => {
                if (userArray.length !== expectedArray.length) return false;
                const sortedUser = [...userArray].sort();
                const sortedExpected = [...expectedArray].sort();
                for (let i = 0; i < sortedUser.length; i++) {
                    if (sortedUser[i] !== sortedExpected[i]) return false;
                }
                return true;
            };

            // Check Chief Complaint
            if (userChiefComplaint.toLowerCase() === currentSoapScenarioData.expected.chiefComplaint.toLowerCase()) {
                feedbackHtml += `<p class="text-green-700">Chief Complaint: Correct! ("${currentSoapScenarioData.expected.chiefComplaint}")</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Chief Complaint: Incorrect. Expected: "${currentSoapScenarioData.expected.chiefComplaint}".</p>`;
                allCorrect = false;
            }

            // Check Primary ICD-10
            const expectedICD = currentSoapScenarioData.expected.icd10.split(',').map(s => s.trim().toUpperCase());
            if (compareCodeArrays(userICD, expectedICD)) {
                feedbackHtml += `<p class="text-green-700">Primary ICD-10 Code(s): Correct! ("${currentSoapScenarioData.expected.icd10}")</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Primary ICD-10 Code(s): Incorrect. Expected: "${currentSoapScenarioData.expected.icd10}".</p>`;
                allCorrect = false;
            }

            // Check Primary CPT
            const expectedCPT = currentSoapScenarioData.expected.cpt.split(',').map(s => s.trim().toUpperCase());
            if (compareCodeArrays(userCPT, expectedCPT)) {
                feedbackHtml += `<p class="text-green-700">Primary CPT Code(s): Correct! ("${currentSoapScenarioData.expected.cpt}")</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Primary CPT Code(s): Incorrect. Expected: "${currentSoapScenarioData.expected.cpt}".</p>`;
                allCorrect = false;
            }

            // Check Modifier
            const expectedModifier = currentSoapScenarioData.expected.modifier.toUpperCase();
            const userModNormalized = (userSoapModifierInput.value.trim().toUpperCase() === 'NONE' || userSoapModifierInput.value.trim() === '') ? 'NONE' : userSoapModifierInput.value.trim().toUpperCase();

            if (userModNormalized === expectedModifier) {
                feedbackHtml += `<p class="text-green-700">Modifier(s): Correct! ("${expectedModifier}")</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Modifier(s): Incorrect. Expected: "${expectedModifier}".</p>`;
                allCorrect = false;
            }

            // Check Key Plan Elements (using keywords)
            const expectedPlanKeywords = currentSoapScenarioData.expected.planKeywords.map(k => k.toUpperCase());
            const userPlanWords = userPlan.split(/\s|,\s*|\.\s*|;\s*/).filter(word => word !== '').map(word => word.toUpperCase());
            
            let planCorrect = true;
            let missingPlanKeywords = [];
            let extraPlanKeywords = [];

            expectedPlanKeywords.forEach(keyword => {
                if (!userPlanWords.some(word => word.includes(keyword))) { // Check if any user word contains the keyword
                    missingPlanKeywords.push(keyword);
                    planCorrect = false;
                }
            });

            userPlanWords.forEach(word => {
                 // Check if the user's word is not directly one of the expected keywords AND doesn't contain an expected keyword
                if (!expectedPlanKeywords.includes(word) && !expectedPlanKeywords.some(kw => word.includes(kw))) {
                    extraPlanKeywords.push(word);
                }
            });

            if (planCorrect && extraPlanKeywords.length === 0) {
                feedbackHtml += `<p class="text-green-700 mt-2">Key Plan Elements: Well done! Your summary covers the main points.</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700 mt-2">Key Plan Elements: Review your plan summary.</p>`;
                if (missingPlanKeywords.length > 0) {
                    feedbackHtml += `<p class="text-red-700 text-sm">Missing key elements: ${missingPlanKeywords.join(', ')}.</p>`;
                }
                if (extraPlanKeywords.length > 0) {
                    feedbackHtml += `<p class="text-red-700 text-sm">You included some unexpected elements: ${extraKeywords.join(', ')}.</p>`;
                }
                allCorrect = false;
            }

            // Overall feedback
            if (allCorrect) {
                soapFeedback.innerHTML = `<p class="text-green-700 font-bold">Excellent! You correctly extracted all key information from the SOAP note.</p>`;
                soapFeedback.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
            } else {
                soapFeedback.innerHTML = `<p class="text-red-700 font-bold">Not quite perfect. Review the feedback and explanation:</p>` + feedbackHtml;
                soapFeedback.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
            }
            soapFeedback.innerHTML += `<p class="text-gray-700 mt-4 font-bold">Detailed Explanation:</p><p class="soap-feedback-text">${currentSoapScenarioData.explanation}</p>`;

            // Disable inputs after checking
            userSoapChiefComplaintInput.disabled = true;
            userSoapICDInput.disabled = true;
            userSoapCPTInput.disabled = true;
            userSoapModifierInput.disabled = true;
            userSoapPlanInput.disabled = true;
        });

        resetSoapBtn.addEventListener('click', resetSoapInputsAndFeedback);

        function resetSoapInputsAndFeedback() {
            userSoapChiefComplaintInput.value = '';
            userSoapICDInput.value = '';
            userSoapCPTInput.value = '';
            userSoapModifierInput.value = '';
            userSoapPlanInput.value = '';
            userSoapChiefComplaintInput.disabled = false;
            userSoapICDInput.disabled = false;
            userSoapCPTInput.disabled = false;
            userSoapModifierInput.disabled = false;
            userSoapPlanInput.disabled = false;
            soapFeedback.innerHTML = '<p class="text-gray-500 soap-feedback-text">Feedback on your extraction will appear here.</p>';
            soapFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
        }

        // --- Code Lookup Tool Logic ---
        lookupCodeBtn.addEventListener('click', () => {
            const code = codeLookupInput.value.trim().toUpperCase();
            if (code === '') {
                codeLookupResult.innerHTML = '<p class="text-red-700">Please enter a code to look up.</p>';
                codeLookupResult.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
                return;
            }

            const description = codeDatabase[code];
            if (description) {
                codeLookupResult.innerHTML = `<p class="text-green-700 font-bold">Code found:</p><p class="code-lookup-text">${code}: ${description}</p>`;
                codeLookupResult.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
            } else {
                codeLookupResult.innerHTML = `<p class="text-red-700 font-bold">Code not found.</p><p class="code-lookup-text">"${code}" is not in our current database. Please try another common ICD-10 or CPT code (e.g., J02.0, 99213).</p>`;
                codeLookupResult.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
            }
        });

        // --- NEW: A/R Aging Simulation Logic ---
        loadArScenarioBtn.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * arAgingScenarios.length);
            currentArScenarioClaims = arAgingScenarios[randomIndex].claims;
            
            arAgingContent.classList.remove('hidden');
            arClaimList.innerHTML = ''; // Clear previous claims

            currentArScenarioClaims.forEach((claim, index) => {
                const claimDiv = document.createElement('div');
                claimDiv.classList.add('ar-claim-item');
                claimDiv.dataset.index = index; // Store index for easy lookup

                claimDiv.innerHTML = `
                    <h3 class="font-semibold text-gray-800">Claim ID: ${claim.claimId}</h3>
                    <div class="ar-claim-details">
                        <p><strong>Patient:</strong> ${claim.patient}</p>
                        <p><strong>Payer:</strong> ${claim.payer}</p>
                        <p><strong>Amount:</strong> $${claim.amount.toFixed(2)}</p>
                        <p><strong>Days Old:</strong> ${claim.daysOld}</p>
                    </div>
                    <label for="arAction-${index}" class="block text-gray-700 text-sm font-bold mb-2">Your Action:</label>
                    <select id="arAction-${index}" name="arAction-${index}" class="ar-action-select focus:ring-red-500 focus:border-red-500 w-full">
                        <option value="">-- Select Action --</option>
                        <option value="check_status_online">Check claim status online (payer portal).</option>
                        <option value="call_payer">Call payer (provider services) for status/details.</option>
                        <option value="review_eob_era">Review EOB/ERA for denial reason/details.</option>
                        <option value="submit_appeal">Submit an appeal with supporting documentation.</option>
                        <option value="correct_resubmit">Correct simple errors and resubmit claim.</option>
                        <option value="bill_patient">Bill patient (if patient responsibility is indicated).</option>
                        <option value="write_off">Write off balance (e.g., timely filing, contractual adjustment).</option>
                        <option value="monitor_further">Monitor further, still within initial processing time.</option>
                    </select>
                    <div id="arFeedback-${index}" class="ar-claim-feedback hidden"></div>
                `;
                arClaimList.appendChild(claimDiv);
            });

            arFeedback.innerHTML = '<p class="text-gray-500">Feedback on your A/R actions will appear here.</p>';
            arFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]';
            checkArActionsBtn.classList.remove('hidden');
            resetArScenarioBtn.classList.remove('hidden');
        });

        checkArActionsBtn.addEventListener('click', () => {
            let allCorrect = true;
            currentArScenarioClaims.forEach((claim, index) => {
                const selectElement = document.getElementById(`arAction-${index}`);
                const userAction = selectElement.value;
                const feedbackDiv = document.getElementById(`arFeedback-${index}`);
                
                let isClaimCorrect = false;
                // Determine correctness based on daysOld and user selection
                if (claim.daysOld <= 30 && userAction === "monitor_further") {
                    isClaimCorrect = true;
                } else if (claim.daysOld > 30 && claim.daysOld <= 60 && (userAction === "check_status_online" || userAction === "call_payer")) {
                    isClaimCorrect = true;
                } else if (claim.daysOld > 60 && claim.daysOld <= 90 && (userAction === "call_payer" || userAction === "review_eob_era" || userAction === "submit_appeal" || userAction === "correct_resubmit")) {
                     isClaimCorrect = true;
                } else if (claim.daysOld > 90 && (userAction === "review_eob_era" || userAction === "submit_appeal" || userAction === "correct_resubmit" || userAction === "write_off")) {
                    isClaimCorrect = true;
                }
                // Specific conditions override general if applicable (e.g., patient billing or write-off)
                // This block adds flexibility to the logic, allowing for *any* correct action based on the specific claim's correctAction string
                if (claim.correctAction.includes("Bill patient") && userAction === "bill_patient") {
                    isClaimCorrect = true;
                }
                if (claim.correctAction.includes("Write off") && userAction === "write_off") {
                    isClaimCorrect = true;
                }
                if (claim.correctAction.includes("Check claim status online") && userAction === "check_status_online") {
                    isClaimCorrect = true;
                }
                if (claim.correctAction.includes("Call payer") && userAction === "call_payer") {
                    isClaimCorrect = true;
                }
                if (claim.correctAction.includes("Review EOB/ERA") && userAction === "review_eob_era") {
                    isClaimCorrect = true;
                }
                if (claim.correctAction.includes("Submit an appeal") && userAction === "submit_appeal") {
                    isClaimCorrect = true;
                }
                if (claim.correctAction.includes("Correct simple errors") && userAction === "correct_resubmit") {
                    isClaimCorrect = true;
                }
                if (claim.correctAction.includes("Monitor claim status") && userAction === "monitor_further") {
                    isClaimCorrect = true;
                }


                feedbackDiv.classList.remove('hidden');
                if (isClaimCorrect) {
                    feedbackDiv.classList.add('correct');
                    feedbackDiv.classList.remove('incorrect');
                    feedbackDiv.innerHTML = `<p>Correct Action: ${claim.correctAction}</p><p class="mt-1 text-xs">(${claim.explanation})</p>`;
                } else {
                    feedbackDiv.classList.add('incorrect');
                    feedbackDiv.classList.remove('correct');
                    feedbackDiv.innerHTML = `<p>Incorrect. Expected action: ${claim.correctAction}</p><p class="mt-1 text-xs">(${claim.explanation})</p>`;
                    allCorrect = false;
                }
                selectElement.disabled = true; // Disable selection after checking
            });

            if (allCorrect) {
                arFeedback.innerHTML = '<p class="text-green-700 font-bold">Excellent! You correctly identified the best action for all aging claims.</p>';
                arFeedback.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
            } else {
                arFeedback.innerHTML = '<p class="text-red-700 font-bold">Review the feedback for each claim. Some actions were not ideal.</p>';
                arFeedback.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
            }
        });

        resetArScenarioBtn.addEventListener('click', () => {
            arAgingContent.classList.add('hidden');
            loadArScenarioBtn.classList.remove('hidden');
            arClaimList.innerHTML = '';
            arFeedback.innerHTML = '<p class="text-gray-500">Feedback on your A/R actions will appear here.</p>';
            arFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]';
            resetArScenarioBtn.classList.add('hidden');
            checkArActionsBtn.classList.add('hidden');
            showMessage('A/R Aging Scenario Reset.', 'success');
        });

    </script>
</body>
</html>
