<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EHR Simulator for Medical Billing Practice</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }
        input[type="text"], input[type="date"], input[type="number"], textarea, select {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
            padding: 8px 14px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.875rem; /* text-sm */
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .message-box {
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
            display: none; /* Hidden by default */
        }
        .message-box.success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .message-box.error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .flex-grow-1 { /* Custom utility to make item grow */
            flex-grow: 1;
        }
        .hidden {
            display: none;
        }
        .walkthrough-step-content, .quiz-content, .balance-calculator-content, .modifier-challenge-content, .matching-game-content, .scrubber-challenge-content, .denial-challenge-content, .soap-challenge-content, .code-lookup-content, .ar-aging-content, .form-repository-content {
            background-color: #f8fafc; /* bg-blue-50 alternative */
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0; /* border-gray-200 alternative */
            margin-top: 1rem;
        }
        .walkthrough-step-title, .quiz-question-title, .balance-scenario-title, .modifier-challenge-title, .matching-game-title, .scrubber-challenge-title, .denial-challenge-title, .soap-challenge-title, .code-lookup-title, .ar-aging-title, .form-repository-title {
            font-weight: 600; /* font-semibold */
            color: #1a202c; /* text-gray-900 */
            margin-bottom: 0.5rem;
        }
        .walkthrough-instructions, .quiz-instructions, .quiz-feedback-text, .balance-scenario-text, .balance-feedback-text, .modifier-scenario-text, .modifier-feedback-text, .matching-game-text, .scrubber-scenario-text, .scrubber-feedback-text, .denial-scenario-text, .denial-feedback-text, .soap-scenario-text, .soap-feedback-text, .code-lookup-text, .ar-aging-text, .form-repository-text {
            font-size: 0.875rem; /* text-sm */
            color: #4a5568; /* text-gray-700 */
        }
        .quiz-option, .denial-option {
            display: block;
            padding: 8px 0;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 4px;
        }
        .quiz-option:hover, .denial-option:hover {
            background-color: #f0f4f8;
        }
        .quiz-option input[type="radio"], .denial-option input[type="radio"] {
            margin-right: 8px;
        }
        .match-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* Responsive grid */
            gap: 10px;
            margin-top: 20px;
        }
        .match-card {
            background-color: #cbd5e0; /* gray-300 */
            border-radius: 8px;
            padding: 15px;
            height: 120px; /* Fixed height for consistency */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: 600;
            color: #2d3748; /* gray-800 */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
            transform-style: preserve-3d;
            position: relative;
        }
        .match-card.flipped {
            background-color: #fff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .match-card.matched {
            background-color: #a7f3d0; /* green-200 */
            color: #065f46; /* green-800 */
            cursor: default;
            pointer-events: none; /* Disable clicks on matched cards */
        }
        .match-card.incorrect {
            background-color: #fca5a5; /* red-300 */
            color: #991b1b; /* red-800 */
        }
        .card-inner {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            backface-visibility: hidden;
            position: absolute;
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            backface-visibility: hidden;
            border-radius: 8px;
            padding: 15px;
            box-sizing: border-box;
            font-size: 0.9em;
        }
        .card-front {
            background-color: #cbd5e0; /* gray-300 */
            color: #2d3748; /* gray-800 */
            font-weight: 600;
        }
        .card-back {
            background-color: #fff;
            color: #2d3748;
            transform: rotateY(180deg);
        }
        .match-card.is-flipped .card-front {
            transform: rotateY(180deg);
        }
        .match-card.is-flipped .card-back {
            transform: rotateY(360deg);
        }
        #soapNoteDisplay {
            background-color: #f0f4f8; /* Light blue-gray */
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 15px;
            white-space: pre-wrap; /* Preserves formatting */
            font-family: monospace; /* Monospace for code-like text */
            font-size: 0.85rem;
            max-height: 400px; /* Limit height */
            overflow-y: auto; /* Enable scrolling */
            margin-bottom: 20px;
        }
        .ar-claim-item {
            background-color: #f0f4f8;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .ar-claim-details {
            font-size: 0.9rem;
            color: #4a5568;
            margin-bottom: 10px;
        }
        .ar-claim-feedback {
            margin-top: 10px;
            padding: 8px;
            border-radius: 6px;
            font-weight: 500;
        }
        .ar-claim-feedback.correct {
            background-color: #d1fae5;
            color: #065f46;
        }
        .ar-claim-feedback.incorrect {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .form-item {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        .form-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container">
        <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-8">EHR Practice System</h1>

        <!-- Message Box for user feedback -->
        <div id="messageBox" class="message-box"></div>

        <!-- Patient Registration Section -->
        <section class="mb-8 p-6 bg-blue-50 rounded-lg">
            <h2 class="section-title text-blue-800">1. Patient Registration üìù</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="patientName" class="block text-gray-700 text-sm font-bold mb-2">Patient Name:</label>
                    <input type="text" id="patientName" name="patientName" placeholder="John Doe" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="patientDOB" class="block text-gray-700 text-sm font-bold mb-2">Date of Birth:</label>
                    <input type="date" id="patientDOB" name="patientDOB" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label for="insuranceID" class="block text-gray-700 text-sm font-bold mb-2">Insurance ID:</label>
                    <input type="text" id="insuranceID" name="insuranceID" placeholder="ABC123456789" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <button id="registerPatientBtn" class="btn-primary w-full">Register Patient</button>
        </section>

        <!-- Encounter Documentation Section -->
        <section class="mb-8 p-6 bg-green-50 rounded-lg">
            <h2 class="section-title text-green-800">2. Encounter Documentation ü©∫</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="encounterDate" class="block text-gray-700 text-sm font-bold mb-2">Encounter Date:</label>
                    <input type="date" id="encounterDate" name="encounterDate" class="focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="md:col-span-2">
                    <label for="chiefComplaint" class="block text-gray-700 text-sm font-bold mb-2">Chief Complaint:</label>
                    <input type="text" id="chiefComplaint" name="chiefComplaint" placeholder="Patient reports sore throat and fever" class="focus:ring-green-500 focus:border-green-500">
                </div>
            </div>

            <div id="diagnosisList" class="mb-4 space-y-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Diagnoses (ICD Codes):</label>
                <div class="flex items-center gap-2">
                    <input type="text" class="diagnosis-code flex-grow-1 focus:ring-green-500 focus:border-green-500" name="diagnosisCode" placeholder="e.g., J02.9 (Acute pharyngitis)">
                    <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                </div>
            </div>
            <button id="addDiagnosisBtn" class="btn-primary mb-6 w-full bg-green-600 hover:bg-green-700">Add Another Diagnosis</button>

            <div id="procedureList" class="mb-4 space-y-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Procedures (CPT/HCPCS Codes):</label>
                <div class="flex items-center gap-2">
                    <input type="text" class="procedure-code flex-grow-1 focus:ring-green-500 focus:border-green-500" name="procedureCode" placeholder="e.g., 99213 (Office visit)">
                    <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                </div>
            </div>
            <button id="addProcedureBtn" class="btn-primary w-full bg-green-600 hover:bg-green-700">Add Another Procedure</button>
        </section>

        <!-- Charge Entry Section -->
        <section class="mb-8 p-6 bg-purple-50 rounded-lg">
            <h2 class="section-title text-purple-800">3. Charge Entry & Services üí≤</h2>
            <div id="chargeList" class="mb-4 space-y-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Services Rendered:</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 service-item">
                    <input type="text" class="service-description col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500" name="serviceDescription" placeholder="Service Description">
                    <input type="text" class="service-cpt-code col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500" name="serviceCptCode" placeholder="CPT Code">
                    <div class="flex gap-2 col-span-1 md:col-span-1">
                        <input type="number" class="service-price flex-grow-1 focus:ring-purple-500 focus:border-purple-500" name="servicePrice" placeholder="Price ($)" min="0" step="0.01">
                        <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                    </div>
                </div>
            </div>
            <button id="addChargeBtn" class="btn-primary w-full bg-purple-600 hover:bg-purple-700">Add Another Service</button>
        </section>

        <!-- Generate Claim Section -->
        <section class="p-6 bg-red-50 rounded-lg mb-8">
            <h2 class="section-title text-red-800">4. Generate & View Claim üìÑ</h2>
            <button id="generateClaimBtn" class="btn-primary w-full mb-6 bg-red-600 hover:bg-red-700">Generate Simulated Claim</button>

            <div id="claimOutput" class="bg-gray-50 p-4 border border-gray-200 rounded-lg min-h-[150px] overflow-auto text-sm text-gray-800 whitespace-pre-wrap">
                <!-- Claim data will appear here -->
                <p class="text-gray-500">Your simulated claim details will appear here after generation.</p>
            </div>
            <button id="clearAllBtn" class="btn-secondary w-full mt-4">Clear All Data</button>
        </section>

        <!-- Medical Billing Walkthrough Section -->
        <section class="p-6 bg-indigo-50 rounded-lg mb-8">
            <h2 class="section-title text-indigo-800">5. Medical Billing Process Walkthrough üö∂‚Äç‚ôÄÔ∏è</h2>
            <p class="text-gray-700 mb-4">Click "Start Step" or "Next Step" to walk through the revenue cycle.</p>

            <div id="billingWalkthroughContent" class="hidden">
                <h3 id="walkthroughStepTitle" class="walkthrough-step-title text-indigo-700"></h3>
                <div id="walkthroughStepInstructions" class="walkthrough-instructions"></div>
            </div>
           
            <button id="startBillingWalkthroughBtn" class="btn-primary w-full mb-4 bg-indigo-600 hover:bg-indigo-700">Start Billing Walkthrough</button>
            <button id="nextBillingWalkthroughBtn" class="btn-primary w-full mb-4 bg-indigo-600 hover:bg-indigo-700 hidden">Next Step</button>
            <button id="resetBillingWalkthroughBtn" class="btn-secondary w-full hidden">Reset Walkthrough</button>
        </section>

        <!-- Prior Authorization Walkthrough Section -->
        <section class="p-6 bg-orange-50 rounded-lg mb-8">
            <h2 class="section-title text-orange-800">6. Prior Authorization (PA) Walkthrough üö¶</h2>
            <p class="text-gray-700 mb-4">Follow the steps to understand a PA scenario.</p>

            <div id="paWalkthroughContent" class="hidden">
                <h3 id="paWalkthroughStepTitle" class="walkthrough-step-title text-orange-700"></h3>
                <div id="paWalkthroughStepInstructions" class="walkthrough-instructions"></div>
            </div>
           
            <button id="startPaWalkthroughBtn" class="btn-primary w-full mb-4 bg-orange-600 hover:bg-orange-700">Start PA Walkthrough</button>
            <button id="nextPaWalkthroughBtn" class="btn-primary w-full mb-4 bg-orange-600 hover:bg-orange-700 hidden">Next Step</button>
            <button id="resetPaWalkthroughBtn" class="btn-secondary w-full hidden">Reset PA Walkthrough</button>
        </section>

        <!-- Knowledge Quizzes Section -->
        <section class="p-6 bg-pink-50 rounded-lg mb-8">
            <h2 class="section-title text-pink-800">7. Knowledge Quizzes! üìö</h2>
            <p class="text-gray-700 mb-4">Test your understanding of coding guidelines, healthcare laws, ethics, and denials & appeals!</p>

            <div class="flex flex-wrap gap-3 mb-6">
                <button id="quizGuidelinesBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Coding Guidelines</button>
                <button id="quizLawsBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Healthcare Laws</button>
                <button id="quizEthicsBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Coding Ethics</button>
                <button id="quizDenialsBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Denials & Appeals</button>
                <button id="quizInsuranceNuanceBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Insurance Nuances</button>
            </div>

            <div id="quizContent" class="quiz-content hidden">
                <h3 id="quizQuestionTitle" class="quiz-question-title text-pink-700"></h3>
                <div id="quizOptions" class="mb-4">
                    <!-- Options will be dynamically inserted here -->
                </div>
                
                <button id="submitAnswerBtn" class="btn-primary bg-pink-600 hover:bg-pink-700 mb-4">Submit Answer</button>
                <button id="nextQuestionBtn" class="btn-secondary hidden">Next Question</button>
                <button id="resetQuizBtn" class="btn-secondary hidden">Reset Quiz</button>

                <div id="quizFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 quiz-feedback-text">Your feedback will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Patient Balance Calculator Section -->
        <section class="p-6 bg-teal-50 rounded-lg mb-8">
            <h2 class="section-title text-teal-800">8. Patient Balance Calculator üí∞</h2>
            <p class="text-gray-700 mb-4">Practice calculating patient responsibility based on common scenarios.</p>

            <button id="loadBalanceScenarioBtn" class="btn-primary w-full mb-6 bg-teal-600 hover:bg-teal-700">Load New Scenario</button>

            <div id="balanceCalculatorContent" class="balance-calculator-content hidden">
                <h3 id="balanceScenarioTitle" class="balance-scenario-title text-teal-700"></h3>
                <div id="balanceScenarioDetails" class="balance-scenario-text mb-4"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="userCopay" class="block text-gray-700 text-sm font-bold mb-2">Your Calculated Copay ($):</label>
                        <input type="number" id="userCopay" name="userCopay" placeholder="0.00" min="0" step="0.01" class="focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="userDeductibleInput" class="block text-gray-700 text-sm font-bold mb-2">Your Calculated Deductible Applied ($):</label>
                        <input type="number" id="userDeductibleInput" name="userDeductibleInput" placeholder="0.00" min="0" step="0.01" class="focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="userCoinsurance" class="block text-gray-700 text-sm font-bold mb-2">Your Calculated Coinsurance ($):</label>
                        <input type="number" id="userCoinsurance" name="userCoinsurance" placeholder="0.00" min="0" step="0.01" class="focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="userTotalBalance" class="block text-gray-700 text-sm font-bold mb-2">Your Calculated Total Patient Balance ($):</label>
                        <input type="number" id="userTotalBalance" name="userTotalBalance" placeholder="0.00" min="0" step="0.01" class="font-bold focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                
                <button id="checkBalanceBtn" class="btn-primary bg-teal-600 hover:bg-teal-700 mb-4">Check My Calculation</button>
                <button id="resetBalanceBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="balanceFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 balance-feedback-text">Feedback on your calculation will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Advanced Modifier Application Challenge Section -->
        <section class="p-6 bg-yellow-50 rounded-lg mb-8">
            <h2 class="section-title text-yellow-800">9. Advanced Modifier Application Challenge üåü</h2>
            <p class="text-gray-700 mb-4">Analyze the scenario and apply the appropriate CPT code and modifier.</p>

            <button id="loadModifierScenarioBtn" class="btn-primary w-full mb-6 bg-yellow-600 hover:bg-yellow-700">Load New Scenario</button>

            <div id="modifierChallengeContent" class="modifier-challenge-content hidden">
                <h3 id="modifierScenarioTitle" class="modifier-challenge-title text-yellow-700"></h3>
                <div id="modifierScenarioDetails" class="modifier-scenario-text mb-4"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="userModifierCPT" class="block text-gray-700 text-sm font-bold mb-2">Your CPT Code:</label>
                        <input type="text" id="userModifierCPT" name="userModifierCPT" placeholder="e.g., 99213" class="focus:ring-yellow-500 focus:border-yellow-500 uppercase">
                    </div>
                    <div>
                        <label for="userModifier" class="block text-gray-700 text-sm font-bold mb-2">Your Modifier(s) (e.g., 25, 59):</label>
                        <input type="text" id="userModifier" name="userModifier" placeholder="e.g., 25" class="focus:ring-yellow-500 focus:border-yellow-500 uppercase">
                    </div>
                </div>
                
                <button id="checkModifierBtn" class="btn-primary bg-yellow-600 hover:bg-yellow-700 mb-4">Check My Modifier</button>
                <button id="resetModifierBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="modifierFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 modifier-feedback-text">Feedback on your modifier application will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Medical Terminology Matching Game -->
        <section class="p-6 bg-blue-50 rounded-lg mb-8">
            <h2 class="section-title text-blue-800">10. Medical Terminology Matching Game üß†</h2>
            <p class="text-gray-700 mb-4">Match the medical billing terms/acronyms with their correct definitions.</p>

            <button id="startGameBtn" class="btn-primary w-full mb-6 bg-blue-600 hover:bg-blue-700">Start New Game</button>

            <div id="matchingGameContent" class="matching-game-content hidden">
                <p id="gameMessage" class="text-center text-lg font-bold mb-4"></p>
                <div id="cardGrid" class="match-card-grid">
                    <!-- Cards will be dynamically inserted here -->
                </div>
                <button id="resetGameBtn" class="btn-secondary w-full mt-6 hidden">Reset Game</button>
            </div>
        </section>

        <!-- Claim Scrubber / Error Finder Challenge Section -->
        <section class="p-6 bg-orange-100 rounded-lg mb-8">
            <h2 class="section-title text-orange-800">11. Claim Scrubber / Error Finder Challenge üîç</h2>
            <p class="text-gray-700 mb-4">Review the presented claim scenario and identify/correct the errors.</p>

            <button id="loadScrubberScenarioBtn" class="btn-primary w-full mb-6 bg-orange-600 hover:bg-orange-700">Load New Scenario</button>

            <div id="scrubberChallengeContent" class="scrubber-challenge-content hidden">
                <h3 id="scrubberScenarioTitle" class="scrubber-challenge-title text-orange-700"></h3>
                <div id="scrubberScenarioDetails" class="scrubber-scenario-text mb-4"></div>
                
                <p class="font-bold text-gray-700 mb-2">Presented Claim Details:</p>
                <pre id="presentedClaimOutput" class="bg-gray-50 p-3 rounded-lg border border-gray-200 text-sm whitespace-pre-wrap mb-4"></pre>

                <p class="font-bold text-gray-700 mb-2">Your Corrected Codes/Modifiers:</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="userScrubberICD" class="block text-gray-700 text-sm font-bold mb-2">Corrected ICD-10:</label>
                        <input type="text" id="userScrubberICD" name="userScrubberICD" placeholder="e.g., I10" class="focus:ring-orange-500 focus:border-orange-500 uppercase">
                    </div>
                    <div>
                        <label for="userScrubberCPT" class="block text-gray-700 text-sm font-bold mb-2">Corrected CPT:</label>
                        <input type="text" id="userScrubberCPT" name="userScrubberCPT" placeholder="e.g., 99213" class="focus:ring-orange-500 focus:border-orange-500 uppercase">
                    </div>
                    <div>
                        <label for="userScrubberModifier" class="block text-gray-700 text-sm font-bold mb-2">Corrected Modifier(s):</label>
                        <input type="text" id="userScrubberModifier" name="userScrubberModifier" placeholder="e.g., 25, 59 (or 'None')" class="focus:ring-orange-500 focus:border-orange-500 uppercase">
                    </div>
                </div>
                
                <button id="checkScrubberBtn" class="btn-primary bg-orange-600 hover:bg-orange-700 mb-4">Check My Corrections</button>
                <button id="resetScrubberBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="scrubberFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 scrubber-feedback-text">Feedback on your corrections will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Denial Code Interpreter & Action Plan Simulator Section -->
        <section class="p-6 bg-purple-100 rounded-lg mb-8">
            <h2 class="section-title text-purple-800">12. Denial Code Interpreter & Action Plan Simulator üö´</h2>
            <p class="text-gray-700 mb-4">Interpret the denial code and plan your next steps to resolve the claim.</p>

            <button id="loadDenialScenarioBtn" class="btn-primary w-full mb-6 bg-purple-600 hover:bg-purple-700">Load New Denial Scenario</button>

            <div id="denialChallengeContent" class="denial-challenge-content hidden">
                <h3 id="denialScenarioTitle" class="denial-challenge-title text-purple-700"></h3>
                <div id="denialScenarioDetails" class="denial-scenario-text mb-4"></div>
                
                <p class="font-bold text-gray-700 mb-2">Interpret the Denial Code:</p>
                <div id="denialInterpretationOptions" class="mb-4">
                    <!-- Options for interpretation will be dynamically inserted here -->
                </div>

                <p class="font-bold text-gray-700 mb-2">Your Action Plan (be specific):</p>
                <textarea id="userActionPlan" name="userActionPlan" rows="4" placeholder="e.g., Research payer policy, appeal with medical records, bill patient..." class="focus:ring-purple-500 focus:border-purple-500 mb-4"></textarea>
                
                <button id="checkDenialBtn" class="btn-primary bg-purple-600 hover:bg-purple-700 mb-4">Check My Plan</button>
                <button id="resetDenialBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="denialFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 denial-feedback-text">Feedback on your denial resolution plan will appear here.</p>
                </div>
            </div>
        </section>

        <!-- SOAP Note Coder & Extractor Challenge Section -->
        <section class="p-6 bg-teal-100 rounded-lg mb-8">
            <h2 class="section-title text-teal-800">13. SOAP Note Coder & Extractor Challenge üìã</h2>
            <p class="text-gray-700 mb-4">Review the SOAP note below and extract the relevant coding and plan information.</p>

            <button id="loadSoapScenarioBtn" class="btn-primary w-full mb-6 bg-teal-600 hover:bg-teal-700">Load New SOAP Note Scenario</button>

            <div id="soapChallengeContent" class="soap-challenge-content hidden">
                <h3 id="soapScenarioTitle" class="soap-challenge-title text-teal-700"></h3>
                <p id="soapScenarioDescription" class="soap-scenario-text mb-4"></p>
                
                <div id="soapNoteDisplay" class="mb-4">
                    <!-- SOAP note content will be loaded here -->
                </div>

                <p class="font-bold text-gray-700 mb-2">Your Extracted Information:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="md:col-span-2">
                        <label for="userSoapChiefComplaint" class="block text-gray-700 text-sm font-bold mb-2">Chief Complaint:</label>
                        <input type="text" id="userSoapChiefComplaint" name="userSoapChiefComplaint" placeholder="Patient's main reason for visit" class="focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="userSoapICD" class="block text-gray-700 text-sm font-bold mb-2">Primary ICD-10 Code(s):</label>
                        <input type="text" id="userSoapICD" name="userSoapICD" placeholder="e.g., J02.0 (comma-separated if multiple)" class="focus:ring-teal-500 focus:border-teal-500 uppercase">
                    </div>
                    <div>
                        <label for="userSoapCPT" class="block text-gray-700 text-sm font-bold mb-2">Primary CPT Code(s):</label>
                        <input type="text" id="userSoapCPT" name="userSoapCPT" placeholder="e.g., 99213, 87880 (comma-separated if multiple)" class="focus:ring-teal-500 focus:border-teal-500 uppercase">
                    </div>
                    <div class="md:col-span-2">
                        <label for="userSoapModifier" class="block text-gray-700 text-sm font-bold mb-2">Modifier(s) (if any):</label>
                        <input type="text" id="userSoapModifier" name="userSoapModifier" placeholder="e.g., 25 (or 'None')" class="focus:ring-teal-500 focus:border-teal-500 uppercase">
                    </div>
                    <div class="md:col-span-2">
                        <label for="userSoapPlan" class="block text-gray-700 text-sm font-bold mb-2">Key Elements of the Plan:</label>
                        <textarea id="userSoapPlan" name="userSoapPlan" rows="4" placeholder="Summarize medication, follow-up, education etc." class="focus:ring-teal-500 focus:border-teal-500"></textarea>
                    </div>
                </div>
                
                <button id="checkSoapBtn" class="btn-primary bg-teal-600 hover:bg-teal-700 mb-4">Check My Extraction</button>
                <button id="resetSoapBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="soapFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 soap-feedback-text">Feedback on your extraction will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Code Lookup Tool Section -->
        <section class="p-6 bg-yellow-100 rounded-lg mb-8">
            <h2 class="section-title text-yellow-800">14. Code Lookup Tool üìö</h2>
            <p class="text-gray-700 mb-4">Enter a code (e.g., J02.0, 99213, G0439) or a medical phrase (e.g., "headache", "diabetes type 2") to find descriptions.</p>

            <div id="codeLookupContent" class="code-lookup-content">
                <div class="mb-4">
                    <label for="codeLookupInput" class="block text-gray-700 text-sm font-bold mb-2">Search Code or Phrase:</label>
                    <input type="text" id="codeLookupInput" name="codeLookupInput" placeholder="Enter code or medical phrase" class="focus:ring-yellow-500 focus:border-yellow-500">
                </div>
                <button id="lookupCodeBtn" class="btn-primary w-full mb-4 bg-yellow-600 hover:bg-yellow-700">Lookup</button>
                <div id="codeLookupResult" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500">Code description(s) will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Accounts Receivable (A/R) Aging Simulation Section -->
        <section class="p-6 bg-red-100 rounded-lg mb-8">
            <h2 class="section-title text-red-800">15. Accounts Receivable (A/R) Aging Simulation üìà</h2>
            <p class="text-gray-700 mb-4">Practice analyzing aging claims and determining the correct follow-up action. Select an action for each claim.</p>

            <button id="loadArScenarioBtn" class="btn-primary w-full mb-6 bg-red-600 hover:bg-red-700">Load New A/R Scenario</button>

            <div id="arAgingContent" class="ar-aging-content hidden">
                <div id="arClaimList">
                    <!-- A/R claims will be dynamically inserted here -->
                </div>
                <button id="checkArActionsBtn" class="btn-primary w-full mt-4 bg-red-600 hover:bg-red-700">Check My Actions</button>
                <button id="resetArScenarioBtn" class="btn-secondary w-full mt-2 hidden">Reset A/R Scenario</button>
                <div id="arFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500">Feedback on your A/R actions will appear here.</p>
                </div>
            </div>
        </section>

        <!-- NEW: Medical Billing Form Repository Section -->
        <section class="p-6 bg-blue-100 rounded-lg mb-8">
            <h2 class="section-title text-blue-800">16. Medical Billing Form Repository üìÇ</h2>
            <p class="text-gray-700 mb-4">Explore descriptions of common forms used in medical billing and where to find their blank templates online for practice.</p>

            <div id="formRepositoryContent" class="form-repository-content">
                <div class="form-item">
                    <h3 class="form-repository-title text-blue-700">CMS-1500 Claim Form</h3>
                    <p class="form-repository-text">This is the universal claim form for professional (physician and non-institutional) services. It captures patient demographics, insurance information, diagnoses (ICD-10), procedures (CPT/HCPCS), and charges. It's the most common form you'll encounter for outpatient billing.</p>
                    <p class="form-repository-text mt-1 text-xs italic">You can find blank CMS-1500 templates by searching online for "CMS-1500 form fillable PDF" or "NUCC CMS-1500 form".</p>
                </div>
                <div class="form-item">
                    <h3 class="form-repository-title text-blue-700">UB-04 Claim Form (CMS-1450)</h3>
                    <p class="form-repository-text">This is the claim form used by institutional providers (like hospitals, skilled nursing facilities, ambulatory surgical centers) for inpatient and outpatient services. It captures facility charges, revenue codes, and patient stay details.</p>
                    <p class="form-repository-text mt-1 text-xs italic">You can find blank UB-04 templates by searching online for "UB-04 form fillable PDF" or "NUBC UB-04 form".</p>
                </div>
                <div class="form-item">
                    <h3 class="form-repository-title text-blue-700">Advance Beneficiary Notice of Noncoverage (ABN)</h3>
                    <p class="form-repository-text">A form given to Medicare beneficiaries when a service may not be covered by Medicare. It informs the patient they may be responsible for payment if Medicare denies the service, requiring their signature before service delivery. This protects the provider's right to bill the patient.</p>
                    <p class="form-repository-text mt-1 text-xs italic">You can find blank ABN forms (CMS-R-131) on the CMS website or by searching for "CMS ABN form".</p>
                </div>
                 <div class="form-item">
                    <h3 class="form-repository-title text-blue-700">Explanation of Benefits (EOB) / Electronic Remittance Advice (ERA)</h3>
                    <p class="form-repository-text">These are not "forms" you fill out, but rather documents generated by insurance companies. The EOB is sent to the patient and provider, detailing how a claim was processed (what was paid, denied, applied to deductible, etc.). The ERA is the electronic version sent to the provider, allowing for automated payment posting.</p>
                    <p class="form-repository-text mt-1 text-xs italic">Practice interpreting EOBs/ERAs by requesting sample EOBs from your insurance provider (if they offer them) or by searching online for "sample EOB Medicare" or "sample ERA medical billing".</p>
                </div>
            </div>
        </section>

    </div>

    <footer class="text-center text-gray-600 text-sm mt-10 pb-5">
        &copy; 2025 Chandra M Harris
    </footer>

    <script type="module">
        // Import the functions you need from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, addDoc, getDocs, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration (provided by Canvas environment)
        const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app;
        let db;
        let auth;
        let userId = null; // To store the user's UID or an anonymous ID

        // Function to show messages
        function showMessage(message, type = 'success') {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = `message-box ${type}`; // Reset classes and add new type
            messageBox.style.display = 'block'; // Make it visible
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }

        // Initialize Firebase ONLY if config is available
        if (firebaseConfig) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User signed in:", userId);
                    } else {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try {
                                const userCredential = await signInWithCustomToken(auth, __initial_auth_token);
                                userId = userCredential.user.uid;
                                console.log("Signed in with custom token:", userId);
                            } catch (error) {
                                console.error("Error signing in with custom token:", error);
                                try {
                                    const userCredential = await signInAnonymously(auth);
                                    userId = userCredential.user.uid;
                                    console.log("Signed in anonymously (fallback):", userId);
                                } catch (anonError) {
                                    console.error("Error signing in anonymously:", anonError);
                                    userId = crypto.randomUUID();
                                    console.warn("Could not authenticate, using random ID:", userId);
                                }
                            }
                        } else {
                            try {
                                const userCredential = await signInAnonymously(auth);
                                userId = userCredential.user.uid;
                                console.log("Signed in anonymously:", userId);
                            } catch (error) {
                                console.error("Error signing in anonymously:", error);
                                userId = crypto.randomUUID();
                                console.warn("Could not authenticate, using random ID:", userId);
                            }
                        }
                    }
                    console.log("Firebase Auth and Firestore services initialized. User ID:", userId);
                    // Load any saved patient data here after auth is ready
                    loadPatientData(); // Call a function to load data
                });
            } catch (error) {
                console.error("Error initializing Firebase App:", error);
                showMessage("Firebase initialization failed. Data saving/loading disabled.", "error");
                userId = crypto.randomUUID(); // Fallback userId for local operations
            }
        } else {
            console.warn("Firebase configuration not found. Firebase services will not be initialized.");
            userId = crypto.randomUUID(); // Fallback userId for local operations
            showMessage("Firebase services not available. Data will not be saved.", "error");
        }

        // --- GLOBAL DATA STORAGE (ENSURE THESE ARE ALWAYS AT THE TOP OF THE SCRIPT) ---
        // These global variables store data for various simulator sections.
        // They need to be defined before any functions or event listeners
        // that might try to access them upon script execution.

        // Global Data Storage (for existing simulation)
        let patientData = {}; // Will load from Firestore if available
        let diagnoses = [];
        let procedures = [];
        let charges = [];

        // Global Data Storage (Medical Billing Walkthrough)
        let currentBillingStep = 0;
        const billingSteps = [
            {
                title: "Step 1: Patient Registration & Insurance Verification",
                instructions: `**Action:** Begin by gathering the patient's full demographics and insurance details. **On the simulator:** Fill in the 'Patient Registration' section (Name, DOB, Insurance ID) and click 'Register Patient'. In a real scenario, you'd also call the payer to verify eligibility and benefits.`,
            },
            {
                title: "Step 2: Patient Encounter Documentation",
                instructions: `**Action:** This is where the provider records the visit details. **On the simulator:** Fill in the 'Encounter Documentation' section (Encounter Date, Chief Complaint, and add at least one Diagnosis and one Procedure). This mirrors the clinical notes that inform coding.`,
            },
            {
                title: "Step 3: Medical Coding",
                instructions: `**Action:** Translate the documentation into standardized ICD-10 and CPT codes. **On the simulator:** Ensure your Diagnosis and Procedure inputs in Section 2 are correctly formatted codes. This is a critical skill for accurate billing.`,
            },
            {
                title: "Step 4: Charge Entry & Superbill Creation",
                instructions: `**Action:** Enter the charges for the services provided. **On the simulator:** Go to 'Charge Entry & Services', add descriptions, CPT codes (ensure they match your procedures from step 2), and prices for the services. This creates the financial record.`,
            },
            {
                title: "Step 5: Claim Generation & Submission",
                instructions: `**Action:** Compile all data into a standardized claim (CMS-1500 for professional, UB-04 for institutional) and send it to the payer. **On the simulator:** Click 'Generate Simulated Claim' in Section 4. This is the official request for payment.`,
            },
            {
                title: "Step 6: Claim Adjudication",
                instructions: `**Understanding:** The insurance company reviews the claim. They'll either pay, deny, or reject it, sending an EOB (for patient) or ERA (for provider). **Think:** What common reasons lead to denials at this stage? (e.g., medical necessity, timely filing)`,
            },
            {
                title: "Step 7: Payment Posting",
                instructions: `**Action:** Once paid, the payment is recorded in the billing system. **Understanding:** This updates the patient's balance and the provider's accounts. Accurate posting prevents overbilling or outstanding balances.`,
            },
            {
                title: "Step 8: Patient Billing & Collections",
                instructions: `**Action:** If a balance remains after insurance pays, the patient is billed. **Understanding:** This involves sending statements and following up on overdue payments. Clear communication with patients is key.`,
            },
            {
                title: "Step 9: Reporting & Analysis",
                instructions: `**Understanding:** Continuously analyze billing data to identify trends, improve efficiency, and reduce denials. This step helps optimize the entire revenue cycle. **You've completed the walkthrough!**`,
            },
        ];

        // Global Data Storage (Prior Authorization Walkthrough)
        let currentPaStep = 0;
        const paSteps = [
            {
                title: "PA Step 1: Identify Need for Prior Authorization",
                instructions: `**Scenario:** A patient needs an MRI of the knee.
                **Action:** The first step is to check the patient's insurance plan and the specific CPT code (e.g., CPT 73721 for MRI knee without contrast) against the payer's policy to determine if a Prior Authorization (PA) is required. Many high-cost imaging services or specialty medications require PA.`,
            },
            {
                title: "PA Step 2: Gather Necessary Information",
                instructions: `**Action:** If PA is required, you must collect all relevant clinical and administrative information.
                **Required Info:** Patient demographics, insurance details, referring and rendering provider NPIs, **exact CPT code(s) with modifiers**, **supporting ICD-10 diagnosis code(s) demonstrating medical necessity**, date of service, and any clinical notes (e.g., physician's order, previous treatments tried and failed).`,
            },
            {
                title: "PA Step 3: Submit the Request",
                instructions: `**Action:** Submit the PA request to the insurance company. This is usually done online via a payer portal, fax, or phone.
                **Key Point:** Ensure all fields are accurately completed and all required supporting documentation is attached. Incomplete requests are a common cause of delays or denials.`,
            },
            {
                title: "PA Step 4: Follow-up and Await Decision",
                instructions: `**Action:** After submission, monitor the status of the request. Payers have specific turnaround times (e.g., 7-14 business days for routine, 24-72 hours for urgent).
                **Outcome:** The PA will either be **Approved**, **Denied**, or sent back for **More Information**.`,
            },
            {
                title: "PA Step 5: Handle Approved Authorization",
                instructions: `**Action:** If approved, carefully note the **authorization number**, the **approved CPT codes**, the **number of units/visits approved**, and the **valid date range**.
                **Next:** Ensure this authorization number is included on the claim when submitted to prevent denials. Inform the patient and scheduling department.`,
            },
            {
                title: "PA Step 6: Handle Denied Authorization",
                instructions: `**Action:** If denied, review the denial reason code carefully (often found on an EOB/ERA from the PA department). Common reasons include 'not medically necessary' or 'incorrect information'.
                **Next:** If denied for medical necessity, discuss with the provider if an appeal (with additional clinical documentation or a peer-to-peer review) is warranted. If denied for administrative reasons, correct and resubmit. **You've completed the PA walkthrough!**`,
            },
        ];

        // Global Data Storage (Knowledge Quizzes)
        let selectedQuizModule = null; // Stores the array of questions for the current module
        let currentQuizQuestionIndex = 0; // Tracks the current question in the module

        const quizModules = {
            "Coding Guidelines": [
                {
                    question: "What does a CPT code modifier indicate?",
                    options: ["A. A new diagnosis", "B. The code has been altered in some way", "C. The patient has insurance", "D. The service was performed in a hospital"],
                    answer: "B",
                    explanation: "A CPT modifier is a two-digit code appended to a CPT code to provide additional information about the procedure or service, such as that it was altered or performed by more than one physician."
                },
                {
                    question: "Which coding system is used for diagnosis codes?",
                    options: ["A. CPT", "B. HCPCS Level II", "C. ICD-10-CM", "D. E&M"],
                    answer: "C",
                    explanation: "ICD-10-CM (International Classification of Diseases, 10th Revision, Clinical Modification) is the standard system for diagnosis codes in the U.S."
                },
            ],
            "Healthcare Laws": [
                {
                    question: "What is the primary purpose of HIPAA for medical coders?",
                    options: ["A. To ensure patients get timely appointments", "B. To protect the privacy and security of patient health information (PHI)", "C. To set reimbursement rates for services", "D. To standardize coding manuals"],
                    answer: "B",
                    explanation: "HIPAA's Privacy Rule and Security Rule mandate that Protected Health Information (PHI) is kept confidential and secure."
                },
                {
                    question: "Submitting a claim with codes that you know are wrong to get a higher payment is a violation of which law?",
                    options: ["A. Stark Law", "B. Anti-Kickback Statute", "C. False Claims Act (FCA)", "D. OIG Exclusions"],
                    answer: "C",
                    explanation: "The False Claims Act (FCA) imposes liability on persons and companies who knowingly submit false claims to the government."
                },
            ],
            "Coding Ethics": [
                {
                    question: "Your boss tells you to change a code to one that provides higher reimbursement, even though the documentation doesn't support it. What is the most ethical action?",
                    options: ["A. Do what your boss says to avoid conflict", "B. Report the incident to a compliance officer", "C. Change the code but make a note in your personal records", "D. Tell the patient to file a complaint"],
                    answer: "B",
                    explanation: "The most ethical and legally compliant action is to report fraudulent activities, such as upcoding, to a designated compliance officer or legal department. This protects you and the organization."
                },
            ],
            "Denials & Appeals": [
                {
                    question: "A claim is denied because the diagnosis code does not justify the procedure code. What is this denial reason called?",
                    options: ["A. Medical necessity denial", "B. Bundling issue", "C. Payer policy change", "D. Inconsistent patient information"],
                    answer: "A",
                    explanation: "A denial for 'lack of medical necessity' means the payer believes the procedure performed was not necessary to treat the patient's documented diagnosis. The diagnosis code must support the procedure code."
                },
                {
                    question: "What is the first step in appealing a denied claim?",
                    options: ["A. Resubmit the claim with a new code", "B. Send a letter of protest to the payer's legal department", "C. Review the patient's chart and the denial reason", "D. Bill the patient directly for the full amount"],
                    answer: "C",
                    explanation: "The crucial first step in any appeal is to thoroughly review the patient‚Äôs documentation and compare it against the denial reason provided by the payer. This helps you identify if the issue is a simple coding error or a more complex medical necessity dispute."
                },
            ],
            "Insurance Nuances": [
                {
                    question: "Which type of insurance plan typically requires a referral from a Primary Care Provider (PCP) to see a specialist?",
                    options: ["A. PPO", "B. HMO", "C. Medicare Part B", "D. Fee-for-Service"],
                    answer: "B",
                    explanation: "HMO (Health Maintenance Organization) plans generally require a referral from a PCP to see a specialist, as they focus on managed care within a network."
                },
                {
                    question: "When a patient has both active Medicare and Medicaid, which payer is usually considered primary?",
                    options: ["A. Medicaid", "B. Medicare", "C. The patient's choice", "D. Whichever plan has been active longer"],
                    answer: "B",
                    explanation: "Medicare is almost always the primary payer when a patient has both Medicare and Medicaid. Medicaid then acts as the payer of last resort, covering what Medicare doesn't."
                },
                {
                    question: "Medicare Part B typically covers what percentage of approved physician services after the deductible is met?",
                    options: ["A. 100%", "B. 50%", "C. 80%", "D. 20%"],
                    answer: "C",
                    explanation: "Medicare Part B covers 80% of approved physician services after the annual deductible is met, with the patient responsible for the remaining 20% (coinsurance)."
                }
            ]
        };

        // Global Data Storage (Patient Balance Calculator)
        let currentBalanceScenarioData = null;
        const patientBalanceScenarios = [
            {
                patient: "Alex Green",
                plan: {
                    copay: 0,
                    deductible: 1000,
                    deductibleMetToDate: 700,
                    coinsurance: 0.15, // 15%
                },
                visit: {
                    service: "Office visit with minor procedure",
                    allowedAmount: 300,
                },
                correct: {
                    copay: 0,
                    deductibleApplied: 300,
                    coinsurance: 0, // No coinsurance applied as allowed amount only covers deductible
                    totalBalance: 300,
                },
                calculationSteps: `
1. Remaining Deductible: $1,000 (total) - $700 (met) = $300.
2. Apply Allowed Amount to Deductible: The full $300 allowed amount for this visit goes towards meeting the remaining $300 deductible.
3. Deductible is now fully met. No amount remains for coinsurance from this visit.
4. Total Patient Balance: $300 (deductible portion met by this visit).
                `.trim(),
            },
            {
                patient: "Brenda White",
                plan: {
                    copay: 35,
                    deductible: 500,
                    deductibleMetToDate: 0,
                    coinsurance: 0.20, // 20%
                },
                visit: {
                    service: "Specialist Consultation",
                    allowedAmount: 250,
                },
                correct: {
                    copay: 35,
                    deductibleApplied: 250,
                    coinsurance: 0, // Deductible not fully met, so no coinsurance yet
                    totalBalance: 285, // Copay + Deductible Applied
                },
                calculationSteps: `
1. Collect Copay: $35.
2. Apply Allowed Amount ($250) to Deductible ($500). $250 is applied to deductible.
3. Remaining Deductible: $500 - $250 = $250.
4. Since deductible is not fully met, no coinsurance applies from this visit.
5. Total Patient Balance: $35 (copay) + $250 (deductible portion) = $285.
                `.trim(),
            },
            {
                patient: "Chris Johnson",
                plan: {
                    copay: 0,
                    deductible: 1500,
                    deductibleMetToDate: 1500, // Deductible already met
                    coinsurance: 0.10, // 10%
                },
                visit: {
                    service: "Follow-up Lab Tests",
                    allowedAmount: 100,
                },
                correct: {
                    copay: 0,
                    deductibleApplied: 0,
                    coinsurance: 10, // 10% of $100
                    totalBalance: 10,
                },
                calculationSteps: `
1. Copay: $0.
2. Deductible: Already met. $0 applied.
3. Coinsurance: 10% of $100 (Allowed Amount) = $10.
4. Total Patient Balance: $10 (coinsurance).
                `.trim(),
            },
            {
                patient: "Diana Smith",
                plan: {
                    copay: 20,
                    deductible: 750,
                    deductibleMetToDate: 750, // Deductible already met
                    coinsurance: 0.25, // 25%
                },
                visit: {
                    service: "Primary Care Office Visit",
                    allowedAmount: 90,
                },
                correct: {
                    copay: 20,
                    deductibleApplied: 0,
                    coinsurance: 22.50, // 25% of $90
                    totalBalance: 42.50, // Copay + Coinsurance
                },
                calculationSteps: `
1. Collect Copay: $20.
2. Deductible: Already met. $0 applied.
3. Coinsurance: 25% of $90 (Allowed Amount) = $22.50.
4. Total Patient Balance: $20 (copay) + $22.50 (coinsurance) = $42.50.
                `.trim(),
            },
        ];

        // Global Data Storage (Modifier Application Challenge)
        let currentModifierChallenge = null;
        const modifierScenarios = [
            {
                id: "Scenario 1: E/M with Minor Procedure",
                scenario: "A patient comes in for a routine follow-up for their diabetes (E/M service). During the same visit, the physician also performs a minor skin tag removal (separate procedure) that is distinct from the diabetes management.",
                cptCodeToInput: "99213", // E/M code
                correctModifier: "25",
                explanation: "Modifier -25 is used when a significant, separately identifiable evaluation and management (E/M) service is performed on the same day as another procedure or service by the same physician. The diabetes follow-up is separate from the skin tag removal."
            },
            {
                id: "Scenario 2: Professional Component of Imaging",
                scenario: "A hospital provides an X-ray service (technical component), but the radiologist (physician) from a separate group reads and interprets the X-ray (professional component). Your billing office is for the radiologist's group.",
                cptCodeToInput: "71045", // Chest X-ray, single view
                correctModifier: "26",
                explanation: "Modifier -26 indicates that only the professional component of a service was performed. The radiologist's group is billing for the interpretation, not the technical aspects (equipment, tech time) of the X-ray."
            },
            {
                id: "Scenario 3: Repeat Procedure by Same Physician",
                scenario: "A patient received an injection in their left knee earlier today. Later in the same day, due to continued severe pain, the same physician performs another, distinct injection in the *same* left knee.",
                cptCodeToInput: "20610", // Arthrocentesis, aspiration and/or injection, major joint
                correctModifier: "76",
                explanation: "Modifier -76 indicates a repeat procedure by the same physician on the same date of service. This clarifies that the second injection was not a duplicate but a medically necessary, distinct service."
            },
            {
                id: "Scenario 4: E/M during Global Post-Op Period",
                scenario: "A patient had a hernia repair (surgical procedure with a 90-day global period) 30 days ago. Today, the patient comes in for a completely unrelated visit for acute bronchitis, seen by the same surgeon who performed the hernia repair.",
                cptCodeToInput: "99213", // Established patient E/M
                correctModifier: "24",
                explanation: "Modifier -24 is used for an unrelated evaluation and management (E/M) service by the same physician during a post-operative global period. The bronchitis is entirely separate from the hernia repair."
            },
            {
                id: "Scenario 5: Telehealth Visit",
                scenario: "A patient has a scheduled follow-up for chronic hypertension with their primary care physician. Due to their busy schedule, the patient conducts the visit via a real-time, two-way audio and video telemedicine platform.",
                cptCodeToInput: "99213", // Established patient E/M
                correctModifier: "95",
                explanation: "Modifier -95 indicates that the service was provided via synchronous telemedicine, where both audio and video are used for a real-time interactive encounter. This is critical for billing telehealth services."
            }
        ];

        // Global Data Storage (Matching Game)
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let gameActive = false;

        const termPairs = [
            { term: "EOB", definition: "Explanation of Benefits" },
            { term: "HIPAA", definition: "Health Insurance Portability and Accountability Act" },
            { term: "CPT", definition: "Current Procedural Terminology" },
            { term: "ICD-10-CM", definition: "International Classification of Diseases, 10th Revision, Clinical Modification" },
            { term: "HMO", definition: "Health Maintenance Organization" },
            { term: "PPO", definition: "Preferred Provider Organization" },
            { term: "NPI", definition: "National Provider Identifier" },
            { term: "PHI", definition: "Protected Health Information" },
            { term: "ERA", definition: "Electronic Remittance Advice" },
            { term: "POS", definition: "Place of Service" },
            { term: "UB-04", definition: "Institutional Claim Form" },
            { term: "CMS-1500", definition: "Professional Claim Form" },
            { term: "PA", definition: "Prior Authorization" },
            { term: "AR", definition: "Accounts Receivable" },
            { term: "RCM", definition: "Revenue Cycle Management" }
        ];

        // Global Data Storage (Claim Scrubber)
        let currentScrubberScenarioData = null;
        const claimScrubberScenarios = [
            {
                title: "Scenario 1: Missing Modifier for Separate E/M",
                description: "A patient saw their PCP for a routine check-up and also had a mole removed during the same visit. The claim was submitted without a modifier.",
                presentedClaim: {
                    notes: "Patient had annual physical and also requested removal of a bothering mole on arm. Exam for physical normal. Mole removal performed.",
                    diagnosis: "Z00.00 (Annual Physical), D22.31 (Benign neoplasm of skin, right arm)",
                    cpt: "99395, 11400", // Preventive visit, Excision benign lesion
                    modifier: "NONE" // Incorrect - should have a modifier on 99395 or 99213 if a problem was also addressed.
                },
                errors: [
                    { type: "modifier", explanation: "When an E/M service (like an annual physical which is coded with a preventive CPT 99395) and a separate, distinct procedure (like mole removal CPT 11400) are performed on the same day by the same provider, the E/M code requires a modifier -25 if a significant, separately identifiable E/M service was performed (or, if it was a problem-focused E/M in addition to the preventive, then 9921x with -25). Given the prompt's simplicity, the main issue is a missing modifier for separate services." }
                ],
                expectedInputs: {
                    correctedICD: "Z00.00,D22.31", // Both diagnoses are correct.
                    correctedCPT: "99395,11400", // CPTs are correct for the services.
                    correctedModifier: "25" // Modifier for the E/M or procedure depending on primary service/payer.
                },
                 explanation: "The initial claim was missing a modifier to indicate that the mole removal was a separate, distinct procedure from the annual physical. Modifier -25 should be appended to the E/M code (99395 in this case, or if a separate problem was managed, a 9921x code) to signify a significant, separately identifiable service was provided on the same day as another procedure. The simulator focuses on the *concept* of the missing modifier."
            },
            {
                title: "Scenario 2: Diagnosis-Procedure Mismatch",
                description: "A claim for a chest X-ray was submitted with a diagnosis code for a common cold, but the notes indicate potential pneumonia. The payer denied for lack of medical necessity.",
                presentedClaim: {
                    notes: "Patient with cough, fever, and congestion. Suspicion of common cold. Chest X-ray performed.",
                    diagnosis: "J00 (Common Cold)",
                    cpt: "71045 (Chest X-ray, single view)",
                    modifier: "NONE"
                },
                errors: [
                    { type: "diagnosis-medical-necessity", explanation: "A common cold (J00) typically does not justify a chest X-ray. The documentation suggests pneumonia, which would medically necessitate the X-ray. The diagnosis should be changed to reflect the true medical necessity for the X-ray." }
                ],
                expectedInputs: {
                    correctedICD: "J18.9", // Pneumonia, unspecified
                    correctedCPT: "71045",
                    correctedModifier: "NONE"
                },
                explanation: "The original diagnosis (J00 Common Cold) did not provide medical necessity for the Chest X-ray (71045). A diagnosis like J18.9 (Pneumonia, unspecified organism) would justify the imaging study, making it a medically necessary service. This is a common denial reason."
            },
            {
                title: "Scenario 3: Incorrect CPT for Service Rendered",
                description: "A claim was submitted for a complex office visit (99215), but the documentation only supports a moderate complexity visit.",
                presentedClaim: {
                    notes: "Established patient. Follow-up for stable hypertension. BP good. Meds refilled. Quick review, no new complaints.",
                    diagnosis: "I10 (Essential hypertension)",
                    cpt: "99215 (Established patient office or other outpatient visit, 40-54 minutes)",
                    modifier: "NONE"
                },
                errors: [
                    { type: "cpt", explanation: "CPT code 99215 is for a high-complexity established patient visit, typically requiring extensive history, exam, and medical decision making. The documentation provided (routine follow-up for stable hypertension, quick review) only supports a lower level E/M code like 99213 (moderate complexity) or 99212 (low complexity). This is an example of upcoding." }
                ],
                expectedInputs: {
                    correctedICD: "I10",
                    correctedCPT: "99213", // Or even 99212, but 99213 is a common correction.
                    correctedModifier: "NONE"
                },
                explanation: "The CPT code 99215 was an 'upcode' as the documentation did not support the highest level of office visit. The visit description fits CPT 99213, which is for an established patient office visit requiring a moderate level of medical decision making. Always ensure the CPT code accurately reflects the complexity and time/elements documented."
            }
        ];

        // Global Data Storage (Denial Code Interpreter)
        let currentDenialScenarioData = null;
        const denialScenarios = [
            {
                denialCode: "CO-45 / M80",
                context: "A Medicare claim for a routine annual physical (CPT 99395) was submitted, but it was denied with 'Contractual Obligation - Charge exceeds fee schedule/maximum allowable or contracted maximum' and 'Not covered when performed in this setting/type of service'.",
                interpretations: [
                    { text: "The service was not medically necessary.", correct: false },
                    { text: "The provider is not in-network with Medicare.", correct: false },
                    { text: "The claim was denied because it was a preventive service, and Medicare only covers problem-focused visits.", correct: false },
                    { text: "Medicare does not pay for routine annual physicals using this CPT code (99395) under Part B; it covers Annual Wellness Visits (AWV) with different codes.", correct: true }
                ],
                correctActionPlanKeywords: ["Medicare", "Annual Wellness Visit", "AWV", "G0438", "G0439", "Rebill"],
                explanation: "Medicare Part B does not cover routine annual physicals (CPT 99395). Instead, it covers an Annual Wellness Visit (AWV), which focuses on preventive care and health planning. The correct CPT codes for an AWV are G0438 (initial) or G0439 (subsequent). If the documentation supports an AWV, the claim should be rebilled with the appropriate G-code. If it was a standard physical, it might be non-covered. The M80 remark code ('Not covered when performed in this setting/type of service') further points to this policy difference.",
            },
            {
                denialCode: "PR-1 / N1",
                context: "A claim for an office visit (CPT 99213) was denied with 'Patient Responsibility - Deductible Amount' and a remark code 'Patient eligibility for the service date is not confirmed'.",
                interpretations: [
                    { text: "The patient did not pay their copay.", correct: false },
                    { text: "The patient's deductible has not been met, but also their insurance was not active for that date of service.", correct: true },
                    { text: "The CPT code was incorrect for the services rendered.", correct: false },
                    { text: "The claim was filed outside the timely filing limit.", correct: false }
                ],
                correctActionPlanKeywords: ["Verify Eligibility", "Payer Portal", "Call Payer", "Patient Responsibility", "Bill Patient"],
                explanation: "PR-1 means the patient owes the deductible. However, the N1 remark code (Patient eligibility for service date not confirmed) is critical here. It indicates a primary issue: the patient may not have had active insurance on the date of service, or their benefits changed. The first step is to **verify the patient's eligibility and benefits** with the payer for the date of service. If confirmed ineligible, the patient is responsible for the full balance. If eligible but deductible not met, bill the patient.",
            },
            {
                denialCode: "CO-97",
                context: "A claim for a laceration repair (CPT 12001) performed in the ED was denied with 'Contractual Obligation - Payment adjusted because the benefit for this service is included in the payment/allowance for another service'.",
                interpretations: [
                    { text: "The laceration repair was not medically necessary.", correct: false },
                    { text: "The service was bundled into another payment and cannot be billed separately.", correct: true },
                    { text: "The patient's deductible was not met for this service.", correct: false },
                    { text: "The claim was missing a required modifier.", correct: false }
                ],
                correctActionPlanKeywords: ["Bundling", "Review NCCI Edits", "Payer Policy", "Appeal if appropriate"],
                explanation: "CO-97 indicates a **bundling issue**. This means the laceration repair (12001) is considered part of a larger service or procedure that was also billed (e.g., an Evaluation and Management (E/M) service for the ED visit). Medicare's National Correct Coding Initiative (NCCI) edits often bundle certain minor procedures into E/M services. Review the full claim to see if an E/M code was also billed. If it's truly a separate, distinct service, a modifier (like -59) might be needed, but for many minor procedures, bundling is expected. **Do not rebill without a modifier unless documentation clearly supports it and is compliant with payer rules.**",
            }
        ];

        // Global Data Storage (SOAP Note Coder & Extractor)
        let currentSoapScenarioData = null;
        const soapNoteScenarios = [
            {
                title: "Acute Pharyngitis (Strep Throat) Encounter",
                description: "Extract the Chief Complaint, ICD-10, CPT, Modifier, and Key Plan elements.",
                soapNote: `
S:
Chief Complaint: "Sore throat and difficulty swallowing for 3 days."
HPI: Ms. Davis reports onset of severe sore throat 3 days ago, which has progressively worsened, making it painful to swallow liquids and solids. Associated with mild fever (up to 100.5¬∞F at home), body aches, and fatigue. Denies cough, runny nose, congestion, or rash. No known sick contacts. Has been taking Tylenol for fever with minimal relief.
ROS: No recent strep exposure. Denies nausea, vomiting, abdominal pain, or dysuria.

O:
Vitals: BP: 118/78 mmHg, HR: 88 bpm, RR: 18 bpm, Temp: 100.8¬∞F, Wt: 130 lbs
Physical Exam:
General: Appears tired, mild distress due to throat pain.
HEENT: Throat: Erythematous pharynx. Tonsils 2+ enlarged, with white exudates bilaterally. No peritonsillar swelling. Neck: Anterior cervical lymphadenopathy, tender to palpation.
Lungs: Clear to auscultation bilaterally.
Rapid Strep Test: Positive

A:
1. Acute streptococcal pharyngitis (J02.0): Confirmed by positive rapid strep test and classic Centor criteria symptoms.

P:
1. Acute streptococcal pharyngitis:
   - Medication: Prescribed Amoxicillin 500mg, 2 tabs po BID x 10 days. Advised to complete full course.
   - Symptomatic Relief: Advised warm salt water gargles, lozenges, Tylenol/ibuprofen as needed.
   - Education: Discussed contagiousness, hand hygiene, stay home from work/school 24h after starting abx and once afebrile.
   - Complications: Educated on potential complications of untreated strep throat.
Follow-up: Return to clinic if symptoms worsen or no improvement in 48-72 hours.
                `.trim(),
                expected: {
                    chiefComplaint: "Sore throat and difficulty swallowing",
                    icd10: "J02.0",
                    cpt: "99213,87880", // 99213 for established visit, 87880 for rapid strep test
                    modifier: "NONE", // Assuming no specific modifiers for this basic scenario
                    planKeywords: ["Amoxicillin", "10 days", "gargles", "lozenge", "Tylenol", "hygiene", "stay home", "return if worse"],
                },
                explanation: `
- Chief Complaint is directly from the 'S' section.
- ICD-10 code J02.0 is provided in the 'A' (Assessment) section, confirmed by positive rapid strep and symptoms.
- CPT 99213 is for an established patient office visit (implied by the follow-up). CPT 87880 is for the rapid strep test performed.
- No specific modifier is needed for this simple, direct encounter.
- Key plan elements are extracted from the 'P' section, focusing on medication, symptomatic relief, education, and follow-up instructions.
                `.trim(),
            },
            {
                title: "Hypertension Follow-up and Medication Refill",
                description: "Extract the Chief Complaint, ICD-10, CPT, Modifier, and Key Plan elements.",
                soapNote: `
S:
Chief Complaint: "Follow-up for blood pressure."
HPI: Mr. Doe reports his home blood pressure readings have been consistently in the range of 130-140/80-90 mmHg daily since his last visit. Denies headaches, dizziness, chest pain, or vision changes. Reports adherence to prescribed Lisinopril 20mg daily. States he has been walking 30 minutes, 4 times a week, and trying to reduce sodium intake. Denies any side effects from medication.
ROS: No new complaints. Denies fever, cough, shortness of breath, nausea, vomiting, diarrhea, constipation, or urinary symptoms.

O:
Vitals: BP: 138/86 mmHg, HR: 72 bpm, RR: 16 bpm, Temp: 98.6¬∞F, Wt: 185 lbs (down 2 lbs from last visit)
Physical Exam:
General: Alert, oriented, appears comfortable.
CV: Regular rhythm, no murmurs, rubs, or gallops.
Pulmonary: Lungs clear to auscultation bilaterally.
Labs (from 2 weeks prior): BMP: Na 140, K 4.1, Cr 0.9, Glucose 102; HbA1c: 5.7%; Lipid Panel: Total Chol 180, HDL 55, LDL 90, Trig 120

A:
1. Essential Hypertension (I10): Stable blood pressure readings at target.
2. Prediabetes (R73.03): HbA1c remains stable.
3. Hyperlipidemia (E78.5): LDL well-controlled.

P:
1. Essential Hypertension: Continue Lisinopril 20mg daily. Encourage continued home BP monitoring; bring log to next visit. Continue DASH diet and regular exercise.
2. Prediabetes: Continue emphasizing diet and exercise. Recheck HbA1c in 6 months.
3. Hyperlipidemia: Continue current diet and exercise. Recheck Lipid Panel in 1 year.
Follow-up: Return to clinic in 3 months for recheck of BP and overall health.
                `.trim(),
                expected: {
                    chiefComplaint: "Follow-up for blood pressure",
                    icd10: "I10,R73.03,E78.5",
                    cpt: "99213", // Established patient office visit, assuming moderate complexity
                    modifier: "NONE",
                    planKeywords: ["Lisinopril", "BP monitoring", "DASH diet", "exercise", "HbA1c", "Lipid Panel", "3 months"],
                },
                explanation: `
- Chief Complaint is directly from the 'S' section.
- ICD-10 codes I10, R73.03, E78.5 are all listed in the 'A' (Assessment) section.
- CPT 99213 is an appropriate code for an established patient office visit managing stable chronic conditions.
- No modifiers are needed for this straightforward follow-up.
- Key plan elements involve medication continuation, lifestyle advice, upcoming lab work, and the next follow-up schedule.
                `.trim(),
            },
            {
                title: "Acute Knee Pain and X-ray",
                description: "Extract the Chief Complaint, ICD-10, CPT, Modifier, and Key Plan elements.",
                soapNote: `
S:
Chief Complaint: "Right knee pain after fall."
HPI: Patient reports falling down stairs 2 days ago, landing on right knee. Immediate severe pain and swelling. Unable to bear full weight. No numbness or tingling. Has been icing and taking ibuprofen with minimal relief.
ROS: No fever, chills. No other injuries from fall.

O:
Vitals: BP: 120/80 mmHg, HR: 70 bpm, RR: 16 bpm, Temp: 98.2¬∞F
Physical Exam:
Right Knee: Moderate swelling over patella. Tenderness to palpation along medial joint line. Pain with range of motion, especially flexion and extension. Effusion present. Stable to valgus/varus stress. Distal pulses intact. No neurological deficits.
X-ray Right Knee: Ordered.

A:
1. Right Knee Sprain (S83.91XA - Sprain of unspecified ligament of right knee, initial encounter)
2. Traumatic Effusion, right knee (M25.461) - if applicable, otherwise omit.

P:
1. Right Knee Sprain:
   - Immobilization: Knee immobilizer prescribed.
   - Pain Management: Continue Ibuprofen 600mg every 6 hours as needed.
   - RICE therapy: Rest, Ice, Compression, Elevation.
   - Imaging: X-ray of right knee performed today, results pending. Will notify patient once read.
   - Activity: Non-weight bearing on right leg, crutches provided.
   - Follow-up: Orthopedic referral placed. Return to clinic in 1 week for re-evaluation or sooner if worsening.
                `.trim(),
                expected: {
                    chiefComplaint: "Right knee pain after fall",
                    icd10: "S83.91XA",
                    cpt: "99213,73560", // 99213 established visit, 73560 for knee X-ray
                    modifier: "RT", // Right side
                    planKeywords: ["immobilizer", "Ibuprofen", "RICE", "X-ray", "non-weight bearing", "crutches", "orthopedic referral", "1 week"],
                },
                explanation: `
- Chief Complaint is clear from the 'S' section.
- ICD-10 code S83.91XA is provided in the 'A' (Assessment) section. If a traumatic effusion was also explicitly diagnosed, M25.461 could be added.
- CPT 99213 is for the established patient office visit. CPT 73560 is for the X-ray of the knee.
- Modifier RT is crucial to indicate the service was performed on the Right side.
- Key plan elements involve immobilization, pain management, RICE therapy, imaging details, activity restrictions, and follow-up/referral.
                `.trim(),
            }
        ];

        // Global Data Storage (Code Lookup Tool) - EXPANDED
        const codeDatabase = {
            // --- ICD-10-CM Codes ---
            "J02.0": "Acute pharyngitis, unspecified",
            "J02.9": "Acute pharyngitis, unspecified",
            "I10": "Essential (primary) hypertension",
            "R05": "Cough",
            "R53.83": "Other fatigue",
            "B07.0": "Plantar wart",
            "B07.9": "Viral wart, unspecified",
            "J11.1": "Influenza with gastrointestinal manifestations, virus identified",
            "Z00.00": "Encounter for general adult medical examination without abnormal findings",
            "R73.03": "Prediabetes",
            "E78.5": "Hyperlipidemia, unspecified",
            "S83.91XA": "Sprain of unspecified ligament of right knee, initial encounter",
            "M25.461": "Effusion, right knee",
            "J18.9": "Pneumonia, unspecified organism",
            "M54.5": "Low back pain",
            "G43.909": "Migraine, unspecified, not intractable, without status migrainosus",
            "E11.9": "Type 2 diabetes mellitus without complications",
            "K21.9": "Gastro-esophageal reflux disease without esophagitis",
            "J45.909": "Unspecified asthma, uncomplicated",
            "N39.0": "Urinary tract infection, site not specified",
            "H61.20": "Impacted cerumen, unspecified ear",
            "A09": "Infectious gastroenteritis and colitis, unspecified",
            "F41.1": "Generalized anxiety disorder",
            "Z12.31": "Encounter for screening mammogram for malignant neoplasm of breast",
            "D22.31": "Benign neoplasm of skin of right upper limb, including shoulder",
            "L03.116": "Cellulitis of right lower limb",
            "J30.9": "Allergic rhinitis, unspecified",
            "M17.11": "Unilateral primary osteoarthrosis, right knee",

            // --- CPT Codes ---
            "99203": "Office or other outpatient visit for the evaluation and management of a new patient, which requires a medically appropriate history and/or examination and high complexity medical decision making. (30-44 minutes)",
            "99213": "Office or other outpatient visit for the evaluation and management of an established patient, which requires a medically appropriate history and/or examination and moderate complexity medical decision making. (20-29 minutes)",
            "99395": "Periodic comprehensive preventive medicine reevaluation and management of an individual including an age and gender appropriate history, examination, counseling/anticipatory guidance/risk factor reduction interventions, and the ordering of laboratory/diagnostic procedures, established patient; 40-64 years.",
            "17110": "Destruction (e.g., laser surgery, electrosurgery, cryosurgery, chemosurgery, surgical curettement), of benign lesions other than skin tags or cutaneous vascular proliferative lesions; up to 14 lesions",
            "87804": "Influenza virus antigen detection, immunoassay, with direct optical observation; with optical instrument analysis",
            "71045": "Radiologic examination, chest; single view",
            "20610": "Arthrocentesis, aspiration and/or injection; major joint or bursa (e.g., shoulder, hip, knee, subacromial bursa)",
            "73560": "Radiologic examination, knee; 1 or 2 views",
            "G0438": "Annual wellness visit; includes a personalized prevention plan of service (pps), initial visit",
            "G0439": "Annual wellness visit, subsequent",
            "99214": "Office or other outpatient visit for the evaluation and management of an established patient, which requires at least 2 of 3 key components: a comprehensive history; a comprehensive examination; medical decision making of moderate complexity. (30-39 minutes)",
            "99215": "Office or other outpatient visit for the evaluation and management of an established patient, which requires at least 2 of 3 key components: a comprehensive history; a comprehensive examination; medical decision making of high complexity. (40-54 minutes)",
            "99490": "Chronic care management services, at least 20 minutes of clinical staff time directed by a physician or other qualified health care professional, per calendar month...",
            "90471": "Immunization administration (includes percutaneous, intradermal, subcutaneous, or intramuscular injections); 1 vaccine",
            "81002": "Urinalysis, by dipstick or tablet reagent for bilirubin, glucose, hemoglobin, ketone, leukocytes, nitrite, pH, protein, urobilinogen, specific gravity, any number of these constituents; non-automated, without microscopy",
            "97110": "Therapeutic procedure, one or more areas, each 15 minutes; therapeutic exercises to develop strength and endurance, range of motion, and flexibility",
            "64490": "Injection(s), diagnostic or therapeutic agent, paravertebral facet joint (s) (e.g., C2-C5, L2-L5) or sacra-iliac joint, cervical or thoracic; single level, unilateral or bilateral",
            "43239": "Esophagogastroduodenoscopy, flexible, transoral; with biopsy(s), single or multiple",
            "45378": "Colonoscopy, flexible, proximal to splenic flexure; diagnostic, including collection of specimen(s) by brushing or washing, when performed (separate procedure); with biopsy(s), single or multiple",

            // --- HCPCS Level II Codes (examples) ---
            "A0428": "Ambulance service, basic life support, non-emergency transport (BLS)",
            "J0897": "Injection, EPO, recombinant, for use in patients with chronic renal failure...",
            "K0001": "Standard wheelchair",
            "E0424": "Stationary oxygen concentrator, requires an HCPCS code for durable medical equipment"
        };

        // Global Data Storage (A/R Aging Simulation)
        let currentArScenarioClaims = [];
        const arAgingScenarios = [
            {
                scenarioId: "Scenario A: Mixed Aging",
                claims: [
                    { claimId: "C9001", patient: "Alice", payer: "BCBS", amount: 150.00, daysOld: 15, correctAction: "Monitor claim status", explanation: "Claims under 30 days old are typically still within the payer's initial processing time. Continue to monitor the status online before calling." },
                    { claimId: "C9002", patient: "Bob", payer: "Aetna", amount: 320.00, daysOld: 45, correctAction: "Check claim status online", explanation: "For claims 31-60 days old, check the payer's online portal first. If details are not available or it's stuck, call payer services." },
                    { claimId: "C9003", patient: "Charlie", payer: "UnitedHealthcare", amount: 75.00, daysOld: 70, correctAction: "Call payer (provider services) for status/details", explanation: "Claims 61-90 days old often require a direct call to payer services to identify specific issues or denials not yet communicated via EOB/ERA." },
                    { claimId: "C9004", patient: "Dana", payer: "Medicare", amount: 200.00, daysOld: 100, correctAction: "Review EOB/ERA for denial reason/details", explanation: "For claims over 90 days, there's a high probability of denial. Locate the EOB/ERA to understand the denial code and reason before planning an appeal or correction." },
                    { claimId: "C9005", patient: "Eve", payer: "Cigna", amount: 50.00, daysOld: 65, correctAction: "Review EOB/ERA for denial reason/details", explanation: "If an EOB/ERA is available for a claim over 60 days, always review it first to pinpoint the exact reason for non-payment or underpayment. This guides your next action." },
                    { claimId: "C9006", patient: "Frank", payer: "Humana", amount: 450.00, daysOld: 95, correctAction: "Submit an appeal", explanation: "For older denied claims where the service was medically necessary and supported by documentation, an appeal is often required. Ensure you have all necessary clinical notes." },
                ]
            },
            {
                scenarioId: "Scenario B: Denial Focus",
                claims: [
                    { claimId: "D1001", patient: "Grace", payer: "BCBS", amount: 120.00, daysOld: 80, correctAction: "Review EOB/ERA for denial reason/details", explanation: "This claim is old enough that it's likely been processed. Check for EOB/ERA to find a specific denial reason." },
                    { claimId: "D1002", patient: "Henry", payer: "Aetna", amount: 25.00, daysOld: 40, correctAction: "Check claim status online", explanation: "For a claim 31-60 days old, start with an online status check. It's too early for an appeal unless a denial is confirmed." },
                    { claimId: "D1003", patient: "Ivy", payer: "UnitedHealthcare", amount: 600.00, daysOld: 150, correctAction: "Write off balance", explanation: "A very old claim (150 days) with no resolution might be uncollectible, especially if it's past timely filing limits or payer response periods. Consider writing off after all other avenues are exhausted." },
                    { claimId: "D1004", patient: "Jack", payer: "Medicare", amount: 80.00, daysOld: 20, correctAction: "Monitor claim status", explanation: "This claim is still very new. Monitor its progress, no immediate action required." },
                    { claimId: "D1005", patient: "Karen", payer: "Cigna", amount: 180.00, daysOld: 75, correctAction: "Correct simple errors and resubmit claim", explanation: "If initial review (EOB/ERA or call) reveals a simple administrative error (e.g., typo, missing info), correct and resubmit promptly. This is faster than an appeal." },
                    { claimId: "D1006", patient: "Liam", payer: "Humana", amount: 100.00, daysOld: 50, correctAction: "Bill patient", explanation: "If the EOB/ERA clearly indicates the patient is responsible (e.g., deductible, coinsurance, non-covered service), send a patient statement. This claim is mature enough for patient billing." },
                ]
            }
        ];

        // --- DOM Element References (existing sections) ---
        // Moved here to ensure they are defined AFTER global data but BEFORE event listeners
        const patientNameInput = document.getElementById('patientName');
        const patientDOBInput = document.getElementById('patientDOB');
        const insuranceIDInput = document.getElementById('insuranceID');
        const registerPatientBtn = document.getElementById('registerPatientBtn');

        const encounterDateInput = document.getElementById('encounterDate');
        const chiefComplaintInput = document.getElementById('chiefComplaint');
        const diagnosisList = document.getElementById('diagnosisList');
        const addDiagnosisBtn = document.getElementById('addDiagnosisBtn');
        const procedureList = document.getElementById('procedureList');
        const addProcedureBtn = document.getElementById('addProcedureBtn');

        const chargeList = document.getElementById('chargeList');
        const addChargeBtn = document.getElementById('addChargeBtn');

        const generateClaimBtn = document.getElementById('generateClaimBtn');
        const claimOutput = document.getElementById('claimOutput');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const messageBox = document.getElementById('messageBox');

        // DOM Element References (Medical Billing Walkthrough)
        const billingWalkthroughContent = document.getElementById('billingWalkthroughContent');
        const walkthroughStepTitle = document.getElementById('walkthroughStepTitle');
        const walkthroughStepInstructions = document.getElementById('walkthroughStepInstructions');
        const startBillingWalkthroughBtn = document.getElementById('startBillingWalkthroughBtn');
        const nextBillingWalkthroughBtn = document.getElementById('nextBillingWalkthroughBtn');
        const resetBillingWalkthroughBtn = document.getElementById('resetBillingWalkthroughBtn');

        // DOM Element References (Prior Authorization Walkthrough)
        const paWalkthroughContent = document.getElementById('paWalkthroughContent');
        const paWalkthroughStepTitle = document.getElementById('paWalkthroughStepTitle');
        const paWalkthroughStepInstructions = document.getElementById('paWalkthroughStepInstructions');
        const startPaWalkthroughBtn = document.getElementById('startPaWalkthroughBtn');
        const nextPaWalkthroughBtn = document.getElementById('nextPaWalkthroughBtn');
        const resetPaWalkthroughBtn = document.getElementById('resetPaWalkthroughBtn');

        // DOM Element References (Knowledge Quizzes)
        const quizGuidelinesBtn = document.getElementById('quizGuidelinesBtn');
        const quizLawsBtn = document.getElementById('quizLawsBtn');
        const quizEthicsBtn = document.getElementById('quizEthicsBtn');
        const quizDenialsBtn = document.getElementById('quizDenialsBtn');
        const quizInsuranceNuanceBtn = document.getElementById('quizInsuranceNuanceBtn');
        const quizContent = document.getElementById('quizContent');
        const quizQuestionTitle = document.getElementById('quizQuestionTitle');
        const quizOptions = document.getElementById('quizOptions');
        const submitAnswerBtn = document.getElementById('submitAnswerBtn');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const resetQuizBtn = document.getElementById('resetQuizBtn');
        const quizFeedback = document.getElementById('quizFeedback');

        // DOM Element References (Patient Balance Calculator)
        const loadBalanceScenarioBtn = document.getElementById('loadBalanceScenarioBtn');
        const balanceCalculatorContent = document.getElementById('balanceCalculatorContent');
        const balanceScenarioTitle = document.getElementById('balanceScenarioTitle');
        const balanceScenarioDetails = document.getElementById('balanceScenarioDetails');
        const userCopayInput = document.getElementById('userCopay');
        const userDeductibleInput = document.getElementById('userDeductibleInput');
        const userCoinsuranceInput = document.getElementById('userCoinsurance');
        const userTotalBalanceInput = document.getElementById('userTotalBalance');
        const checkBalanceBtn = document.getElementById('checkBalanceBtn');
        const resetBalanceBtn = document.getElementById('resetBalanceBtn');
        const balanceFeedback = document.getElementById('balanceFeedback');

        // DOM Element References (Modifier Application Challenge)
        const loadModifierScenarioBtn = document.getElementById('loadModifierScenarioBtn');
        const modifierChallengeContent = document.getElementById('modifierChallengeContent');
        const modifierScenarioTitle = document.getElementById('modifierScenarioTitle');
        const modifierScenarioDetails = document.getElementById('modifierScenarioDetails');
        const userModifierCPTInput = document.getElementById('userModifierCPT');
        const userModifierInput = document.getElementById('userModifier');
        const checkModifierBtn = document.getElementById('checkModifierBtn');
        const resetModifierBtn = document.getElementById('resetModifierBtn');
        const modifierFeedback = document.getElementById('modifierFeedback');

        // DOM Element References (Matching Game)
        const startGameBtn = document.getElementById('startGameBtn');
        const matchingGameContent = document.getElementById('matchingGameContent');
        const cardGrid = document.getElementById('cardGrid');
        const gameMessage = document.getElementById('gameMessage');
        const resetGameBtn = document.getElementById('resetGameBtn');

        // DOM Element References (Claim Scrubber)
        const loadScrubberScenarioBtn = document.getElementById('loadScrubberScenarioBtn');
        const scrubberChallengeContent = document.getElementById('scrubberChallengeContent');
        const scrubberScenarioTitle = document.getElementById('scrubberScenarioTitle');
        const scrubberScenarioDetails = document.getElementById('scrubberScenarioDetails');
        const presentedClaimOutput = document.getElementById('presentedClaimOutput');
        const userScrubberICDInput = document.getElementById('userScrubberICD');
        const userScrubberCPTInput = document.getElementById('userScrubberCPT');
        const userScrubberModifierInput = document.getElementById('userScrubberModifier');
        const checkScrubberBtn = document.getElementById('checkScrubberBtn');
        const resetScrubberBtn = document.getElementById('resetScrubberBtn');
        const scrubberFeedback = document.getElementById('scrubberFeedback');

        // DOM Element References (Denial Code Interpreter)
        const loadDenialScenarioBtn = document.getElementById('loadDenialScenarioBtn');
        const denialChallengeContent = document.getElementById('denialChallengeContent');
        const denialScenarioTitle = document.getElementById('denialScenarioTitle');
        const denialScenarioDetails = document.getElementById('denialScenarioDetails');
        const denialInterpretationOptions = document.getElementById('denialInterpretationOptions');
        const userActionPlanInput = document.getElementById('userActionPlan');
        const checkDenialBtn = document.getElementById('checkDenialBtn');
        const resetDenialBtn = document.getElementById('resetDenialBtn');
        const denialFeedback = document.getElementById('denialFeedback');

        // DOM Element References (SOAP Note Challenge)
        const loadSoapScenarioBtn = document.getElementById('loadSoapScenarioBtn');
        const soapChallengeContent = document.getElementById('soapChallengeContent');
        const soapScenarioTitle = document.getElementById('soapScenarioTitle');
        const soapScenarioDescription = document.getElementById('soapScenarioDescription');
        const soapNoteDisplay = document.getElementById('soapNoteDisplay');
        const userSoapChiefComplaintInput = document.getElementById('userSoapChiefComplaint');
        const userSoapICDInput = document.getElementById('userSoapICD');
        const userSoapCPTInput = document.getElementById('userSoapCPT');
        const userSoapModifierInput = document.getElementById('userSoapModifier');
        const userSoapPlanInput = document.getElementById('userSoapPlan');
        const checkSoapBtn = document.getElementById('checkSoapBtn');
        const resetSoapBtn = document.getElementById('resetSoapBtn');
        const soapFeedback = document.getElementById('soapFeedback');

        // Code Lookup Tool DOM Elements
        const codeLookupInput = document.getElementById('codeLookupInput');
        const lookupCodeBtn = document.getElementById('lookupCodeBtn');
        const codeLookupResult = document.getElementById('codeLookupResult');
        const codeLookupContent = document.getElementById('codeLookupContent');

        // NEW: A/R Aging Simulation DOM Elements
        const loadArScenarioBtn = document.getElementById('loadArScenarioBtn');
        const arAgingContent = document.getElementById('arAgingContent');
        const arClaimList = document.getElementById('arClaimList');
        const checkArActionsBtn = document.getElementById('checkArActionsBtn');
        const resetArScenarioBtn = document.getElementById('resetArScenarioBtn');
        const arFeedback = document.getElementById('arFeedback');

        // NEW: Form Repository DOM Elements (no dynamic parts, just content)
        const formRepositoryContent = document.getElementById('formRepositoryContent');


        // --- UTILITY FUNCTIONS ---
        // Function to load patient data from Firestore
        async function loadPatientData() {
            if (!db || !userId) {
                console.warn("Firestore not initialized or userId not available. Cannot load patient data.");
                return;
            }
            try {
                // Fetch the latest registered patient, or just one patient
                const patientsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/patients`);
                const q = query(patientsCollectionRef); // You might want to order/limit here
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    // Assuming we want to load the last patient registered for display purposes
                    const lastPatientDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                    patientData = lastPatientDoc.data();
                    patientNameInput.value = patientData.name || '';
                    patientDOBInput.value = patientData.dob || '';
                    insuranceIDInput.value = patientData.insuranceID || '';
                    showMessage('Loaded previously registered patient data.', 'success');
                    console.log("Loaded patient data from Firestore:", patientData);
                } else {
                    console.log("No saved patient data found for this user.");
                    // showMessage('No saved patient data found. Start by registering a new patient!', 'info');
                }
            } catch (e) {
                console.error("Error loading patient data from Firestore:", e);
                showMessage('Error loading patient data.', 'error');
            }
        }

        // Add/Remove Diagnosis and Procedure Fields
        function addInputGroup(containerId, inputClass, placeholder, type = 'text') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2'; // Tailwind classes for flex and gap

            const input = document.createElement('input');
            input.type = type;
            input.className = `${inputClass} flex-grow-1 focus:ring-green-500 focus:border-green-500`;
            input.name = inputClass.replace(/-/g, ''); // Convert class to name attribute
            input.placeholder = placeholder;

            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'btn-secondary remove-item-btn';
            removeButton.textContent = 'Remove';
            removeButton.onclick = function() {
                div.remove();
            };

            div.appendChild(input);
            div.appendChild(removeButton);
            container.appendChild(div);
        }

        function addServiceInputGroup() {
            const container = document.getElementById('chargeList');
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-3 gap-2 service-item';

            const descriptionInput = document.createElement('input');
            descriptionInput.type = 'text';
            descriptionInput.className = 'service-description col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500';
            descriptionInput.name = 'serviceDescription';
            descriptionInput.placeholder = 'Service Description';

            const cptCodeInput = document.createElement('input');
            cptCodeInput.type = 'text';
            cptCodeInput.className = 'service-cpt-code col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500';
            cptCodeInput.name = 'serviceCptCode';
            cptCodeInput.placeholder = 'CPT Code';

            const priceDiv = document.createElement('div');
            priceDiv.className = 'flex gap-2 col-span-1 md:col-span-1';

            const priceInput = document.createElement('input');
            priceInput.type = 'number';
            priceInput.className = 'service-price flex-grow-1 focus:ring-purple-500 focus:border-purple-500';
            priceInput.name = 'servicePrice';
            priceInput.placeholder = 'Price ($)';
            priceInput.min = "0";
            priceInput.step = "0.01";

            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'btn-secondary remove-item-btn';
            removeButton.textContent = 'Remove';
            removeButton.onclick = function() {
                div.remove();
            };

            priceDiv.appendChild(priceInput);
            priceDiv.appendChild(removeButton);

            div.appendChild(descriptionInput);
            div.appendChild(cptCodeInput);
            div.appendChild(priceDiv);
            container.appendChild(div);
        }


        // --- EVENT LISTENERS ---

        // Patient Registration
        registerPatientBtn.addEventListener('click', async () => {
            const patientToSave = {
                name: patientNameInput.value.trim(),
                dob: patientDOBInput.value.trim(),
                insuranceID: insuranceIDInput.value.trim()
            };

            if (patientToSave.name && patientToSave.dob && patientToSave.insuranceID) {
                patientData = patientToSave; // Update the local patientData variable
                if (db && userId) { // Check if Firestore is initialized and userId is available
                    try {
                        const patientDocRef = doc(db, `artifacts/${appId}/users/${userId}/patients`, `${patientToSave.name.replace(/\s/g, '-')}-${patientToSave.dob}`);
                        await setDoc(patientDocRef, patientToSave, { merge: true });
                        console.log("Patient data saved to Firestore:", patientToSave);
                        showMessage('Patient Registered Successfully and data saved!', 'success');
                    } catch (e) {
                        console.error("Error saving patient data to Firestore:", e);
                        showMessage('Error saving patient data to cloud.', 'error');
                    }
                } else {
                    showMessage('Patient Registered Successfully (data not saved to cloud as Firebase is not initialized).', 'info');
                }
            } else {
                showMessage('Please fill in all patient registration fields.', 'error');
            }
        });

        // Encounter Documentation
        addDiagnosisBtn.addEventListener('click', () => addInputGroup('diagnosisList', 'diagnosis-code', 'e.g., J02.9 (Acute pharyngitis)'));
        addProcedureBtn.addEventListener('click', () => addInputGroup('procedureList', 'procedure-code', 'e.g., 99213 (Office visit)'));

        // Charge Entry
        addChargeBtn.addEventListener('click', addServiceInputGroup);

        // Generate Claim
        generateClaimBtn.addEventListener('click', async () => {
            const currentDiagnoses = Array.from(document.querySelectorAll('.diagnosis-code')).map(input => input.value.trim()).filter(Boolean);
            const currentProcedures = Array.from(document.querySelectorAll('.procedure-code')).map(input => input.value.trim()).filter(Boolean);
            const currentCharges = Array.from(document.querySelectorAll('.service-item')).map(item => {
                const description = item.querySelector('.service-description').value.trim();
                const cptCode = item.querySelector('.service-cpt-code').value.trim();
                const price = parseFloat(item.querySelector('.service-price').value);
                return { description, cptCode, price: isNaN(price) ? 0 : price };
            }).filter(item => item.description || item.cptCode || item.price > 0);

            if (!patientData.name) {
                showMessage('Please register a patient first.', 'error');
                return;
            }
            if (!encounterDateInput.value || !chiefComplaintInput.value) {
                showMessage('Please fill in encounter date and chief complaint.', 'error');
                return;
            }
            if (currentDiagnoses.length === 0 || currentProcedures.length === 0 || currentCharges.length === 0) {
                showMessage('Please add at least one diagnosis, procedure, and service charge.', 'error');
                return;
            }

            const claim = {
                patient: patientData,
                encounter: {
                    date: encounterDateInput.value,
                    chiefComplaint: chiefComplaintInput.value,
                },
                diagnoses: currentDiagnoses,
                procedures: currentProcedures,
                charges: currentCharges,
                totalCharge: currentCharges.reduce((sum, item) => sum + item.price, 0)
            };

            let claimText = `--- CMS-1500 Claim (Simulated) ---\n\n`;
            claimText += `Patient Name: ${claim.patient.name}\n`;
            claimText += `Patient DOB: ${claim.patient.dob}\n`;
            claimText += `Insurance ID: ${claim.patient.insuranceID}\n`;
            claimText += `\nEncounter Date: ${claim.encounter.date}\n`;
            claimText += `Chief Complaint: ${claim.encounter.chiefComplaint}\n`;
            claimText += `\nDiagnoses (ICD-10): ${claim.diagnoses.join(', ')}\n`;
            claimText += `Procedures (CPT/HCPCS): ${claim.procedures.join(', ')}\n`;
            claimText += `\nServices & Charges:\n`;
            claim.charges.forEach(charge => {
                claimText += `- ${charge.description} (CPT: ${charge.cptCode}): $${charge.price.toFixed(2)}\n`;
            });
            claimText += `\nTotal Billed: $${claim.totalCharge.toFixed(2)}\n`;
            claimText += `------------------------------------\n`;

            claimOutput.textContent = claimText;
            showMessage('Simulated Claim Generated!', 'success');

            if (db && userId) { // Check if Firestore is initialized and userId is available
                try {
                    const claimsCollection = collection(db, `artifacts/${appId}/users/${userId}/claims`);
                    await addDoc(claimsCollection, claim);
                    console.log("Claim data saved to Firestore:", claim);
                } catch (e) {
                    console.error("Error saving claim data to Firestore:", e);
                    showMessage('Error saving claim data to cloud.', 'error');
                }
            } else {
                showMessage('Claim Generated (data not saved to cloud as Firebase is not initialized).', 'info');
            }
        });

        clearAllBtn.addEventListener('click', () => {
            patientNameInput.value = '';
            patientDOBInput.value = '';
            insuranceIDInput.value = '';
            encounterDateInput.value = '';
            chiefComplaintInput.value = '';
            diagnosisList.innerHTML = `
                <label class="block text-gray-700 text-sm font-bold mb-2">Diagnoses (ICD Codes):</label>
                <div class="flex items-center gap-2">
                    <input type="text" class="diagnosis-code flex-grow-1 focus:ring-green-500 focus:border-green-500" name="diagnosisCode" placeholder="e.g., J02.9 (Acute pharyngitis)">
                    <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                </div>
            `;
            procedureList.innerHTML = `
                <label class="block text-gray-700 text-sm font-bold mb-2">Procedures (CPT/HCPCS Codes):</label>
                <div class="flex items-center gap-2">
                    <input type="text" class="procedure-code flex-grow-1 focus:ring-green-500 focus:border-green-500" name="procedureCode" placeholder="e.g., 99213 (Office visit)">
                    <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                </div>
            `;
            chargeList.innerHTML = `
                <label class="block text-gray-700 text-sm font-bold mb-2">Services Rendered:</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 service-item">
                    <input type="text" class="service-description col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500" name="serviceDescription" placeholder="Service Description">
                    <input type="text" class="service-cpt-code col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500" name="serviceCptCode" placeholder="CPT Code">
                    <div class="flex gap-2 col-span-1 md:col-span-1">
                        <input type="number" class="service-price flex-grow-1 focus:ring-purple-500 focus:border-purple-500" name="servicePrice" placeholder="Price ($)" min="0" step="0.01">
                        <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                    </div>
                </div>
            `;
            claimOutput.textContent = '';
            patientData = {}; // Clear local patient data
            diagnoses = [];
            procedures = [];
            charges = [];
            showMessage('All local data cleared!', 'success');
        });

        // Medical Billing Walkthrough Event Listeners
        startBillingWalkthroughBtn.addEventListener('click', () => {
            currentBillingStep = 0;
            billingWalkthroughContent.classList.remove('hidden');
            startBillingWalkthroughBtn.classList.add('hidden');
            nextBillingWalkthroughBtn.classList.remove('hidden');
            resetBillingWalkthroughBtn.classList.remove('hidden');
            displayBillingStep();
        });

        nextBillingWalkthroughBtn.addEventListener('click', () => {
            currentBillingStep++;
            if (currentBillingStep < billingSteps.length) {
                displayBillingStep();
            } else {
                walkthroughStepTitle.textContent = "Walkthrough Complete!";
                walkthroughStepInstructions.innerHTML = "<p>You've walked through the entire medical billing revenue cycle. Great job!</p>";
                nextBillingWalkthroughBtn.classList.add('hidden');
                showMessage('Medical Billing Walkthrough Complete!', 'success');
            }
        });

        resetBillingWalkthroughBtn.addEventListener('click', () => {
            currentBillingStep = 0;
            billingWalkthroughContent.classList.add('hidden');
            startBillingWalkthroughBtn.classList.remove('hidden');
            nextBillingWalkthroughBtn.classList.add('hidden');
            resetBillingWalkthroughBtn.classList.add('hidden');
            showMessage('Medical Billing Walkthrough Reset.', 'success');
        });

        function displayBillingStep() {
            const step = billingSteps[currentBillingStep];
            walkthroughStepTitle.textContent = step.title;
            walkthroughStepInstructions.innerHTML = step.instructions;
        }

        // Prior Authorization Walkthrough Event Listeners
        startPaWalkthroughBtn.addEventListener('click', () => {
            currentPaStep = 0;
            paWalkthroughContent.classList.remove('hidden');
            startPaWalkthroughBtn.classList.add('hidden');
            nextPaWalkthroughBtn.classList.remove('hidden');
            resetPaWalkthroughBtn.classList.remove('hidden');
            displayPaStep();
        });

        nextPaWalkthroughBtn.addEventListener('click', () => {
            currentPaStep++;
            if (currentPaStep < paSteps.length) {
                displayPaStep();
            } else {
                paWalkthroughStepTitle.textContent = "PA Walkthrough Complete!";
                paWalkthroughStepInstructions.innerHTML = "<p>You've walked through the Prior Authorization process. Great job!</p>";
                nextPaWalkthroughBtn.classList.add('hidden');
                showMessage('Prior Authorization Walkthrough Complete!', 'success');
            }
        });

        resetPaWalkthroughBtn.addEventListener('click', () => {
            currentPaStep = 0;
            paWalkthroughContent.classList.add('hidden');
            startPaWalkthroughBtn.classList.remove('hidden');
            nextPaWalkthroughBtn.classList.add('hidden');
            resetPaWalkthroughBtn.classList.add('hidden');
            showMessage('PA Walkthrough Reset.', 'success');
        });

        function displayPaStep() {
            const step = paSteps[currentPaStep];
            paWalkthroughStepTitle.textContent = step.title;
            paWalkthroughStepInstructions.innerHTML = step.instructions;
        }

        // Knowledge Quizzes Event Listeners
        function loadQuiz(moduleName) {
            selectedQuizModule = quizModules[moduleName];
            currentQuizQuestionIndex = 0;
            quizContent.classList.remove('hidden');
            submitAnswerBtn.classList.remove('hidden');
            nextQuestionBtn.classList.add('hidden');
            resetQuizBtn.classList.remove('hidden');
            displayQuizQuestion();
            quizFeedback.innerHTML = '<p class="text-gray-500 quiz-feedback-text">Your feedback will appear here.</p>';
        }

        function displayQuizQuestion() {
            if (!selectedQuizModule || currentQuizQuestionIndex >= selectedQuizModule.length) {
                quizQuestionTitle.textContent = "Quiz Complete!";
                quizOptions.innerHTML = '<p class="text-lg text-center text-gray-700">You\'ve finished this quiz module!</p>';
                submitAnswerBtn.classList.add('hidden');
                nextQuestionBtn.classList.add('hidden');
                showMessage('Quiz Module Complete!', 'success');
                return;
            }

            const questionData = selectedQuizModule[currentQuizQuestionIndex];
            quizQuestionTitle.textContent = `Question ${currentQuizQuestionIndex + 1}: ${questionData.question}`;
            quizOptions.innerHTML = ''; // Clear previous options

            questionData.options.forEach((option, index) => {
                const label = document.createElement('label');
                label.className = 'quiz-option';
                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'quizOption';
                input.value = option.charAt(0); // Value is A, B, C, D
                label.appendChild(input);
                label.appendChild(document.createTextNode(option));
                quizOptions.appendChild(label);
            });
            submitAnswerBtn.classList.remove('hidden');
            nextQuestionBtn.classList.add('hidden');
            quizFeedback.innerHTML = '<p class="text-gray-500 quiz-feedback-text">Your feedback will appear here.</p>';
            // Re-enable radio buttons
            quizOptions.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = false);
        }

        submitAnswerBtn.addEventListener('click', () => {
            const selectedOption = document.querySelector('input[name="quizOption"]:checked');
            if (!selectedOption) {
                quizFeedback.innerHTML = '<p class="text-red-700 quiz-feedback-text">Please select an answer.</p>';
                quizFeedback.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
                return;
            }

            const questionData = selectedQuizModule[currentQuizQuestionIndex];
            if (selectedOption.value === questionData.answer) {
                quizFeedback.innerHTML = `<p class="text-green-700 font-bold">Correct! üéâ</p><p class="quiz-feedback-text">${questionData.explanation}</p>`;
                quizFeedback.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
            } else {
                quizFeedback.innerHTML = `<p class="text-red-700 font-bold">Incorrect. üòî</p><p class="quiz-feedback-text">The correct answer was **${questionData.answer}**. ${questionData.explanation}</p>`;
                quizFeedback.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
            }
            submitAnswerBtn.classList.add('hidden');
            nextQuestionBtn.classList.remove('hidden');
            // Disable radio buttons after submission
            quizOptions.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = true);
        });

        nextQuestionBtn.addEventListener('click', () => {
            currentQuizQuestionIndex++;
            displayQuizQuestion();
        });

        resetQuizBtn.addEventListener('click', () => {
            selectedQuizModule = null;
            currentQuizQuestionIndex = 0;
            quizContent.classList.add('hidden');
            quizFeedback.innerHTML = '<p class="text-gray-500 quiz-feedback-text">Your feedback will appear here.</p>';
            quizFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
            submitAnswerBtn.classList.add('hidden');
            nextQuestionBtn.classList.add('hidden');
            resetQuizBtn.classList.add('hidden');
            showMessage('Quiz Reset.', 'success');
        });

        quizGuidelinesBtn.addEventListener('click', () => loadQuiz("Coding Guidelines"));
        quizLawsBtn.addEventListener('click', () => loadQuiz("Healthcare Laws"));
        quizEthicsBtn.addEventListener('click', () => loadQuiz("Coding Ethics"));
        quizDenialsBtn.addEventListener('click', () => loadQuiz("Denials & Appeals"));
        quizInsuranceNuanceBtn.addEventListener('click', () => loadQuiz("Insurance Nuances"));

        // Patient Balance Calculator Event Listeners
        loadBalanceScenarioBtn.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * patientBalanceScenarios.length);
            currentBalanceScenarioData = patientBalanceScenarios[randomIndex];
            
            balanceCalculatorContent.classList.remove('hidden');
            balanceScenarioTitle.textContent = `Scenario for ${currentBalanceScenarioData.patient}:`;
            balanceScenarioDetails.innerHTML = `
                <p><strong>Plan Details:</strong></p>
                <ul>
                    <li>Copay: $${currentBalanceScenarioData.plan.copay.toFixed(2)}</li>
                    <li>Deductible: $${currentBalanceScenarioData.plan.deductible.toFixed(2)}</li>
                    <li>Deductible Met to Date: $${currentBalanceScenarioData.plan.deductibleMetToDate.toFixed(2)}</li>
                    <li>Coinsurance: ${(currentBalanceScenarioData.plan.coinsurance * 100).toFixed(0)}%</li>
                </ul>
                <p><strong>Visit Details:</strong></p>
                <ul>
                    <li>Service: ${currentBalanceScenarioData.visit.service}</li>
                    <li>Total Allowed Amount by Insurance: $${currentBalanceScenarioData.visit.allowedAmount.toFixed(2)}</li>
                </ul>
                <p class="font-bold mt-2">Calculate the Patient's Responsibility:</p>
            `;
            resetBalanceCalculator(); // Reset inputs and feedback
            checkBalanceBtn.classList.remove('hidden');
            resetBalanceBtn.classList.remove('hidden');
        });

        checkBalanceBtn.addEventListener('click', () => {
            if (!currentBalanceScenarioData) {
                balanceFeedback.innerHTML = '<p class="text-red-700 balance-feedback-text">Please load a scenario first!</p>';
                return;
            }

            const userCopay = parseFloat(userCopayInput.value);
            const userDeductibleApplied = parseFloat(userDeductibleInput.value); 
            const userCoinsurance = parseFloat(userCoinsuranceInput.value);
            const userTotalBalance = parseFloat(userTotalBalanceInput.value);

            let feedbackHtml = '';
            let allCorrect = true;

            // Check Copay
            if (userCopay === currentBalanceScenarioData.correct.copay) {
                feedbackHtml += `<p class="text-green-700">Copay: Correct! ($${currentBalanceScenarioData.correct.copay.toFixed(2)})</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Copay: Incorrect. Expected $${currentBalanceScenarioData.correct.copay.toFixed(2)}.</p>`;
                allCorrect = false;
            }

            // Check Deductible Applied
            if (userDeductibleApplied === currentBalanceScenarioData.correct.deductibleApplied) {
                feedbackHtml += `<p class="text-green-700">Deductible Applied: Correct! ($${currentBalanceScenarioData.correct.deductibleApplied.toFixed(2)})</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Deductible Applied: Incorrect. Expected $${currentBalanceScenarioData.correct.deductibleApplied.toFixed(2)}.</p>`;
                allCorrect = false;
            }

            // Check Coinsurance
            if (userCoinsurance === currentBalanceScenarioData.correct.coinsurance) {
                feedbackHtml += `<p class="text-green-700">Coinsurance: Correct! ($${currentBalanceScenarioData.correct.coinsurance.toFixed(2)})</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Coinsurance: Incorrect. Expected $${currentBalanceScenarioData.correct.coinsurance.toFixed(2)}.</p>`;
                allCorrect = false;
            }

            // Check Total Patient Balance
            if (userTotalBalance === currentBalanceScenarioData.correct.totalBalance) {
                feedbackHtml += `<p class="text-green-700 font-bold mt-2">Total Patient Balance: Correct! ($${currentBalanceScenarioData.correct.totalBalance.toFixed(2)})</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700 font-bold mt-2">Total Patient Balance: Incorrect. Expected $${currentBalanceScenarioData.correct.totalBalance.toFixed(2)}.</p>`;
                allCorrect = false;
            }

            // Overall feedback and detailed steps if incorrect
            if (!allCorrect) {
                feedbackHtml += `<p class="text-gray-700 mt-4 font-bold">Here's a breakdown of the correct calculation:</p>`;
                feedbackHtml += `<pre class="bg-gray-100 p-2 rounded text-xs mt-1 whitespace-pre-wrap">${currentBalanceScenarioData.calculationSteps.trim()}</pre>`;
                balanceFeedback.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
            } else {
                 balanceFeedback.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
            }
            
            balanceFeedback.innerHTML = feedbackHtml;
        });

        resetBalanceBtn.addEventListener('click', resetBalanceCalculator);

        function resetBalanceCalculator() {
            userCopayInput.value = '';
            userDeductibleInput.value = '';
            userCoinsuranceInput.value = '';
            userTotalBalanceInput.value = '';
            balanceFeedback.innerHTML = '<p class="text-gray-500 balance-feedback-text">Feedback on your calculation will appear here.</p>';
            balanceFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
        }

        // Modifier Application Challenge Event Listeners
        loadModifierScenarioBtn.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * modifierScenarios.length);
            currentModifierChallenge = modifierScenarios[randomIndex];
            
            modifierChallengeContent.classList.remove('hidden');
            modifierScenarioTitle.textContent = `Scenario: ${currentModifierChallenge.id}`;
            modifierScenarioDetails.innerHTML = `<p class="text-sm text-yellow-800 italic">${currentModifierChallenge.scenario}</p>
                <p class="mt-2"><strong>Required CPT Code to Input:</strong> ${currentModifierChallenge.cptCodeToInput}</p>
                <p class="font-bold mt-2">Enter the CPT Code (if different from the required) and the appropriate Modifier(s).</p>
            `;
            userModifierCPTInput.value = '';
            userModifierInput.value = '';
            modifierFeedback.innerHTML = '<p class="text-gray-500 modifier-feedback-text">Feedback on your modifier application will appear here.</p>';
            modifierFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
            checkModifierBtn.classList.remove('hidden');
            resetModifierBtn.classList.remove('hidden');
        });

        checkModifierBtn.addEventListener('click', () => {
            if (!currentModifierChallenge) {
                modifierFeedback.innerHTML = '<p class="text-red-700 modifier-feedback-text">Please load a scenario first!</p>';
                return;
            }

            const userCPT = userModifierCPTInput.value.trim().toUpperCase();
            const userMod = userModifierInput.value.trim().toUpperCase();

            let feedbackHtml = '';
            let isCorrect = true;

            // Check CPT code
            if (userCPT !== currentModifierChallenge.cptCodeToInput.trim().toUpperCase()) {
                feedbackHtml += `<p class="text-red-700">CPT Code: Incorrect. Expected "${currentModifierChallenge.cptCodeToInput}".</p>`;
                isCorrect = false;
            } else {
                feedbackHtml += `<p class="text-green-700">CPT Code: Correct! ("${currentModifierChallenge.cptCodeToInput}")</p>`;
            }

            // Check Modifier
            if (userMod !== currentModifierChallenge.correctModifier.trim().toUpperCase()) {
                feedbackHtml += `<p class="text-red-700">Modifier: Incorrect. Expected "${currentModifierChallenge.correctModifier}".</p>`;
                isCorrect = false;
            } else {
                feedbackHtml += `<p class="text-green-700">Modifier: Correct! ("${currentModifierChallenge.correctModifier}")</p>`;
            }

            if (isCorrect) {
                modifierFeedback.innerHTML = `<p class="text-green-700 font-bold">Excellent! Your CPT code and modifier application are correct.</p>`;
            } else {
                modifierFeedback.innerHTML += `<p class="text-gray-700 mt-4 font-bold">Explanation:</p><p class="modifier-feedback-text">${currentModifierChallenge.explanation}</p>`;
            }
            modifierFeedback.className = isCorrect ? 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]' : 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
        });

        resetModifierBtn.addEventListener('click', () => {
            userModifierCPTInput.value = '';
            userModifierInput.value = '';
            modifierFeedback.innerHTML = '<p class="text-gray-500 modifier-feedback-text">Feedback on your modifier application will appear here.</p>';
            modifierFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
            checkModifierBtn.classList.remove('hidden');
            resetModifierBtn.classList.remove('hidden');
        });

        // Matching Game Event Listeners
        startGameBtn.addEventListener('click', startGame);
        resetGameBtn.addEventListener('click', resetGame);

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function createCards() {
            cardGrid.innerHTML = ''; // Clear previous cards
            gameMessage.textContent = '';
            flippedCards = [];
            matchedPairs = 0;
            gameActive = true;

            cards = [];
            termPairs.forEach((pair, index) => {
                cards.push({ id: `term-${index}`, type: 'term', value: pair.term, pairId: index });
                cards.push({ id: `def-${index}`, type: 'definition', value: pair.definition, pairId: index });
            });

            shuffle(cards);

            cards.forEach(cardData => {
                const cardElement = document.createElement('div');
                cardElement.classList.add('match-card');
                cardElement.dataset.id = cardData.id;
                cardElement.dataset.pairId = cardData.pairId;
                cardElement.dataset.type = cardData.type;

                const cardFront = document.createElement('div');
                cardFront.classList.add('card-front');
                cardFront.textContent = '?'; // Placeholder for the back of the card

                const cardBack = document.createElement('div');
                cardBack.classList.add('card-back');
                cardBack.textContent = cardData.value;

                cardElement.appendChild(cardFront);
                cardElement.appendChild(cardBack);
                cardGrid.appendChild(cardElement);

                cardElement.addEventListener('click', () => flipCard(cardElement, cardData));
            });
        }

        function flipCard(cardElement, cardData) {
            if (!gameActive || flippedCards.length === 2 || cardElement.classList.contains('is-flipped') || cardElement.classList.contains('matched')) {
                return; // Do nothing if game not active, two cards already flipped, or card already flipped/matched
            }

            cardElement.classList.add('is-flipped');
            flippedCards.push({ element: cardElement, data: cardData });

            if (flippedCards.length === 2) {
                checkForMatch();
            }
        }

        function checkForMatch() {
            const [card1, card2] = flippedCards;
            const isMatch = card1.data.pairId === card2.data.pairId;

            if (isMatch) {
                card1.element.classList.add('matched');
                card2.element.classList.add('matched');
                gameMessage.textContent = 'Match found!';
                matchedPairs++;
                if (matchedPairs === termPairs.length) {
                    gameMessage.textContent = 'Congratulations! You matched all pairs!';
                    gameActive = false;
                }
                flippedCards = []; // Clear flipped cards for next turn
            } else {
                gameMessage.textContent = 'No match. Try again!';
                // Add incorrect class temporarily for visual feedback
                card1.element.classList.add('incorrect');
                card2.element.classList.add('incorrect');

                setTimeout(() => {
                    card1.element.classList.remove('is-flipped', 'incorrect');
                    card2.element.classList.remove('is-flipped', 'incorrect');
                    flippedCards = []; // Clear flipped cards
                    gameMessage.textContent = ''; // Clear message
                }, 1000); // Flip back after 1 second
            }
        }

        function startGame() {
            matchingGameContent.classList.remove('hidden');
            startGameBtn.classList.add('hidden');
            resetGameBtn.classList.remove('hidden');
            createCards();
            gameMessage.textContent = 'Find the matching pairs!';
        }

        function resetGame() {
            matchingGameContent.classList.add('hidden');
            startGameBtn.classList.remove('hidden');
            resetGameBtn.classList.add('hidden');
            cardGrid.innerHTML = '';
            gameMessage.textContent = '';
            flippedCards = [];
            matchedPairs = 0;
            gameActive = false;
            showMessage('Matching Game Reset.', 'success');
        }

        // Claim Scrubber Event Listeners
        loadScrubberScenarioBtn.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * claimScrubberScenarios.length);
            currentScrubberScenarioData = claimScrubberScenarios[randomIndex];
            
            scrubberChallengeContent.classList.remove('hidden');
            scrubberScenarioTitle.textContent = `Claim Scrubber: ${currentScrubberScenarioData.title}`;
            scrubberScenarioDetails.innerHTML = `<p class="text-sm text-orange-800 italic">${currentScrubberScenarioData.description}</p>
                <p class="mt-2 font-bold">Your Task: Correct the errors in the presented claim details below.</p>
            `;
            presentedClaimOutput.textContent = `
Patient Notes: ${currentScrubberScenarioData.presentedClaim.notes}
Diagnosis: ${currentScrubberScenarioData.presentedClaim.diagnosis}
CPT Code(s): ${currentScrubberScenarioData.presentedClaim.cpt}
Modifier(s): ${currentScrubberScenarioData.presentedClaim.modifier}
            `.trim();
            
            resetScrubberInputsAndFeedback(); // Reset inputs and feedback
            checkScrubberBtn.classList.remove('hidden');
            resetScrubberBtn.classList.remove('hidden');
        });

        checkScrubberBtn.addEventListener('click', () => {
            if (!currentScrubberScenarioData) {
                scrubberFeedback.innerHTML = '<p class="text-red-700 scrubber-feedback-text">Please load a scenario first!</p>';
                return;
            }

            const userICD = userScrubberICDInput.value.trim().toUpperCase();
            const userCPT = userScrubberCPTInput.value.trim().toUpperCase();
            const userModifier = userScrubberModifierInput.value.trim().toUpperCase();

            let feedbackHtml = '';
            let allCorrect = true;

            // Helper to compare inputs, treating "NONE" or empty as the same for modifiers
            const compareInput = (userInput, expectedValue) => {
                if (expectedValue.toLowerCase() === 'none' || expectedValue.toLowerCase() === '') {
                    return userInput === '' || userInput.toLowerCase() === 'none';
                }
                // For ICDs, allow comma-separated and check if all expected are present.
                if (expectedValue.includes(',')) {
                    const expectedParts = expectedValue.split(',').map(p => p.trim());
                    const userParts = userInput.split(',').map(p => p.trim());
                    const allExpectedFound = expectedParts.every(part => userParts.includes(part));
                    const noExtraParts = userParts.every(part => expectedParts.includes(part));
                    return allExpectedFound && noExtraParts;
                }
                return userInput === expectedValue;
            };

            // Check ICD
            if (!compareInput(userICD, currentScrubberScenarioData.expectedInputs.correctedICD.toUpperCase())) {
                const error = currentScrubberScenarioData.errors.find(e => e.type === 'diagnosis' || e.type === 'diagnosis-medical-necessity');
                feedbackHtml += `<p class="text-red-700">ICD-10 Code: Incorrect. Expected "${currentScrubberScenarioData.expectedInputs.correctedICD}".</p>`;
                if (error) feedbackHtml += `<p class="text-gray-700 text-sm mt-1">${error.explanation}</p>`;
                allCorrect = false;
            } else {
                feedbackHtml += `<p class="text-green-700">ICD-10 Code: Correct! ("${currentScrubberScenarioData.expectedInputs.correctedICD}")</p>`;
            }

            // Check CPT
            if (!compareInput(userCPT, currentScrubberScenarioData.expectedInputs.correctedCPT.toUpperCase())) {
                const error = currentScrubberScenarioData.errors.find(e => e.type === 'cpt');
                feedbackHtml += `<p class="text-red-700">CPT Code: Incorrect. Expected "${currentScrubberScenarioData.expectedInputs.correctedCPT}".</p>`;
                if (error) feedbackHtml += `<p class="text-gray-700 text-sm mt-1">${error.explanation}</p>`;
                allCorrect = false;
            } else {
                feedbackHtml += `<p class="text-green-700">CPT Code: Correct! ("${currentScrubberScenarioData.expectedInputs.correctedCPT}")</p>`;
            }

            // Check Modifier
            if (!compareInput(userModifier, currentScrubberScenarioData.expectedInputs.correctedModifier.toUpperCase())) {
                const error = currentScrubberScenarioData.errors.find(e => e.type === 'modifier');
                 feedbackHtml += `<p class="text-red-700">Modifier(s): Incorrect. Expected "${currentScrubberScenarioData.expectedInputs.correctedModifier}".</p>`;
                 if (error) feedbackHtml += `<p class="text-gray-700 text-sm mt-1">${error.explanation}</p>`;
                 allCorrect = false;
            } else {
                feedbackHtml += `<p class="text-green-700">Modifier(s): Correct! ("${currentScrubberScenarioData.expectedInputs.correctedModifier}")</p>`;
            }

            if (allCorrect) {
                scrubberFeedback.innerHTML = `<p class="text-green-700 font-bold">Excellent! You found and corrected all errors in this claim.</p>`;
                scrubberFeedback.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
            } else {
                scrubberFeedback.innerHTML = `<p class="text-red-700 font-bold">Not quite right. Review the feedback:</p>` + feedbackHtml;
                scrubberFeedback.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
            }
        });

        resetScrubberBtn.addEventListener('click', resetScrubberInputsAndFeedback);

        function resetScrubberInputsAndFeedback() {
            userScrubberICDInput.value = '';
            userScrubberCPTInput.value = '';
            userScrubberModifierInput.value = '';
            scrubberFeedback.innerHTML = '<p class="text-gray-500 scrubber-feedback-text">Feedback on your corrections will appear here.</p>';
            scrubberFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
        }

        // Denial Code Interpreter Event Listeners
        loadDenialScenarioBtn.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * denialScenarios.length);
            currentDenialScenarioData = denialScenarios[randomIndex];
            
            denialChallengeContent.classList.remove('hidden');
            denialScenarioTitle.textContent = `Denial Challenge: ${currentDenialScenarioData.denialCode}`;
            denialScenarioDetails.innerHTML = `<p class="text-sm text-purple-800 italic">Context: ${currentDenialScenarioData.context}</p>`;
            
            denialInterpretationOptions.innerHTML = ''; // Clear previous options
            currentDenialScenarioData.interpretations.forEach((interpretation, index) => {
                const label = document.createElement('label');
                label.className = 'denial-option';
                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'denialInterpretation';
                input.id = `denialOption${index}`; // Add unique ID for the radio button
                input.value = index; // Use index to map back to the interpretation object
                label.setAttribute('for', `denialOption${index}`); // Link label to input via 'for'
                label.appendChild(input);
                label.appendChild(document.createTextNode(interpretation.text));
                denialInterpretationOptions.appendChild(label);
            });

            resetDenialInputsAndFeedback();
            checkDenialBtn.classList.remove('hidden');
            resetDenialBtn.classList.remove('hidden');
        });

        checkDenialBtn.addEventListener('click', () => {
            if (!currentDenialScenarioData) {
                denialFeedback.innerHTML = '<p class="text-red-700 denial-feedback-text">Please load a scenario first!</p>';
                return;
            }

            const selectedInterpretationOption = document.querySelector('input[name="denialInterpretation"]:checked');
            const userActionPlan = userActionPlanInput.value.trim().toUpperCase();

            let feedbackHtml = '';
            let allCorrect = true;

            // Check Interpretation
            if (!selectedInterpretationOption) {
                feedbackHtml += `<p class="text-red-700">Interpretation: Please select an interpretation.</p>`;
                allCorrect = false;
            } else {
                const selectedInterpretationIndex = parseInt(selectedInterpretationOption.value);
                const isInterpretationCorrect = currentDenialScenarioData.interpretations[selectedInterpretationIndex].correct;
                
                if (isInterpretationCorrect) {
                    feedbackHtml += `<p class="text-green-700">Interpretation: Correct! ("${currentDenialScenarioData.interpretations[selectedInterpretationIndex].text}")</p>`;
                } else {
                    const correctText = currentDenialScenarioData.interpretations.find(i => i.correct).text;
                    feedbackHtml += `<p class="text-red-700">Interpretation: Incorrect. The correct interpretation is: "${correctText}".</p>`;
                    allCorrect = false;
                }
            }

            // Check Action Plan (using keywords)
            const correctActionKeywords = currentDenialScenarioData.correctActionPlanKeywords.map(k => k.toUpperCase());
            const userActionWords = userActionPlan.split(/\s|,\s*/).filter(word => word !== '').map(word => word.toUpperCase());
            
            let actionPlanCorrect = true;
            let missingKeywords = [];
            let extraKeywords = [];

            correctActionKeywords.forEach(keyword => {
                if (!userActionWords.includes(keyword)) {
                    missingKeywords.push(keyword);
                    actionPlanCorrect = false;
                }
            });

            userActionWords.forEach(word => {
                if (!correctActionKeywords.includes(word)) {
                    extraKeywords.push(word);
                }
            });

            if (actionPlanCorrect && extraKeywords.length === 0) { // All correct keywords present, no extra unexpected ones
                feedbackHtml += `<p class="text-green-700 mt-2">Action Plan: Well done! Your action plan is comprehensive.</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700 mt-2">Action Plan: Review your action plan.</p>`;
                if (missingKeywords.length > 0) {
                    feedbackHtml += `<p class="text-red-700 text-sm">Missing key elements: ${missingKeywords.join(', ')}.</p>`;
                }
                if (extraKeywords.length > 0) {
                    feedbackHtml += `<p class="text-red-700 text-sm">You included some unexpected elements: ${extraKeywords.join(', ')}.</p>`;
                }
                allCorrect = false;
            }

            // Overall feedback
            if (allCorrect) {
                denialFeedback.innerHTML = `<p class="text-green-700 font-bold">Excellent! You correctly interpreted the denial and formulated the ideal action plan.</p>`;
                denialFeedback.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
            } else {
                denialFeedback.innerHTML = `<p class="text-red-700 font-bold">Not quite perfect. Review the feedback and explanation:</p>` + feedbackHtml;
                denialFeedback.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
            }
            denialFeedback.innerHTML += `<p class="text-gray-700 mt-4 font-bold">Detailed Explanation for Resolution:</p><p class="denial-feedback-text">${currentDenialScenarioData.explanation}</p>`;

            // Disable inputs after checking
            denialInterpretationOptions.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = true);
            userActionPlanInput.disabled = true;
        });

        resetDenialBtn.addEventListener('click', resetDenialInputsAndFeedback);

        function resetDenialInputsAndFeedback() {
            denialInterpretationOptions.innerHTML = '<p class="text-gray-500 denial-scenario-text">Select an interpretation.</p>'; // Reset radio buttons
            userActionPlanInput.value = '';
            userActionPlanInput.disabled = false;
            denialInterpretationOptions.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = false);
            denialFeedback.innerHTML = '<p class="text-gray-500 denial-feedback-text">Feedback on your denial resolution plan will appear here.</p>';
            denialFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
        }

        // SOAP Note Coder & Extractor Event Listeners
        loadSoapScenarioBtn.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * soapNoteScenarios.length);
            currentSoapScenarioData = soapNoteScenarios[randomIndex];
            
            soapChallengeContent.classList.remove('hidden');
            soapScenarioTitle.textContent = `SOAP Note Challenge: ${currentSoapScenarioData.title}`;
            soapScenarioDescription.textContent = currentSoapScenarioData.description;
            soapNoteDisplay.textContent = currentSoapScenarioData.soapNote;
            
            resetSoapInputsAndFeedback();
            checkSoapBtn.classList.remove('hidden');
            resetSoapBtn.classList.remove('hidden');
        });

        checkSoapBtn.addEventListener('click', () => {
            if (!currentSoapScenarioData) {
                soapFeedback.innerHTML = '<p class="text-red-700 soap-feedback-text">Please load a scenario first!</p>';
                return;
            }

            const userChiefComplaint = userSoapChiefComplaintInput.value.trim();
            const userICD = userSoapICDInput.value.trim().toUpperCase().split(',').map(s => s.trim()).filter(s => s !== '');
            const userCPT = userSoapCPTInput.value.trim().toUpperCase().split(',').map(s => s.trim()).filter(s => s !== '');
            const userModifier = userSoapModifierInput.value.trim().toUpperCase();
            const userPlan = userSoapPlanInput.value.trim().toUpperCase();

            let feedbackHtml = '';
            let allCorrect = true;

            // Helper to compare arrays of codes, ignoring order
            const compareCodeArrays = (userArray, expectedArray) => {
                if (userArray.length !== expectedArray.length) return false;
                const sortedUser = [...userArray].sort();
                const sortedExpected = [...expectedArray].sort();
                for (let i = 0; i < sortedUser.length; i++) {
                    if (sortedUser[i] !== sortedExpected[i]) return false;
                }
                return true;
            };

            // Check Chief Complaint
            if (userChiefComplaint.toLowerCase() === currentSoapScenarioData.expected.chiefComplaint.toLowerCase()) {
                feedbackHtml += `<p class="text-green-700">Chief Complaint: Correct! ("${currentSoapScenarioData.expected.chiefComplaint}")</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Chief Complaint: Incorrect. Expected: "${currentSoapScenarioData.expected.chiefComplaint}".</p>`;
                allCorrect = false;
            }

            // Check Primary ICD-10
            const expectedICD = currentSoapScenarioData.expected.icd10.split(',').map(s => s.trim().toUpperCase());
            if (compareCodeArrays(userICD, expectedICD)) {
                feedbackHtml += `<p class="text-green-700">Primary ICD-10 Code(s): Correct! ("${currentSoapScenarioData.expected.icd10}")</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Primary ICD-10 Code(s): Incorrect. Expected: "${currentSoapScenarioData.expected.icd10}".</p>`;
                allCorrect = false;
            }

            // Check Primary CPT
            const expectedCPT = currentSoapScenarioData.expected.cpt.split(',').map(s => s.trim().toUpperCase());
            if (compareCodeArrays(userCPT, expectedCPT)) {
                feedbackHtml += `<p class="text-green-700">Primary CPT Code(s): Correct! ("${currentSoapScenarioData.expected.cpt}")</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Primary CPT Code(s): Incorrect. Expected: "${currentSoapScenarioData.expected.cpt}".</p>`;
                allCorrect = false;
            }

            // Check Modifier
            const expectedModifier = currentSoapScenarioData.expected.modifier.toUpperCase();
            const userModNormalized = (userSoapModifierInput.value.trim().toUpperCase() === 'NONE' || userSoapModifierInput.value.trim() === '') ? 'NONE' : userSoapModifierInput.value.trim().toUpperCase();

            if (userModNormalized === expectedModifier) {
                feedbackHtml += `<p class="text-green-700">Modifier(s): Correct! ("${expectedModifier}")</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Modifier(s): Incorrect. Expected: "${expectedModifier}".</p>`;
                allCorrect = false;
            }

            // Check Key Plan Elements (using keywords)
            const expectedPlanKeywords = currentSoapScenarioData.expected.planKeywords.map(k => k.toUpperCase());
            const userPlanWords = userPlan.split(/\s|,\s*|\.\s*|;\s*/).filter(word => word !== '').map(word => word.toUpperCase());
            
            let planCorrect = true;
            let missingPlanKeywords = [];
            let extraPlanKeywords = [];

            expectedPlanKeywords.forEach(keyword => {
                if (!userPlanWords.some(word => word.includes(keyword))) { // Check if any user word contains the keyword
                    missingPlanKeywords.push(keyword);
                    planCorrect = false;
                }
            });

            userPlanWords.forEach(word => {
                if (!expectedPlanKeywords.includes(word) && !expectedPlanKeywords.some(kw => word.includes(kw))) {
                    extraPlanKeywords.push(word);
                }
            });

            if (planCorrect && extraPlanKeywords.length === 0) {
                feedbackHtml += `<p class="text-green-700 mt-2">Key Plan Elements: Well done! Your summary covers the main points.</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700 mt-2">Key Plan Elements: Review your plan summary.</p>`;
                if (missingPlanKeywords.length > 0) {
                    feedbackHtml += `<p class="text-red-700 text-sm">Missing key elements: ${missingPlanKeywords.join(', ')}.</p>`;
                }
                if (extraPlanKeywords.length > 0) {
                    feedbackHtml += `<p class="text-red-700 text-sm">You included some unexpected elements: ${extraKeywords.join(', ')}.</p>`;
                }
                allCorrect = false;
            }

            // Overall feedback
            if (allCorrect) {
                soapFeedback.innerHTML = `<p class="text-green-700 font-bold">Excellent! You correctly extracted all key information from the SOAP note.</p>`;
                soapFeedback.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
            } else {
                soapFeedback.innerHTML = `<p class="text-red-700 font-bold">Not quite perfect. Review the feedback and explanation:</p>` + feedbackHtml;
                soapFeedback.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
            }
            soapFeedback.innerHTML += `<p class="text-gray-700 mt-4 font-bold">Detailed Explanation:</p><p class="soap-feedback-text">${currentSoapScenarioData.explanation}</p>`;

            // Disable inputs after checking
            userSoapChiefComplaintInput.disabled = true;
            userSoapICDInput.disabled = true;
            userSoapCPTInput.disabled = true;
            userSoapModifierInput.disabled = true;
            userSoapPlanInput.disabled = true;
        });

        resetSoapBtn.addEventListener('click', resetSoapInputsAndFeedback);

        function resetSoapInputsAndFeedback() {
            userSoapChiefComplaintInput.value = '';
            userSoapICDInput.value = '';
            userSoapCPTInput.value = '';
            userSoapModifierInput.value = '';
            userSoapPlanInput.value = '';
            userSoapChiefComplaintInput.disabled = false;
            userSoapICDInput.disabled = false;
            userSoapCPTInput.disabled = false;
            userSoapModifierInput.disabled = false;
            userSoapPlanInput.disabled = false;
            soapFeedback.innerHTML = '<p class="text-gray-500 soap-feedback-text">Feedback on your extraction will appear here.</p>';
            soapFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
        }

        // Code Lookup Tool Event Listeners (MODIFIED)
        lookupCodeBtn.addEventListener('click', () => {
            const searchTerm = codeLookupInput.value.trim();
            if (searchTerm === '') {
                showMessage('Please enter a code or phrase to look up.', 'error');
                codeLookupResult.innerHTML = '<p class="text-red-700">Please enter a code or phrase to look up.</p>';
                codeLookupResult.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
                return;
            }

            // Determine if the input is likely a code or a phrase
            // Simple regex: ICD-10 usually has letter-number.number or letter.number, CPT/HCPCS are usually 5 digits or letter-number-letter-number.
            const isCode = /^[A-Z]\d{2}(\.\d{1,4})?$|^\d{5}$|^[A-Z]\d{4}$/i.test(searchTerm); // A12.3456, 12345, A1234

            if (isCode) {
                const code = searchTerm.toUpperCase();
                const description = codeDatabase[code];
                if (description) {
                    codeLookupResult.innerHTML = `<p class="text-green-700 font-bold">Code found:</p><p class="code-lookup-text">${code}: ${description}</p>`;
                    codeLookupResult.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
                } else {
                    codeLookupResult.innerHTML = `<p class="text-red-700 font-bold">Code not found.</p><p class="code-lookup-text">"${code}" is not in our current database. Please try another common ICD-10, CPT, or HCPCS code (e.g., J02.0, 99213, G0439).</p>`;
                    codeLookupResult.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
                }
            } else {
                // Search by phrase
                const lowerCaseSearchTerm = searchTerm.toLowerCase();
                let matchingCodes = [];
                for (const code in codeDatabase) {
                    const description = codeDatabase[code];
                    if (description.toLowerCase().includes(lowerCaseSearchTerm)) {
                        matchingCodes.push({ code: code, description: description });
                    }
                }

                if (matchingCodes.length > 0) {
                    let resultsHtml = `<p class="text-green-700 font-bold">Matches for "${searchTerm}":</p><ul class="list-disc list-inside mt-2 text-gray-800">`;
                    matchingCodes.forEach(match => {
                        resultsHtml += `<li class="code-lookup-text"><strong>${match.code}:</strong> ${match.description}</li>`;
                    });
                    resultsHtml += `</ul>`;
                    codeLookupResult.innerHTML = resultsHtml;
                    codeLookupResult.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
                } else {
                    codeLookupResult.innerHTML = `<p class="text-red-700 font-bold">No descriptions found containing "${searchTerm}".</p><p class="code-lookup-text">Try a different phrase or a specific code.</p>`;
                    codeLookupResult.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
                }
            }
        });

        // A/R Aging Simulation Event Listeners
        loadArScenarioBtn.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * arAgingScenarios.length);
            currentArScenarioClaims = arAgingScenarios[randomIndex].claims;
            
            arAgingContent.classList.remove('hidden');
            arClaimList.innerHTML = ''; // Clear previous claims

            currentArScenarioClaims.forEach((claim, index) => {
                const claimDiv = document.createElement('div');
                claimDiv.classList.add('ar-claim-item');
                claimDiv.dataset.index = index; // Store index for easy lookup

                claimDiv.innerHTML = `
                    <h3 class="font-semibold text-gray-800">Claim ID: ${claim.claimId}</h3>
                    <div class="ar-claim-details">
                        <p><strong>Patient:</strong> ${claim.patient}</p>
                        <p><strong>Payer:</strong> ${claim.payer}</p>
                        <p><strong>Amount:</strong> $${claim.amount.toFixed(2)}</p>
                        <p><strong>Days Old:</strong> ${claim.daysOld}</p>
                    </div>
                    <label for="arAction-${index}" class="block text-gray-700 text-sm font-bold mb-2">Your Action:</label>
                    <select id="arAction-${index}" name="arAction-${index}" class="ar-action-select focus:ring-red-500 focus:border-red-500 w-full">
                        <option value="">-- Select Action --</option>
                        <option value="check_status_online">Check claim status online (payer portal).</option>
                        <option value="call_payer">Call payer (provider services) for status/details.</option>
                        <option value="review_eob_era">Review EOB/ERA for denial reason/details.</option>
                        <option value="submit_appeal">Submit an appeal with supporting documentation.</option>
                        <option value="correct_resubmit">Correct simple errors and resubmit claim.</option>
                        <option value="bill_patient">Bill patient (if patient responsibility is indicated).</option>
                        <option value="write_off">Write off balance (e.g., timely filing, contractual adjustment).</option>
                        <option value="monitor_further">Monitor further, still within initial processing time.</option>
                    </select>
                    <div id="arFeedback-${index}" class="ar-claim-feedback hidden"></div>
                `;
                arClaimList.appendChild(claimDiv);
            });

            arFeedback.innerHTML = '<p class="text-gray-500">Feedback on your A/R actions will appear here.</p>';
            arFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]';
            checkArActionsBtn.classList.remove('hidden');
            resetArScenarioBtn.classList.remove('hidden');
        });

        checkArActionsBtn.addEventListener('click', () => {
            let allCorrect = true;
            currentArScenarioClaims.forEach((claim, index) => {
                const selectElement = document.getElementById(`arAction-${index}`);
                const userAction = selectElement.value;
                const feedbackDiv = document.getElementById(`arFeedback-${index}`);
                
                let isClaimCorrect = false;
                // Determine correctness based on daysOld and user selection
                if (claim.daysOld <= 30 && userAction === "monitor_further") {
                    isClaimCorrect = true;
                } else if (claim.daysOld > 30 && claim.daysOld <= 60 && (userAction === "check_status_online" || userAction === "call_payer")) {
                    isClaimCorrect = true;
                } else if (claim.daysOld > 60 && claim.daysOld <= 90 && (userAction === "call_payer" || userAction === "review_eob_era" || userAction === "submit_appeal" || userAction === "correct_resubmit")) {
                     isClaimCorrect = true;
                } else if (claim.daysOld > 90 && (userAction === "review_eob_era" || userAction === "submit_appeal" || userAction === "correct_resubmit" || userAction === "write_off")) {
                    isClaimCorrect = true;
                }
                // Specific conditions override general if applicable (e.g., patient billing or write-off)
                if (claim.correctAction.includes(userAction)) { // Check if user's action is one of the allowed correct actions
                    isClaimCorrect = true;
                }


                feedbackDiv.classList.remove('hidden');
                if (isClaimCorrect) {
                    feedbackDiv.classList.add('correct');
                    feedbackDiv.classList.remove('incorrect');
                    feedbackDiv.innerHTML = `<p>Correct Action: ${claim.correctAction}</p><p class="mt-1 text-xs">(${claim.explanation})</p>`;
                } else {
                    feedbackDiv.classList.add('incorrect');
                    feedbackDiv.classList.remove('correct');
                    feedbackDiv.innerHTML = `<p>Incorrect. Expected action: ${claim.correctAction}</p><p class="mt-1 text-xs">(${claim.explanation})</p>`;
                    allCorrect = false;
                }
                selectElement.disabled = true; // Disable selection after checking
            });

            if (allCorrect) {
                arFeedback.innerHTML = '<p class="text-green-700 font-bold">Excellent! You correctly identified the best action for all aging claims.</p>';
                arFeedback.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
            } else {
                arFeedback.innerHTML = '<p class="text-red-700 font-bold">Review the feedback for each claim. Some actions were not ideal.</p>';
                arFeedback.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
            }
        });

        resetArScenarioBtn.addEventListener('click', () => {
            arAgingContent.classList.add('hidden');
            loadArScenarioBtn.classList.remove('hidden');
            arClaimList.innerHTML = '';
            arFeedback.innerHTML = '<p class="text-gray-500">Feedback on your A/R actions will appear here.</p>';
            arFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]';
            resetArScenarioBtn.classList.add('hidden');
            checkArActionsBtn.classList.add('hidden');
            showMessage('A/R Aging Scenario Reset.', 'success');
        });

    </script>
    <script>
    // --------------------------------------------------------------------------------------
    // --- Data Definitions (Quizzes, Scenarios, etc.) ---
    // --------------------------------------------------------------------------------------

    const quizzes = {
        'Coding Guidelines': [
            {
                question: 'When should a CPT modifier be used?',
                options: [
                    'To increase the payment amount for a service.',
                    'To report a service that was altered from its standard description.',
                    'To denote an unusual diagnosis.',
                    'To indicate the number of times a procedure was performed.'
                ],
                answer: 'To report a service that was altered from its standard description.',
                feedback: 'Correct! Modifiers provide additional information about a service without changing the original CPT code.'
            },
            {
                question: 'What is the purpose of the ICD-10-CM coding system?',
                options: [
                    'To describe medical services and procedures performed by physicians.',
                    'To classify and code all diagnoses, symptoms, and procedures recorded in hospitals.',
                    'To track drug usage in outpatient settings.',
                    'To identify the type of durable medical equipment used by a patient.'
                ],
                answer: 'To classify and code all diagnoses, symptoms, and procedures recorded in hospitals.',
                feedback: 'Correct! ICD-10-CM is the official system for medical diagnoses in the U.S. healthcare system.'
            },
            {
                question: 'Which of the following is true about selecting an E/M code?',
                options: [
                    'The highest code is always used for complex cases.',
                    'It is based on the patient‚Äôs age and gender.',
                    'It depends on the complexity of the visit, including history, exam, and medical decision making.',
                    'The same E/M code can be used for all visits by the same patient.'
                ],
                answer: 'It depends on the complexity of the visit, including history, exam, and medical decision making.',
                feedback: 'Correct! E/M (Evaluation and Management) codes are chosen based on the level of service provided, often determined by the complexity of the visit documentation.'
            }
        ],
        'Healthcare Laws': [
            {
                question: 'What is the primary purpose of HIPAA?',
                options: [
                    'To set standards for hospital accreditation.',
                    'To provide health insurance to low-income families.',
                    'To protect the privacy and security of patient health information.',
                    'To regulate drug pricing and pharmacy operations.'
                ],
                answer: 'To protect the privacy and security of patient health information.',
                feedback: 'Correct! HIPAA (Health Information Portability and Accountability Act) sets national standards to protect sensitive patient data.'
            },
            {
                question: 'What does the Stark Law prohibit?',
                options: [
                    'Billing for services not rendered.',
                    'Physicians from referring patients to entities in which they or a family member have a financial interest.',
                    'Upcoding services to increase reimbursement.',
                    'Billing patients for services that were not medically necessary.'
                ],
                answer: 'Physicians from referring patients to entities in which they or a family member have a financial interest.',
                feedback: 'Correct! The Stark Law, also known as the Physician Self-Referral Law, is meant to prevent conflicts of interest.'
            },
            {
                question: 'Which of these acts governs Medicare and Medicaid reimbursement?',
                options: [
                    'The Patient Protection and Affordable Care Act (PPACA).',
                    'The Social Security Act.',
                    'The False Claims Act.',
                    'The Health Information Technology for Economic and Clinical Health (HITECH) Act.'
                ],
                answer: 'The Social Security Act.',
                feedback: 'Correct! The Social Security Act establishes the statutory authority for the Medicare and Medicaid programs.'
            }
        ],
        'Coding Ethics': [
            {
                question: 'What is the most important ethical principle for a medical coder?',
                options: [
                    'To bill for the highest possible level of service.',
                    'To ensure maximum reimbursement for the provider.',
                    'To accurately represent the patient encounter in a compliant manner.',
                    'To protect the financial interests of the practice.'
                ],
                answer: 'To accurately represent the patient encounter in a compliant manner.',
                feedback: 'Correct! The primary ethical duty of a coder is to be accurate and compliant with all coding rules, regardless of financial impact.'
            },
            {
                question: 'What is "upcoding"?',
                options: [
                    'Coding a diagnosis to a higher level of specificity.',
                    'Submitting a claim with incorrect patient information.',
                    'Billing for a more expensive service than was actually provided.',
                    'Using an outdated code that is no longer valid.'
                ],
                answer: 'Billing for a more expensive service than was actually provided.',
                feedback: 'Correct! Upcoding is a form of fraud that involves submitting codes for a higher level of service or a more severe diagnosis than what was documented.'
            },
            {
                question: 'You find a mistake on a claim from a previous month that resulted in a small overpayment. What should you do?',
                options: [
                    'Ignore it, as the amount is too small to matter.',
                    'Correct the mistake and resubmit the claim for the correct amount.',
                    'Report the overpayment to the payer and return the funds.',
                    'Keep the money and apply it as a credit for the next visit.'
                ],
                answer: 'Report the overpayment to the payer and return the funds.',
                feedback: 'Correct! Under the False Claims Act, failing to report and return an overpayment can be considered fraud.'
            }
        ],
        'Denials & Appeals': [
            {
                question: 'A claim is denied with reason code CO-16. What does this typically indicate?',
                options: [
                    'Services were not medically necessary.',
                    'A claim has been duplicated.',
                    'The patient is not eligible for this service.',
                    'The claim was submitted to the wrong payer.'
                ],
                answer: 'The patient is not eligible for this service.',
                feedback: 'Correct! CO-16 means "Claim/service lacks information which is needed for adjudication." Ineligibility is a common reason for this code.'
            },
            {
                question: 'What is the first step in the appeals process for a denied claim?',
                options: [
                    'File a lawsuit against the payer.',
                    'Resubmit the claim with a new set of codes.',
                    'Review the payer‚Äôs policy and appeal process for the specific denial reason.',
                    'Immediately write off the balance to the patient.'
                ],
                answer: 'Review the payer‚Äôs policy and appeal process for the specific denial reason.',
                feedback: 'Correct! Research is key. You must understand why the claim was denied before you can formulate a successful appeal.'
            }
        ],
        'Insurance Nuances': [
            {
                question: 'What is the "Deductible" in a health insurance plan?',
                options: [
                    'The fixed amount a patient pays for a doctor‚Äôs visit.',
                    'The maximum amount a patient will pay in a year.',
                    'The amount the patient must pay out-of-pocket before their insurance starts paying for services.',
                    'The percentage of the cost of a medical service paid by the patient after the deductible is met.'
                ],
                answer: 'The amount the patient must pay out-of-pocket before their insurance starts paying for services.',
                feedback: 'Correct! The deductible is the initial out-of-pocket amount a patient must pay before their insurance begins to cover costs.'
            },
            {
                question: 'What is the difference between a PPO and an HMO?',
                options: [
                    'PPO plans are always more expensive than HMO plans.',
                    'HMO plans require you to have a primary care provider (PCP) and get referrals to see specialists; PPOs do not.',
                    'PPO plans cover preventative care, while HMO plans do not.',
                    'HMO plans have no deductibles or copays.'
                ],
                answer: 'HMO plans require you to have a primary care provider (PCP) and get referrals to see specialists; PPOs do not.',
                feedback: 'Correct! This is a primary difference. PPO plans offer more flexibility to see out-of-network providers without a referral.'
            }
        ]
    };

    const balanceScenarios = [
        {
            title: 'Scenario 1: Standard Office Visit',
            details: 'The patient has a **$50 copay** for a primary care office visit. Their **$1,000 deductible** and **20% coinsurance** have not been met. The total charge for the visit is **$150**. How much does the patient owe today?',
            answers: { copay: 50, deductible: 0, coinsurance: 0, total: 50 }
        },
        {
            title: 'Scenario 2: Deductible Not Met',
            details: 'The patient has a **$50 copay** and a **$1,000 deductible**. The total charge is **$200**. The patient has paid **$0** towards their deductible so far. How much does the patient owe today? (Remember, the copay may be waived or applied differently in a deductible-first plan.)',
            answers: { copay: 0, deductible: 200, coinsurance: 0, total: 200 }
        },
        {
            title: 'Scenario 3: Coinsurance Kicks In',
            details: 'The patient has a **$500 deductible** and a **10% coinsurance**. Their deductible has been fully met from a previous visit. The total charge for today\'s visit is **$100**. How much does the patient owe?',
            answers: { copay: 0, deductible: 0, coinsurance: 10, total: 10 }
        },
        {
            title: 'Scenario 4: Combination of Deductible & Coinsurance',
            details: 'The patient has a **$2,000 deductible** and **30% coinsurance**. They have already paid **$1,800** toward their deductible. The total charge for today\'s visit is **$500**. How much does the patient owe today?',
            answers: { copay: 0, deductible: 200, coinsurance: 90, total: 290 }
        }
    ];

    const modifierScenarios = [
        {
            title: 'Scenario 1: Evaluation and Management (E/M) on the Same Day',
            details: 'A patient presents to the clinic for an office visit (E/M code). During the visit, the provider performs a minor surgical procedure that is normally a part of the office visit. However, the documentation shows that the E/M service was significant and separately identifiable from the procedure. What codes and modifiers should be used?',
            cpt: '99213',
            modifier: '25',
            feedback: 'Correct! Modifier 25 is used to indicate that a significant, separately identifiable E/M service was performed on the same day as a minor surgical procedure. The CPT code would be the appropriate E/M code for the visit.'
        },
        {
            title: 'Scenario 2: Distinct Procedural Service',
            details: 'A patient has a mole removed from their left arm (CPT 17000). During the same visit, they have another, unrelated mole removed from their right leg (CPT 17000). The two procedures are distinct and separate from each other. What codes and modifiers should be used?',
            cpt: '17000',
            modifier: '59',
            feedback: 'Correct! Modifier 59 is used to identify a distinct procedural service. Since the two mole removals were on different, separate sites (arm and leg), this modifier is appropriate to show they are not duplicate services.'
        },
        {
            title: 'Scenario 3: Discontinued Procedure',
            details: 'A provider begins a procedure (CPT 43235, EGD) but must discontinue it due to equipment malfunction before it is completed. Anesthesia was administered and the scope was inserted, but the procedure could not be finished. What codes and modifiers should be used to bill for the work that was done?',
            cpt: '43235',
            modifier: '53',
            feedback: 'Correct! Modifier 53 is used for discontinued physician services. It indicates that the procedure was started but was stopped due to extenuating circumstances or for the patient\'s well-being.'
        }
    ];

    const matchingGameData = [
        { term: 'EOB', definition: 'Explanation of Benefits' },
        { term: 'A/R', definition: 'Accounts Receivable' },
        { term: 'CPT', definition: 'Current Procedural Terminology' },
        { term: 'ICD-10', definition: 'International Classification of Diseases, 10th Revision' },
        { term: 'CMS', definition: 'Centers for Medicare & Medicaid Services' },
        { term: 'HCPCS', definition: 'Healthcare Common Procedure Coding System' },
        { term: 'RVU', definition: 'Relative Value Unit' },
        { term: 'POS', definition: 'Place of Service' },
        { term: 'PPO', definition: 'Preferred Provider Organization' },
        { term: 'HMO', definition: 'Health Maintenance Organization' }
    ];

    const scrubberScenarios = [
        {
            title: 'Scenario 1: Medical Necessity Mismatch',
            details: 'A patient is seen for a routine flu shot. The provider documented a diagnosis of "influenza" and billed with a CPT code for a vaccine administration. The claim was submitted with the following codes:',
            claim: 'ICD-10: J11.1 (Influenza with pneumonia) \nCPT: 90471 (Immunization Administration)',
            incorrectReason: 'The ICD-10 code (J11.1) is for a patient who already has influenza with complications, but the service provided (vaccine administration) is for prevention. This is a medical necessity mismatch.',
            correctCodes: { icd: 'Z23', cpt: '90471', modifier: 'None' },
            feedback: 'The correct ICD-10 code for a routine vaccination is Z23. The original diagnosis code (J11.1) implies the patient is already sick, which does not justify a preventive vaccination. This claim would be denied for lack of medical necessity.'
        },
        {
            title: 'Scenario 2: Unbundling',
            details: 'A patient undergoes a surgical procedure that includes a routine closure (suturing). The provider bills separately for both the surgery and the closure. The submitted claim includes these two codes:',
            claim: 'CPT: 25000 (Excision of lesion on radius)\nCPT: 12001 (Simple repair of wound)',
            incorrectReason: 'A simple wound closure is considered a part of the surgical procedure and should not be billed separately. This is a classic example of "unbundling."',
            correctCodes: { icd: 'M79.5 (or another appropriate diagnosis)', cpt: '25000', modifier: 'None' },
            feedback: 'The code for simple wound closure (12001) is bundled into the surgical procedure (25000). Billing for both is considered unbundling, which is a form of fraud. Only the code for the major procedure should be submitted.'
        },
        {
            title: 'Scenario 3: Missing Modifier for Bilateral Procedure',
            details: 'A patient has a procedure performed on both their left and right knees. The provider bills for the same procedure code twice, but forgets to add a modifier to indicate a bilateral procedure.',
            claim: 'CPT: 27440 (Arthroplasty, knee) \nCPT: 27440 (Arthroplasty, knee)',
            incorrectReason: 'Billing for the same procedure code twice without a modifier indicates a duplicate service. The payer will likely deny the second line item.',
            correctCodes: { icd: 'M23.90', cpt: '27440', modifier: '50' },
            feedback: 'Correct! The CPT code should be listed once with the -50 modifier to indicate a bilateral procedure. This is the correct way to bill for services performed on paired body parts.'
        }
    ];

    const denialScenarios = [
        {
            title: 'Scenario 1: Lack of Prior Authorization',
            details: 'You submitted a claim for a specialized MRI. It was denied with a **CO-23** reason code.',
            options: [
                'The patient has been seen too many times.',
                'The service was performed by an unauthorized provider.',
                'The patient is not eligible for this service.',
                'The service requires a prior authorization that was not obtained.'
            ],
            correctInterpretation: 'The service requires a prior authorization that was not obtained.',
            actionPlanKeywords: ['verify', 'prior authorization', 'appeal', 'retrospective authorization', 'patient responsibility', 'medical record']
        },
        {
            title: 'Scenario 2: Service Exceeds Authorization',
            details: 'You submitted a claim for 5 physical therapy sessions. The claim was denied with a **CO-109** reason code, and you know you had a prior authorization for the services.',
            options: [
                'The service was not documented.',
                'The patient is no longer covered by this plan.',
                'The services exceeded the number of authorized visits.',
                'The claim was submitted to the wrong payer.'
            ],
            correctInterpretation: 'The services exceeded the number of authorized visits.',
            actionPlanKeywords: ['review', 'authorization', 'appeal', 'medical necessity', 'document', 'payer policy']
        },
        {
            title: 'Scenario 3: Missing or Invalid Documentation',
            details: 'A claim for a consultation service (CPT 99244) was denied with a **CO-22** reason code.',
            options: [
                'Services were not medically necessary.',
                'The patient\'s diagnosis code is invalid.',
                'The claim lacks necessary documentation or a report.',
                'The CPT code is for a service not covered by the plan.'
            ],
            correctInterpretation: 'The claim lacks necessary documentation or a report.',
            actionPlanKeywords: ['review', 'documentation', 'submit', 'appeal', 'medical record', 'attestation']
        }
    ];

    const soapScenarios = [
        {
            title: 'Scenario 1: Sinus Infection',
            description: 'Extract the codes for a patient presenting with a sinus infection and fever.',
            soapNote: `
Date: 08/25/2025
Subjective: Patient is a 35-year-old male presenting with a 3-day history of nasal congestion, facial pain, and a low-grade fever. He reports green discharge from his nose and a cough that started yesterday. He denies shortness of breath or headache.
Objective: Vitals: BP 120/80, T 99.8¬∞F. Exam: Nasal mucosa is swollen and erythematous with mucopurulent discharge. Sinuses are tender to palpation. Pharynx is mildly inflamed.
Assessment: Acute sinusitis due to streptococcus.
Plan: 1. Prescribe Amoxicillin 500mg. 2. Advise saline nasal spray and warm compresses. 3. Follow up in 7 days or sooner if symptoms worsen. 4. Code and bill today's visit.
            `,
            correctExtraction: {
                chiefComplaint: 'nasal congestion, facial pain, low-grade fever',
                icd: 'J01.00',
                cpt: '99213',
                modifier: 'None'
            }
        },
        {
            title: 'Scenario 2: Sprained Ankle',
            description: 'Extract the codes and information for a patient seen for an ankle injury.',
            soapNote: `
Date: 08/26/2025
Subjective: Patient is a 22-year-old female who twisted her right ankle while playing basketball. She reports immediate pain and swelling. She is limping and unable to put full weight on it. She denies any previous ankle injuries.
Objective: Exam: Right ankle is swollen with ecchymosis noted laterally. Tenderness to palpation over the anterior talofibular ligament. Patient has decreased range of motion due to pain. No deformity noted. X-ray of the ankle was performed in the clinic and shows no fracture.
Assessment: Sprain of the lateral collateral ligament of the right ankle.
Plan: 1. Apply an ankle brace. 2. Prescribe NSAIDs for pain. 3. R.I.C.E. instructions (Rest, Ice, Compression, Elevation). 4. Follow up in 2 weeks. 5. Code and bill today's E/M and x-ray services.
            `,
            correctExtraction: {
                chiefComplaint: 'twisted right ankle, pain, swelling',
                icd: 'S93.401A',
                cpt: '99213, 73600',
                modifier: 'RT'
            }
        },
        {
            title: 'Scenario 3: Laceration Repair',
            description: 'Extract the codes for a patient who had a laceration repaired.',
            soapNote: `
Date: 08/27/2025
Subjective: Patient is a 15-year-old male who sustained a cut to his left forearm while climbing a fence. He reports bleeding and pain.
Objective: Exam: 3.5 cm simple laceration on the left forearm. No foreign bodies noted. Bleeding is minimal and controlled.
Assessment: Laceration of forearm, simple.
Plan: 1. Irrigate and prep the wound. 2. Close with sutures. 3. Apply sterile dressing. 4. Advise to keep the wound clean and dry. 5. Follow up in 10 days for suture removal.
            `,
            correctExtraction: {
                chiefComplaint: 'cut on left forearm',
                icd: 'S51.812A',
                cpt: '12002',
                modifier: 'None'
            }
        }
    ];

    const billingWalkthroughSteps = [
        {
            title: 'Step 1: Patient Registration & Eligibility',
            instructions: 'The first step is to collect patient demographics and insurance information. Verify the patient\'s eligibility and benefits, including copay, deductible, and coinsurance, before the appointment.'
        },
        {
            title: 'Step 2: Encounter Documentation',
            instructions: 'The healthcare provider documents the patient\'s visit. This includes the chief complaint, medical history, physical exam, and the provider\'s assessment and plan.'
        },
        {
            title: 'Step 3: Medical Coding',
            instructions: 'The encounter documentation is reviewed and translated into standardized medical codes. This includes assigning ICD-10 codes for diagnoses and CPT/HCPCS codes for services and procedures.'
        },
        {
            title: 'Step 4: Charge Entry',
            instructions: 'The medical codes are entered into the EHR system along with the corresponding charges for each service. This creates a detailed record of what the patient owes.'
        },
        {
            title: 'Step 5: Claim Generation & Submission',
            instructions: 'A claim form (e.g., CMS-1500) is generated from the charge entry data. The claim is then sent to the insurance payer, either electronically or on paper.'
        },
        {
            title: 'Step 6: Payer Adjudication',
            instructions: 'The insurance company reviews the claim to determine if the services are medically necessary and if the patient is eligible for coverage. The claim is either paid, denied, or sent back for more information.'
        },
        {
            title: 'Step 7: Payment Posting',
            instructions: 'The payment from the insurance company is posted to the patient\'s account. Any remaining balance is either transferred to the patient or a secondary payer.'
        },
        {
            title: 'Step 8: Patient Billing & A/R Follow-up',
            instructions: 'A bill is sent to the patient for any remaining balance (copays, deductibles, coinsurance). If the claim was denied, the billing team will work on resolving the denial (A/R follow-up).'
        }
    ];

    const paWalkthroughSteps = [
        {
            title: 'Step 1: Determine PA Necessity',
            instructions: 'Before the service, confirm with the patient\'s insurance provider if the CPT code for the planned procedure or medication requires prior authorization. This prevents a denial later on.'
        },
        {
            title: 'Step 2: Gather Required Documentation',
            instructions: 'Collect all necessary clinical documentation, including the patient\'s medical history, lab results, and a letter of medical necessity from the physician. This documentation supports the request.'
        },
        {
            title: 'Step 3: Submit the PA Request',
            instructions: 'Submit the prior authorization request to the insurance payer via their online portal, phone, or fax, along with all the supporting documentation.'
        },
        {
            title: 'Step 4: Await Payer Decision',
            instructions: 'Wait for the insurance company to review the request. This can take anywhere from a few hours to several days, depending on the payer and the urgency of the service.'
        },
        {
            title: 'Step 5: Receive and Track the PA',
            instructions: 'Once the payer approves or denies the request, you will receive a decision with a unique prior authorization number. This number must be included on the claim form when the service is eventually billed.'
        }
    ];

    const terminologyPairs = [
        { key: 'A/R', value: 'Accounts Receivable' },
        { key: 'CPT', value: 'Current Procedural Terminology' },
        { key: 'EOB', value: 'Explanation of Benefits' },
        { key: 'EMR', value: 'Electronic Medical Record' },
        { key: 'HMO', value: 'Health Maintenance Organization' },
        { key: 'ICD', value: 'International Classification of Diseases' },
        { key: 'NDC', value: 'National Drug Code' },
        { key: 'POS', value: 'Place of Service' },
        { key: 'PPO', value: 'Preferred Provider Organization' },
        { key: 'RVU', value: 'Relative Value Unit' },
        { key: 'UB-04', value: 'Uniform Bill' },
        { key: 'Dx', value: 'Diagnosis' },
        { key: 'Px', value: 'Procedure' },
        { key: 'COB', value: 'Coordination of Benefits' },
        { key: 'MAC', value: 'Medicare Administrative Contractor' },
    ];


    // --------------------------------------------------------------------------------------
    // --- Global Variables and Utility Functions ---
    // --------------------------------------------------------------------------------------

    let patientData = {};
    let currentQuiz = null;
    let quizIndex = 0;
    let quizScore = 0;
    let currentBalanceScenario = null;
    let currentModifierScenario = null;
    let currentScrubberScenario = null;
    let currentDenialScenario = null;
    let currentSoapScenario = null;
    let walkthroughStep = 0;
    let paWalkthroughStep = 0;

    let flippedCards = [];
    let matchedCards = [];

    function showMessage(text, type) {
        const messageBox = document.getElementById('messageBox');
        messageBox.textContent = text;
        messageBox.className = `message-box ${type}`;
        messageBox.style.display = 'block';
        setTimeout(() => {
            messageBox.style.display = 'none';
        }, 5000);
    }

    function generateUniqueId() {
        return '_' + Math.random().toString(36).substr(2, 9);
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function normalizeText(text) {
        if (text === null || text === undefined) return '';
        return text.toString().toLowerCase().trim().replace(/[\s\-,.()]/g, '');
    }

    // --------------------------------------------------------------------------------------
    // --- Patient Registration & Claim Generation Logic ---
    // --------------------------------------------------------------------------------------

    document.getElementById('registerPatientBtn').addEventListener('click', () => {
        const name = document.getElementById('patientName').value.trim();
        const dob = document.getElementById('patientDOB').value;
        const insuranceID = document.getElementById('insuranceID').value.trim();

        if (name && dob && insuranceID) {
            patientData = {
                name,
                dob,
                insuranceID,
                id: generateUniqueId()
            };
            localStorage.setItem('patientRecord', JSON.stringify(patientData));
            showMessage('Patient registered and saved successfully! You can now document the encounter.', 'success');
        } else {
            showMessage('Please complete all patient registration fields.', 'error');
        }
    });

    function createItemInput(type) {
        const wrapper = document.createElement('div');
        wrapper.className = 'flex items-center gap-2';
        const input = document.createElement('input');
        input.type = 'text';
        input.className = `${type}-code flex-grow-1 focus:ring-green-500 focus:border-green-500`;
        input.name = `${type}Code`;
        input.placeholder = type === 'diagnosis' ? 'e.g., J02.9' : 'e.g., 99213';
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn-secondary remove-item-btn';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', () => wrapper.remove());
        wrapper.appendChild(input);
        wrapper.appendChild(removeBtn);
        return wrapper;
    }

    document.getElementById('addDiagnosisBtn').addEventListener('click', () => {
        const list = document.getElementById('diagnosisList');
        list.appendChild(createItemInput('diagnosis'));
    });

    document.getElementById('addProcedureBtn').addEventListener('click', () => {
        const list = document.getElementById('procedureList');
        list.appendChild(createItemInput('procedure'));
    });

    function createServiceInput() {
        const wrapper = document.createElement('div');
        wrapper.className = 'grid grid-cols-1 md:grid-cols-3 gap-2 service-item';
        const descInput = document.createElement('input');
        descInput.type = 'text';
        descInput.className = 'service-description col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500';
        descInput.name = 'serviceDescription';
        descInput.placeholder = 'Service Description';
        const cptInput = document.createElement('input');
        cptInput.type = 'text';
        cptInput.className = 'service-cpt-code col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500';
        cptInput.name = 'serviceCptCode';
        cptInput.placeholder = 'CPT Code';
        const priceWrapper = document.createElement('div');
        priceWrapper.className = 'flex gap-2 col-span-1 md:col-span-1';
        const priceInput = document.createElement('input');
        priceInput.type = 'number';
        priceInput.className = 'service-price flex-grow-1 focus:ring-purple-500 focus:border-purple-500';
        priceInput.name = 'servicePrice';
        priceInput.placeholder = 'Price ($)';
        priceInput.min = '0';
        priceInput.step = '0.01';
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn-secondary remove-item-btn';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', () => wrapper.remove());
        priceWrapper.appendChild(priceInput);
        priceWrapper.appendChild(removeBtn);
        wrapper.appendChild(descInput);
        wrapper.appendChild(cptInput);
        wrapper.appendChild(priceWrapper);
        return wrapper;
    }

    document.getElementById('addChargeBtn').addEventListener('click', () => {
        const list = document.getElementById('chargeList');
        list.appendChild(createServiceInput());
    });

    document.getElementById('generateClaimBtn').addEventListener('click', () => {
        const chiefComplaint = document.getElementById('chiefComplaint').value.trim();
        const encounterDate = document.getElementById('encounterDate').value;
        const diagnosisCodes = Array.from(document.querySelectorAll('.diagnosis-code')).map(input => input.value.trim()).filter(code => code);
        const procedureCodes = Array.from(document.querySelectorAll('.procedure-code')).map(input => input.value.trim()).filter(code => code);
        const services = Array.from(document.querySelectorAll('.service-item')).map(item => {
            return {
                description: item.querySelector('.service-description').value.trim(),
                cpt: item.querySelector('.service-cpt-code').value.trim(),
                price: parseFloat(item.querySelector('.service-price').value) || 0
            };
        }).filter(service => service.cpt && service.price > 0);

        if (!patientData.id || !encounterDate || diagnosisCodes.length === 0 || procedureCodes.length === 0 || services.length === 0) {
            showMessage('Please complete all sections to generate a claim.', 'error');
            return;
        }

        const totalCharges = services.reduce((sum, service) => sum + service.price, 0).toFixed(2);
        
        const claimOutput = `
PATIENT INFORMATION
-------------------
Patient Name: ${patientData.name}
Patient DOB: ${patientData.dob}
Insurance ID: ${patientData.insuranceID}
Claim ID: ${generateUniqueId()}
            
ENCOUNTER DETAILS
-------------------
Encounter Date: ${encounterDate}
Chief Complaint: ${chiefComplaint}
Diagnoses (ICD-10): ${diagnosisCodes.join(', ')}
Procedures (CPT/HCPCS): ${procedureCodes.join(', ')}
            
SERVICES RENDERED
-------------------
${services.map(s => `${s.cpt}: ${s.description} ($${s.price.toFixed(2)})`).join('\n            ')}
            
FINANCIALS
-------------------
Total Billed: $${totalCharges}
        `;

        document.getElementById('claimOutput').textContent = claimOutput;
        showMessage('Simulated claim generated successfully!', 'success');
    });

    document.getElementById('clearAllBtn').addEventListener('click', () => {
        document.getElementById('patientName').value = '';
        document.getElementById('patientDOB').value = '';
        document.getElementById('insuranceID').value = '';
        document.getElementById('encounterDate').value = '';
        document.getElementById('chiefComplaint').value = '';
        
        const diagnosisList = document.getElementById('diagnosisList');
        while (diagnosisList.children.length > 1) { diagnosisList.removeChild(diagnosisList.lastChild); }
        diagnosisList.querySelector('input').value = '';

        const procedureList = document.getElementById('procedureList');
        while (procedureList.children.length > 1) { procedureList.removeChild(procedureList.lastChild); }
        procedureList.querySelector('input').value = '';

        const chargeList = document.getElementById('chargeList');
        while (chargeList.children.length > 1) { chargeList.removeChild(chargeList.lastChild); }
        chargeList.querySelector('.service-description').value = '';
        chargeList.querySelector('.service-cpt-code').value = '';
        chargeList.querySelector('.service-price').value = '';

        document.getElementById('claimOutput').textContent = 'Your simulated claim details will appear here after generation.';
        patientData = {};
        localStorage.removeItem('patientRecord');
        showMessage('All data has been cleared.', 'success');
    });
    
    // Auto-load patient data on page load
    (function loadPatientData() {
        const savedData = localStorage.getItem('patientRecord');
        if (savedData) {
            patientData = JSON.parse(savedData);
            document.getElementById('patientName').value = patientData.name;
            document.getElementById('patientDOB').value = patientData.dob;
            document.getElementById('insuranceID').value = patientData.insuranceID;
            showMessage('Patient data loaded successfully!', 'success');
        }
    })();

    // --------------------------------------------------------------------------------------
    // --- Walkthroughs Logic ---
    // --------------------------------------------------------------------------------------

    const billingWalkthroughContent = document.getElementById('billingWalkthroughContent');
    const walkthroughStepTitle = document.getElementById('walkthroughStepTitle');
    const walkthroughStepInstructions = document.getElementById('walkthroughStepInstructions');
    const startBillingWalkthroughBtn = document.getElementById('startBillingWalkthroughBtn');
    const nextBillingWalkthroughBtn = document.getElementById('nextBillingWalkthroughBtn');
    const resetBillingWalkthroughBtn = document.getElementById('resetBillingWalkthroughBtn');

    function displayWalkthroughStep(step) {
        if (step < billingWalkthroughSteps.length) {
            walkthroughStepTitle.textContent = billingWalkthroughSteps[step].title;
            walkthroughStepInstructions.textContent = billingWalkthroughSteps[step].instructions;
            billingWalkthroughContent.classList.remove('hidden');
            nextBillingWalkthroughBtn.classList.remove('hidden');
            resetBillingWalkthroughBtn.classList.remove('hidden');
            startBillingWalkthroughBtn.classList.add('hidden');
        } else {
            walkthroughStepTitle.textContent = 'Walkthrough Complete!';
            walkthroughStepInstructions.textContent = 'You have successfully completed the medical billing revenue cycle walkthrough. Click "Reset" to start over.';
            nextBillingWalkthroughBtn.classList.add('hidden');
        }
    }

    startBillingWalkthroughBtn.addEventListener('click', () => {
        walkthroughStep = 0;
        displayWalkthroughStep(walkthroughStep);
    });

    nextBillingWalkthroughBtn.addEventListener('click', () => {
        walkthroughStep++;
        displayWalkthroughStep(walkthroughStep);
    });

    resetBillingWalkthroughBtn.addEventListener('click', () => {
        walkthroughStep = 0;
        billingWalkthroughContent.classList.add('hidden');
        startBillingWalkthroughBtn.classList.remove('hidden');
        nextBillingWalkthroughBtn.classList.add('hidden');
        resetBillingWalkthroughBtn.classList.add('hidden');
        showMessage('Walkthrough reset.', 'success');
    });

    const paWalkthroughContent = document.getElementById('paWalkthroughContent');
    const paWalkthroughStepTitle = document.getElementById('paWalkthroughStepTitle');
    const paWalkthroughStepInstructions = document.getElementById('paWalkthroughStepInstructions');
    const startPaWalkthroughBtn = document.getElementById('startPaWalkthroughBtn');
    const nextPaWalkthroughBtn = document.getElementById('nextPaWalkthroughBtn');
    const resetPaWalkthroughBtn = document.getElementById('resetPaWalkthroughBtn');

    function displayPaWalkthroughStep(step) {
        if (step < paWalkthroughSteps.length) {
            paWalkthroughStepTitle.textContent = paWalkthroughSteps[step].title;
            paWalkthroughStepInstructions.textContent = paWalkthroughSteps[step].instructions;
            paWalkthroughContent.classList.remove('hidden');
            nextPaWalkthroughBtn.classList.remove('hidden');
            resetPaWalkthroughBtn.classList.remove('hidden');
            startPaWalkthroughBtn.classList.add('hidden');
        } else {
            paWalkthroughStepTitle.textContent = 'PA Walkthrough Complete!';
            paWalkthroughStepInstructions.textContent = 'You have successfully completed the prior authorization walkthrough. Click "Reset" to start over.';
            nextPaWalkthroughBtn.classList.add('hidden');
        }
    }

    startPaWalkthroughBtn.addEventListener('click', () => {
        paWalkthroughStep = 0;
        displayPaWalkthroughStep(paWalkthroughStep);
    });

    nextPaWalkthroughBtn.addEventListener('click', () => {
        paWalkthroughStep++;
        displayPaWalkthroughStep(paWalkthroughStep);
    });

    resetPaWalkthroughBtn.addEventListener('click', () => {
        paWalkthroughStep = 0;
        paWalkthroughContent.classList.add('hidden');
        startPaWalkthroughBtn.classList.remove('hidden');
        nextPaWalkthroughBtn.classList.add('hidden');
        resetPaWalkthroughBtn.classList.add('hidden');
        showMessage('PA walkthrough reset.', 'success');
    });

    // --------------------------------------------------------------------------------------
    // --- Quiz Logic ---
    // --------------------------------------------------------------------------------------

    const quizContent = document.getElementById('quizContent');
    const quizQuestionTitle = document.getElementById('quizQuestionTitle');
    const quizOptionsDiv = document.getElementById('quizOptions');
    const quizFeedbackDiv = document.getElementById('quizFeedback');
    const submitAnswerBtn = document.getElementById('submitAnswerBtn');
    const nextQuestionBtn = document.getElementById('nextQuestionBtn');
    const resetQuizBtn = document.getElementById('resetQuizBtn');

    function loadQuiz(quizName) {
        currentQuiz = shuffleArray(quizzes[quizName]);
        quizIndex = 0;
        quizScore = 0;
        quizContent.classList.remove('hidden');
        resetQuizBtn.classList.remove('hidden');
        submitAnswerBtn.classList.remove('hidden');
        nextQuestionBtn.classList.add('hidden');
        loadQuestion();
    }

    function loadQuestion() {
        if (quizIndex < currentQuiz.length) {
            const questionData = currentQuiz[quizIndex];
            quizQuestionTitle.textContent = `Question ${quizIndex + 1}: ${questionData.question}`;
            quizOptionsDiv.innerHTML = '';
            shuffleArray(questionData.options).forEach(option => {
                const label = document.createElement('label');
                label.className = 'quiz-option';
                label.innerHTML = `<input type="radio" name="quizOption" value="${option}"> ${option}`;
                quizOptionsDiv.appendChild(label);
            });
            quizFeedbackDiv.innerHTML = '<p class="text-gray-500 quiz-feedback-text">Your feedback will appear here.</p>';
        } else {
            quizQuestionTitle.textContent = `Quiz Complete! Your score is ${quizScore} out of ${currentQuiz.length}.`;
            quizOptionsDiv.innerHTML = '';
            quizFeedbackDiv.innerHTML = `<p class="quiz-feedback-text font-bold">You've finished the quiz! Click "Reset" to try another.</p>`;
            submitAnswerBtn.classList.add('hidden');
            nextQuestionBtn.classList.add('hidden');
        }
    }

    document.querySelectorAll('.btn-primary[id^="quiz"]').forEach(button => {
        button.addEventListener('click', (e) => {
            const quizName = e.target.textContent.trim();
            loadQuiz(quizName);
        });
    });

    submitAnswerBtn.addEventListener('click', () => {
        const selectedOption = document.querySelector('input[name="quizOption"]:checked');
        if (!selectedOption) {
            showMessage('Please select an answer.', 'error');
            return;
        }
        const selectedAnswer = selectedOption.value;
        const correctAnswer = currentQuiz[quizIndex].answer;
        const feedbackText = currentQuiz[quizIndex].feedback;

        if (selectedAnswer === correctAnswer) {
            quizScore++;
            quizFeedbackDiv.innerHTML = `<p class="quiz-feedback-text text-green-700 font-bold">Correct! </p><p class="quiz-feedback-text mt-2">${feedbackText}</p>`;
        } else {
            quizFeedbackDiv.innerHTML = `<p class="quiz-feedback-text text-red-700 font-bold">Incorrect. The correct answer was: ${correctAnswer}</p><p class="quiz-feedback-text mt-2">${feedbackText}</p>`;
        }
        
        submitAnswerBtn.classList.add('hidden');
        nextQuestionBtn.classList.remove('hidden');
    });

    nextQuestionBtn.addEventListener('click', () => {
        quizIndex++;
        loadQuestion();
        nextQuestionBtn.classList.add('hidden');
        submitAnswerBtn.classList.remove('hidden');
    });

    resetQuizBtn.addEventListener('click', () => {
        quizContent.classList.add('hidden');
        quizIndex = 0;
        quizScore = 0;
        currentQuiz = null;
        showMessage('Quiz reset.', 'success');
    });

    // --------------------------------------------------------------------------------------
    // --- Patient Balance Calculator Logic ---
    // --------------------------------------------------------------------------------------

    const balanceCalculatorContent = document.getElementById('balanceCalculatorContent');
    const balanceScenarioTitle = document.getElementById('balanceScenarioTitle');
    const balanceScenarioDetails = document.getElementById('balanceScenarioDetails');
    const userCopayInput = document.getElementById('userCopay');
    const userDeductibleInput = document.getElementById('userDeductibleInput');
    const userCoinsuranceInput = document.getElementById('userCoinsurance');
    const userTotalBalanceInput = document.getElementById('userTotalBalance');
    const balanceFeedbackDiv = document.getElementById('balanceFeedback');
    const loadBalanceScenarioBtn = document.getElementById('loadBalanceScenarioBtn');
    const checkBalanceBtn = document.getElementById('checkBalanceBtn');
    const resetBalanceBtn = document.getElementById('resetBalanceBtn');

    function loadBalanceScenario() {
        currentBalanceScenario = balanceScenarios[Math.floor(Math.random() * balanceScenarios.length)];
        balanceCalculatorContent.classList.remove('hidden');
        balanceScenarioTitle.textContent = currentBalanceScenario.title;
        balanceScenarioDetails.innerHTML = currentBalanceScenario.details;
        
        userCopayInput.value = '';
        userDeductibleInput.value = '';
        userCoinsuranceInput.value = '';
        userTotalBalanceInput.value = '';
        balanceFeedbackDiv.innerHTML = '<p class="text-gray-500 balance-feedback-text">Feedback on your calculation will appear here.</p>';
        
        checkBalanceBtn.classList.remove('hidden');
        resetBalanceBtn.classList.remove('hidden');
    }

    loadBalanceScenarioBtn.addEventListener('click', loadBalanceScenario);

    checkBalanceBtn.addEventListener('click', () => {
        const userCopay = parseFloat(userCopayInput.value) || 0;
        const userDeductible = parseFloat(userDeductibleInput.value) || 0;
        const userCoinsurance = parseFloat(userCoinsuranceInput.value) || 0;
        const userTotalBalance = parseFloat(userTotalBalanceInput.value) || 0;
        
        const correctAnswers = currentBalanceScenario.answers;
        let feedback = '';
        let isCorrect = true;

        if (userCopay !== correctAnswers.copay) { feedback += `<p>‚Ä¢ Copay is incorrect. Should be $${correctAnswers.copay.toFixed(2)}.</p>`; isCorrect = false; }
        if (userDeductible !== correctAnswers.deductible) { feedback += `<p>‚Ä¢ Deductible applied is incorrect. Should be $${correctAnswers.deductible.toFixed(2)}.</p>`; isCorrect = false; }
        if (userCoinsurance !== correctAnswers.coinsurance) { feedback += `<p>‚Ä¢ Coinsurance is incorrect. Should be $${correctAnswers.coinsurance.toFixed(2)}.</p>`; isCorrect = false; }
        if (userTotalBalance !== correctAnswers.total) { feedback += `<p>‚Ä¢ Total patient balance is incorrect. Should be $${correctAnswers.total.toFixed(2)}.</p>`; isCorrect = false; }

        if (isCorrect) {
            balanceFeedbackDiv.innerHTML = '<p class="text-green-700 font-bold">All calculations are correct! Great job!</p>';
        } else {
            balanceFeedbackDiv.innerHTML = `<p class="text-red-700 font-bold">Something is incorrect.</p>${feedback}`;
        }
    });

    resetBalanceBtn.addEventListener('click', () => {
        balanceCalculatorContent.classList.add('hidden');
        showMessage('Scenario reset.', 'success');
    });

    // --------------------------------------------------------------------------------------
    // --- Advanced Modifier Application Challenge Logic ---
    // --------------------------------------------------------------------------------------

    const modifierChallengeContent = document.getElementById('modifierChallengeContent');
    const modifierScenarioTitle = document.getElementById('modifierScenarioTitle');
    const modifierScenarioDetails = document.getElementById('modifierScenarioDetails');
    const userModifierCPTInput = document.getElementById('userModifierCPT');
    const userModifierInput = document.getElementById('userModifier');
    const modifierFeedbackDiv = document.getElementById('modifierFeedback');
    const loadModifierScenarioBtn = document.getElementById('loadModifierScenarioBtn');
    const checkModifierBtn = document.getElementById('checkModifierBtn');
    const resetModifierBtn = document.getElementById('resetModifierBtn');

    function loadModifierScenario() {
        currentModifierScenario = modifierScenarios[Math.floor(Math.random() * modifierScenarios.length)];
        modifierChallengeContent.classList.remove('hidden');
        modifierScenarioTitle.textContent = currentModifierScenario.title;
        modifierScenarioDetails.textContent = currentModifierScenario.details;
        
        userModifierCPTInput.value = '';
        userModifierInput.value = '';
        modifierFeedbackDiv.innerHTML = '<p class="text-gray-500 modifier-feedback-text">Feedback on your modifier application will appear here.</p>';
        
        checkModifierBtn.classList.remove('hidden');
        resetModifierBtn.classList.remove('hidden');
    }

    loadModifierScenarioBtn.addEventListener('click', loadModifierScenario);

    checkModifierBtn.addEventListener('click', () => {
        const userCPT = normalizeText(userModifierCPTInput.value);
        const userModifier = normalizeText(userModifierInput.value);
        
        const correctCPT = normalizeText(currentModifierScenario.cpt);
        const correctModifier = normalizeText(currentModifierScenario.modifier);
        
        if (userCPT === correctCPT && userModifier === correctModifier) {
            modifierFeedbackDiv.innerHTML = `<p class="text-green-700 font-bold">Correct! </p><p class="modifier-feedback-text mt-2">${currentModifierScenario.feedback}</p>`;
        } else {
            let feedback = `<p class="text-red-700 font-bold">Incorrect. Please try again.</p>`;
            if (userCPT !== correctCPT) { feedback += `<p class="text-sm mt-2">The CPT code is incorrect. It should be: <span class="font-bold">${currentModifierScenario.cpt}</span></p>`; }
            if (userModifier !== correctModifier) { feedback += `<p class="text-sm">The modifier is incorrect. It should be: <span class="font-bold">${currentModifierScenario.modifier}</span></p>`; }
            modifierFeedbackDiv.innerHTML = feedback;
        }
    });

    resetModifierBtn.addEventListener('click', () => {
        modifierChallengeContent.classList.add('hidden');
        showMessage('Scenario reset.', 'success');
    });

    // --------------------------------------------------------------------------------------
    // --- Medical Terminology Matching Game Logic ---
    // --------------------------------------------------------------------------------------

    const matchingGameContent = document.getElementById('matchingGameContent');
    const cardGrid = document.getElementById('cardGrid');
    const startGameBtn = document.getElementById('startGameBtn');
    const resetGameBtn = document.getElementById('resetGameBtn');
    const gameMessage = document.getElementById('gameMessage');

    function createCards() {
        const cards = [];
        const pairs = shuffleArray(terminologyPairs.slice(0, 8)); // Use a smaller set for a manageable game
        pairs.forEach(pair => {
            cards.push({ id: pair.term, text: pair.term, type: 'term', matched: false });
            cards.push({ id: pair.term, text: pair.value, type: 'definition', matched: false });
        });
        return shuffleArray(cards);
    }

    function renderCards(cards) {
        cardGrid.innerHTML = '';
        cards.forEach(card => {
            const cardElement = document.createElement('div');
            cardElement.className = 'match-card';
            cardElement.dataset.id = card.id;
            cardElement.dataset.type = card.type;
            cardElement.textContent = card.type === 'term' ? card.text : 'Click to Flip';
            cardElement.addEventListener('click', () => handleCardClick(cardElement, card));
            cardGrid.appendChild(cardElement);
        });
    }
    
    function handleCardClick(cardElement, card) {
        if (flippedCards.length < 2 && !cardElement.classList.contains('flipped') && !card.matched) {
            cardElement.classList.add('flipped');
            cardElement.textContent = card.text;
            flippedCards.push(cardElement);

            if (flippedCards.length === 2) {
                setTimeout(checkMatch, 1000);
            }
        }
    }

    function checkMatch() {
        const [card1, card2] = flippedCards;
        const id1 = card1.dataset.id;
        const id2 = card2.dataset.id;
        
        if (id1 === id2) {
            card1.classList.add('matched');
            card2.classList.add('matched');
            matchedCards.push(id1);
            gameMessage.textContent = 'Match found!';
            flippedCards = [];
            if (matchedCards.length === terminologyPairs.slice(0, 8).length) {
                gameMessage.textContent = 'You won! All pairs matched!';
                resetGameBtn.classList.remove('hidden');
            }
        } else {
            gameMessage.textContent = 'No match. Try again.';
            setTimeout(() => {
                card1.classList.remove('flipped');
                card2.classList.remove('flipped');
                card1.textContent = 'Click to Flip';
                card2.textContent = 'Click to Flip';
                flippedCards = [];
            }, 1000);
        }
    }

    startGameBtn.addEventListener('click', () => {
        matchingGameContent.classList.remove('hidden');
        startGameBtn.classList.add('hidden');
        resetGameBtn.classList.add('hidden');
        gameMessage.textContent = 'Find all matching pairs.';
        flippedCards = [];
        matchedCards = [];
        const cards = createCards();
        renderCards(cards);
    });

    resetGameBtn.addEventListener('click', () => {
        matchingGameContent.classList.add('hidden');
        startGameBtn.classList.remove('hidden');
        resetGameBtn.classList.add('hidden');
        gameMessage.textContent = '';
        showMessage('Game reset.', 'success');
    });

    // --------------------------------------------------------------------------------------
    // --- Claim Scrubber / Error Finder Challenge Logic ---
    // --------------------------------------------------------------------------------------

    const scrubberChallengeContent = document.getElementById('scrubberChallengeContent');
    const scrubberScenarioTitle = document.getElementById('scrubberScenarioTitle');
    const scrubberScenarioDetails = document.getElementById('scrubberScenarioDetails');
    const presentedClaimOutput = document.getElementById('presentedClaimOutput');
    const userScrubberICDInput = document.getElementById('userScrubberICD');
    const userScrubberCPTInput = document.getElementById('userScrubberCPT');
    const userScrubberModifierInput = document.getElementById('userScrubberModifier');
    const scrubberFeedbackDiv = document.getElementById('scrubberFeedback');
    const loadScrubberScenarioBtn = document.getElementById('loadScrubberScenarioBtn');
    const checkScrubberBtn = document.getElementById('checkScrubberBtn');
    const resetScrubberBtn = document.getElementById('resetScrubberBtn');

    function loadScrubberScenario() {
        currentScrubberScenario = scrubberScenarios[Math.floor(Math.random() * scrubberScenarios.length)];
        scrubberChallengeContent.classList.remove('hidden');
        scrubberScenarioTitle.textContent = currentScrubberScenario.title;
        scrubberScenarioDetails.textContent = currentScrubberScenario.details;
        presentedClaimOutput.textContent = currentScrubberScenario.claim;
        
        userScrubberICDInput.value = '';
        userScrubberCPTInput.value = '';
        userScrubberModifierInput.value = '';
        scrubberFeedbackDiv.innerHTML = '<p class="text-gray-500 scrubber-feedback-text">Feedback on your corrections will appear here.</p>';
        
        checkScrubberBtn.classList.remove('hidden');
        resetScrubberBtn.classList.remove('hidden');
    }

    loadScrubberScenarioBtn.addEventListener('click', loadScrubberScenario);

    checkScrubberBtn.addEventListener('click', () => {
        const userICD = normalizeText(userScrubberICDInput.value);
        const userCPT = normalizeText(userScrubberCPTInput.value);
        const userModifier = normalizeText(userScrubberModifierInput.value);
        
        const correctICD = normalizeText(currentScrubberScenario.correctCodes.icd);
        const correctCPT = normalizeText(currentScrubberScenario.correctCodes.cpt);
        const correctModifier = normalizeText(currentScrubberScenario.correctCodes.modifier);
        
        if (userICD === correctICD && userCPT === correctCPT && userModifier === correctModifier) {
            scrubberFeedbackDiv.innerHTML = `<p class="text-green-700 font-bold">Excellent! All corrections are right.</p><p class="scrubber-feedback-text mt-2">${currentScrubberScenario.feedback}</p>`;
        } else {
            let feedback = `<p class="text-red-700 font-bold">One or more of your corrections is incorrect. Please review the scenario and try again.</p>`;
            scrubberFeedbackDiv.innerHTML = feedback;
        }
    });

    resetScrubberBtn.addEventListener('click', () => {
        scrubberChallengeContent.classList.add('hidden');
        showMessage('Scenario reset.', 'success');
    });

    // --------------------------------------------------------------------------------------
    // --- Denial Code Interpreter & Action Plan Simulator Logic ---
    // --------------------------------------------------------------------------------------

    const denialChallengeContent = document.getElementById('denialChallengeContent');
    const denialScenarioTitle = document.getElementById('denialScenarioTitle');
    const denialScenarioDetails = document.getElementById('denialScenarioDetails');
    const denialInterpretationOptionsDiv = document.getElementById('denialInterpretationOptions');
    const userActionPlanInput = document.getElementById('userActionPlan');
    const denialFeedbackDiv = document.getElementById('denialFeedback');
    const loadDenialScenarioBtn = document.getElementById('loadDenialScenarioBtn');
    const checkDenialBtn = document.getElementById('checkDenialBtn');
    const resetDenialBtn = document.getElementById('resetDenialBtn');

    function loadDenialScenario() {
        currentDenialScenario = denialScenarios[Math.floor(Math.random() * denialScenarios.length)];
        denialChallengeContent.classList.remove('hidden');
        denialScenarioTitle.textContent = currentDenialScenario.title;
        denialScenarioDetails.textContent = currentDenialScenario.details;
        
        denialInterpretationOptionsDiv.innerHTML = '';
        shuffleArray(currentDenialScenario.options).forEach(option => {
            const label = document.createElement('label');
            label.className = 'denial-option';
            label.innerHTML = `<input type="radio" name="denialOption" value="${option}"> ${option}`;
            denialInterpretationOptionsDiv.appendChild(label);
        });
        
        userActionPlanInput.value = '';
        denialFeedbackDiv.innerHTML = '<p class="text-gray-500 denial-feedback-text">Feedback on your denial resolution plan will appear here.</p>';
        
        checkDenialBtn.classList.remove('hidden');
        resetDenialBtn.classList.remove('hidden');
    }

    loadDenialScenarioBtn.addEventListener('click', loadDenialScenario);

    checkDenialBtn.addEventListener('click', () => {
        const selectedOption = document.querySelector('input[name="denialOption"]:checked');
        const userActionPlan = userActionPlanInput.value.toLowerCase().trim();
        
        let isCorrectInterpretation = false;
        if (selectedOption) {
            isCorrectInterpretation = selectedOption.value === currentDenialScenario.correctInterpretation;
        }

        const actionPlanCorrect = currentDenialScenario.actionPlanKeywords.every(keyword => userActionPlan.includes(keyword));
        
        let feedbackMessage = '';
        if (isCorrectInterpretation && actionPlanCorrect) {
            feedbackMessage = '<p class="text-green-700 font-bold">Correct! You correctly interpreted the denial and provided a great action plan.</p>';
        } else {
            feedbackMessage = '<p class="text-red-700 font-bold">Incorrect. Please try again.</p>';
            if (!isCorrectInterpretation) {
                feedbackMessage += `<p class="text-sm mt-2">Your interpretation of the denial code was incorrect. The correct meaning is: <span class="font-bold">${currentDenialScenario.correctInterpretation}</span></p>`;
            }
            if (!actionPlanCorrect) {
                feedbackMessage += `<p class="text-sm">Your action plan is missing key steps. Make sure to mention researching, appealing, and using documentation.</p>`;
            }
        }
        denialFeedbackDiv.innerHTML = feedbackMessage;
    });

    resetDenialBtn.addEventListener('click', () => {
        denialChallengeContent.classList.add('hidden');
        showMessage('Scenario reset.', 'success');
    });

    // --------------------------------------------------------------------------------------
    // --- SOAP Note Coder & Extractor Challenge Logic ---
    // --------------------------------------------------------------------------------------

    const soapChallengeContent = document.getElementById('soapChallengeContent');
    const soapScenarioTitle = document.getElementById('soapScenarioTitle');
    const soapScenarioDescription = document.getElementById('soapScenarioDescription');
    const soapNoteDisplay = document.getElementById('soapNoteDisplay');
    const userSoapChiefComplaintInput = document.getElementById('userSoapChiefComplaint');
    const userSoapICDInput = document.getElementById('userSoapICD');
    const userSoapCPTInput = document.getElementById('userSoapCPT');
    const userSoapModifierInput = document.getElementById('userSoapModifier');
    const soapFeedbackDiv = document.getElementById('soapFeedback');
    const loadSoapScenarioBtn = document.getElementById('loadSoapScenarioBtn');
    const checkSoapBtn = document.getElementById('checkSoapBtn');
    const resetSoapBtn = document.getElementById('resetSoapBtn');

    function loadSoapScenario() {
        currentSoapScenario = soapScenarios[Math.floor(Math.random() * soapScenarios.length)];
        soapChallengeContent.classList.remove('hidden');
        soapScenarioTitle.textContent = currentSoapScenario.title;
        soapScenarioDescription.textContent = currentSoapScenario.description;
        soapNoteDisplay.textContent = currentSoapScenario.soapNote.trim();
        
        userSoapChiefComplaintInput.value = '';
        userSoapICDInput.value = '';
        userSoapCPTInput.value = '';
        userSoapModifierInput.value = '';
        soapFeedbackDiv.innerHTML = '<p class="text-gray-500 soap-feedback-text">Feedback on your extraction will appear here.</p>';
        
        checkSoapBtn.classList.remove('hidden');
        resetSoapBtn.classList.remove('hidden');
    }

    loadSoapScenarioBtn.addEventListener('click', loadSoapScenario);

    checkSoapBtn.addEventListener('click', () => {
        const userComplaint = normalizeText(userSoapChiefComplaintInput.value);
        const userICD = normalizeText(userSoapICDInput.value.replace(/\s/g, ''));
        const userCPT = normalizeText(userSoapCPTInput.value.replace(/\s/g, ''));
        const userModifier = normalizeText(userSoapModifierInput.value.replace(/\s/g, ''));
        
        const correctComplaint = normalizeText(currentSoapScenario.correctExtraction.chiefComplaint);
        const correctICD = normalizeText(currentSoapScenario.correctExtraction.icd.replace(/\s/g, ''));
        const correctCPT = normalizeText(currentSoapScenario.correctExtraction.cpt.replace(/\s/g, ''));
        const correctModifier = normalizeText(currentSoapScenario.correctExtraction.modifier.replace(/\s/g, ''));
        
        let feedbackMessage = '';
        let isCorrect = true;

        if (userComplaint.includes(correctComplaint) || correctComplaint.includes(userComplaint)) {
            feedbackMessage += '<p class="text-green-700 font-bold">‚Ä¢ Chief Complaint: Correct.</p>';
        } else {
            feedbackMessage += '<p class="text-red-700 font-bold">‚Ä¢ Chief Complaint: Incorrect.</p>';
            isCorrect = false;
        }

        if (userICD === correctICD) {
            feedbackMessage += '<p class="text-green-700 font-bold">‚Ä¢ ICD-10 Code(s): Correct.</p>';
        } else {
            feedbackMessage += `<p class="text-red-700 font-bold">‚Ä¢ ICD-10 Code(s): Incorrect. Should be ${currentSoapScenario.correctExtraction.icd}.</p>`;
            isCorrect = false;
        }

        if (userCPT === correctCPT) {
            feedbackMessage += '<p class="text-green-700 font-bold">‚Ä¢ CPT Code(s): Correct.</p>';
        } else {
            feedbackMessage += `<p class="text-red-700 font-bold">‚Ä¢ CPT Code(s): Incorrect. Should be ${currentSoapScenario.correctExtraction.cpt}.</p>`;
            isCorrect = false;
        }
        
        if (userModifier === correctModifier) {
            feedbackMessage += '<p class="text-green-700 font-bold">‚Ä¢ Modifier(s): Correct.</p>';
        } else {
            feedbackMessage += `<p class="text-red-700 font-bold">‚Ä¢ Modifier(s): Incorrect. Should be ${currentSoapScenario.correctExtraction.modifier}.</p>`;
            isCorrect = false;
        }

        if (isCorrect) {
            soapFeedbackDiv.innerHTML = `<p class="text-green-700 font-bold">Excellent! All your extractions are correct.</p>`;
        } else {
            soapFeedbackDiv.innerHTML = `<p class="text-red-700 font-bold">One or more of your extractions is incorrect. Please review and try again.</p><div class="mt-4">${feedbackMessage}</div>`;
        }
    });

    resetSoapBtn.addEventListener('click', () => {
        soapChallengeContent.classList.add('hidden');
        showMessage('Scenario reset.', 'success');
    });

</script>
</body>
</html>



