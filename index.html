<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EHR Simulator for Medical Billing Practice</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }
        input[type="text"], input[type="date"], input[type="number"], textarea, select {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
            padding: 8px 14px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.875rem; /* text-sm */
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .message-box {
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
            display: none; /* Hidden by default */
        }
        .message-box.success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .message-box.error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .flex-grow-1 { /* Custom utility to make item grow */
            flex-grow: 1;
        }
        .hidden {
            display: none;
        }
        .walkthrough-step-content, .quiz-content, .balance-calculator-content, .modifier-challenge-content, .matching-game-content, .scrubber-challenge-content, .denial-challenge-content, .soap-challenge-content, .code-lookup-content, .ar-aging-content, .form-repository-content {
            background-color: #f8fafc; /* bg-blue-50 alternative */
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0; /* border-gray-200 alternative */
            margin-top: 1rem;
        }
        .walkthrough-step-title, .quiz-question-title, .balance-scenario-title, .modifier-challenge-title, .matching-game-title, .scrubber-challenge-title, .denial-challenge-title, .soap-challenge-title, .code-lookup-title, .ar-aging-title, .form-repository-title {
            font-weight: 600; /* font-semibold */
            color: #1a202c; /* text-gray-900 */
            margin-bottom: 0.5rem;
        }
        .walkthrough-instructions, .quiz-instructions, .quiz-feedback-text, .balance-scenario-text, .balance-feedback-text, .modifier-scenario-text, .modifier-feedback-text, .matching-game-text, .scrubber-scenario-text, .scrubber-feedback-text, .denial-scenario-text, .denial-feedback-text, .soap-scenario-text, .soap-feedback-text, .code-lookup-text, .ar-aging-text, .form-repository-text {
            font-size: 0.875rem; /* text-sm */
            color: #4a5568; /* text-gray-700 */
        }
        .quiz-option, .denial-option {
            display: block;
            padding: 8px 0;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 4px;
        }
        .quiz-option:hover, .denial-option:hover {
            background-color: #f0f4f8;
        }
        .quiz-option input[type="radio"], .denial-option input[type="radio"] {
            margin-right: 8px;
        }
        .match-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* Responsive grid */
            gap: 10px;
            margin-top: 20px;
        }
        .match-card {
            background-color: #cbd5e0; /* gray-300 */
            border-radius: 8px;
            padding: 15px;
            height: 120px; /* Fixed height for consistency */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: 600;
            color: #2d3748; /* gray-800 */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
            transform-style: preserve-3d;
            position: relative;
        }
        .match-card.flipped {
            background-color: #fff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .match-card.matched {
            background-color: #a7f3d0; /* green-200 */
            color: #065f46; /* green-800 */
            cursor: default;
            pointer-events: none; /* Disable clicks on matched cards */
        }
        .match-card.incorrect {
            background-color: #fca5a5; /* red-300 */
            color: #991b1b; /* red-800 */
        }
        .card-inner {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            backface-visibility: hidden;
            position: absolute;
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            backface-visibility: hidden;
            border-radius: 8px;
            padding: 15px;
            box-sizing: border-box;
            font-size: 0.9em;
        }
        .card-front {
            background-color: #cbd5e0; /* gray-300 */
            color: #2d3748; /* gray-800 */
            font-weight: 600;
        }
        .card-back {
            background-color: #fff;
            color: #2d3748;
            transform: rotateY(180deg);
        }
        .match-card.is-flipped .card-front {
            transform: rotateY(180deg);
        }
        .match-card.is-flipped .card-back {
            transform: rotateY(360deg);
        }
        #soapNoteDisplay {
            background-color: #f0f4f8; /* Light blue-gray */
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 15px;
            white-space: pre-wrap; /* Preserves formatting */
            font-family: monospace; /* Monospace for code-like text */
            font-size: 0.85rem;
            max-height: 400px; /* Limit height */
            overflow-y: auto; /* Enable scrolling */
            margin-bottom: 20px;
        }
        .ar-claim-item {
            background-color: #f0f4f8;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .ar-claim-details {
            font-size: 0.9rem;
            color: #4a5568;
            margin-bottom: 10px;
        }
        .ar-claim-feedback {
            margin-top: 10px;
            padding: 8px;
            border-radius: 6px;
            font-weight: 500;
        }
        .ar-claim-feedback.correct {
            background-color: #d1fae5;
            color: #065f46;
        }
        .ar-claim-feedback.incorrect {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .form-item {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        .form-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container">
        <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-8">EHR Practice System</h1>

        <!-- Message Box for user feedback -->
        <div id="messageBox" class="message-box"></div>

        <!-- Patient Registration Section -->
        <section class="mb-8 p-6 bg-blue-50 rounded-lg">
            <h2 class="section-title text-blue-800">1. Patient Registration üìù</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="patientName" class="block text-gray-700 text-sm font-bold mb-2">Patient Name:</label>
                    <input type="text" id="patientName" name="patientName" placeholder="John Doe" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="patientDOB" class="block text-gray-700 text-sm font-bold mb-2">Date of Birth:</label>
                    <input type="date" id="patientDOB" name="patientDOB" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label for="insuranceID" class="block text-gray-700 text-sm font-bold mb-2">Insurance ID:</label>
                    <input type="text" id="insuranceID" name="insuranceID" placeholder="ABC123456789" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <button id="registerPatientBtn" class="btn-primary w-full">Register Patient</button>
        </section>

        <!-- Encounter Documentation Section -->
        <section class="mb-8 p-6 bg-green-50 rounded-lg">
            <h2 class="section-title text-green-800">2. Encounter Documentation ü©∫</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="encounterDate" class="block text-gray-700 text-sm font-bold mb-2">Encounter Date:</label>
                    <input type="date" id="encounterDate" name="encounterDate" class="focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="md:col-span-2">
                    <label for="chiefComplaint" class="block text-gray-700 text-sm font-bold mb-2">Chief Complaint:</label>
                    <input type="text" id="chiefComplaint" name="chiefComplaint" placeholder="Patient reports sore throat and fever" class="focus:ring-green-500 focus:border-green-500">
                </div>
            </div>

            <div id="diagnosisList" class="mb-4 space-y-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Diagnoses (ICD Codes):</label>
                <div class="flex items-center gap-2">
                    <input type="text" class="diagnosis-code flex-grow-1 focus:ring-green-500 focus:border-green-500" name="diagnosisCode" placeholder="e.g., J02.9 (Acute pharyngitis)">
                    <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                </div>
            </div>
            <button id="addDiagnosisBtn" class="btn-primary mb-6 w-full bg-green-600 hover:bg-green-700">Add Another Diagnosis</button>

            <div id="procedureList" class="mb-4 space-y-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Procedures (CPT/HCPCS Codes):</label>
                <div class="flex items-center gap-2">
                    <input type="text" class="procedure-code flex-grow-1 focus:ring-green-500 focus:border-green-500" name="procedureCode" placeholder="e.g., 99213 (Office visit)">
                    <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                </div>
            </div>
            <button id="addProcedureBtn" class="btn-primary w-full bg-green-600 hover:bg-green-700">Add Another Procedure</button>
        </section>

        <!-- Charge Entry Section -->
        <section class="mb-8 p-6 bg-purple-50 rounded-lg">
            <h2 class="section-title text-purple-800">3. Charge Entry & Services üí≤</h2>
            <div id="chargeList" class="mb-4 space-y-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Services Rendered:</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 service-item">
                    <input type="text" class="service-description col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500" name="serviceDescription" placeholder="Service Description">
                    <input type="text" class="service-cpt-code col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500" name="serviceCptCode" placeholder="CPT Code">
                    <div class="flex gap-2 col-span-1 md:col-span-1">
                        <input type="number" class="service-price flex-grow-1 focus:ring-purple-500 focus:border-purple-500" name="servicePrice" placeholder="Price ($)" min="0" step="0.01">
                        <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                    </div>
                </div>
            </div>
            <button id="addChargeBtn" class="btn-primary w-full bg-purple-600 hover:bg-purple-700">Add Another Service</button>
        </section>

        <!-- Generate Claim Section -->
        <section class="p-6 bg-red-50 rounded-lg mb-8">
            <h2 class="section-title text-red-800">4. Generate & View Claim üìÑ</h2>
            <button id="generateClaimBtn" class="btn-primary w-full mb-6 bg-red-600 hover:bg-red-700">Generate Simulated Claim</button>

            <div id="claimOutput" class="bg-gray-50 p-4 border border-gray-200 rounded-lg min-h-[150px] overflow-auto text-sm text-gray-800 whitespace-pre-wrap">
                <!-- Claim data will appear here -->
                <p class="text-gray-500">Your simulated claim details will appear here after generation.</p>
            </div>
            <button id="clearAllBtn" class="btn-secondary w-full mt-4">Clear All Data</button>
        </section>

        <!-- Medical Billing Walkthrough Section -->
        <section class="p-6 bg-indigo-50 rounded-lg mb-8">
            <h2 class="section-title text-indigo-800">5. Medical Billing Process Walkthrough üö∂‚Äç‚ôÄÔ∏è</h2>
            <p class="text-gray-700 mb-4">Click "Start Step" or "Next Step" to walk through the revenue cycle.</p>

            <div id="billingWalkthroughContent" class="hidden">
                <h3 id="walkthroughStepTitle" class="walkthrough-step-title text-indigo-700"></h3>
                <div id="walkthroughStepInstructions" class="walkthrough-instructions"></div>
            </div>
           
            <button id="startBillingWalkthroughBtn" class="btn-primary w-full mb-4 bg-indigo-600 hover:bg-indigo-700">Start Billing Walkthrough</button>
            <button id="nextBillingWalkthroughBtn" class="btn-primary w-full mb-4 bg-indigo-600 hover:bg-indigo-700 hidden">Next Step</button>
            <button id="resetBillingWalkthroughBtn" class="btn-secondary w-full hidden">Reset Walkthrough</button>
        </section>

        <!-- Prior Authorization Walkthrough Section -->
        <section class="p-6 bg-orange-50 rounded-lg mb-8">
            <h2 class="section-title text-orange-800">6. Prior Authorization (PA) Walkthrough üö¶</h2>
            <p class="text-gray-700 mb-4">Follow the steps to understand a PA scenario.</p>

            <div id="paWalkthroughContent" class="hidden">
                <h3 id="paWalkthroughStepTitle" class="walkthrough-step-title text-orange-700"></h3>
                <div id="paWalkthroughStepInstructions" class="walkthrough-instructions"></div>
            </div>
           
            <button id="startPaWalkthroughBtn" class="btn-primary w-full mb-4 bg-orange-600 hover:bg-orange-700">Start PA Walkthrough</button>
            <button id="nextPaWalkthroughBtn" class="btn-primary w-full mb-4 bg-orange-600 hover:bg-orange-700 hidden">Next Step</button>
            <button id="resetPaWalkthroughBtn" class="btn-secondary w-full hidden">Reset PA Walkthrough</button>
        </section>

        <!-- Knowledge Quizzes Section -->
        <section class="p-6 bg-pink-50 rounded-lg mb-8">
            <h2 class="section-title text-pink-800">7. Knowledge Quizzes! üìö</h2>
            <p class="text-gray-700 mb-4">Test your understanding of coding guidelines, healthcare laws, ethics, and denials & appeals!</p>

            <div class="flex flex-wrap gap-3 mb-6">
                <button id="quizGuidelinesBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Coding Guidelines</button>
                <button id="quizLawsBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Healthcare Laws</button>
                <button id="quizEthicsBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Coding Ethics</button>
                <button id="quizDenialsBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Denials & Appeals</button>
                <button id="quizInsuranceNuanceBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Insurance Nuances</button>
            </div>

            <div id="quizContent" class="quiz-content hidden">
                <h3 id="quizQuestionTitle" class="quiz-question-title text-pink-700"></h3>
                <div id="quizOptions" class="mb-4">
                    <!-- Options will be dynamically inserted here -->
                </div>
                
                <button id="submitAnswerBtn" class="btn-primary bg-pink-600 hover:bg-pink-700 mb-4">Submit Answer</button>
                <button id="nextQuestionBtn" class="btn-secondary hidden">Next Question</button>
                <button id="resetQuizBtn" class="btn-secondary hidden">Reset Quiz</button>

                <div id="quizFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 quiz-feedback-text">Your feedback will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Patient Balance Calculator Section -->
        <section class="p-6 bg-teal-50 rounded-lg mb-8">
            <h2 class="section-title text-teal-800">8. Patient Balance Calculator üí∞</h2>
            <p class="text-gray-700 mb-4">Practice calculating patient responsibility based on common scenarios.</p>

            <button id="loadBalanceScenarioBtn" class="btn-primary w-full mb-6 bg-teal-600 hover:bg-teal-700">Load New Scenario</button>

            <div id="balanceCalculatorContent" class="balance-calculator-content hidden">
                <h3 id="balanceScenarioTitle" class="balance-scenario-title text-teal-700"></h3>
                <div id="balanceScenarioDetails" class="balance-scenario-text mb-4"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="userCopay" class="block text-gray-700 text-sm font-bold mb-2">Your Calculated Copay ($):</label>
                        <input type="number" id="userCopay" name="userCopay" placeholder="0.00" min="0" step="0.01" class="focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="userDeductibleInput" class="block text-gray-700 text-sm font-bold mb-2">Your Calculated Deductible Applied ($):</label>
                        <input type="number" id="userDeductibleInput" name="userDeductibleInput" placeholder="0.00" min="0" step="0.01" class="focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="userCoinsurance" class="block text-gray-700 text-sm font-bold mb-2">Your Calculated Coinsurance ($):</label>
                        <input type="number" id="userCoinsurance" name="userCoinsurance" placeholder="0.00" min="0" step="0.01" class="focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="userTotalBalance" class="block text-gray-700 text-sm font-bold mb-2">Your Calculated Total Patient Balance ($):</label>
                        <input type="number" id="userTotalBalance" name="userTotalBalance" placeholder="0.00" min="0" step="0.01" class="font-bold focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                
                <button id="checkBalanceBtn" class="btn-primary bg-teal-600 hover:bg-teal-700 mb-4">Check My Calculation</button>
                <button id="resetBalanceBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="balanceFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 balance-feedback-text">Feedback on your calculation will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Advanced Modifier Application Challenge Section -->
        <section class="p-6 bg-yellow-50 rounded-lg mb-8">
            <h2 class="section-title text-yellow-800">9. Advanced Modifier Application Challenge üåü</h2>
            <p class="text-gray-700 mb-4">Analyze the scenario and apply the appropriate CPT code and modifier.</p>

            <button id="loadModifierScenarioBtn" class="btn-primary w-full mb-6 bg-yellow-600 hover:bg-yellow-700">Load New Scenario</button>

            <div id="modifierChallengeContent" class="modifier-challenge-content hidden">
                <h3 id="modifierScenarioTitle" class="modifier-challenge-title text-yellow-700"></h3>
                <div id="modifierScenarioDetails" class="modifier-scenario-text mb-4"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="userModifierCPT" class="block text-gray-700 text-sm font-bold mb-2">Your CPT Code:</label>
                        <input type="text" id="userModifierCPT" name="userModifierCPT" placeholder="e.g., 99213" class="focus:ring-yellow-500 focus:border-yellow-500 uppercase">
                    </div>
                    <div>
                        <label for="userModifier" class="block text-gray-700 text-sm font-bold mb-2">Your Modifier(s) (e.g., 25, 59):</label>
                        <input type="text" id="userModifier" name="userModifier" placeholder="e.g., 25" class="focus:ring-yellow-500 focus:border-yellow-500 uppercase">
                    </div>
                </div>
                
                <button id="checkModifierBtn" class="btn-primary bg-yellow-600 hover:bg-yellow-700 mb-4">Check My Modifier</button>
                <button id="resetModifierBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="modifierFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 modifier-feedback-text">Feedback on your modifier application will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Medical Terminology Matching Game -->
        <section class="p-6 bg-blue-50 rounded-lg mb-8">
            <h2 class="section-title text-blue-800">10. Medical Terminology Matching Game üß†</h2>
            <p class="text-gray-700 mb-4">Match the medical billing terms/acronyms with their correct definitions.</p>

            <button id="startGameBtn" class="btn-primary w-full mb-6 bg-blue-600 hover:bg-blue-700">Start New Game</button>

            <div id="matchingGameContent" class="matching-game-content hidden">
                <p id="gameMessage" class="text-center text-lg font-bold mb-4"></p>
                <div id="cardGrid" class="match-card-grid">
                    <!-- Cards will be dynamically inserted here -->
                </div>
                <button id="resetGameBtn" class="btn-secondary w-full mt-6 hidden">Reset Game</button>
            </div>
        </section>

        <!-- Claim Scrubber / Error Finder Challenge Section -->
        <section class="p-6 bg-orange-100 rounded-lg mb-8">
            <h2 class="section-title text-orange-800">11. Claim Scrubber / Error Finder Challenge üîç</h2>
            <p class="text-gray-700 mb-4">Review the presented claim scenario and identify/correct the errors.</p>

            <button id="loadScrubberScenarioBtn" class="btn-primary w-full mb-6 bg-orange-600 hover:bg-orange-700">Load New Scenario</button>

            <div id="scrubberChallengeContent" class="scrubber-challenge-content hidden">
                <h3 id="scrubberScenarioTitle" class="scrubber-challenge-title text-orange-700"></h3>
                <div id="scrubberScenarioDetails" class="scrubber-scenario-text mb-4"></div>
                
                <p class="font-bold text-gray-700 mb-2">Presented Claim Details:</p>
                <pre id="presentedClaimOutput" class="bg-gray-50 p-3 rounded-lg border border-gray-200 text-sm whitespace-pre-wrap mb-4"></pre>

                <p class="font-bold text-gray-700 mb-2">Your Corrected Codes/Modifiers:</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="userScrubberICD" class="block text-gray-700 text-sm font-bold mb-2">Corrected ICD-10:</label>
                        <input type="text" id="userScrubberICD" name="userScrubberICD" placeholder="e.g., I10" class="focus:ring-orange-500 focus:border-orange-500 uppercase">
                    </div>
                    <div>
                        <label for="userScrubberCPT" class="block text-gray-700 text-sm font-bold mb-2">Corrected CPT:</label>
                        <input type="text" id="userScrubberCPT" name="userScrubberCPT" placeholder="e.g., 99213" class="focus:ring-orange-500 focus:border-orange-500 uppercase">
                    </div>
                    <div>
                        <label for="userScrubberModifier" class="block text-gray-700 text-sm font-bold mb-2">Corrected Modifier(s):</label>
                        <input type="text" id="userScrubberModifier" name="userScrubberModifier" placeholder="e.g., 25, 59 (or 'None')" class="focus:ring-orange-500 focus:border-orange-500 uppercase">
                    </div>
                </div>
                
                <button id="checkScrubberBtn" class="btn-primary bg-orange-600 hover:bg-orange-700 mb-4">Check My Corrections</button>
                <button id="resetScrubberBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="scrubberFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 scrubber-feedback-text">Feedback on your corrections will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Denial Code Interpreter & Action Plan Simulator Section -->
        <section class="p-6 bg-purple-100 rounded-lg mb-8">
            <h2 class="section-title text-purple-800">12. Denial Code Interpreter & Action Plan Simulator üö´</h2>
            <p class="text-gray-700 mb-4">Interpret the denial code and plan your next steps to resolve the claim.</p>

            <button id="loadDenialScenarioBtn" class="btn-primary w-full mb-6 bg-purple-600 hover:bg-purple-700">Load New Denial Scenario</button>

            <div id="denialChallengeContent" class="denial-challenge-content hidden">
                <h3 id="denialScenarioTitle" class="denial-challenge-title text-purple-700"></h3>
                <div id="denialScenarioDetails" class="denial-scenario-text mb-4"></div>
                
                <p class="font-bold text-gray-700 mb-2">Interpret the Denial Code:</p>
                <div id="denialInterpretationOptions" class="mb-4">
                    <!-- Options for interpretation will be dynamically inserted here -->
                </div>

                <p class="font-bold text-gray-700 mb-2">Your Action Plan (be specific):</p>
                <textarea id="userActionPlan" name="userActionPlan" rows="4" placeholder="e.g., Research payer policy, appeal with medical records, bill patient..." class="focus:ring-purple-500 focus:border-purple-500 mb-4"></textarea>
                
                <button id="checkDenialBtn" class="btn-primary bg-purple-600 hover:bg-purple-700 mb-4">Check My Plan</button>
                <button id="resetDenialBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="denialFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 denial-feedback-text">Feedback on your denial resolution plan will appear here.</p>
                </div>
            </div>
        </section>

        <!-- SOAP Note Coder & Extractor Challenge Section -->
        <section class="p-6 bg-teal-100 rounded-lg mb-8">
            <h2 class="section-title text-teal-800">13. SOAP Note Coder & Extractor Challenge üìã</h2>
            <p class="text-gray-700 mb-4">Review the SOAP note below and extract the relevant coding and plan information.</p>

            <button id="loadSoapScenarioBtn" class="btn-primary w-full mb-6 bg-teal-600 hover:bg-teal-700">Load New SOAP Note Scenario</button>

            <div id="soapChallengeContent" class="soap-challenge-content hidden">
                <h3 id="soapScenarioTitle" class="soap-challenge-title text-teal-700"></h3>
                <p id="soapScenarioDescription" class="soap-scenario-text mb-4"></p>
                
                <div id="soapNoteDisplay" class="mb-4">
                    <!-- SOAP note content will be loaded here -->
                </div>

                <p class="font-bold text-gray-700 mb-2">Your Extracted Information:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="md:col-span-2">
                        <label for="userSoapChiefComplaint" class="block text-gray-700 text-sm font-bold mb-2">Chief Complaint:</label>
                        <input type="text" id="userSoapChiefComplaint" name="userSoapChiefComplaint" placeholder="Patient's main reason for visit" class="focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="userSoapICD" class="block text-gray-700 text-sm font-bold mb-2">Primary ICD-10 Code(s):</label>
                        <input type="text" id="userSoapICD" name="userSoapICD" placeholder="e.g., J02.0 (comma-separated if multiple)" class="focus:ring-teal-500 focus:border-teal-500 uppercase">
                    </div>
                    <div>
                        <label for="userSoapCPT" class="block text-gray-700 text-sm font-bold mb-2">Primary CPT Code(s):</label>
                        <input type="text" id="userSoapCPT" name="userSoapCPT" placeholder="e.g., 99213, 87880 (comma-separated if multiple)" class="focus:ring-teal-500 focus:border-teal-500 uppercase">
                    </div>
                    <div class="md:col-span-2">
                        <label for="userSoapModifier" class="block text-gray-700 text-sm font-bold mb-2">Modifier(s) (if any):</label>
                        <input type="text" id="userSoapModifier" name="userSoapModifier" placeholder="e.g., 25 (or 'None')" class="focus:ring-teal-500 focus:border-teal-500 uppercase">
                    </div>
                    <div class="md:col-span-2">
                        <label for="userSoapPlan" class="block text-gray-700 text-sm font-bold mb-2">Key Elements of the Plan:</label>
                        <textarea id="userSoapPlan" name="userSoapPlan" rows="4" placeholder="Summarize medication, follow-up, education etc." class="focus:ring-teal-500 focus:border-teal-500"></textarea>
                    </div>
                </div>
                
                <button id="checkSoapBtn" class="btn-primary bg-teal-600 hover:bg-teal-700 mb-4">Check My Extraction</button>
                <button id="resetSoapBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="soapFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 soap-feedback-text">Feedback on your extraction will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Code Lookup Tool Section -->
        <section class="p-6 bg-yellow-100 rounded-lg mb-8">
            <h2 class="section-title text-yellow-800">14. Code Lookup Tool üìö</h2>
            <p class="text-gray-700 mb-4">Search for common ICD-10 or CPT codes to see their descriptions.</p>

            <div id="codeLookupContent" class="code-lookup-content">
                <div class="mb-4">
                    <label for="codeLookupInput" class="block text-gray-700 text-sm font-bold mb-2">Enter Code (e.g., J02.0, 99213):</label>
                    <input type="text" id="codeLookupInput" name="codeLookupInput" placeholder="Enter ICD-10 or CPT code" class="focus:ring-yellow-500 focus:border-yellow-500 uppercase">
                </div>
                <button id="lookupCodeBtn" class="btn-primary w-full mb-4 bg-yellow-600 hover:bg-yellow-700">Lookup Code</button>
                <div id="codeLookupResult" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500">Code description will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Accounts Receivable (A/R) Aging Simulation Section -->
        <section class="p-6 bg-red-100 rounded-lg mb-8">
            <h2 class="section-title text-red-800">15. Accounts Receivable (A/R) Aging Simulation üìà</h2>
            <p class="text-gray-700 mb-4">Practice analyzing aging claims and determining the correct follow-up action. Select an action for each claim.</p>

            <button id="loadArScenarioBtn" class="btn-primary w-full mb-6 bg-red-600 hover:bg-red-700">Load New A/R Scenario</button>

            <div id="arAgingContent" class="ar-aging-content hidden">
                <div id="arClaimList">
                    <!-- A/R claims will be dynamically inserted here -->
                </div>
                <button id="checkArActionsBtn" class="btn-primary w-full mt-4 bg-red-600 hover:bg-red-700">Check My Actions</button>
                <button id="resetArScenarioBtn" class="btn-secondary w-full mt-2 hidden">Reset A/R Scenario</button>
                <div id="arFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500">Feedback on your A/R actions will appear here.</p>
                </div>
            </div>
        </section>

        <!-- NEW: Medical Billing Form Repository Section -->
        <section class="p-6 bg-blue-100 rounded-lg mb-8">
            <h2 class="section-title text-blue-800">16. Medical Billing Form Repository üìÇ</h2>
            <p class="text-gray-700 mb-4">Explore descriptions of common forms used in medical billing and where to find their blank templates online for practice.</p>

            <div id="formRepositoryContent" class="form-repository-content">
                <div class="form-item">
                    <h3 class="form-repository-title text-blue-700">CMS-1500 Claim Form</h3>
                    <p class="form-repository-text">This is the universal claim form for professional (physician and non-institutional) services. It captures patient demographics, insurance information, diagnoses (ICD-10), procedures (CPT/HCPCS), and charges. It's the most common form you'll encounter for outpatient billing.</p>
                    <p class="form-repository-text mt-1 text-xs italic">You can find blank CMS-1500 templates by searching online for "CMS-1500 form fillable PDF" or "NUCC CMS-1500 form".</p>
                </div>
                <div class="form-item">
                    <h3 class="form-repository-title text-blue-700">UB-04 Claim Form (CMS-1450)</h3>
                    <p class="form-repository-text">This is the claim form used by institutional providers (like hospitals, skilled nursing facilities, ambulatory surgical centers) for inpatient and outpatient services. It captures facility charges, revenue codes, and patient stay details.</p>
                    <p class="form-repository-text mt-1 text-xs italic">You can find blank UB-04 templates by searching online for "UB-04 form fillable PDF" or "NUBC UB-04 form".</p>
                </div>
                <div class="form-item">
                    <h3 class="form-repository-title text-blue-700">Advance Beneficiary Notice of Noncoverage (ABN)</h3>
                    <p class="form-repository-text">A form given to Medicare beneficiaries when a service may not be covered by Medicare. It informs the patient they may be responsible for payment if Medicare denies the service, requiring their signature before service delivery. This protects the provider's right to bill the patient.</p>
                    <p class="form-repository-text mt-1 text-xs italic">You can find blank ABN forms (CMS-R-131) on the CMS website or by searching for "CMS ABN form".</p>
                </div>
                 <div class="form-item">
                    <h3 class="form-repository-title text-blue-700">Explanation of Benefits (EOB) / Electronic Remittance Advice (ERA)</h3>
                    <p class="form-repository-text">These are not "forms" you fill out, but rather documents generated by insurance companies. The EOB is sent to the patient and provider, detailing how a claim was processed (what was paid, denied, applied to deductible, etc.). The ERA is the electronic version sent to the provider, allowing for automated payment posting.</p>
                    <p class="form-repository-text mt-1 text-xs italic">Practice interpreting EOBs/ERAs by requesting sample EOBs from your insurance provider (if they offer them) or by searching online for "sample EOB Medicare" or "sample ERA medical billing".</p>
                </div>
            </div>
        </section>

    </div>

    <footer class="text-center text-gray-600 text-sm mt-10 pb-5">
        &copy; 2025 Chandra M Harris
    </footer>

    <script>
        // DOM Element References (existing sections)
        const patientNameInput = document.getElementById('patientName');
        const patientDOBInput = document.getElementById('patientDOB');
        const insuranceIDInput = document.getElementById('insuranceID');
        const registerPatientBtn = document.getElementById('registerPatientBtn');

        const encounterDateInput = document.getElementById('encounterDate');
        const chiefComplaintInput = document.getElementById('chiefComplaint');
        const diagnosisList = document.getElementById('diagnosisList');
        const addDiagnosisBtn = document.getElementById('addDiagnosisBtn');
        const procedureList = document.getElementById('procedureList');
        const addProcedureBtn = document.getElementById('addProcedureBtn');

        const chargeList = document.getElementById('chargeList');
        const addChargeBtn = document.getElementById('addChargeBtn');

        const generateClaimBtn = document.getElementById('generateClaimBtn');
        const claimOutput = document.getElementById('claimOutput');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const messageBox = document.getElementById('messageBox');

        // DOM Element References (Medical Billing Walkthrough)
        const billingWalkthroughContent = document.getElementById('billingWalkthroughContent');
        const walkthroughStepTitle = document.getElementById('walkthroughStepTitle');
        const walkthroughStepInstructions = document.getElementById('walkthroughStepInstructions');
        const startBillingWalkthroughBtn = document.getElementById('startBillingWalkthroughBtn');
        const nextBillingWalkthroughBtn = document.getElementById('nextBillingWalkthroughBtn');
        const resetBillingWalkthroughBtn = document.getElementById('resetBillingWalkthroughBtn');

        // DOM Element References (Prior Authorization Walkthrough)
        const paWalkthroughContent = document.getElementById('paWalkthroughContent');
        const paWalkthroughStepTitle = document.getElementById('paWalkthroughStepTitle');
        const paWalkthroughStepInstructions = document.getElementById('paWalkthroughStepInstructions');
        const startPaWalkthroughBtn = document.getElementById('startPaWalkthroughBtn');
        const nextPaWalkthroughBtn = document.getElementById('nextPaWalkthroughBtn');
        const resetPaWalkthroughBtn = document.getElementById('resetPaWalkthroughBtn');

        // DOM Element References (Knowledge Quizzes)
        const quizGuidelinesBtn = document.getElementById('quizGuidelinesBtn');
        const quizLawsBtn = document.getElementById('quizLawsBtn');
        const quizEthicsBtn = document.getElementById('quizEthicsBtn');
        const quizDenialsBtn = document.getElementById('quizDenialsBtn');
        const quizInsuranceNuanceBtn = document.getElementById('quizInsuranceNuanceBtn');
        const quizContent = document.getElementById('quizContent');
        const quizQuestionTitle = document.getElementById('quizQuestionTitle');
        const quizOptions = document.getElementById('quizOptions');
        const submitAnswerBtn = document.getElementById('submitAnswerBtn');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const resetQuizBtn = document.getElementById('resetQuizBtn');
        const quizFeedback = document.getElementById('quizFeedback');

        // DOM Element References (Patient Balance Calculator)
        const loadBalanceScenarioBtn = document.getElementById('loadBalanceScenarioBtn');
        const balanceCalculatorContent = document.getElementById('balanceCalculatorContent');
        const balanceScenarioTitle = document.getElementById('balanceScenarioTitle');
        const balanceScenarioDetails = document.getElementById('balanceScenarioDetails');
        const userCopayInput = document.getElementById('userCopay');
        const userDeductibleInput = document.getElementById('userDeductibleInput'); // Corrected ID
        const userCoinsuranceInput = document.getElementById('userCoinsurance');
        const userTotalBalanceInput = document.getElementById('userTotalBalance');
        const checkBalanceBtn = document.getElementById('checkBalanceBtn');
        const resetBalanceBtn = document.getElementById('resetBalanceBtn');
        const balanceFeedback = document.getElementById('balanceFeedback');

        // DOM Element References (Modifier Application Challenge)
        const loadModifierScenarioBtn = document.getElementById('loadModifierScenarioBtn');
        const modifierChallengeContent = document.getElementById('modifierChallengeContent');
        const modifierScenarioTitle = document.getElementById('modifierScenarioTitle');
        const modifierScenarioDetails = document.getElementById('modifierScenarioDetails');
        const userModifierCPTInput = document.getElementById('userModifierCPT');
        const userModifierInput = document.getElementById('userModifier');
        const checkModifierBtn = document.getElementById('checkModifierBtn');
        const resetModifierBtn = document.getElementById('resetModifierBtn');
        const modifierFeedback = document.getElementById('modifierFeedback');

        // DOM Element References (Matching Game)
        const startGameBtn = document.getElementById('startGameBtn');
        const matchingGameContent = document.getElementById('matchingGameContent');
        const cardGrid = document.getElementById('cardGrid');
        const gameMessage = document.getElementById('gameMessage');
        const resetGameBtn = document.getElementById('resetGameBtn');

        // DOM Element References (Claim Scrubber)
        const loadScrubberScenarioBtn = document.getElementById('loadScrubberScenarioBtn');
        const scrubberChallengeContent = document.getElementById('scrubberChallengeContent');
        const scrubberScenarioTitle = document.getElementById('scrubberScenarioTitle');
        const scrubberScenarioDetails = document.getElementById('scrubberScenarioDetails');
        const presentedClaimOutput = document.getElementById('presentedClaimOutput');
        const userScrubberICDInput = document.getElementById('userScrubberICD');
        const userScrubberCPTInput = document.getElementById('userScrubberCPT');
        const userScrubberModifierInput = document.getElementById('userScrubberModifier');
        const checkScrubberBtn = document.getElementById('checkScrubberBtn');
        const resetScrubberBtn = document.getElementById('resetScrubberBtn');
        const scrubberFeedback = document.getElementById('scrubberFeedback');

        // DOM Element References (Denial Code Interpreter)
        const loadDenialScenarioBtn = document.getElementById('loadDenialScenarioBtn');
        const denialChallengeContent = document.getElementById('denialChallengeContent');
        const denialScenarioTitle = document.getElementById('denialScenarioTitle');
        const denialScenarioDetails = document.getElementById('denialScenarioDetails');
        const denialInterpretationOptions = document.getElementById('denialInterpretationOptions');
        const userActionPlanInput = document.getElementById('userActionPlan');
        const checkDenialBtn = document.getElementById('checkDenialBtn');
        const resetDenialBtn = document.getElementById('resetDenialBtn');
        const denialFeedback = document.getElementById('denialFeedback');

        // DOM Element References (SOAP Note Challenge)
        const loadSoapScenarioBtn = document.getElementById('loadSoapScenarioBtn');
        const soapChallengeContent = document.getElementById('soapChallengeContent');
        const soapScenarioTitle = document.getElementById('soapScenarioTitle');
        const soapScenarioDescription = document.getElementById('soapScenarioDescription');
        const soapNoteDisplay = document.getElementById('soapNoteDisplay');
        const userSoapChiefComplaintInput = document.getElementById('userSoapChiefComplaint');
        const userSoapICDInput = document.getElementById('userSoapICD');
        const userSoapCPTInput = document.getElementById('userSoapCPT');
        const userSoapModifierInput = document.getElementById('userSoapModifier');
        const userSoapPlanInput = document.getElementById('userSoapPlan');
        const checkSoapBtn = document.getElementById('checkSoapBtn');
        const resetSoapBtn = document.getElementById('resetSoapBtn');
        const soapFeedback = document.getElementById('soapFeedback');

        // Code Lookup Tool DOM Elements
        const codeLookupInput = document.getElementById('codeLookupInput');
        const lookupCodeBtn = document.getElementById('lookupCodeBtn');
        const codeLookupResult = document.getElementById('codeLookupResult');
        const codeLookupContent = document.getElementById('codeLookupContent');

        // NEW: A/R Aging Simulation DOM Elements
        const loadArScenarioBtn = document.getElementById('loadArScenarioBtn');
        const arAgingContent = document.getElementById('arAgingContent');
        const arClaimList = document.getElementById('arClaimList');
        const checkArActionsBtn = document.getElementById('checkArActionsBtn');
        const resetArScenarioBtn = document.getElementById('resetArScenarioBtn');
        const arFeedback = document.getElementById('arFeedback');

        // NEW: Form Repository DOM Elements (no dynamic parts, just content)
        const formRepositoryContent = document.getElementById('formRepositoryContent');


        // --- Global Data Storage (for existing simulation) ---
        let patientData = {};
        let diagnoses = [];
        let procedures = [];
        let charges = [];

        // --- Global Data Storage (Medical Billing Walkthrough) ---
        let currentBillingStep = 0;
        const billingSteps = [
            {
                title: "Step 1: Patient Registration & Insurance Verification",
                instructions: `**Action:** Begin by gathering the patient's full demographics and insurance details. **On the simulator:** Fill in the 'Patient Registration' section (Name, DOB, Insurance ID) and click 'Register Patient'. In a real scenario, you'd also call the payer to verify eligibility and benefits.`,
            },
            {
                title: "Step 2: Patient Encounter Documentation",
                instructions: `**Action:** This is where the provider records the visit details. **On the simulator:** Fill in the 'Encounter Documentation' section (Encounter Date, Chief Complaint, and add at least one Diagnosis and one Procedure). This mirrors the clinical notes that inform coding.`,
            },
            {
                title: "Step 3: Medical Coding",
                instructions: `**Action:** Translate the documentation into standardized ICD-10 and CPT codes. **On the simulator:** Ensure your Diagnosis and Procedure inputs in Section 2 are correctly formatted codes. This is a critical skill for accurate billing.`,
            },
            {
                title: "Step 4: Charge Entry & Superbill Creation",
                instructions: `**Action:** Enter the charges for the services provided. **On the simulator:** Go to 'Charge Entry & Services', add descriptions, CPT codes (ensure they match your procedures from step 2), and prices for the services. This creates the financial record.`,
            },
            {
                title: "Step 5: Claim Generation & Submission",
                instructions: `**Action:** Compile all data into a standardized claim (CMS-1500 for professional, UB-04 for institutional) and send it to the payer. **On the simulator:** Click 'Generate Simulated Claim' in Section 4. This is the official request for payment.`,
            },
            {
                title: "Step 6: Claim Adjudication",
                instructions: `**Understanding:** The insurance company reviews the claim. They'll either pay, deny, or reject it, sending an EOB (for patient) or ERA (for provider). **Think:** What common reasons lead to denials at this stage? (e.g., medical necessity, timely filing)`,
            },
            {
                title: "Step 7: Payment Posting",
                instructions: `**Action:** Once paid, the payment is recorded in the billing system. **Understanding:** This updates the patient's balance and the provider's accounts. Accurate posting prevents overbilling or outstanding balances.`,
            },
            {
                title: "Step 8: Patient Billing & Collections",
                instructions: `**Action:** If a balance remains after insurance pays, the patient is billed. **Understanding:** This involves sending statements and following up on overdue payments. Clear communication with patients is key.`,
            },
            {
                title: "Step 9: Reporting & Analysis",
                instructions: `**Understanding:** Continuously analyze billing data to identify trends, improve efficiency, and reduce denials. This step helps optimize the entire revenue cycle. **You've completed the walkthrough!**`,
            },
        ];

        // --- Global Data Storage (Prior Authorization Walkthrough) ---
        let currentPaStep = 0;
        const paSteps = [
            {
                title: "PA Step 1: Identify Need for Prior Authorization",
                instructions: `**Scenario:** A patient needs an MRI of the knee.
                **Action:** The first step is to check the patient's insurance plan and the specific CPT code (e.g., CPT 73721 for MRI knee without contrast) against the payer's policy to determine if a Prior Authorization (PA) is required. Many high-cost imaging services or specialty medications require PA.`,
            },
            {
                title: "PA Step 2: Gather Necessary Information",
                instructions: `**Action:** If PA is required, you must collect all relevant clinical and administrative information.
                **Required Info:** Patient demographics, insurance details, referring and rendering provider NPIs, **exact CPT code(s) with modifiers**, **supporting ICD-10 diagnosis code(s) demonstrating medical necessity**, date of service, and any clinical notes (e.g., physician's order, previous treatments tried and failed).`,
            },
            {
                title: "PA Step 3: Submit the Request",
                instructions: `**Action:** Submit the PA request to the insurance company. This is usually done online via a payer portal, fax, or phone.
                **Key Point:** Ensure all fields are accurately completed and all required supporting documentation is attached. Incomplete requests are a common cause of delays or denials.`,
            },
            {
                title: "PA Step 4: Follow-up and Await Decision",
                instructions: `**Action:** After submission, monitor the status of the request. Payers have specific turnaround times (e.g., 7-14 business days for routine, 24-72 hours for urgent).
                **Outcome:** The PA will either be **Approved**, **Denied**, or sent back for **More Information**.`,
            },
            {
                title: "PA Step 5: Handle Approved Authorization",
                instructions: `**Action:** If approved, carefully note the **authorization number**, the **approved CPT codes**, the **number of units/visits approved**, and the **valid date range**.
                **Next:** Ensure this authorization number is included on the claim when submitted to prevent denials. Inform the patient and scheduling department.`,
            },
            {
                title: "PA Step 6: Handle Denied Authorization",
                instructions: `**Action:** If denied, review the denial reason code carefully (often found on an EOB/ERA from the PA department). Common reasons include 'not medically necessary' or 'incorrect information'.
                **Next:** If denied for medical necessity, discuss with the provider if an appeal (with additional clinical documentation or a peer-to-peer review) is warranted. If denied for administrative reasons, correct and resubmit. **You've completed the PA walkthrough!**`,
            },
        ];

        // --- Global Data Storage (Knowledge Quizzes) ---
        let selectedQuizModule = null; // Stores the array of questions for the current module
        let currentQuizQuestionIndex = 0; // Tracks the current question in the module

        const quizModules = {
            "Coding Guidelines": [
                {
                    question: "What does a CPT code modifier indicate?",
                    options: ["A. A new diagnosis", "B. The code has been altered in some way", "C. The patient has insurance", "D. The service was performed in a hospital"],
                    answer: "B",
                    explanation: "A CPT modifier is a two-digit code appended to a CPT code to provide additional information about the procedure or service, such as that it was altered or performed by more than one physician."
                },
                {
                    question: "Which coding system is used for diagnosis codes?",
                    options: ["A. CPT", "B. HCPCS Level II", "C. ICD-10-CM", "D. E&M"],
                    answer: "C",
                    explanation: "ICD-10-CM (International Classification of Diseases, 10th Revision, Clinical Modification) is the standard system for diagnosis codes in the U.S."
                },
                // Add more Coding Guidelines questions here
            ],
            "Healthcare Laws": [
                {
                    question: "What is the primary purpose of HIPAA for medical coders?",
                    options: ["A. To ensure patients get timely appointments", "B. To protect the privacy and security of patient health information (PHI)", "C. To set reimbursement rates for services", "D. To standardize coding manuals"],
                    answer: "B",
                    explanation: "HIPAA's Privacy Rule and Security Rule mandate that Protected Health Information (PHI) is kept confidential and secure."
                },
                {
                    question: "Submitting a claim with codes that you know are wrong to get a higher payment is a violation of which law?",
                    options: ["A. Stark Law", "B. Anti-Kickback Statute", "C. False Claims Act (FCA)", "D. OIG Exclusions"],
                    answer: "C",
                    explanation: "The False Claims Act (FCA) imposes liability on persons and companies who knowingly submit false claims to the government."
                },
                // Add more Healthcare Laws questions here
            ],
            "Coding Ethics": [
                {
                    question: "Your boss tells you to change a code to one that provides higher reimbursement, even though the documentation doesn't support it. What is the most ethical action?",
                    options: ["A. Do what your boss says to avoid conflict", "B. Report the incident to a compliance officer", "C. Change the code but make a note in your personal records", "D. Tell the patient to file a complaint"],
                    answer: "B",
                    explanation: "The most ethical and legally compliant action is to report fraudulent activities, such as upcoding, to a designated compliance officer or legal department. This protects you and the organization."
                },
                // Add more Coding Ethics questions here
            ],
            "Denials & Appeals": [
                {
                    question: "A claim is denied because the diagnosis code does not justify the procedure code. What is this denial reason called?",
                    options: ["A. Medical necessity denial", "B. Bundling issue", "C. Payer policy change", "D. Inconsistent patient information"],
                    answer: "A",
                    explanation: "A denial for 'lack of medical necessity' means the payer believes the procedure performed was not necessary to treat the patient's documented diagnosis. The diagnosis code must support the procedure code."
                },
                {
                    question: "What is the first step in appealing a denied claim?",
                    options: ["A. Resubmit the claim with a new code", "B. Send a letter of protest to the payer's legal department", "C. Review the patient's chart and the denial reason", "D. Bill the patient directly for the full amount"],
                    answer: "C",
                    explanation: "The crucial first step in any appeal is to thoroughly review the patient‚Äôs documentation and compare it against the denial reason provided by the payer. This helps you identify if the issue is a simple coding error or a more complex medical necessity dispute."
                },
                // Add more Denials & Appeals questions here
            ],
            // Insurance Nuances Quiz Module
            "Insurance Nuances": [
                {
                    question: "Which type of insurance plan typically requires a referral from a Primary Care Provider (PCP) to see a specialist?",
                    options: ["A. PPO", "B. HMO", "C. Medicare Part B", "D. Fee-for-Service"],
                    answer: "B",
                    explanation: "HMO (Health Maintenance Organization) plans generally require a referral from a PCP to see a specialist, as they focus on managed care within a network."
                },
                {
                    question: "When a patient has both active Medicare and Medicaid, which payer is usually considered primary?",
                    options: ["A. Medicaid", "B. Medicare", "C. The patient's choice", "D. Whichever plan has been active longer"],
                    answer: "B",
                    explanation: "Medicare is almost always the primary payer when a patient has both Medicare and Medicaid. Medicaid then acts as the payer of last resort, covering what Medicare doesn't."
                },
                {
                    question: "Medicare Part B typically covers what percentage of approved physician services after the deductible is met?",
                    options: ["A. 100%", "B. 50%", "C. 80%", "D. 20%"],
                    answer: "C",
                    explanation: "Medicare Part B covers 80% of approved physician services after the annual deductible is met, with the patient responsible for the remaining 20% (coinsurance)."
                }
            ]
        };

        // --- Global Data Storage (Patient Balance Calculator) ---
        let currentBalanceScenario = null;
        const patientBalanceScenarios = [
            {
                id: 1,
                patient: "Alex Green",
                plan: {
                    copay: 0,
                    deductible: 1000,
                    deductibleMetToDate: 700,
                    coinsurance: 0.15 // 15%
                },
                visit: {
                    service: "Office visit with minor procedure",
                    allowedAmount: 300
                },
                correct: {
                    copay: 0,
                    deductibleApplied: 300,
                    coinsurance: 0,
                    totalBalance: 300
                },
                calculationSteps: `
                    1. Remaining Deductible: $1,000 (Initial) - $700 (Met to Date) = $300.
                    2. Apply Allowed Amount ($300) to Remaining Deductible ($300). Deductible is now fully met.
                    3. No amount remaining for coinsurance from this visit.
                    4. Total Patient Balance: $300 (Deductible Applied).
                `
            },
            {
                id: 2,
                patient: "Brenda White",
                plan: {
                    copay: 35, // for specialist
                    deductible: 500,
                    deductibleMetToDate: 0,
                    coinsurance: 0.20 // 20%
                },
                visit: {
                    service: "Specialist Consultation",
                    allowedAmount: 250
                },
                correct: {
                    copay: 35,
                    deductibleApplied: 250,
                    coinsurance: 0, // Deductible not fully met, no coinsurance applies yet
                    totalBalance: 285
                },
                calculationSteps: `
                    1. Collect Copay: $35.
                    2. Apply Allowed Amount ($250) to Deductible. Remaining Deductible: $500 - $250 = $250.
                    3. Deductible is not fully met, so no coinsurance applies from this visit.
                    4. Total Patient Balance: $35 (Copay) + $250 (Deductible Applied) = $285.
                `
            },
            {
                id: 3,
                patient: "Chris Johnson",
                plan: {
                    copay: 0,
                    deductible: 1500,
                    deductibleMetToDate: 1500, // Deductible fully met
                    coinsurance: 0.10 // 10%
                },
                visit: {
                    service: "Follow-up Lab Tests",
                    allowedAmount: 100
                },
                correct: {
                    copay: 0,
                    deductibleApplied: 0,
                    coinsurance: 10,
                    totalBalance: 10
                },
                calculationSteps: `
                    1. No Copay.
                    2. Deductible is already fully met. No amount applies to deductible.
                    3. Calculate Coinsurance: $100 (Allowed Amount) * 10% = $10.
                    4. Total Patient Balance: $10 (Coinsurance).
                `
            },
             {
                id: 4,
                patient: "Diana Smith",
                plan: {
                    copay: 20, // for PCP
                    deductible: 750,
                    deductibleMetToDate: 750, // Deductible fully met
                    coinsurance: 0.25 // 25%
                },
                visit: {
                    service: "Primary Care Office Visit",
                    allowedAmount: 90
                },
                correct: {
                    copay: 20,
                    deductibleApplied: 0,
                    coinsurance: 22.50,
                    totalBalance: 42.50
                },
                calculationSteps: `
                    1. Collect Copay: $20.
                    2. Deductible is already fully met. No amount applies to deductible.
                    3. Calculate Coinsurance: $90 (Allowed Amount) * 25% = $22.50.
                    4. Total Patient Balance: $20 (Copay) + $22.50 (Coinsurance) = $42.50.
                `
            }
        ];

        // --- Global Data Storage (Modifier Application Challenge) ---
        let currentModifierChallenge = null;
        const modifierScenarios = [
            {
                id: 1,
                scenario: `Patient presents for a routine annual physical exam (CPT 99395). During the same visit, the patient expresses concern about a new, painful mole on their arm. The physician performs a separate, distinct evaluation and management (E/M) service to assess and manage the mole. The E/M service for the mole is significant and separately identifiable from the preventive exam.`,
                cptCodeToInput: "99213", // Problem-focused E/M (e.g., 99213 for mole evaluation)
                correctModifier: "25",
                explanation: "Modifier -25 is used when a significant, separately identifiable Evaluation and Management (E/M) service is performed on the same day as a preventive service or other procedure by the same physician. In this case, the mole evaluation (99213) is separate from the routine physical (99395)."
            },
            {
                id: 2,
                scenario: `A patient undergoes a complex surgical procedure (e.g., CPT 20680 - Removal of implant; deep (e.g., buried) bone fixation material; knee). During the post-operative period (global period) of this surgery, the patient comes back to the office for an E/M visit due to a severe, acute upper respiratory infection, which is completely unrelated to the knee surgery.`,
                cptCodeToInput: "99213", // E/M service for URI
                correctModifier: "24",
                explanation: "Modifier -24 is appended to an E/M service code to indicate that the E/M service was performed during a post-operative global period for a procedure, and the E/M service was unrelated to the original surgical procedure. Here, the URI (99213) is unrelated to the knee surgery (20680)."
            },
            {
                id: 3,
                scenario: `A surgeon performs a diagnostic arthroscopy of the knee (CPT 29870). During the same surgical session, they identify a torn meniscus and immediately perform a meniscectomy (CPT 29881). The diagnostic procedure leads directly to the therapeutic procedure. You should use a modifier that indicates a distinct procedural service.`,
                cptCodeToInput: "29870", // Diagnostic Arthroscopy
                correctModifier: "59",
                explanation: "Modifier -59 (Distinct Procedural Service) is used to identify a procedure or service as distinct or independent from other non-E/M services performed on the same day. In this case, the diagnostic arthroscopy (29870) was distinct and necessary to identify the need for the meniscectomy (29881), even though it was performed in the same session. Many payers bundle diagnostic into therapeutic without -59."
            },
            {
                id: 4,
                scenario: `A patient has a scheduled ultrasound (CPT 76801) for the abdomen. The technical component (use of equipment, technician time) is provided by the facility, but the radiologist provides the professional interpretation of the images. You are billing for the radiologist's service.`,
                cptCodeToInput: "76801", // Ultrasound code
                correctModifier: "26",
                explanation: "Modifier -26 (Professional Component) is used when billing for only the professional (physician‚Äôs) portion of a service that has both technical and professional components, such as radiology or pathology services. The radiologist's interpretation is the professional component."
            },
            {
                id: 5,
                scenario: `A patient is seen for an office visit. During the visit, a minor surgical procedure (CPT 17110 - destruction of benign lesions) is performed. The office visit (CPT 99213) is separate and significant from the procedure performed.`,
                cptCodeToInput: "99213", // E/M service
                correctModifier: "25",
                explanation: "Modifier -25 indicates a significant, separately identifiable evaluation and management service by the same physician on the same day of a procedure. The office visit for general symptoms is distinct from the minor procedure."
            }
        ];

        // --- Global Data Storage (Matching Game) ---
        const termPairs = [
            { term: "EOB", definition: "Explanation of Benefits" },
            { term: "ERA", definition: "Electronic Remittance Advice" },
            { term: "HIPAA", definition: "Health Insurance Portability and Accountability Act" },
            { term: "PHI", definition: "Protected Health Information" },
            { term: "NPI", definition: "National Provider Identifier" },
            { term: "CPT", definition: "Current Procedural Terminology" },
            { term: "ICD-10-CM", definition: "International Classification of Diseases, 10th Revision, Clinical Modification" },
            { term: "HCPCS", definition: "Healthcare Common Procedure Coding System" },
            { term: "CMS-1500", definition: "Standard claim form for professional services" },
            { term: "UB-04", definition: "Standard claim form for institutional services" }
        ];

        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let gameActive = false;

        // --- Global Data Storage (Claim Scrubber) ---
        let currentScrubberScenario = null;
        const claimScrubberScenarios = [
            {
                id: 1,
                title: "Scenario 1: Outdated Diagnosis Code",
                description: "A 65-year-old patient presented with symptoms of an acute myocardial infarction (heart attack). The physician documented a diagnosis of 'Acute Myocardial Infarction'. The claim was submitted with an old ICD-9 code.",
                presentedClaim: {
                    diagnosis: "410.10 (Acute MI, initial episode of care)", // ICD-9 - ERROR
                    cpt: "99214 (Office visit)",
                    modifier: "None",
                    notes: "Patient seen urgently for chest pain. EKG changes noted."
                },
                errors: [
                    { type: "diagnosis", correctValue: "I21.01", explanation: "Outdated ICD-9 code used. ICD-9 codes are no longer valid for billing since October 1, 2015. The correct ICD-10-CM code for an acute anterior wall STEMI is I21.01." }
                ],
                expectedInputs: {
                    correctedICD: "I21.01",
                    correctedCPT: "99214",
                    correctedModifier: "NONE" // Assume 'None' or empty string for no modifier
                }
            },
            {
                id: 2,
                title: "Scenario 2: Missing Modifier - Same Day E/M and Procedure",
                description: "A patient came in for a routine follow-up E/M visit (CPT 99213) for chronic hypertension. During the same visit, the physician performed a separately identifiable lesion removal (CPT 11100). The claim was submitted without a modifier on the E/M service.",
                presentedClaim: {
                    diagnosis: "I10 (Essential Hypertension)",
                    cpt: "99213, 11100",
                    modifier: "None", // ERROR: 99213 needs a modifier
                    notes: "Routine follow-up for HTN. Also evaluated and removed a skin lesion."
                },
                errors: [
                    { type: "modifier", correctValue: "25", explanation: "Missing modifier on E/M service. Modifier -25 (Significant, Separately Identifiable E/M Service) is required on the E/M code (99213) when a distinct E/M service is performed on the same day as a minor procedure (11100)." }
                ],
                expectedInputs: {
                    correctedICD: "I10",
                    correctedCPT: "99213", // User should input 99213 for this specific problem in the context of the modifier.
                    correctedModifier: "25"
                }
            },
            {
                id: 3,
                title: "Scenario 3: Procedure Not Supported by Diagnosis",
                description: "A patient was seen for a cough and fever. The physician ordered a chest X-ray. The diagnosis provided on the claim for the X-ray was 'Fatigue'.",
                presentedClaim: {
                    diagnosis: "R53.81 (Fatigue)", // ERROR: Does not support Chest X-ray
                    cpt: "71045 (Radiologic examination, chest; single view, frontal)",
                    modifier: "None",
                    notes: "Patient complaints of cough and fever. Chest X-ray performed."
                },
                errors: [
                    { type: "diagnosis", correctValue: "R05, R50.9", explanation: "The diagnosis 'Fatigue' does not support the medical necessity for a chest X-ray. More appropriate diagnoses based on the chief complaint would be 'Cough' (R05) and 'Fever, unspecified' (R50.9)." }
                ],
                expectedInputs: {
                    correctedICD: "R05,R50.9", // Allow comma-separated
                    correctedCPT: "71045",
                    correctedModifier: "NONE"
                }
            }
        ];

        // --- Global Data Storage (Denial Code Interpreter) ---
        let currentDenialScenario = null;
        const denialScenarios = [
            {
                id: 1,
                denialCode: "CO 16",
                context: "CPT 99213 denied. The claim submission was missing the referring physician's NPI.",
                interpretations: [
                    { text: "The service was not medically necessary.", correct: false },
                    { text: "The claim was submitted after the timely filing limit.", correct: false },
                    { text: "The claim lacks information required for processing.", correct: true },
                    { text: "The charge submitted exceeded the allowed amount.", correct: false }
                ],
                correctActionPlanKeywords: ["CORRECT", "RESUBMIT", "MISSING NPI"],
                explanation: "CO 16 means 'Claim/service lacks information which is needed for adjudication, or has been altered.' In this case, the missing referring physician's NPI needs to be added, and the claim should be corrected and resubmitted."
            },
            {
                id: 2,
                denialCode: "CO 45",
                context: "CPT 88305 (Pathology) denied. The billed amount was $150, but the payer's allowed amount is $100.",
                interpretations: [
                    { text: "The service requires prior authorization.", correct: false },
                    { text: "The charge submitted exceeds the allowed fee schedule amount.", correct: true },
                    { text: "The patient's deductible has not been met.", correct: false },
                    { text: "The claim has a coding error.", correct: false }
                ],
                correctActionPlanKeywords: ["ADJUST", "WRITE-OFF", "PATIENT RESPONSIBILITY (IF APPLICABLE)"],
                explanation: "CO 45 indicates 'Charge exceeds fee schedule/maximum allowable or contracted rate.' The billed amount was higher than what the payer allows. The provider must adjust the fee to the allowed amount. Any remaining balance, after deductible/coinsurance, should be written off as a contractual adjustment, unless the plan allows for balance billing (rare for in-network)."
            },
            {
                id: 3,
                denialCode: "CO 29",
                context: "CPT 99203 denied. The date of service was 18 months ago, and the payer's timely filing limit is 12 months.",
                interpretations: [
                    { text: "The service was not medically necessary.", correct: false },
                    { text: "The claim was submitted after the timely filing limit.", correct: true },
                    { text: "The patient's policy terminated.", correct: false },
                    { text: "There was a duplicate claim submission.", correct: false }
                ],
                correctActionPlanKeywords: ["WRITE OFF", "CHECK FILING LIMITS"],
                explanation: "CO 29 means 'The time limit for filing has expired.' If the claim was genuinely submitted late and no exception applies (e.g., patient eligibility retroactive), the balance should be written off. Always verify the payer's specific timely filing limits."
            },
            {
                id: 4,
                denialCode: "CO 150",
                context: "CPT 72148 (MRI Lumbar Spine) denied. The patient's documentation did not clearly state conservative treatment was tried and failed.",
                interpretations: [
                    { text: "The payer determined the service was not medically necessary.", correct: true },
                    { text: "A modifier is missing from the CPT code.", correct: false },
                    { text: "The patient has other insurance that is primary.", correct: false },
                    { text: "The CPT code is incorrect for the service provided.", correct: false }
                ],
                correctActionPlanKeywords: ["APPEAL", "MEDICAL RECORDS", "PROVIDER REVIEW", "CLINICAL JUSTIFICATION"],
                explanation: "CO 150 means 'Payment adjusted because the payer deems the information submitted does not support this many/frequency/duration of services/items.' This is a medical necessity denial. An appeal, including comprehensive medical records (physician notes, treatment history, rationale for the service), is required to justify the service. Sometimes a peer-to-peer review with the ordering provider is necessary."
            },
            {
                id: 5,
                denialCode: "CO 236",
                context: "CPT 90832 (Psychotherapy) denied. The patient's mental health benefits specify no coverage for outpatient psychotherapy.",
                interpretations: [
                    { text: "The service requires prior authorization.", correct: false },
                    { text: "The procedure is bundled with another service.", correct: false },
                    { text: "This procedure/service is not covered by the patient's plan.", correct: true },
                    { text: "The patient has not met their deductible.", correct: false }
                ],
                correctActionPlanKeywords: ["INFORM PATIENT", "BILL PATIENT (IF ABN SIGNED)", "NON-COVERED"],
                explanation: "CO 236 means 'This procedure/service is not covered by the patient's current benefits/plan.' This indicates a fundamental lack of coverage for the service. If an Advance Beneficiary Notice (ABN) or similar waiver was signed by the patient, the patient can be billed. Otherwise, it may need to be written off. Verify the patient's specific benefit plan details."
            },
            {
                id: 6,
                denialCode: "CO 18",
                context: "CPT 99213 denied. This is the second submission of the exact same claim, and the first one was already paid.",
                interpretations: [
                    { text: "The claim was a duplicate submission.", correct: true },
                    { text: "The service was not documented.", correct: false },
                    { text: "The patient's insurance was inactive.", correct: false },
                    { text: "The CPT code needs a modifier.", correct: false }
                ],
                correctActionPlanKeywords: ["NO ACTION", "DUPLICATE", "PREVENT DUPLICATES"], // Simplified keywords
                explanation: "CO 18 means 'Duplicate claim/service.' This denial occurs when a claim has already been paid or processed. No action is typically needed unless the previous payment was incorrect. Implement measures to prevent future duplicate submissions."
            }
        ];

        // --- Global Data Storage (SOAP Note Challenge) ---
        let currentSoapScenarioData = null; // Declare once globally
        const soapNoteScenarios = [
            {
                id: 1,
                title: "Acute Sore Throat Patient",
                description: "Review this SOAP note for a patient presenting with an acute sore throat and extract key coding and plan details.",
                soapNote: `
**Patient Name:** Emily Davis
**Date of Birth:** 11/22/2005
**Date of Visit:** 2025-08-16
**Provider:** Dr. Samantha Lee

**S (Subjective):**
* Chief Complaint: "Sore throat and difficulty swallowing for 3 days."
* HPI: Ms. Davis reports onset of severe sore throat 3 days ago, which has progressively worsened, making it painful to swallow liquids and solids. Associated with mild fever (up to 100.5¬∞F at home), body aches, and fatigue. Denies cough, runny nose, congestion, or rash. No known sick contacts. Has been taking Tylenol for fever with minimal relief.
* ROS: No recent strep exposure. Denies nausea, vomiting, abdominal pain, or dysuria. Last menstrual period 2 weeks ago.

**O (Objective):**
* Vitals:
    * BP: 118/78 mmHg
    * HR: 88 bpm
    * RR: 18 bpm
    * Temp: 100.8¬∞F (oral)
    * Wt: 130 lbs
* Physical Exam:
    * General: Appears tired, mild distress due to throat pain.
    * HEENT:
        * Throat: Erythematous pharynx. Tonsils 2+ enlarged, with white exudates bilaterally. No peritonsillar swelling.
        * Neck: Anterior cervical lymphadenopathy, tender to palpation.
        * Nose: Clear nasal passages, no discharge.
        * Ears: Tympanic membranes clear bilaterally.
    * Lungs: Clear to auscultation bilaterally.
* Rapid Strep Test: Positive

**A (Assessment):**
* 1. Acute streptococcal pharyngitis (J02.0): Confirmed by positive rapid strep test and classic Centor criteria symptoms (tonsillar exudates, swollen/tender anterior cervical nodes, fever, absence of cough).

**P (Plan):**
* 1. Acute streptococcal pharyngitis:
    * Medication: Prescribed Amoxicillin 500mg, 2 tablets by mouth twice daily for 10 days. Advised to complete full course of antibiotics even if symptoms improve.
    * Symptomatic Relief: Advised warm salt water gargles, lozenges, and continued use of Tylenol/ibuprofen as needed for pain and fever.
    * Education: Discussed contagiousness and importance of hand hygiene. Advised to stay home from work/school for 24 hours after starting antibiotics and once afebrile.
    * Complications: Educated on potential complications of untreated strep throat (rheumatic fever, glomerulonephritis) and importance of completing antibiotics.
* Follow-up: Return to clinic if symptoms worsen, develop rash, or no improvement in 48-72 hours.
                `.trim(),
                expected: {
                    chiefComplaint: "Sore throat and difficulty swallowing for 3 days.",
                    icd10: "J02.0",
                    cpt: "99213,87880", // Assuming established patient visit (99213) and Rapid Strep Test (87880)
                    modifier: "NONE",
                    planKeywords: ["AMOXICILLIN", "ANTIBIOTICS", "SALT WATER", "TYLENOL", "HAND HYGIENE", "STAY HOME", "FOLLOW-UP"]
                },
                explanation: `
**Chief Complaint:** Directly stated under 'S'.
**Primary ICD-10:** J02.0 for Acute streptococcal pharyngitis is clearly stated in the 'A' section.
**Primary CPT Code(s):** An established patient office visit (e.g., 99213) is implied for the encounter, and a Rapid Strep Test (87880) is explicitly mentioned and positive.
**Modifier(s):** No specific modifiers are indicated by the scenario for these services.
**Key Elements of the Plan:** The plan (P) includes medication (Amoxicillin, antibiotics), symptomatic relief (salt water gargles, Tylenol), education (hand hygiene, staying home), and follow-up instructions.
                `.trim()
            },
            {
                id: 2,
                title: "Hypertension Follow-up Patient",
                description: "Review this SOAP note for a follow-up visit regarding hypertension and extract key coding and plan details.",
                soapNote: `
**Patient Name:** John Doe
**Date of Birth:** 03/15/1970
**Date of Visit:** 2025-08-16
**Provider:** Dr. Alex Chen

**S (Subjective):**
* Chief Complaint: "Follow-up for blood pressure."
* HPI: Mr. Doe reports his home blood pressure readings have been consistently in the range of 130-140/80-90 mmHg daily since his last visit. Denies headaches, dizziness, chest pain, or vision changes. Reports adherence to prescribed Lisinopril 20mg daily. States he has been walking 30 minutes, 4 times a week, and trying to reduce sodium intake. Denies any side effects from medication.
* ROS: No new complaints. Denies fever, cough, shortness of breath, nausea, vomiting, diarrhea, constipation, or urinary symptoms.

**O (Objective):**
* Vitals:
    * BP: 138/86 mmHg (right arm, sitting)
    * HR: 72 bpm
    * RR: 16 bpm
    * Temp: 98.6¬∞F (oral)
    * Wt: 185 lbs (down 2 lbs from last visit)
* Physical Exam:
    * General: Alert, oriented, appears comfortable.
    * CV: Regular rhythm, no murmurs, rubs, or gallops. Normal S1/S2.
    * Pulmonary: Lungs clear to auscultation bilaterally. No wheezes, rales, or rhonchi.
    * Extremities: No edema. Peripheral pulses 2+ and symmetric.
* Labs (from 2 weeks prior):
    * BMP: Na 140, K 4.1, Cr 0.9, Glucose 102
    * HbA1c: 5.7%
    * Lipid Panel: Total Chol 180, HDL 55, LDL 90, Trig 120

**A (Assessment):**
* 1. Essential Hypertension (I10): Stable blood pressure readings at target. Patient reports good medication adherence and lifestyle modifications. Labs are stable.
* 2. Prediabetes (R73.03): HbA1c remains stable. Continue lifestyle modifications.
* 3. Hyperlipidemia (E78.5): LDL well-controlled on current diet and exercise.

**P (Plan):**
* 1. Essential Hypertension:
    * Continue Lisinopril 20mg daily.
    * Encourage continued home BP monitoring; bring log to next visit.
    * Continue DASH diet and regular exercise.
* 2. Prediabetes:
    * Continue emphasizing diet and exercise.
    * Recheck HbA1c in 6 months.
* 3. Hyperlipidemia:
    * Continue current diet and exercise.
    * Recheck Lipid Panel in 1 year.
* Follow-up: Return to clinic in 3 months for recheck of BP and overall health. Patient advised to call earlier if any concerns.
                `.trim(),
                expected: {
                    chiefComplaint: "Follow-up for blood pressure.",
                    icd10: "I10,R73.03,E78.5", // Multiple diagnoses
                    cpt: "99213", // Assuming a standard established patient office visit
                    modifier: "NONE",
                    planKeywords: ["LISINOPRIL", "BP MONITORING", "DASH DIET", "EXERCISE", "HBA1C", "LIPID PANEL", "FOLLOW-UP"]
                },
                explanation: `
**Chief Complaint:** Directly stated under 'S'.
**Primary ICD-10:** All three diagnoses (I10, R73.03, E78.5) are listed in the 'A' section.
**Primary CPT Code(s):** A standard established patient office visit (e.g., 99213) is the most appropriate CPT code for this type of follow-up.
**Modifier(s):** No specific modifiers are indicated by the scenario.
**Key Elements of the Plan:** The plan (P) includes continuing medication (Lisinopril), monitoring (home BP), lifestyle (DASH diet, exercise), and follow-up for multiple conditions (HbA1c, Lipid Panel, clinic visit).
                `.trim()
            },
            {
                id: 3,
                title: "Dermatology: Skin Lesion Evaluation",
                description: "Review this SOAP note for a patient presenting with a skin lesion and extract key coding and plan details.",
                soapNote: `
**Patient Name:** Sarah Lee
**Date of Birth:** 07/07/1995
**Date of Visit:** 2025-08-16
**Provider:** Dr. Maria Rodriguez (Dermatology)

**S (Subjective):**
* Chief Complaint: "Concern about a mole on my back, it looks different."
* HPI: Ms. Lee reports noticing a new, dark mole on her upper back approximately 3 months ago. She states it has grown slightly and recently became itchy. Denies bleeding or pain. No family history of melanoma. Denies excessive sun exposure.
* ROS: No fevers, chills, nausea, vomiting. Otherwise healthy.

**O (Objective):**
* Vitals: Stable. BP 120/75, HR 70, RR 16, Temp 98.6¬∞F.
* Physical Exam:
    * Skin: On the upper left back, a solitary, irregularly shaped pigmented lesion is noted. Approximately 0.8 cm in greatest diameter. Color varies from dark brown to black, with some areas of lighter pigmentation. Borders are asymmetric and somewhat ill-defined. No erythema or discharge.
    * Palpation: Non-tender to palpation.
    * Lymph Nodes: No palpable regional lymphadenopathy.
* Dermoscopy performed: Lesion features concerning for atypical nevus.

**A (Assessment):**
* 1. Atypical Nevus (D22.5 - Melanocytic nevi of trunk, left upper quadrant): Suspicious lesion requiring excisional biopsy for definitive diagnosis.

**P (Plan):**
* 1. Atypical Nevus (Left upper back):
    * Procedure: Recommend excisional biopsy of the lesion. Discussed risks, benefits, and alternatives. Patient consents.
    * Anesthesia: Local anesthesia will be used.
    * Supplies: Sterile drape, biopsy punch, sutures for closure.
    * Follow-up: Schedule procedure for next week. Patient to return 7-10 days post-procedure for suture removal and pathology results discussion.
    * Education: Advised on wound care post-biopsy. Discussed sun protection and regular self-skin exams.
    * Pathology: Specimen to be sent for histopathologic examination.
                `.trim(),
                expected: {
                    chiefComplaint: "Concern about a mole on my back, it looks different.",
                    icd10: "D22.5",
                    cpt: "11401,99213", // Assuming lesion excision (11401 for trunk lesion 0.6-1.0cm) and E/M (99213). Modifier -25 should be applied to 99213.
                    modifier: "25", // E/M separate from procedure
                    planKeywords: ["EXCISIONAL BIOPSY", "LOCAL ANESTHESIA", "SUTURE REMOVAL", "PATHOLOGY", "WOUND CARE", "SUN PROTECTION", "FOLLOW-UP"]
                },
                explanation: `
**Chief Complaint:** Clearly stated under 'S'.
**Primary ICD-10:** D22.5 for Melanocytic nevi of trunk, left upper quadrant is derived from the assessment.
**Primary CPT Code(s):** An established patient office visit (e.g., 99213) is for the initial evaluation. Excisional biopsy of the lesion (e.g., 11401 for 0.8 cm lesion on trunk) is the planned procedure.
**Modifier(s):** Modifier -25 is required on the E/M code (99213) because a significant, separately identifiable E/M service was performed on the same day as a minor surgical procedure (lesion excision).
**Key Elements of the Plan:** The plan (P) explicitly outlines the excisional biopsy, wound care, pathology submission, and future follow-up.
                `.trim()
            }
        ];

        // Code Lookup Data
        const codeDatabase = {
            // ICD-10 Codes
            "J02.0": "Acute streptococcal pharyngitis",
            "I10": "Essential (primary) hypertension",
            "R05": "Cough",
            "B07.0": "Plantar wart",
            "J11.1": "Influenza, virus not identified, with other respiratory manifestations",
            "R53.83": "Other fatigue",
            "I21.01": "ST elevation (STEMI) myocardial infarction of anterior wall, initial episode of care",
            "R50.9": "Fever, unspecified",
            "R73.03": "Prediabetes",
            "E78.5": "Hyperlipidemia, unspecified",
            "B07.9": "Viral wart, unspecified",
            "D22.5": "Melanocytic nevi of trunk, left upper quadrant",

            // CPT Codes
            "99213": "Established patient office or other outpatient visit, 20-29 minutes",
            "99203": "New patient office or other outpatient visit, 30-44 minutes",
            "87880": "Infectious agent antigen detection by immunoassay with direct optical observation; Streptococcus, group A",
            "17110": "Destruction (e.g., laser surgery, electrosurgery, cryosurgery, chemosurgery, surgical curettement), of benign lesions other than skin tags or cutaneous vascular proliferative lesions; up to 14 lesions",
            "99395": "Periodic comprehensive preventive medicine reevaluation and management of an individual aged 40-64 years",
            "99396": "Periodic comprehensive preventive medicine reevaluation and management of an individual aged 40-64 years", // Often same code range for different age groups
            "76801": "Ultrasound, pregnant uterus, real time with image documentation, fetal and maternal evaluation, first trimester (< 14 weeks 0 days), transabdominal approach", // Example, usually more specific
            "20680": "Removal of implant; deep (e.g., buried) bone fixation material; knee",
            "29870": "Arthroscopy, knee, diagnostic, with or without synovial biopsy (separate procedure)",
            "29881": "Arthroscopy, knee, surgical; with meniscectomy (medial OR lateral), including meniscal repair when performed",
            "71045": "Radiologic examination, chest; single view, frontal",
            "72148": "Magnetic resonance (MR) imaging, spinal canal and contents, lumbar; without contrast material",
            "90832": "Psychotherapy, 30 minutes with patient and/or family member",
            "80061": "Lipid panel",
            "99490": "Chronic care management services, at least 20 minutes of clinical staff time directed by a physician or other qualified health care professional, per calendar month, for patients with multiple (two or more) chronic conditions expected to last at least 12 months, or until the death of the patient, and that place the patient at significant risk of death, acute exacerbation/decompensation, or functional decline; with the following required elements: multiple (two or more) chronic conditions expected to last at least 12 months, or until the death of the patient, and that place the patient at significant risk of death, acute exacerbation/decompensation, or functional decline; comprehensive care plan established, implemented, revised, or monitored; and moderate or high complexity medical decision making",
            "11401": "Excision, benign lesion, except skin tag, excludes cutaneous or subcutaneous non-lipomatous tumors, trunk, arms, or legs; excised diameter 0.6 to 1.0 cm"
        };

        // NEW: A/R Aging Scenarios
        let currentArScenarioClaims = [];
        const arAgingScenarios = [
            {
                id: 1,
                claims: [
                    {
                        claimId: "C1001", patient: "Alice Brown", payer: "Blue Cross Blue Shield", amount: 150.00, daysOld: 35,
                        correctAction: "Check claim status online (payer portal), ensure it was received and is processing.",
                        explanation: "Claims 30-45 days old are typically still within normal processing times but should be monitored. Check the payer portal for status."
                    },
                    {
                        claimId: "C1002", patient: "Bob Johnson", payer: "UnitedHealthcare", amount: 500.00, daysOld: 65,
                        correctAction: "Call payer (provider services line), inquire about claim status and denial reasons if any; be prepared with claim number, patient info, DOS, CPTs.",
                        explanation: "Claims 60-75 days old often require direct follow-up. A call to payer services is usually the most efficient next step."
                    },
                    {
                        claimId: "C1003", patient: "Carol White", payer: "Medicare", amount: 25.00, daysOld: 95,
                        correctAction: "Review EOB/ERA for denial reason. If denied, appeal with supporting documentation or correct/resubmit if a simple error (e.g., modifier, NPI).",
                        explanation: "Claims 90+ days old are a high priority. They've likely been denied or are stuck. Focus on reviewing the EOB/ERA for specific denial codes and reasons, then initiate an appeal or correction."
                    }
                ]
            },
            {
                id: 2,
                claims: [
                    {
                        claimId: "C2001", patient: "David Green", payer: "Aetna", amount: 300.00, daysOld: 28,
                        correctAction: "Monitor claim status (check next week). This is still within typical initial processing time.",
                        explanation: "Claims less than 30 days old are usually still processing. It's too early for aggressive follow-up unless a known issue exists."
                    },
                    {
                        claimId: "C2002", patient: "Eve Taylor", payer: "Cigna", amount: 1200.00, daysOld: 78,
                        correctAction: "Call payer, specifically ask if prior authorization was applied correctly or if medical records are needed. If denied, review EOB for reason.",
                        explanation: "For high-value claims over 75 days old, direct contact is crucial. Be ready to discuss PA and clinical documentation requirements."
                    },
                    {
                        claimId: "C2003", patient: "Frank Miller", payer: "Medicaid (State X)", amount: 80.00, daysOld: 110,
                        correctAction: "Check timely filing limit for Medicaid in State X. If limit passed, determine if a justifiable exception exists or prepare for write-off. If within limits, review denial EOB.",
                        explanation: "Medicaid timely filing limits can be strict and vary by state. It's critical to know these limits for very old claims. If past, document write-off unless an appeal can be justified."
                    }
                ]
            }
        ];


        // --- Utility Functions (general) ---

        /**
         * Displays a message to the user in the message box.
         * @param {string} message - The message to display.
         * @param {string} type - 'success' or 'error' to style the message.
         */
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = `message-box ${type}`; // Reset and apply new classes
            messageBox.style.display = 'block'; // Make visible
            setTimeout(() => {
                messageBox.style.display = 'none'; // Hide after 5 seconds
            }, 5000);
        }

        /**
         * Adds a new input row for diagnoses or procedures.
         */
        function addInputRow(parentList, className, placeholder) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex items-center gap-2';
           
            const input = document.createElement('input');
            input.type = 'text';
            input.className = `${className} flex-grow-1 focus:ring-${parentList.id.includes('diagnosis') ? 'green' : 'green'}-500 focus:border-${parentList.id.includes('diagnosis') ? 'green' : 'green'}-500`;
            // Add name attribute for accessibility/best practices
            input.name = className.replace('-', ''); 
            input.placeholder = placeholder;
           
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn-secondary remove-item-btn';
            removeBtn.textContent = 'Remove';
            removeBtn.onclick = () => wrapper.remove(); // Remove the entire row when clicked

            wrapper.appendChild(input);
            wrapper.appendChild(removeBtn);
            parentList.appendChild(wrapper);
        }

        /**
         * Adds a new input row for charges (description, CPT, price).
         */
        function addChargeRow() {
            const wrapper = document.createElement('div');
            wrapper.className = 'grid grid-cols-1 md:grid-cols-3 gap-2 service-item';

            const descriptionInput = document.createElement('input');
            descriptionInput.type = 'text';
            descriptionInput.className = 'service-description col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500';
            descriptionInput.name = 'serviceDescription'; // Added name attribute
            descriptionInput.placeholder = 'Service Description';

            const cptInput = document.createElement('input');
            cptInput.type = 'text';
            cptInput.className = 'service-cpt-code col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500';
            cptInput.name = 'serviceCptCode'; // Added name attribute
            cptInput.placeholder = 'CPT Code';

            const priceWrapper = document.createElement('div');
            priceWrapper.className = 'flex gap-2 col-span-1 md:col-span-1';

            const priceInput = document.createElement('input');
            priceInput.type = 'number';
            priceInput.className = 'service-price flex-grow-1 focus:ring-purple-500 focus:border-purple-500';
            priceInput.name = 'servicePrice'; // Added name attribute
            priceInput.placeholder = 'Price ($)';
            priceInput.min = "0";
            priceInput.step = "0.01";

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn-secondary remove-item-btn';
            removeBtn.textContent = 'Remove';
            removeBtn.onclick = () => wrapper.remove();

            priceWrapper.appendChild(priceInput);
            priceWrapper.appendChild(removeBtn);

            wrapper.appendChild(descriptionInput);
            wrapper.appendChild(cptInput);
            wrapper.appendChild(priceWrapper);
            chargeList.appendChild(wrapper);
        }

        /**
         * Clears all input fields and stored data for the main EHR simulation.
         */
        function clearAllData() {
            // Clear patient data inputs
            patientNameInput.value = '';
            patientDOBInput.value = '';
            insuranceIDInput.value = '';

            // Clear encounter data inputs
            encounterDateInput.value = '';
            chiefComplaintInput.value = '';

            // Remove all dynamically added rows for diagnosis, procedure, and charges
            // Keep one initial empty row for each for user convenience
            diagnosisList.querySelectorAll('.flex.items-center.gap-2').forEach((row, index) => {
                if (index > 0) row.remove();
                else row.querySelector('input').value = '';
            });
            procedureList.querySelectorAll('.flex.items-center.gap-2').forEach((row, index) => {
                if (index > 0) row.remove();
                else row.querySelector('input').value = '';
            });
            chargeList.querySelectorAll('.service-item').forEach((row, index) => {
                if (index > 0) row.remove();
                else {
                    row.querySelector('.service-description').value = '';
                    row.querySelector('.service-cpt-code').value = '';
                    row.querySelector('.service-price').value = '';
                }
            });

            // Clear stored data
            patientData = {};
            diagnoses = [];
            procedures = [];
            charges = {};

            // Clear claim output
            claimOutput.innerHTML = '<p class="text-gray-500">Your simulated claim details will appear here after generation.</p>';
            showMessage('All data cleared!', 'success');
        }


        // --- Event Listeners (existing sections) ---

        registerPatientBtn.addEventListener('click', () => {
            const name = patientNameInput.value.trim();
            const dob = patientDOBInput.value;
            const insurance = insuranceIDInput.value.trim();

            if (!name || !dob || !insurance) {
                showMessage('Please fill in all patient registration fields.', 'error');
                return;
            }

            patientData = {
                name: name,
                dob: dob,
                insuranceID: insurance
            };
            showMessage('Patient registered successfully!', 'success');
        });

        addDiagnosisBtn.addEventListener('click', () => {
            addInputRow(diagnosisList, 'diagnosis-code', 'e.g., J02.9 (Acute pharyngitis)');
        });

        addProcedureBtn.addEventListener('click', () => {
            addInputRow(procedureList, 'procedure-code', 'e.g., 99213 (Office visit)');
        });

        addChargeBtn.addEventListener('click', addChargeRow);

        generateClaimBtn.addEventListener('click', () => {
            // 1. Validate Patient Data
            if (Object.keys(patientData).length === 0 || !patientData.name) {
                showMessage('Please register patient data first.', 'error');
                return;
            }

            // 2. Collect Encounter Data
            const encounterDate = encounterDateInput.value.trim();
            const chiefComplaint = chiefComplaintInput.value.trim();

            if (!encounterDate || !chiefComplaint) {
                showMessage('Please fill in encounter date and chief complaint.', 'error');
                return;
            }

            diagnoses = Array.from(diagnosisList.querySelectorAll('.diagnosis-code'))
                             .map(input => input.value.trim())
                             .filter(value => value !== '');

            procedures = Array.from(procedureList.querySelectorAll('.procedure-code'))
                               .map(input => input.value.trim())
                               .filter(value => value !== '');

            if (diagnoses.length === 0 || procedures.length === 0) {
                showMessage('Please add at least one diagnosis and one procedure.', 'error');
                return;
            }

            // 3. Collect Charge Data
            charges = Array.from(chargeList.querySelectorAll('.service-item')).map(row => {
                return {
                    description: row.querySelector('.service-description').value.trim(),
                    cpt: row.querySelector('.service-cpt-code').value.trim(),
                    price: parseFloat(row.querySelector('.service-price').value) || 0
                };
            }).filter(charge => charge.description !== '' && charge.cpt !== '' && charge.price > 0);

            if (charges.length === 0) {
                showMessage('Please add at least one service with description, CPT, and price.', 'error');
                return;
            }

            // 4. Construct Simulated Claim Output
            let claimText = `--- Simulated Medical Claim ---\n\n`;
            claimText += `PATIENT INFORMATION:\n`;
            claimText += `  Name: ${patientData.name}\n`;
            claimText += `  DOB: ${patientData.dob}\n`;
            claimText += `  Insurance ID: ${patientData.insuranceID}\n\n`;

            claimText += `ENCOUNTER DETAILS:\n`;
            claimText += `  Date: ${encounterDate}\n`;
            claimText += `  Chief Complaint: ${chiefComplaint}\n\n`;

            claimText += `DIAGNOSES (ICD CODES):\n`;
            if (diagnoses.length > 0) {
                diagnoses.forEach(diag => claimText += `  - ${diag}\n`);
            } else {
                claimText += `  (No diagnoses entered)\n`;
            }
            claimText += `\n`;

            claimText += `PROCEDURES (CPT/HCPCS CODES):\n`;
            if (procedures.length > 0) {
                procedures.forEach(proc => claimText += `  - ${proc}\n`);
            } else {
                claimText += `  (No procedures entered)\n`;
            }
            claimText += `\n`;

            claimText += `SERVICES & CHARGES:\n`;
            let totalAmount = 0;
            if (charges.length > 0) {
                charges.forEach(charge => {
                    claimText += `  - ${charge.description} (CPT: ${charge.cpt}) - $${charge.price.toFixed(2)}\n`;
                    totalAmount += charge.price;
                });
            } else {
                claimText += `  (No charges entered)\n`;
            }
            claimText += `\nTOTAL CHARGE: $${totalAmount.toFixed(2)}\n`;
            claimText += `\n--- End of Claim ---`;

            claimOutput.textContent = claimText;
            showMessage('Claim generated successfully!', 'success');
        });

        clearAllBtn.addEventListener('click', clearAllData);

        // Initial setup to ensure one input row is always present for existing sections
        window.onload = () => {
            if (diagnosisList.querySelectorAll('.diagnosis-code').length === 0) {
                addInputRow(diagnosisList, 'diagnosis-code', 'e.g., J02.9 (Acute pharyngitis)');
            }
            if (procedureList.querySelectorAll('.procedure-code').length === 0) {
                addInputRow(procedureList, 'procedure-code', 'e.g., 99213 (Office visit)');
            }
            if (chargeList.querySelectorAll('.service-item').length === 0) {
                addChargeRow();
            }
            // Initialize walkthroughs
            resetBillingWalkthrough();
            resetPaWalkthrough();
            // Hide quiz content by default
            quizContent.classList.add('hidden');
            // Hide balance calculator content by default
            balanceCalculatorContent.classList.add('hidden');
            // Hide modifier challenge content by default
            modifierChallengeContent.classList.add('hidden');
            // Hide matching game content by default
            matchingGameContent.classList.add('hidden');
            // Hide scrubber challenge content by default
            scrubberChallengeContent.classList.add('hidden');
            // Hide denial challenge content by default
            denialChallengeContent.classList.add('hidden');
            // Hide SOAP challenge content by default
            soapChallengeContent.classList.add('hidden');
            // Hide code lookup content by default
            codeLookupContent.classList.remove('hidden'); // Show it by default now
            // Hide A/R Aging content by default
            arAgingContent.classList.add('hidden');
            // Form Repository is always visible as it's static informational content
            // formRepositoryContent.classList.remove('hidden'); // No need to explicitly hide/show this.
        };

        // --- Medical Billing Walkthrough Logic ---
        startBillingWalkthroughBtn.addEventListener('click', () => {
            currentBillingStep = 0; // Start from the first step
            displayBillingStep();
            startBillingWalkthroughBtn.classList.add('hidden');
            nextBillingWalkthroughBtn.classList.remove('hidden');
            resetBillingWalkthroughBtn.classList.remove('hidden');
            billingWalkthroughContent.classList.remove('hidden');
        });

        nextBillingWalkthroughBtn.addEventListener('click', () => {
            currentBillingStep++;
            if (currentBillingStep < billingSteps.length) {
                displayBillingStep();
            } else {
                walkthroughStepTitle.textContent = "Walkthrough Complete!";
                walkthroughStepInstructions.innerHTML = `<p class="text-green-700 font-bold">You've successfully reviewed all steps of the Medical Billing Revenue Cycle. Click 'Reset Walkthrough' to start again.</p>`;
                nextBillingWalkthroughBtn.classList.add('hidden');
            }
        });

        resetBillingWalkthroughBtn.addEventListener('click', resetBillingWalkthrough);

        function displayBillingStep() {
            const step = billingSteps[currentBillingStep];
            walkthroughStepTitle.textContent = step.title;
            walkthroughStepInstructions.innerHTML = step.instructions;
        }

        function resetBillingWalkthrough() {
            currentBillingStep = 0;
            billingWalkthroughContent.classList.add('hidden');
            startBillingWalkthroughBtn.classList.remove('hidden');
            nextBillingWalkthroughBtn.classList.add('hidden');
            resetBillingWalkthroughBtn.classList.add('hidden');
            walkthroughStepTitle.textContent = '';
            walkthroughStepInstructions.innerHTML = '';
            showMessage('Medical Billing Walkthrough Reset.', 'success');
        }

        // --- Prior Authorization Walkthrough Logic ---
        startPaWalkthroughBtn.addEventListener('click', () => {
            currentPaStep = 0; // Start from the first step
            displayPaStep();
            startPaWalkthroughBtn.classList.add('hidden');
            nextPaWalkthroughBtn.classList.remove('hidden');
            resetPaWalkthroughBtn.classList.remove('hidden');
            paWalkthroughContent.classList.remove('hidden');
        });

        nextPaWalkthroughBtn.addEventListener('click', () => {
            currentPaStep++;
            if (currentPaStep < paSteps.length) {
                displayPaStep();
            } else {
                paWalkthroughStepTitle.textContent = "PA Walkthrough Complete!";
                paWalkthroughStepInstructions.innerHTML = `<p class="text-green-700 font-bold">You've successfully reviewed the Prior Authorization process. Click 'Reset Walkthrough' to start again.</p>`;
                nextPaWalkthroughBtn.classList.add('hidden');
            }
        });

        resetPaWalkthroughBtn.addEventListener('click', resetPaWalkthrough);

        function displayPaStep() {
            const step = paSteps[currentPaStep];
            paWalkthroughStepTitle.textContent = step.title;
            paWalkthroughStepInstructions.innerHTML = step.instructions;
        }

        function resetPaWalkthrough() {
            currentPaStep = 0;
            paWalkthroughContent.classList.add('hidden');
            startPaWalkthroughBtn.classList.remove('hidden');
            nextPaWalkthroughBtn.classList.add('hidden');
            resetPaWalkthroughBtn.classList.add('hidden');
            paWalkthroughStepTitle.textContent = '';
            paWalkthroughStepInstructions.innerHTML = '';
            showMessage('Prior Authorization Walkthrough Reset.', 'success');
        }

        // --- Knowledge Quizzes Logic ---
        // selectedQuizModule and currentQuizQuestionIndex are already declared globally above.

        // Function to load a specific quiz module
        function loadQuizModule(moduleName) {
            quizContent.classList.remove('hidden');
            quizFeedback.innerHTML = '<p class="text-gray-500 quiz-feedback-text">Your feedback will appear here.</p>';
            selectedQuizModule = quizModules[moduleName]; // Assign to the global variable
            currentQuizQuestionIndex = 0;
            displayQuizQuestion();
            submitAnswerBtn.classList.remove('hidden');
            nextQuestionBtn.classList.add('hidden');
            resetQuizBtn.classList.remove('hidden');
        }

        // Function to display the current quiz question
        function displayQuizQuestion() {
            if (!selectedQuizModule || currentQuizQuestionIndex >= selectedQuizModule.length) {
                quizQuestionTitle.textContent = "Quiz Complete!";
                quizOptions.innerHTML = `<p class="text-green-700 font-bold">You've completed this quiz module! Click 'Reset Quiz' or select another module.</p>`;
                submitAnswerBtn.classList.add('hidden');
                nextQuestionBtn.classList.add('hidden');
                return;
            }

            const questionData = selectedQuizModule[currentQuizQuestionIndex];
            quizQuestionTitle.textContent = `Question ${currentQuizQuestionIndex + 1}: ${questionData.question}`;
            quizOptions.innerHTML = ''; // Clear previous options
            quizFeedback.innerHTML = '<p class="text-gray-500 quiz-feedback-text">Your feedback will appear here.</p>'; // Clear feedback for new question

            questionData.options.forEach((option, index) => {
                const label = document.createElement('label');
                label.className = 'quiz-option';
                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'quizAnswer'; // Ensure name attribute is set
                input.id = `quizOption${index}`; // Add unique ID for the radio button
                input.value = option.charAt(0); // Get the A, B, C, D part
                label.setAttribute('for', `quizOption${index}`); // Link label to input via 'for'
                label.appendChild(input);
                label.appendChild(document.createTextNode(option));
                quizOptions.appendChild(label);
            });

            submitAnswerBtn.classList.remove('hidden');
            nextQuestionBtn.classList.add('hidden');
        }

        // Function to check the user's answer
        submitAnswerBtn.addEventListener('click', () => {
            const selectedOption = document.querySelector('input[name="quizAnswer"]:checked');
            if (!selectedOption) {
                quizFeedback.innerHTML = '<p class="text-red-700 quiz-feedback-text">Please select an answer.</p>';
                return;
            }

            const userAnswer = selectedOption.value;
            const correctAnswer = selectedQuizModule[currentQuizQuestionIndex].answer;
            const explanation = selectedQuizModule[currentQuizQuestionIndex].explanation;

            if (userAnswer === correctAnswer) {
                quizFeedback.innerHTML = `<p class="text-green-700 font-bold">Correct! Excellent job.</p><p class="quiz-feedback-text">Explanation: ${explanation}</p>`;
            } else {
                quizFeedback.innerHTML = `<p class="text-red-700 font-bold">Incorrect. Here's why:</p><p class="quiz-feedback-text">Explanation: ${explanation}</p>`;
            }

            submitAnswerBtn.classList.add('hidden');
            nextQuestionBtn.classList.remove('hidden');

            // Disable all radio buttons after submission
            quizOptions.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = true);
        });

        // Function to move to the next question
        nextQuestionBtn.addEventListener('click', () => {
            currentQuizQuestionIndex++;
            displayQuizQuestion();
        });

        // Function to reset the current quiz module
        resetQuizBtn.addEventListener('click', () => {
            currentQuizQuestionIndex = 0;
            displayQuizQuestion(); // Start from the beginning of the current module
            quizFeedback.innerHTML = '<p class="text-gray-500 quiz-feedback-text">Your feedback will appear here.</p>';
            submitAnswerBtn.classList.remove('hidden');
            nextQuestionBtn.classList.add('hidden');
            // Re-enable radio buttons for the new question
            quizOptions.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = false);
        });

        // Event listeners for quiz module selection buttons
        quizGuidelinesBtn.addEventListener('click', () => loadQuizModule("Coding Guidelines"));
        quizLawsBtn.addEventListener('click', () => loadQuizModule("Healthcare Laws"));
        quizEthicsBtn.addEventListener('click', () => loadQuizModule("Coding Ethics"));
        quizDenialsBtn.addEventListener('click', () => loadQuizModule("Denials & Appeals"));
        quizInsuranceNuanceBtn.addEventListener('click', () => loadQuizModule("Insurance Nuances"));

        // --- Patient Balance Calculator Logic ---
        let currentBalanceScenarioData = null;

        loadBalanceScenarioBtn.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * patientBalanceScenarios.length);
            currentBalanceScenarioData = patientBalanceScenarios[randomIndex];
            
            balanceCalculatorContent.classList.remove('hidden');
            balanceScenarioTitle.textContent = `Scenario for ${currentBalanceScenarioData.patient}:`;
            balanceScenarioDetails.innerHTML = `
                <p><strong>Plan Details:</strong></p>
                <ul>
                    <li>Copay: $${currentBalanceScenarioData.plan.copay.toFixed(2)}</li>
                    <li>Deductible: $${currentBalanceScenarioData.plan.deductible.toFixed(2)}</li>
                    <li>Deductible Met to Date: $${currentBalanceScenarioData.plan.deductibleMetToDate.toFixed(2)}</li>
                    <li>Coinsurance: ${(currentBalanceScenarioData.plan.coinsurance * 100).toFixed(0)}%</li>
                </ul>
                <p><strong>Visit Details:</strong></p>
                <ul>
                    <li>Service: ${currentBalanceScenarioData.visit.service}</li>
                    <li>Total Allowed Amount by Insurance: $${currentBalanceScenarioData.visit.allowedAmount.toFixed(2)}</li>
                </ul>
                <p class="font-bold mt-2">Calculate the Patient's Responsibility:</p>
            `;
            resetBalanceCalculator(); // Reset inputs and feedback
            checkBalanceBtn.classList.remove('hidden');
            resetBalanceBtn.classList.remove('hidden');
        });

        checkBalanceBtn.addEventListener('click', () => {
            if (!currentBalanceScenarioData) {
                balanceFeedback.innerHTML = '<p class="text-red-700 balance-feedback-text">Please load a scenario first!</p>';
                return;
            }

            const userCopay = parseFloat(userCopayInput.value);
            // Ensure the correct input element is referenced
            const userDeductibleApplied = parseFloat(document.getElementById('userDeductibleInput').value); 
            const userCoinsurance = parseFloat(userCoinsuranceInput.value);
            const userTotalBalance = parseFloat(userTotalBalanceInput.value);

            let feedbackHtml = '';
            let allCorrect = true;

            // Check Copay
            if (userCopay === currentBalanceScenarioData.correct.copay) {
                feedbackHtml += `<p class="text-green-700">Copay: Correct! ($${currentBalanceScenarioData.correct.copay.toFixed(2)})</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Copay: Incorrect. Expected $${currentBalanceScenarioData.correct.copay.toFixed(2)}.</p>`;
                allCorrect = false;
            }

            // Check Deductible Applied
            if (userDeductibleApplied === currentBalanceScenarioData.correct.deductibleApplied) {
                feedbackHtml += `<p class="text-green-700">Deductible Applied: Correct! ($${currentBalanceScenarioData.correct.deductibleApplied.toFixed(2)})</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Deductible Applied: Incorrect. Expected $${currentBalanceScenarioData.correct.deductibleApplied.toFixed(2)}.</p>`;
                allCorrect = false;
            }

            // Check Coinsurance
            if (userCoinsurance === currentBalanceScenarioData.correct.coinsurance) {
                feedbackHtml += `<p class="text-green-700">Coinsurance: Correct! ($${currentBalanceScenarioData.correct.coinsurance.toFixed(2)})</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Coinsurance: Incorrect. Expected $${currentBalanceScenarioData.correct.coinsurance.toFixed(2)}.</p>`;
                allCorrect = false;
            }

            // Check Total Patient Balance
            if (userTotalBalance === currentBalanceScenarioData.correct.totalBalance) {
                feedbackHtml += `<p class="text-green-700 font-bold mt-2">Total Patient Balance: Correct! ($${currentBalanceScenarioData.correct.totalBalance.toFixed(2)})</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700 font-bold mt-2">Total Patient Balance: Incorrect. Expected $${currentBalanceScenarioData.correct.totalBalance.toFixed(2)}.</p>`;
                allCorrect = false;
            }

            // Overall feedback and detailed steps if incorrect
            if (!allCorrect) {
                feedbackHtml += `<p class="text-gray-700 mt-4 font-bold">Here's a breakdown of the correct calculation:</p>`;
                feedbackHtml += `<pre class="bg-gray-100 p-2 rounded text-xs mt-1 whitespace-pre-wrap">${currentBalanceScenarioData.calculationSteps.trim()}</pre>`;
                balanceFeedback.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
            } else {
                 balanceFeedback.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
            }
            
            balanceFeedback.innerHTML = feedbackHtml;
        });

        resetBalanceBtn.addEventListener('click', resetBalanceCalculator);

        function resetBalanceCalculator() {
            userCopayInput.value = '';
            document.getElementById('userDeductibleInput').value = ''; // Corrected ID
            userCoinsuranceInput.value = '';
            userTotalBalanceInput.value = '';
            balanceFeedback.innerHTML = '<p class="text-gray-500 balance-feedback-text">Feedback on your calculation will appear here.</p>';
            balanceFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
        }

        // --- Modifier Application Challenge Logic ---
        // 'currentModifierChallenge' is already declared globally at the top of the script.
        // The original error was due to redeclaring it with 'let' here.
        currentModifierChallenge = null; // Initialize it without 'let' or 'const'

        loadModifierScenarioBtn.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * modifierScenarios.length);
            currentModifierChallenge = modifierScenarios[randomIndex];
            
            modifierChallengeContent.classList.remove('hidden');
            modifierScenarioTitle.textContent = `Scenario: ${currentModifierChallenge.id}`;
            modifierScenarioDetails.innerHTML = `<p class="text-sm text-yellow-800 italic">${currentModifierChallenge.scenario}</p>
                <p class="mt-2"><strong>Required CPT Code to Input:</strong> ${currentModifierChallenge.cptCodeToInput}</p>
                <p class="font-bold mt-2">Enter the CPT Code (if different from the required) and the appropriate Modifier(s).</p>
            `;
            userModifierCPTInput.value = '';
            userModifierInput.value = '';
            modifierFeedback.innerHTML = '<p class="text-gray-500 modifier-feedback-text">Feedback on your modifier application will appear here.</p>';
            modifierFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
            checkModifierBtn.classList.remove('hidden');
            resetModifierBtn.classList.remove('hidden');
        });

        checkModifierBtn.addEventListener('click', () => {
            if (!currentModifierChallenge) {
                modifierFeedback.innerHTML = '<p class="text-red-700 modifier-feedback-text">Please load a scenario first!</p>';
                return;
            }

            const userCPT = userModifierCPTInput.value.trim().toUpperCase();
            const userMod = userModifierInput.value.trim().toUpperCase();

            let feedbackHtml = '';
            let isCorrect = true;

            // Check CPT code
            if (userCPT !== currentModifierChallenge.cptCodeToInput.trim().toUpperCase()) {
                feedbackHtml += `<p class="text-red-700">CPT Code: Incorrect. Expected "${currentModifierChallenge.cptCodeToInput}".</p>`;
                isCorrect = false;
            } else {
                feedbackHtml += `<p class="text-green-700">CPT Code: Correct! ("${currentModifierChallenge.cptCodeToInput}")</p>`;
            }

            // Check Modifier
            if (userMod !== currentModifierChallenge.correctModifier.trim().toUpperCase()) {
                feedbackHtml += `<p class="text-red-700">Modifier: Incorrect. Expected "${currentModifierChallenge.correctModifier}".</p>`;
                isCorrect = false;
            } else {
                feedbackHtml += `<p class="text-green-700">Modifier: Correct! ("${currentModifierChallenge.correctModifier}")</p>`;
            }

            if (isCorrect) {
                modifierFeedback.innerHTML = `<p class="text-green-700 font-bold">Excellent! Your CPT code and modifier application are correct.</p>`;
            } else {
                modifierFeedback.innerHTML += `<p class="text-gray-700 mt-4 font-bold">Explanation:</p><p class="modifier-feedback-text">${currentModifierChallenge.explanation}</p>`;
            }
            modifierFeedback.className = isCorrect ? 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]' : 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
        });

        resetModifierBtn.addEventListener('click', () => {
            userModifierCPTInput.value = '';
            userModifierInput.value = '';
            modifierFeedback.innerHTML = '<p class="text-gray-500 modifier-feedback-text">Feedback on your modifier application will appear here.</p>';
            modifierFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
            checkModifierBtn.classList.remove('hidden');
            resetModifierBtn.classList.remove('hidden');
        });

        // --- Matching Game Logic ---

        startGameBtn.addEventListener('click', startGame);
        resetGameBtn.addEventListener('click', resetGame);

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function createCards() {
            cardGrid.innerHTML = ''; // Clear previous cards
            gameMessage.textContent = '';
            flippedCards = [];
            matchedPairs = 0;
            gameActive = true;

            cards = [];
            termPairs.forEach((pair, index) => {
                cards.push({ id: `term-${index}`, type: 'term', value: pair.term, pairId: index });
                cards.push({ id: `def-${index}`, type: 'definition', value: pair.definition, pairId: index });
            });

            shuffle(cards);

            cards.forEach(cardData => {
                const cardElement = document.createElement('div');
                cardElement.classList.add('match-card');
                cardElement.dataset.id = cardData.id;
                cardElement.dataset.pairId = cardData.pairId;
                cardElement.dataset.type = cardData.type;

                const cardFront = document.createElement('div');
                cardFront.classList.add('card-front');
                cardFront.textContent = '?'; // Placeholder for the back of the card

                const cardBack = document.createElement('div');
                cardBack.classList.add('card-back');
                cardBack.textContent = cardData.value;

                cardElement.appendChild(cardFront);
                cardElement.appendChild(cardBack);
                cardGrid.appendChild(cardElement);

                cardElement.addEventListener('click', () => flipCard(cardElement, cardData));
            });
        }

        function flipCard(cardElement, cardData) {
            if (!gameActive || flippedCards.length === 2 || cardElement.classList.contains('is-flipped') || cardElement.classList.contains('matched')) {
                return; // Do nothing if game not active, two cards already flipped, or card already flipped/matched
            }

            cardElement.classList.add('is-flipped');
            flippedCards.push({ element: cardElement, data: cardData });

            if (flippedCards.length === 2) {
                checkForMatch();
            }
        }

        function checkForMatch() {
            const [card1, card2] = flippedCards;
            const isMatch = card1.data.pairId === card2.data.pairId;

            if (isMatch) {
                card1.element.classList.add('matched');
                card2.element.classList.add('matched');
                gameMessage.textContent = 'Match found!';
                matchedPairs++;
                if (matchedPairs === termPairs.length) {
                    gameMessage.textContent = 'Congratulations! You matched all pairs!';
                    gameActive = false;
                }
                flippedCards = []; // Clear flipped cards for next turn
            } else {
                gameMessage.textContent = 'No match. Try again!';
                // Add incorrect class temporarily for visual feedback
                card1.element.classList.add('incorrect');
                card2.element.classList.add('incorrect');

                setTimeout(() => {
                    card1.element.classList.remove('is-flipped', 'incorrect');
                    card2.element.classList.remove('is-flipped', 'incorrect');
                    flippedCards = []; // Clear flipped cards
                    gameMessage.textContent = ''; // Clear message
                }, 1000); // Flip back after 1 second
            }
        }

        function startGame() {
            matchingGameContent.classList.remove('hidden');
            startGameBtn.classList.add('hidden');
            resetGameBtn.classList.remove('hidden');
            createCards();
            gameMessage.textContent = 'Find the matching pairs!';
        }

        function resetGame() {
            matchingGameContent.classList.add('hidden');
            startGameBtn.classList.remove('hidden');
            resetGameBtn.classList.add('hidden');
            cardGrid.innerHTML = '';
            gameMessage.textContent = '';
            flippedCards = [];
            matchedPairs = 0;
            gameActive = false;
            showMessage('Matching Game Reset.', 'success');
        }

        // --- Claim Scrubber Logic ---
        let currentScrubberScenarioData = null;

        loadScrubberScenarioBtn.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * claimScrubberScenarios.length);
            currentScrubberScenarioData = claimScrubberScenarios[randomIndex];
            
            scrubberChallengeContent.classList.remove('hidden');
            scrubberScenarioTitle.textContent = `Claim Scrubber: ${currentScrubberScenarioData.title}`;
            scrubberScenarioDetails.innerHTML = `<p class="text-sm text-orange-800 italic">${currentScrubberScenarioData.description}</p>
                <p class="mt-2 font-bold">Your Task: Correct the errors in the presented claim details below.</p>
            `;
            presentedClaimOutput.textContent = `
Patient Notes: ${currentScrubberScenarioData.presentedClaim.notes}
Diagnosis: ${currentScrubberScenarioData.presentedClaim.diagnosis}
CPT Code(s): ${currentScrubberScenarioData.presentedClaim.cpt}
Modifier(s): ${currentScrubberScenarioData.presentedClaim.modifier}
            `.trim();
            
            resetScrubberInputsAndFeedback(); // Reset inputs and feedback
            checkScrubberBtn.classList.remove('hidden');
            resetScrubberBtn.classList.remove('hidden');
        });

        checkScrubberBtn.addEventListener('click', () => {
            if (!currentScrubberScenarioData) {
                scrubberFeedback.innerHTML = '<p class="text-red-700 scrubber-feedback-text">Please load a scenario first!</p>';
                return;
            }

            const userICD = userScrubberICDInput.value.trim().toUpperCase();
            const userCPT = userScrubberCPTInput.value.trim().toUpperCase();
            const userModifier = userScrubberModifierInput.value.trim().toUpperCase();

            let feedbackHtml = '';
            let allCorrect = true;

            // Helper to compare inputs, treating "NONE" or empty as the same for modifiers
            const compareInput = (userInput, expectedValue) => {
                if (expectedValue.toLowerCase() === 'none' || expectedValue.toLowerCase() === '') {
                    return userInput === '' || userInput.toLowerCase() === 'none';
                }
                // For ICDs, allow comma-separated and check if all expected are present.
                if (expectedValue.includes(',')) {
                    const expectedParts = expectedValue.split(',').map(p => p.trim());
                    const userParts = userInput.split(',').map(p => p.trim());
                    // Check if all expected parts are in user's input, regardless of order
                    const allExpectedFound = expectedParts.every(part => userParts.includes(part));
                    // Check if user didn't add extra unexpected parts
                    const noExtraParts = userParts.every(part => expectedParts.includes(part));
                    return allExpectedFound && noExtraParts;
                }
                return userInput === expectedValue;
            };

            // Check ICD
            if (!compareInput(userICD, currentScrubberScenarioData.expectedInputs.correctedICD.toUpperCase())) {
                const error = currentScrubberScenarioData.errors.find(e => e.type === 'diagnosis' || e.type === 'diagnosis-medical-necessity');
                feedbackHtml += `<p class="text-red-700">ICD-10 Code: Incorrect. Expected "${currentScrubberScenarioData.expectedInputs.correctedICD}".</p>`;
                if (error) feedbackHtml += `<p class="text-gray-700 text-sm mt-1">${error.explanation}</p>`;
                allCorrect = false;
            } else {
                feedbackHtml += `<p class="text-green-700">ICD-10 Code: Correct! ("${currentScrubberScenarioData.expectedInputs.correctedICD}")</p>`;
            }

            // Check CPT
            if (!compareInput(userCPT, currentScrubberScenarioData.expectedInputs.correctedCPT.toUpperCase())) {
                const error = currentScrubberScenarioData.errors.find(e => e.type === 'cpt');
                feedbackHtml += `<p class="text-red-700">CPT Code: Incorrect. Expected "${currentScrubberScenarioData.expectedInputs.correctedCPT}".</p>`;
                if (error) feedbackHtml += `<p class="text-gray-700 text-sm mt-1">${error.explanation}</p>`;
                allCorrect = false;
            } else {
                feedbackHtml += `<p class="text-green-700">CPT Code: Correct! ("${currentScrubberScenarioData.expectedInputs.correctedCPT}")</p>`;
            }

            // Check Modifier
            if (!compareInput(userModifier, currentScrubberScenarioData.expectedInputs.correctedModifier.toUpperCase())) {
                const error = currentScrubberScenarioData.errors.find(e => e.type === 'modifier');
                 feedbackHtml += `<p class="text-red-700">Modifier(s): Incorrect. Expected "${currentScrubberScenarioData.expectedInputs.correctedModifier}".</p>`;
                 if (error) feedbackHtml += `<p class="text-gray-700 text-sm mt-1">${error.explanation}</p>`;
                 allCorrect = false;
            } else {
                feedbackHtml += `<p class="text-green-700">Modifier(s): Correct! ("${currentScrubberScenarioData.expectedInputs.correctedModifier}")</p>`;
            }

            if (allCorrect) {
                scrubberFeedback.innerHTML = `<p class="text-green-700 font-bold">Excellent! You found and corrected all errors in this claim.</p>`;
                scrubberFeedback.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
            } else {
                // If there were specific error explanations, they are already added to feedbackHtml
                scrubberFeedback.innerHTML = `<p class="text-red-700 font-bold">Not quite right. Review the feedback:</p>` + feedbackHtml;
                scrubberFeedback.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
            }
        });

        resetScrubberBtn.addEventListener('click', resetScrubberInputsAndFeedback);

        function resetScrubberInputsAndFeedback() {
            userScrubberICDInput.value = '';
            userScrubberCPTInput.value = '';
            userScrubberModifierInput.value = '';
            scrubberFeedback.innerHTML = '<p class="text-gray-500 scrubber-feedback-text">Feedback on your corrections will appear here.</p>';
            scrubberFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
        }

        // --- Denial Code Interpreter Logic ---
        let currentDenialScenarioData = null;

        loadDenialScenarioBtn.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * denialScenarios.length);
            currentDenialScenarioData = denialScenarios[randomIndex];
            
            denialChallengeContent.classList.remove('hidden');
            denialScenarioTitle.textContent = `Denial Challenge: ${currentDenialScenarioData.denialCode}`;
            denialScenarioDetails.innerHTML = `<p class="text-sm text-purple-800 italic">Context: ${currentDenialScenarioData.context}</p>
            `;
            
            denialInterpretationOptions.innerHTML = ''; // Clear previous options
            currentDenialScenarioData.interpretations.forEach((interpretation, index) => {
                const label = document.createElement('label');
                label.className = 'denial-option';
                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'denialInterpretation';
                input.id = `denialOption${index}`; // Add unique ID for the radio button
                input.value = index; // Use index to map back to the interpretation object
                label.setAttribute('for', `denialOption${index}`); // Link label to input via 'for'
                label.appendChild(input);
                label.appendChild(document.createTextNode(interpretation.text));
                denialInterpretationOptions.appendChild(label);
            });

            resetDenialInputsAndFeedback();
            checkDenialBtn.classList.remove('hidden');
            resetDenialBtn.classList.remove('hidden');
        });

        checkDenialBtn.addEventListener('click', () => {
            if (!currentDenialScenarioData) {
                denialFeedback.innerHTML = '<p class="text-red-700 denial-feedback-text">Please load a scenario first!</p>';
                return;
            }

            const selectedInterpretationOption = document.querySelector('input[name="denialInterpretation"]:checked');
            const userActionPlan = userActionPlanInput.value.trim().toUpperCase();

            let feedbackHtml = '';
            let allCorrect = true;

            // Check Interpretation
            if (!selectedInterpretationOption) {
                feedbackHtml += `<p class="text-red-700">Interpretation: Please select an interpretation.</p>`;
                allCorrect = false;
            } else {
                const selectedInterpretationIndex = parseInt(selectedInterpretationOption.value);
                const isInterpretationCorrect = currentDenialScenarioData.interpretations[selectedInterpretationIndex].correct;
                
                if (isInterpretationCorrect) {
                    feedbackHtml += `<p class="text-green-700">Interpretation: Correct! ("${currentDenialScenarioData.interpretations[selectedInterpretationIndex].text}")</p>`;
                } else {
                    const correctText = currentDenialScenarioData.interpretations.find(i => i.correct).text;
                    feedbackHtml += `<p class="text-red-700">Interpretation: Incorrect. The correct interpretation is: "${correctText}".</p>`;
                    allCorrect = false;
                }
            }

            // Check Action Plan (using keywords)
            const correctActionKeywords = currentDenialScenarioData.correctActionPlanKeywords.map(k => k.toUpperCase());
            const userActionWords = userActionPlan.split(/\s|,\s*/).filter(word => word !== '').map(word => word.toUpperCase());
            
            let actionPlanCorrect = true;
            let missingKeywords = [];
            let extraKeywords = [];

            correctActionKeywords.forEach(keyword => {
                if (!userActionWords.includes(keyword)) {
                    missingKeywords.push(keyword);
                    actionPlanCorrect = false;
                }
            });

            // Check for extraneous words that are not expected for a perfectly correct answer
            userActionWords.forEach(word => {
                if (!correctActionKeywords.includes(word)) {
                    extraKeywords.push(word);
                }
            });

            if (actionPlanCorrect && extraKeywords.length === 0) { // All correct keywords present, no extra unexpected ones
                feedbackHtml += `<p class="text-green-700 mt-2">Action Plan: Well done! Your action plan is comprehensive.</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700 mt-2">Action Plan: Review your action plan.</p>`;
                if (missingKeywords.length > 0) {
                    feedbackHtml += `<p class="text-red-700 text-sm">Missing key elements: ${missingKeywords.join(', ')}.</p>`;
                }
                if (extraKeywords.length > 0) {
                    feedbackHtml += `<p class="text-red-700 text-sm">You included some unexpected elements: ${extraKeywords.join(', ')}.</p>`;
                }
                allCorrect = false;
            }

            // Overall feedback
            if (allCorrect) {
                denialFeedback.innerHTML = `<p class="text-green-700 font-bold">Excellent! You correctly interpreted the denial and formulated the ideal action plan.</p>`;
                denialFeedback.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
            } else {
                denialFeedback.innerHTML = `<p class="text-red-700 font-bold">Not quite perfect. Review the feedback and explanation:</p>` + feedbackHtml;
                denialFeedback.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
            }
            denialFeedback.innerHTML += `<p class="text-gray-700 mt-4 font-bold">Detailed Explanation for Resolution:</p><p class="denial-feedback-text">${currentDenialScenarioData.explanation}</p>`;

            // Disable inputs after checking
            denialInterpretationOptions.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = true);
            userActionPlanInput.disabled = true;
        });

        resetDenialBtn.addEventListener('click', resetDenialInputsAndFeedback);

        function resetDenialInputsAndFeedback() {
            denialInterpretationOptions.innerHTML = '<p class="text-gray-500 denial-scenario-text">Select an interpretation.</p>'; // Reset radio buttons
            userActionPlanInput.value = '';
            userActionPlanInput.disabled = false;
            denialInterpretationOptions.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = false);
            denialFeedback.innerHTML = '<p class="text-gray-500 denial-feedback-text">Feedback on your denial resolution plan will appear here.</p>';
            denialFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
        }

        // --- SOAP Note Coder & Extractor Logic ---
        // currentSoapScenarioData is already declared globally, no 'let' here.
        currentSoapScenarioData = null;

        loadSoapScenarioBtn.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * soapNoteScenarios.length);
            currentSoapScenarioData = soapNoteScenarios[randomIndex];
            
            soapChallengeContent.classList.remove('hidden');
            soapScenarioTitle.textContent = `SOAP Note Challenge: ${currentSoapScenarioData.title}`;
            soapScenarioDescription.textContent = currentSoapScenarioData.description;
            soapNoteDisplay.textContent = currentSoapScenarioData.soapNote;
            
            resetSoapInputsAndFeedback();
            checkSoapBtn.classList.remove('hidden');
            resetSoapBtn.classList.remove('hidden');
        });

        checkSoapBtn.addEventListener('click', () => {
            if (!currentSoapScenarioData) {
                soapFeedback.innerHTML = '<p class="text-red-700 soap-feedback-text">Please load a scenario first!</p>';
                return;
            }

            const userChiefComplaint = userSoapChiefComplaintInput.value.trim();
            const userICD = userSoapICDInput.value.trim().toUpperCase().split(',').map(s => s.trim()).filter(s => s !== '');
            const userCPT = userSoapCPTInput.value.trim().toUpperCase().split(',').map(s => s.trim()).filter(s => s !== '');
            const userModifier = userSoapModifierInput.value.trim().toUpperCase();
            const userPlan = userSoapPlanInput.value.trim().toUpperCase();

            let feedbackHtml = '';
            let allCorrect = true;

            // Helper to compare arrays of codes, ignoring order
            const compareCodeArrays = (userArray, expectedArray) => {
                if (userArray.length !== expectedArray.length) return false;
                const sortedUser = [...userArray].sort();
                const sortedExpected = [...expectedArray].sort();
                for (let i = 0; i < sortedUser.length; i++) {
                    if (sortedUser[i] !== sortedExpected[i]) return false;
                }
                return true;
            };

            // Check Chief Complaint
            if (userChiefComplaint.toLowerCase() === currentSoapScenarioData.expected.chiefComplaint.toLowerCase()) {
                feedbackHtml += `<p class="text-green-700">Chief Complaint: Correct! ("${currentSoapScenarioData.expected.chiefComplaint}")</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Chief Complaint: Incorrect. Expected: "${currentSoapScenarioData.expected.chiefComplaint}".</p>`;
                allCorrect = false;
            }

            // Check Primary ICD-10
            const expectedICD = currentSoapScenarioData.expected.icd10.split(',').map(s => s.trim().toUpperCase());
            if (compareCodeArrays(userICD, expectedICD)) {
                feedbackHtml += `<p class="text-green-700">Primary ICD-10 Code(s): Correct! ("${currentSoapScenarioData.expected.icd10}")</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Primary ICD-10 Code(s): Incorrect. Expected: "${currentSoapScenarioData.expected.icd10}".</p>`;
                allCorrect = false;
            }

            // Check Primary CPT
            const expectedCPT = currentSoapScenarioData.expected.cpt.split(',').map(s => s.trim().toUpperCase());
            if (compareCodeArrays(userCPT, expectedCPT)) {
                feedbackHtml += `<p class="text-green-700">Primary CPT Code(s): Correct! ("${currentSoapScenarioData.expected.cpt}")</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Primary CPT Code(s): Incorrect. Expected: "${currentSoapScenarioData.expected.cpt}".</p>`;
                allCorrect = false;
            }

            // Check Modifier
            const expectedModifier = currentSoapScenarioData.expected.modifier.toUpperCase();
            const userModNormalized = (userSoapModifierInput.value.trim().toUpperCase() === 'NONE' || userSoapModifierInput.value.trim() === '') ? 'NONE' : userSoapModifierInput.value.trim().toUpperCase();

            if (userModNormalized === expectedModifier) {
                feedbackHtml += `<p class="text-green-700">Modifier(s): Correct! ("${expectedModifier}")</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Modifier(s): Incorrect. Expected: "${expectedModifier}".</p>`;
                allCorrect = false;
            }

            // Check Key Plan Elements (using keywords)
            const expectedPlanKeywords = currentSoapScenarioData.expected.planKeywords.map(k => k.toUpperCase());
            const userPlanWords = userPlan.split(/\s|,\s*|\.\s*|;\s*/).filter(word => word !== '').map(word => word.toUpperCase());
            
            let planCorrect = true;
            let missingPlanKeywords = [];
            let extraPlanKeywords = [];

            expectedPlanKeywords.forEach(keyword => {
                if (!userPlanWords.some(word => word.includes(keyword))) { // Check if any user word contains the keyword
                    missingPlanKeywords.push(keyword);
                    planCorrect = false;
                }
            });

            userPlanWords.forEach(word => {
                 // Check if the user's word is not directly one of the expected keywords AND doesn't contain an expected keyword
                if (!expectedPlanKeywords.includes(word) && !expectedPlanKeywords.some(kw => word.includes(kw))) {
                    extraPlanKeywords.push(word);
                }
            });

            if (planCorrect && extraPlanKeywords.length === 0) {
                feedbackHtml += `<p class="text-green-700 mt-2">Key Plan Elements: Well done! Your summary covers the main points.</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700 mt-2">Key Plan Elements: Review your plan summary.</p>`;
                if (missingPlanKeywords.length > 0) {
                    feedbackHtml += `<p class="text-red-700 text-sm">Missing key elements: ${missingPlanKeywords.join(', ')}.</p>`;
                }
                if (extraPlanKeywords.length > 0) {
                    feedbackHtml += `<p class="text-red-700 text-sm">You included some unexpected elements: ${extraKeywords.join(', ')}.</p>`;
                }
                allCorrect = false;
            }

            // Overall feedback
            if (allCorrect) {
                soapFeedback.innerHTML = `<p class="text-green-700 font-bold">Excellent! You correctly extracted all key information from the SOAP note.</p>`;
                soapFeedback.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
            } else {
                soapFeedback.innerHTML = `<p class="text-red-700 font-bold">Not quite perfect. Review the feedback and explanation:</p>` + feedbackHtml;
                soapFeedback.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
            }
            soapFeedback.innerHTML += `<p class="text-gray-700 mt-4 font-bold">Detailed Explanation:</p><p class="soap-feedback-text">${currentSoapScenarioData.explanation}</p>`;

            // Disable inputs after checking
            userSoapChiefComplaintInput.disabled = true;
            userSoapICDInput.disabled = true;
            userSoapCPTInput.disabled = true;
            userSoapModifierInput.disabled = true;
            userSoapPlanInput.disabled = true;
        });

        resetSoapBtn.addEventListener('click', resetSoapInputsAndFeedback);

        function resetSoapInputsAndFeedback() {
            userSoapChiefComplaintInput.value = '';
            userSoapICDInput.value = '';
            userSoapCPTInput.value = '';
            userSoapModifierInput.value = '';
            userSoapPlanInput.value = '';
            userSoapChiefComplaintInput.disabled = false;
            userSoapICDInput.disabled = false;
            userSoapCPTInput.disabled = false;
            userSoapModifierInput.disabled = false;
            userSoapPlanInput.disabled = false;
            soapFeedback.innerHTML = '<p class="text-gray-500 soap-feedback-text">Feedback on your extraction will appear here.</p>';
            soapFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
        }

        // --- Code Lookup Tool Logic ---
        lookupCodeBtn.addEventListener('click', () => {
            const code = codeLookupInput.value.trim().toUpperCase();
            if (code === '') {
                codeLookupResult.innerHTML = '<p class="text-red-700">Please enter a code to look up.</p>';
                codeLookupResult.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
                return;
            }

            const description = codeDatabase[code];
            if (description) {
                codeLookupResult.innerHTML = `<p class="text-green-700 font-bold">Code found:</p><p class="code-lookup-text">${code}: ${description}</p>`;
                codeLookupResult.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
            } else {
                codeLookupResult.innerHTML = `<p class="text-red-700 font-bold">Code not found.</p><p class="code-lookup-text">"${code}" is not in our current database. Please try another common ICD-10 or CPT code (e.g., J02.0, 99213).</p>`;
                codeLookupResult.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
            }
        });

        // --- NEW: A/R Aging Simulation Logic ---
        loadArScenarioBtn.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * arAgingScenarios.length);
            currentArScenarioClaims = arAgingScenarios[randomIndex].claims;
            
            arAgingContent.classList.remove('hidden');
            arClaimList.innerHTML = ''; // Clear previous claims

            currentArScenarioClaims.forEach((claim, index) => {
                const claimDiv = document.createElement('div');
                claimDiv.classList.add('ar-claim-item');
                claimDiv.dataset.index = index; // Store index for easy lookup

                claimDiv.innerHTML = `
                    <h3 class="font-semibold text-gray-800">Claim ID: ${claim.claimId}</h3>
                    <div class="ar-claim-details">
                        <p><strong>Patient:</strong> ${claim.patient}</p>
                        <p><strong>Payer:</strong> ${claim.payer}</p>
                        <p><strong>Amount:</strong> $${claim.amount.toFixed(2)}</p>
                        <p><strong>Days Old:</strong> ${claim.daysOld}</p>
                    </div>
                    <label for="arAction-${index}" class="block text-gray-700 text-sm font-bold mb-2">Your Action:</label>
                    <select id="arAction-${index}" name="arAction-${index}" class="ar-action-select focus:ring-red-500 focus:border-red-500 w-full">
                        <option value="">-- Select Action --</option>
                        <option value="check_status_online">Check claim status online (payer portal).</option>
                        <option value="call_payer">Call payer (provider services) for status/details.</option>
                        <option value="review_eob_era">Review EOB/ERA for denial reason/details.</option>
                        <option value="submit_appeal">Submit an appeal with supporting documentation.</option>
                        <option value="correct_resubmit">Correct simple errors and resubmit claim.</option>
                        <option value="bill_patient">Bill patient (if patient responsibility is indicated).</option>
                        <option value="write_off">Write off balance (e.g., timely filing, contractual adjustment).</option>
                        <option value="monitor_further">Monitor further, still within initial processing time.</option>
                    </select>
                    <div id="arFeedback-${index}" class="ar-claim-feedback hidden"></div>
                `;
                arClaimList.appendChild(claimDiv);
            });

            arFeedback.innerHTML = '<p class="text-gray-500">Feedback on your A/R actions will appear here.</p>';
            arFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]';
            checkArActionsBtn.classList.remove('hidden');
            resetArScenarioBtn.classList.remove('hidden');
        });

        checkArActionsBtn.addEventListener('click', () => {
            let allCorrect = true;
            currentArScenarioClaims.forEach((claim, index) => {
                const selectElement = document.getElementById(`arAction-${index}`);
                const userAction = selectElement.value;
                const feedbackDiv = document.getElementById(`arFeedback-${index}`);
                
                let isClaimCorrect = false;
                // Determine correctness based on daysOld and user selection
                if (claim.daysOld <= 30 && userAction === "monitor_further") {
                    isClaimCorrect = true;
                } else if (claim.daysOld > 30 && claim.daysOld <= 60 && (userAction === "check_status_online" || userAction === "call_payer")) {
                    isClaimCorrect = true;
                } else if (claim.daysOld > 60 && claim.daysOld <= 90 && (userAction === "call_payer" || userAction === "review_eob_era" || userAction === "submit_appeal" || userAction === "correct_resubmit")) {
                     isClaimCorrect = true;
                } else if (claim.daysOld > 90 && (userAction === "review_eob_era" || userAction === "submit_appeal" || userAction === "correct_resubmit" || userAction === "write_off")) {
                    isClaimCorrect = true;
                }
                // Specific conditions override general if applicable (e.g., patient billing or write-off)
                // This block adds flexibility to the logic, allowing for *any* correct action based on the specific claim's correctAction string
                if (claim.correctAction.includes("Bill patient") && userAction === "bill_patient") {
                    isClaimCorrect = true;
                }
                if (claim.correctAction.includes("Write off") && userAction === "write_off") {
                    isClaimCorrect = true;
                }
                if (claim.correctAction.includes("Check claim status online") && userAction === "check_status_online") {
                    isClaimCorrect = true;
                }
                if (claim.correctAction.includes("Call payer") && userAction === "call_payer") {
                    isClaimCorrect = true;
                }
                if (claim.correctAction.includes("Review EOB/ERA") && userAction === "review_eob_era") {
                    isClaimCorrect = true;
                }
                if (claim.correctAction.includes("Submit an appeal") && userAction === "submit_appeal") {
                    isClaimCorrect = true;
                }
                if (claim.correctAction.includes("Correct simple errors") && userAction === "correct_resubmit") {
                    isClaimCorrect = true;
                }
                if (claim.correctAction.includes("Monitor claim status") && userAction === "monitor_further") {
                    isClaimCorrect = true;
                }


                feedbackDiv.classList.remove('hidden');
                if (isClaimCorrect) {
                    feedbackDiv.classList.add('correct');
                    feedbackDiv.classList.remove('incorrect');
                    feedbackDiv.innerHTML = `<p>Correct Action: ${claim.correctAction}</p><p class="mt-1 text-xs">(${claim.explanation})</p>`;
                } else {
                    feedbackDiv.classList.add('incorrect');
                    feedbackDiv.classList.remove('correct');
                    feedbackDiv.innerHTML = `<p>Incorrect. Expected action: ${claim.correctAction}</p><p class="mt-1 text-xs">(${claim.explanation})</p>`;
                    allCorrect = false;
                }
                selectElement.disabled = true; // Disable selection after checking
            });

            if (allCorrect) {
                arFeedback.innerHTML = '<p class="text-green-700 font-bold">Excellent! You correctly identified the best action for all aging claims.</p>';
                arFeedback.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
            } else {
                arFeedback.innerHTML = '<p class="text-red-700 font-bold">Review the feedback for each claim. Some actions were not ideal.</p>';
                arFeedback.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
            }
        });

        resetArScenarioBtn.addEventListener('click', () => {
            arAgingContent.classList.add('hidden');
            loadArScenarioBtn.classList.remove('hidden');
            arClaimList.innerHTML = '';
            arFeedback.innerHTML = '<p class="text-gray-500">Feedback on your A/R actions will appear here.</p>';
            arFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]';
            resetArScenarioBtn.classList.add('hidden');
            checkArActionsBtn.classList.add('hidden');
            showMessage('A/R Aging Scenario Reset.', 'success');
        });

    </script>
</body>
</html>
