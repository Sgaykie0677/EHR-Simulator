<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EHR Simulator for Medical Billing Practice</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }
        input[type="text"], input[type="date"], input[type="number"], textarea, select {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
            padding: 8px 14px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.875rem; /* text-sm */
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .message-box {
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
            display: none; /* Hidden by default */
        }
        .message-box.success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .message-box.error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .flex-grow-1 { /* Custom utility to make item grow */
            flex-grow: 1;
        }
        .hidden {
            display: none;
        }
        .walkthrough-step-content, .quiz-content, .balance-calculator-content, .modifier-challenge-content, .matching-game-content, .scrubber-challenge-content, .denial-challenge-content, .soap-challenge-content, .code-lookup-content, .ar-aging-content, .form-repository-content {
            background-color: #f8fafc; /* bg-blue-50 alternative */
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0; /* border-gray-200 alternative */
            margin-top: 1rem;
        }
        .walkthrough-step-title, .quiz-question-title, .balance-scenario-title, .modifier-challenge-title, .matching-game-title, .scrubber-challenge-title, .denial-challenge-title, .soap-challenge-title, .code-lookup-title, .ar-aging-title, .form-repository-title {
            font-weight: 600; /* font-semibold */
            color: #1a202c; /* text-gray-900 */
            margin-bottom: 0.5rem;
        }
        .walkthrough-instructions, .quiz-instructions, .quiz-feedback-text, .balance-scenario-text, .balance-feedback-text, .modifier-scenario-text, .modifier-feedback-text, .matching-game-text, .scrubber-scenario-text, .scrubber-feedback-text, .denial-scenario-text, .denial-feedback-text, .soap-scenario-text, .soap-feedback-text, .code-lookup-text, .ar-aging-text, .form-repository-text {
            font-size: 0.875rem; /* text-sm */
            color: #4a5568; /* text-gray-700 */
        }
        .quiz-option, .denial-option {
            display: block;
            padding: 8px 0;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 4px;
        }
        .quiz-option:hover, .denial-option:hover {
            background-color: #f0f4f8;
        }
        .quiz-option input[type="radio"], .denial-option input[type="radio"] {
            margin-right: 8px;
        }
        .match-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* Responsive grid */
            gap: 10px;
            margin-top: 20px;
        }
        .match-card {
            background-color: #cbd5e0; /* gray-300 */
            border-radius: 8px;
            padding: 15px;
            height: 120px; /* Fixed height for consistency */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: 600;
            color: #2d3748; /* gray-800 */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
            transform-style: preserve-3d;
            position: relative;
        }
        .match-card.flipped {
            background-color: #fff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .match-card.matched {
            background-color: #a7f3d0; /* green-200 */
            color: #065f46; /* green-800 */
            cursor: default;
            pointer-events: none; /* Disable clicks on matched cards */
        }
        .match-card.incorrect {
            background-color: #fca5a5; /* red-300 */
            color: #991b1b; /* red-800 */
        }
        .card-inner {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            backface-visibility: hidden;
            position: absolute;
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            backface-visibility: hidden;
            border-radius: 8px;
            padding: 15px;
            box-sizing: border-box;
            font-size: 0.9em;
        }
        .card-front {
            background-color: #cbd5e0; /* gray-300 */
            color: #2d3748; /* gray-800 */
            font-weight: 600;
        }
        .card-back {
            background-color: #fff;
            color: #2d3748;
            transform: rotateY(180deg);
        }
        .match-card.is-flipped .card-front {
            transform: rotateY(180deg);
        }
        .match-card.is-flipped .card-back {
            transform: rotateY(360deg);
        }
        #soapNoteDisplay {
            background-color: #f0f4f8; /* Light blue-gray */
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 15px;
            white-space: pre-wrap; /* Preserves formatting */
            font-family: monospace; /* Monospace for code-like text */
            font-size: 0.85rem;
            max-height: 400px; /* Limit height */
            overflow-y: auto; /* Enable scrolling */
            margin-bottom: 20px;
        }
        .ar-claim-item {
            background-color: #f0f4f8;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .ar-claim-details {
            font-size: 0.9rem;
            color: #4a5568;
            margin-bottom: 10px;
        }
        .ar-claim-feedback {
            margin-top: 10px;
            padding: 8px;
            border-radius: 6px;
            font-weight: 500;
        }
        .ar-claim-feedback.correct {
            background-color: #d1fae5;
            color: #065f46;
        }
        .ar-claim-feedback.incorrect {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .form-item {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        .form-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container">
        <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-8">EHR Practice System</h1>

        <!-- Message Box for user feedback -->
        <div id="messageBox" class="message-box"></div>

        <!-- Patient Registration Section -->
        <section class="mb-8 p-6 bg-blue-50 rounded-lg">
            <h2 class="section-title text-blue-800">1. Patient Registration üìù</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="patientName" class="block text-gray-700 text-sm font-bold mb-2">Patient Name:</label>
                    <input type="text" id="patientName" name="patientName" placeholder="John Doe" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="patientDOB" class="block text-gray-700 text-sm font-bold mb-2">Date of Birth:</label>
                    <input type="date" id="patientDOB" name="patientDOB" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label for="insuranceID" class="block text-gray-700 text-sm font-bold mb-2">Insurance ID:</label>
                    <input type="text" id="insuranceID" name="insuranceID" placeholder="ABC123456789" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <button id="registerPatientBtn" class="btn-primary w-full">Register Patient</button>
        </section>

        <!-- Encounter Documentation Section -->
        <section class="mb-8 p-6 bg-green-50 rounded-lg">
            <h2 class="section-title text-green-800">2. Encounter Documentation ü©∫</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="encounterDate" class="block text-gray-700 text-sm font-bold mb-2">Encounter Date:</label>
                    <input type="date" id="encounterDate" name="encounterDate" class="focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="md:col-span-2">
                    <label for="chiefComplaint" class="block text-gray-700 text-sm font-bold mb-2">Chief Complaint:</label>
                    <input type="text" id="chiefComplaint" name="chiefComplaint" placeholder="Patient reports sore throat and fever" class="focus:ring-green-500 focus:border-green-500">
                </div>
            </div>

            <div id="diagnosisList" class="mb-4 space-y-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Diagnoses (ICD Codes):</label>
                <div class="flex items-center gap-2">
                    <input type="text" class="diagnosis-code flex-grow-1 focus:ring-green-500 focus:border-green-500" name="diagnosisCode" placeholder="e.g., J02.9 (Acute pharyngitis)">
                    <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                </div>
            </div>
            <button id="addDiagnosisBtn" class="btn-primary mb-6 w-full bg-green-600 hover:bg-green-700">Add Another Diagnosis</button>

            <div id="procedureList" class="mb-4 space-y-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Procedures (CPT/HCPCS Codes):</label>
                <div class="flex items-center gap-2">
                    <input type="text" class="procedure-code flex-grow-1 focus:ring-green-500 focus:border-green-500" name="procedureCode" placeholder="e.g., 99213 (Office visit)">
                    <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                </div>
            </div>
            <button id="addProcedureBtn" class="btn-primary w-full bg-green-600 hover:bg-green-700">Add Another Procedure</button>
        </section>

        <!-- Charge Entry Section -->
        <section class="mb-8 p-6 bg-purple-50 rounded-lg">
            <h2 class="section-title text-purple-800">3. Charge Entry & Services üí≤</h2>
            <div id="chargeList" class="mb-4 space-y-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Services Rendered:</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 service-item">
                    <input type="text" class="service-description col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500" name="serviceDescription" placeholder="Service Description">
                    <input type="text" class="service-cpt-code col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500" name="serviceCptCode" placeholder="CPT Code">
                    <div class="flex gap-2 col-span-1 md:col-span-1">
                        <input type="number" class="service-price flex-grow-1 focus:ring-purple-500 focus:border-purple-500" name="servicePrice" placeholder="Price ($)" min="0" step="0.01">
                        <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                    </div>
                </div>
            </div>
            <button id="addChargeBtn" class="btn-primary w-full bg-purple-600 hover:bg-purple-700">Add Another Service</button>
        </section>

        <!-- Generate Claim Section -->
        <section class="p-6 bg-red-50 rounded-lg mb-8">
            <h2 class="section-title text-red-800">4. Generate & View Claim üìÑ</h2>
            <button id="generateClaimBtn" class="btn-primary w-full mb-6 bg-red-600 hover:bg-red-700">Generate Simulated Claim</button>

            <div id="claimOutput" class="bg-gray-50 p-4 border border-gray-200 rounded-lg min-h-[150px] overflow-auto text-sm text-gray-800 whitespace-pre-wrap">
                <!-- Claim data will appear here -->
                <p class="text-gray-500">Your simulated claim details will appear here after generation.</p>
            </div>
            <button id="clearAllBtn" class="btn-secondary w-full mt-4">Clear All Data</button>
        </section>

        <!-- Medical Billing Walkthrough Section -->
        <section class="p-6 bg-indigo-50 rounded-lg mb-8">
            <h2 class="section-title text-indigo-800">5. Medical Billing Process Walkthrough üö∂‚Äç‚ôÄÔ∏è</h2>
            <p class="text-gray-700 mb-4">Click "Start Step" or "Next Step" to walk through the revenue cycle.</p>

            <div id="billingWalkthroughContent" class="hidden">
                <h3 id="walkthroughStepTitle" class="walkthrough-step-title text-indigo-700"></h3>
                <div id="walkthroughStepInstructions" class="walkthrough-instructions"></div>
            </div>
           
            <button id="startBillingWalkthroughBtn" class="btn-primary w-full mb-4 bg-indigo-600 hover:bg-indigo-700">Start Billing Walkthrough</button>
            <button id="nextBillingWalkthroughBtn" class="btn-primary w-full mb-4 bg-indigo-600 hover:bg-indigo-700 hidden">Next Step</button>
            <button id="resetBillingWalkthroughBtn" class="btn-secondary w-full hidden">Reset Walkthrough</button>
        </section>

        <!-- Prior Authorization Walkthrough Section -->
        <section class="p-6 bg-orange-50 rounded-lg mb-8">
            <h2 class="section-title text-orange-800">6. Prior Authorization (PA) Walkthrough üö¶</h2>
            <p class="text-gray-700 mb-4">Follow the steps to understand a PA scenario.</p>

            <div id="paWalkthroughContent" class="hidden">
                <h3 id="paWalkthroughStepTitle" class="walkthrough-step-title text-orange-700"></h3>
                <div id="paWalkthroughStepInstructions" class="walkthrough-instructions"></div>
            </div>
           
            <button id="startPaWalkthroughBtn" class="btn-primary w-full mb-4 bg-orange-600 hover:bg-orange-700">Start PA Walkthrough</button>
            <button id="nextPaWalkthroughBtn" class="btn-primary w-full mb-4 bg-orange-600 hover:bg-orange-700 hidden">Next Step</button>
            <button id="resetPaWalkthroughBtn" class="btn-secondary w-full hidden">Reset PA Walkthrough</button>
        </section>

        <!-- Knowledge Quizzes Section -->
        <section class="p-6 bg-pink-50 rounded-lg mb-8">
            <h2 class="section-title text-pink-800">7. Knowledge Quizzes! üìö</h2>
            <p class="text-gray-700 mb-4">Test your understanding of coding guidelines, healthcare laws, ethics, and denials & appeals!</p>

            <div class="flex flex-wrap gap-3 mb-6">
                <button id="quizGuidelinesBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Coding Guidelines</button>
                <button id="quizLawsBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Healthcare Laws</button>
                <button id="quizEthicsBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Coding Ethics</button>
                <button id="quizDenialsBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Denials & Appeals</button>
                <button id="quizInsuranceNuanceBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Insurance Nuances</button>
            </div>

            <div id="quizContent" class="quiz-content hidden">
                <h3 id="quizQuestionTitle" class="quiz-question-title text-pink-700"></h3>
                <div id="quizOptions" class="mb-4">
                    <!-- Options will be dynamically inserted here -->
                </div>
                
                <button id="submitAnswerBtn" class="btn-primary bg-pink-600 hover:bg-pink-700 mb-4">Submit Answer</button>
                <button id="nextQuestionBtn" class="btn-secondary hidden">Next Question</button>
                <button id="resetQuizBtn" class="btn-secondary hidden">Reset Quiz</button>

                <div id="quizFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 quiz-feedback-text">Your feedback will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Patient Balance Calculator Section -->
        <section class="p-6 bg-teal-50 rounded-lg mb-8">
            <h2 class="section-title text-teal-800">8. Patient Balance Calculator üí∞</h2>
            <p class="text-gray-700 mb-4">Practice calculating patient responsibility based on common scenarios.</p>

            <button id="loadBalanceScenarioBtn" class="btn-primary w-full mb-6 bg-teal-600 hover:bg-teal-700">Load New Scenario</button>

            <div id="balanceCalculatorContent" class="balance-calculator-content hidden">
                <h3 id="balanceScenarioTitle" class="balance-scenario-title text-teal-700"></h3>
                <div id="balanceScenarioDetails" class="balance-scenario-text mb-4"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="userCopay" class="block text-gray-700 text-sm font-bold mb-2">Your Calculated Copay ($):</label>
                        <input type="number" id="userCopay" name="userCopay" placeholder="0.00" min="0" step="0.01" class="focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="userDeductibleInput" class="block text-gray-700 text-sm font-bold mb-2">Your Calculated Deductible Applied ($):</label>
                        <input type="number" id="userDeductibleInput" name="userDeductibleInput" placeholder="0.00" min="0" step="0.01" class="focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="userCoinsurance" class="block text-gray-700 text-sm font-bold mb-2">Your Calculated Coinsurance ($):</label>
                        <input type="number" id="userCoinsurance" name="userCoinsurance" placeholder="0.00" min="0" step="0.01" class="focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="userTotalBalance" class="block text-gray-700 text-sm font-bold mb-2">Your Calculated Total Patient Balance ($):</label>
                        <input type="number" id="userTotalBalance" name="userTotalBalance" placeholder="0.00" min="0" step="0.01" class="font-bold focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                
                <button id="checkBalanceBtn" class="btn-primary bg-teal-600 hover:bg-teal-700 mb-4">Check My Calculation</button>
                <button id="resetBalanceBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="balanceFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 balance-feedback-text">Feedback on your calculation will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Advanced Modifier Application Challenge Section -->
        <section class="p-6 bg-yellow-50 rounded-lg mb-8">
            <h2 class="section-title text-yellow-800">9. Advanced Modifier Application Challenge üåü</h2>
            <p class="text-gray-700 mb-4">Analyze the scenario and apply the appropriate CPT code and modifier.</p>

            <button id="loadModifierScenarioBtn" class="btn-primary w-full mb-6 bg-yellow-600 hover:bg-yellow-700">Load New Scenario</button>

            <div id="modifierChallengeContent" class="modifier-challenge-content hidden">
                <h3 id="modifierScenarioTitle" class="modifier-challenge-title text-yellow-700"></h3>
                <div id="modifierScenarioDetails" class="modifier-scenario-text mb-4"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="userModifierCPT" class="block text-gray-700 text-sm font-bold mb-2">Your CPT Code:</label>
                        <input type="text" id="userModifierCPT" name="userModifierCPT" placeholder="e.g., 99213" class="focus:ring-yellow-500 focus:border-yellow-500 uppercase">
                    </div>
                    <div>
                        <label for="userModifier" class="block text-gray-700 text-sm font-bold mb-2">Your Modifier(s) (e.g., 25, 59):</label>
                        <input type="text" id="userModifier" name="userModifier" placeholder="e.g., 25" class="focus:ring-yellow-500 focus:border-yellow-500 uppercase">
                    </div>
                </div>
                
                <button id="checkModifierBtn" class="btn-primary bg-yellow-600 hover:bg-yellow-700 mb-4">Check My Modifier</button>
                <button id="resetModifierBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="modifierFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 modifier-feedback-text">Feedback on your modifier application will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Medical Terminology Matching Game -->
        <section class="p-6 bg-blue-50 rounded-lg mb-8">
            <h2 class="section-title text-blue-800">10. Medical Terminology Matching Game üß†</h2>
            <p class="text-gray-700 mb-4">Match the medical billing terms/acronyms with their correct definitions.</p>

            <button id="startGameBtn" class="btn-primary w-full mb-6 bg-blue-600 hover:bg-blue-700">Start New Game</button>

            <div id="matchingGameContent" class="matching-game-content hidden">
                <p id="gameMessage" class="text-center text-lg font-bold mb-4"></p>
                <div id="cardGrid" class="match-card-grid">
                    <!-- Cards will be dynamically inserted here -->
                </div>
                <button id="resetGameBtn" class="btn-secondary w-full mt-6 hidden">Reset Game</button>
            </div>
        </section>

        <!-- Claim Scrubber / Error Finder Challenge Section -->
        <section class="p-6 bg-orange-100 rounded-lg mb-8">
            <h2 class="section-title text-orange-800">11. Claim Scrubber / Error Finder Challenge üîç</h2>
            <p class="text-gray-700 mb-4">Review the presented claim scenario and identify/correct the errors.</p>

            <button id="loadScrubberScenarioBtn" class="btn-primary w-full mb-6 bg-orange-600 hover:bg-orange-700">Load New Scenario</button>

            <div id="scrubberChallengeContent" class="scrubber-challenge-content hidden">
                <h3 id="scrubberScenarioTitle" class="scrubber-challenge-title text-orange-700"></h3>
                <div id="scrubberScenarioDetails" class="scrubber-scenario-text mb-4"></div>
                
                <p class="font-bold text-gray-700 mb-2">Presented Claim Details:</p>
                <pre id="presentedClaimOutput" class="bg-gray-50 p-3 rounded-lg border border-gray-200 text-sm whitespace-pre-wrap mb-4"></pre>

                <p class="font-bold text-gray-700 mb-2">Your Corrected Codes/Modifiers:</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="userScrubberICD" class="block text-gray-700 text-sm font-bold mb-2">Corrected ICD-10:</label>
                        <input type="text" id="userScrubberICD" name="userScrubberICD" placeholder="e.g., I10" class="focus:ring-orange-500 focus:border-orange-500 uppercase">
                    </div>
                    <div>
                        <label for="userScrubberCPT" class="block text-gray-700 text-sm font-bold mb-2">Corrected CPT:</label>
                        <input type="text" id="userScrubberCPT" name="userScrubberCPT" placeholder="e.g., 99213" class="focus:ring-orange-500 focus:border-orange-500 uppercase">
                    </div>
                    <div>
                        <label for="userScrubberModifier" class="block text-gray-700 text-sm font-bold mb-2">Corrected Modifier(s):</label>
                        <input type="text" id="userScrubberModifier" name="userScrubberModifier" placeholder="e.g., 25, 59 (or 'None')" class="focus:ring-orange-500 focus:border-orange-500 uppercase">
                    </div>
                </div>
                
                <button id="checkScrubberBtn" class="btn-primary bg-orange-600 hover:bg-orange-700 mb-4">Check My Corrections</button>
                <button id="resetScrubberBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="scrubberFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 scrubber-feedback-text">Feedback on your corrections will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Denial Code Interpreter & Action Plan Simulator Section -->
        <section class="p-6 bg-purple-100 rounded-lg mb-8">
            <h2 class="section-title text-purple-800">12. Denial Code Interpreter & Action Plan Simulator üö´</h2>
            <p class="text-gray-700 mb-4">Interpret the denial code and plan your next steps to resolve the claim.</p>

            <button id="loadDenialScenarioBtn" class="btn-primary w-full mb-6 bg-purple-600 hover:bg-purple-700">Load New Denial Scenario</button>

            <div id="denialChallengeContent" class="denial-challenge-content hidden">
                <h3 id="denialScenarioTitle" class="denial-challenge-title text-purple-700"></h3>
                <div id="denialScenarioDetails" class="denial-scenario-text mb-4"></div>
                
                <p class="font-bold text-gray-700 mb-2">Interpret the Denial Code:</p>
                <div id="denialInterpretationOptions" class="mb-4">
                    <!-- Options for interpretation will be dynamically inserted here -->
                </div>

                <p class="font-bold text-gray-700 mb-2">Your Action Plan (be specific):</p>
                <textarea id="userActionPlan" name="userActionPlan" rows="4" placeholder="e.g., Research payer policy, appeal with medical records, bill patient..." class="focus:ring-purple-500 focus:border-purple-500 mb-4"></textarea>
                
                <button id="checkDenialBtn" class="btn-primary bg-purple-600 hover:bg-purple-700 mb-4">Check My Plan</button>
                <button id="resetDenialBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="denialFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 denial-feedback-text">Feedback on your denial resolution plan will appear here.</p>
                </div>
            </div>
        </section>

        <!-- SOAP Note Coder & Extractor Challenge Section -->
        <section class="p-6 bg-teal-100 rounded-lg mb-8">
            <h2 class="section-title text-teal-800">13. SOAP Note Coder & Extractor Challenge üìã</h2>
            <p class="text-gray-700 mb-4">Review the SOAP note below and extract the relevant coding and plan information.</p>

            <button id="loadSoapScenarioBtn" class="btn-primary w-full mb-6 bg-teal-600 hover:bg-teal-700">Load New SOAP Note Scenario</button>

            <div id="soapChallengeContent" class="soap-challenge-content hidden">
                <h3 id="soapScenarioTitle" class="soap-challenge-title text-teal-700"></h3>
                <p id="soapScenarioDescription" class="soap-scenario-text mb-4"></p>
                
                <div id="soapNoteDisplay" class="mb-4">
                    <!-- SOAP note content will be loaded here -->
                </div>

                <p class="font-bold text-gray-700 mb-2">Your Extracted Information:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="md:col-span-2">
                        <label for="userSoapChiefComplaint" class="block text-gray-700 text-sm font-bold mb-2">Chief Complaint:</label>
                        <input type="text" id="userSoapChiefComplaint" name="userSoapChiefComplaint" placeholder="Patient's main reason for visit" class="focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="userSoapICD" class="block text-gray-700 text-sm font-bold mb-2">Primary ICD-10 Code(s):</label>
                        <input type="text" id="userSoapICD" name="userSoapICD" placeholder="e.g., J02.0 (comma-separated if multiple)" class="focus:ring-teal-500 focus:border-teal-500 uppercase">
                    </div>
                    <div>
                        <label for="userSoapCPT" class="block text-gray-700 text-sm font-bold mb-2">Primary CPT Code(s):</label>
                        <input type="text" id="userSoapCPT" name="userSoapCPT" placeholder="e.g., 99213, 87880 (comma-separated if multiple)" class="focus:ring-teal-500 focus:border-teal-500 uppercase">
                    </div>
                    <div class="md:col-span-2">
                        <label for="userSoapModifier" class="block text-gray-700 text-sm font-bold mb-2">Modifier(s) (if any):</label>
                        <input type="text" id="userSoapModifier" name="userSoapModifier" placeholder="e.g., 25 (or 'None')" class="focus:ring-teal-500 focus:border-teal-500 uppercase">
                    </div>
                    <div class="md:col-span-2">
                        <label for="userSoapPlan" class="block text-gray-700 text-sm font-bold mb-2">Key Elements of the Plan:</label>
                        <textarea id="userSoapPlan" name="userSoapPlan" rows="4" placeholder="Summarize medication, follow-up, education etc." class="focus:ring-teal-500 focus:border-teal-500"></textarea>
                    </div>
                </div>
                
                <button id="checkSoapBtn" class="btn-primary bg-teal-600 hover:bg-teal-700 mb-4">Check My Extraction</button>
                <button id="resetSoapBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="soapFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 soap-feedback-text">Feedback on your extraction will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Code Lookup Tool Section -->
        <section class="p-6 bg-yellow-100 rounded-lg mb-8">
            <h2 class="section-title text-yellow-800">14. Code Lookup Tool üìö</h2>
            <p class="text-gray-700 mb-4">Search for common ICD-10 or CPT codes to see their descriptions.</p>

            <div id="codeLookupContent" class="code-lookup-content">
                <div class="mb-4">
                    <label for="codeLookupInput" class="block text-gray-700 text-sm font-bold mb-2">Enter Code (e.g., J02.0, 99213):</label>
                    <input type="text" id="codeLookupInput" name="codeLookupInput" placeholder="Enter ICD-10 or CPT code" class="focus:ring-yellow-500 focus:border-yellow-500 uppercase">
                </div>
                <button id="lookupCodeBtn" class="btn-primary w-full mb-4 bg-yellow-600 hover:bg-yellow-700">Lookup Code</button>
                <div id="codeLookupResult" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500">Code description will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Accounts Receivable (A/R) Aging Simulation Section -->
        <section class="p-6 bg-red-100 rounded-lg mb-8">
            <h2 class="section-title text-red-800">15. Accounts Receivable (A/R) Aging Simulation üìà</h2>
            <p class="text-gray-700 mb-4">Practice analyzing aging claims and determining the correct follow-up action. Select an action for each claim.</p>

            <button id="loadArScenarioBtn" class="btn-primary w-full mb-6 bg-red-600 hover:bg-red-700">Load New A/R Scenario</button>

            <div id="arAgingContent" class="ar-aging-content hidden">
                <div id="arClaimList">
                    <!-- A/R claims will be dynamically inserted here -->
                </div>
                <button id="checkArActionsBtn" class="btn-primary w-full mt-4 bg-red-600 hover:bg-red-700">Check My Actions</button>
                <button id="resetArScenarioBtn" class="btn-secondary w-full mt-2 hidden">Reset A/R Scenario</button>
                <div id="arFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500">Feedback on your A/R actions will appear here.</p>
                </div>
            </div>
        </section>

        <!-- NEW: Medical Billing Form Repository Section -->
        <section class="p-6 bg-blue-100 rounded-lg mb-8">
            <h2 class="section-title text-blue-800">16. Medical Billing Form Repository üìÇ</h2>
            <p class="text-gray-700 mb-4">Explore descriptions of common forms used in medical billing and where to find their blank templates online for practice.</p>

            <div id="formRepositoryContent" class="form-repository-content">
                <div class="form-item">
                    <h3 class="form-repository-title text-blue-700">CMS-1500 Claim Form</h3>
                    <p class="form-repository-text">This is the universal claim form for professional (physician and non-institutional) services. It captures patient demographics, insurance information, diagnoses (ICD-10), procedures (CPT/HCPCS), and charges. It's the most common form you'll encounter for outpatient billing.</p>
                    <p class="form-repository-text mt-1 text-xs italic">You can find blank CMS-1500 templates by searching online for "CMS-1500 form fillable PDF" or "NUCC CMS-1500 form".</p>
                </div>
                <div class="form-item">
                    <h3 class="form-repository-title text-blue-700">UB-04 Claim Form (CMS-1450)</h3>
                    <p class="form-repository-text">This is the claim form used by institutional providers (like hospitals, skilled nursing facilities, ambulatory surgical centers) for inpatient and outpatient services. It captures facility charges, revenue codes, and patient stay details.</p>
                    <p class="form-repository-text mt-1 text-xs italic">You can find blank UB-04 templates by searching online for "UB-04 form fillable PDF" or "NUBC UB-04 form".</p>
                </div>
                <div class="form-item">
                    <h3 class="form-repository-title text-blue-700">Advance Beneficiary Notice of Noncoverage (ABN)</h3>
                    <p class="form-repository-text">A form given to Medicare beneficiaries when a service may not be covered by Medicare. It informs the patient they may be responsible for payment if Medicare denies the service, requiring their signature before service delivery. This protects the provider's right to bill the patient.</p>
                    <p class="form-repository-text mt-1 text-xs italic">You can find blank ABN forms (CMS-R-131) on the CMS website or by searching for "CMS ABN form".</p>
                </div>
                 <div class="form-item">
                    <h3 class="form-repository-title text-blue-700">Explanation of Benefits (EOB) / Electronic Remittance Advice (ERA)</h3>
                    <p class="form-repository-text">These are not "forms" you fill out, but rather documents generated by insurance companies. The EOB is sent to the patient and provider, detailing how a claim was processed (what was paid, denied, applied to deductible, etc.). The ERA is the electronic version sent to the provider, allowing for automated payment posting.</p>
                    <p class="form-repository-text mt-1 text-xs italic">Practice interpreting EOBs/ERAs by requesting sample EOBs from your insurance provider (if they offer them) or by searching online for "sample EOB Medicare" or "sample ERA medical billing".</p>
                </div>
            </div>
        </section>

    </div>

    <footer class="text-center text-gray-600 text-sm mt-10 pb-5">
        &copy; 2025 Chandra M Harris
    </footer>

    <script type="module">
        // Import the functions you need from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, addDoc, getDocs, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration (provided by Canvas environment)
        // Make sure to parse it as it comes in as a string
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null; // Changed to null if undefined
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Fallback for local testing if not in Canvas

        // Initialize Firebase ONLY if config is available
        let app;
        let db;
        let auth;
        let userId = null;

        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Listen for auth state changes and sign in
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in.
                    userId = user.uid;
                    console.log("User signed in:", userId);
                } else {
                    // User is signed out or not authenticated yet.
                    // Attempt to sign in with custom token if available, otherwise anonymously.
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            const userCredential = await signInWithCustomToken(auth, __initial_auth_token);
                            userId = userCredential.user.uid;
                            console.log("Signed in with custom token:", userId);
                        } catch (error) {
                            console.error("Error signing in with custom token:", error);
                            // Fallback to anonymous if custom token fails
                            try {
                                const userCredential = await signInAnonymously(auth);
                                userId = userCredential.user.uid;
                                console.log("Signed in anonymously (fallback):", userId);
                            } catch (anonError) {
                                console.error("Error signing in anonymously:", anonError);
                                // If all auth fails, generate a random ID
                                userId = crypto.randomUUID();
                                console.warn("Could not authenticate, using random ID:", userId);
                            }
                        }
                    } else {
                        // If no initial token, sign in anonymously
                        try {
                            const userCredential = await signInAnonymously(auth);
                            userId = userCredential.user.uid;
                            console.log("Signed in anonymously:", userId);
                        } catch (error) {
                            console.error("Error signing in anonymously:", error);
                            // If anonymous auth fails, generate a random ID
                            userId = crypto.randomUUID();
                            console.warn("Could not authenticate, using random ID:", userId);
                        }
                    }
                }
                // Now that auth is ready, you can start interacting with Firestore
                console.log("Firebase Auth and Firestore services initialized. User ID:", userId);
            });
        } else {
            console.warn("Firebase configuration not found. Firebase services will not be initialized.");
            // If Firebase config is not available, provide a fallback userId
            userId = crypto.randomUUID();
            console.warn("Using a random ID as Firebase config is missing:", userId);
        }

        // --- GLOBAL DATA STORAGE (MOVE THESE TO THE TOP FOR IMMEDIATE AVAILABILITY) ---
        // These global variables store data for various simulator sections.
        // They need to be defined before any functions or event listeners
        // that might try to access them upon script execution.

        // Global Data Storage (for existing simulation)
        let patientData = {};
        let diagnoses = [];
        let procedures = [];
        let charges = [];

        // Global Data Storage (Medical Billing Walkthrough)
        let currentBillingStep = 0;
        const billingSteps = [
            {
                title: "Step 1: Patient Registration & Insurance Verification",
                instructions: `**Action:** Begin by gathering the patient's full demographics and insurance details. **On the simulator:** Fill in the 'Patient Registration' section (Name, DOB, Insurance ID) and click 'Register Patient'. In a real scenario, you'd also call the payer to verify eligibility and benefits.`,
            },
            {
                title: "Step 2: Patient Encounter Documentation",
                instructions: `**Action:** This is where the provider records the visit details. **On the simulator:** Fill in the 'Encounter Documentation' section (Encounter Date, Chief Complaint, and add at least one Diagnosis and one Procedure). This mirrors the clinical notes that inform coding.`,
            },
            {
                title: "Step 3: Medical Coding",
                instructions: `**Action:** Translate the documentation into standardized ICD-10 and CPT codes. **On the simulator:** Ensure your Diagnosis and Procedure inputs in Section 2 are correctly formatted codes. This is a critical skill for accurate billing.`,
            },
            {
                title: "Step 4: Charge Entry & Superbill Creation",
                instructions: `**Action:** Enter the charges for the services provided. **On the simulator:** Go to 'Charge Entry & Services', add descriptions, CPT codes (ensure they match your procedures from step 2), and prices for the services. This creates the financial record.`,
            },
            {
                title: "Step 5: Claim Generation & Submission",
                instructions: `**Action:** Compile all data into a standardized claim (CMS-1500 for professional, UB-04 for institutional) and send it to the payer. **On the simulator:** Click 'Generate Simulated Claim' in Section 4. This is the official request for payment.`,
            },
            {
                title: "Step 6: Claim Adjudication",
                instructions: `**Understanding:** The insurance company reviews the claim. They'll either pay, deny, or reject it, sending an EOB (for patient) or ERA (for provider). **Think:** What common reasons lead to denials at this stage? (e.g., medical necessity, timely filing)`,
            },
            {
                title: "Step 7: Payment Posting",
                instructions: `**Action:** Once paid, the payment is recorded in the billing system. **Understanding:** This updates the patient's balance and the provider's accounts. Accurate posting prevents overbilling or outstanding balances.`,
            },
            {
                title: "Step 8: Patient Billing & Collections",
                instructions: `**Action:** If a balance remains after insurance pays, the patient is billed. **Understanding:** This involves sending statements and following up on overdue payments. Clear communication with patients is key.`,
            },
            {
                title: "Step 9: Reporting & Analysis",
                instructions: `**Understanding:** Continuously analyze billing data to identify trends, improve efficiency, and reduce denials. This step helps optimize the entire revenue cycle. **You've completed the walkthrough!**`,
            },
        ];

        // Global Data Storage (Prior Authorization Walkthrough)
        let currentPaStep = 0;
        const paSteps = [
            {
                title: "PA Step 1: Identify Need for Prior Authorization",
                instructions: `**Scenario:** A patient needs an MRI of the knee.
                **Action:** The first step is to check the patient's insurance plan and the specific CPT code (e.g., CPT 73721 for MRI knee without contrast) against the payer's policy to determine if a Prior Authorization (PA) is required. Many high-cost imaging services or specialty medications require PA.`,
            },
            {
                title: "PA Step 2: Gather Necessary Information",
                instructions: `**Action:** If PA is required, you must collect all relevant clinical and administrative information.
                **Required Info:** Patient demographics, insurance details, referring and rendering provider NPIs, **exact CPT code(s) with modifiers**, **supporting ICD-10 diagnosis code(s) demonstrating medical necessity**, date of service, and any clinical notes (e.g., physician's order, previous treatments tried and failed).`,
            },
            {
                title: "PA Step 3: Submit the Request",
                instructions: `**Action:** Submit the PA request to the insurance company. This is usually done online via a payer portal, fax, or phone.
                **Key Point:** Ensure all fields are accurately completed and all required supporting documentation is attached. Incomplete requests are a common cause of delays or denials.`,
            },
            {
                title: "PA Step 4: Follow-up and Await Decision",
                instructions: `**Action:** After submission, monitor the status of the request. Payers have specific turnaround times (e.g., 7-14 business days for routine, 24-72 hours for urgent).
                **Outcome:** The PA will either be **Approved**, **Denied**, or sent back for **More Information**.`,
            },
            {
                title: "PA Step 5: Handle Approved Authorization",
                instructions: `**Action:** If approved, carefully note the **authorization number**, the **approved CPT codes**, the **number of units/visits approved**, and the **valid date range**.
                **Next:** Ensure this authorization number is included on the claim when submitted to prevent denials. Inform the patient and scheduling department.`,
            },
            {
                title: "PA Step 6: Handle Denied Authorization",
                instructions: `**Action:** If denied, review the denial reason code carefully (often found on an EOB/ERA from the PA department). Common reasons include 'not medically necessary' or 'incorrect information'.
                **Next:** If denied for medical necessity, discuss with the provider if an appeal (with additional clinical documentation or a peer-to-peer review) is warranted. If denied for administrative reasons, correct and resubmit. **You've completed the PA walkthrough!**`,
            },
        ];

        // Global Data Storage (Knowledge Quizzes)
        let selectedQuizModule = null; // Stores the array of questions for the current module
        let currentQuizQuestionIndex = 0; // Tracks the current question in the module

        const quizModules = {
            "Coding Guidelines": [
                {
                    question: "What does a CPT code modifier indicate?",
                    options: ["A. A new diagnosis", "B. The code has been altered in some way", "C. The patient has insurance", "D. The service was performed in a hospital"],
                    answer: "B",
                    explanation: "A CPT modifier is a two-digit code appended to a CPT code to provide additional information about the procedure or service, such as that it was altered or performed by more than one physician."
                },
                {
                    question: "Which coding system is used for diagnosis codes?",
                    options: ["A. CPT", "B. HCPCS Level II", "C. ICD-10-CM", "D. E&M"],
                    answer: "C",
                    explanation: "ICD-10-CM (International Classification of Diseases, 10th Revision, Clinical Modification) is the standard system for diagnosis codes in the U.S."
                },
                // Add more Coding Guidelines questions here
            ],
            "Healthcare Laws": [
                {
                    question: "What is the primary purpose of HIPAA for medical coders?",
                    options: ["A. To ensure patients get timely appointments", "B. To protect the privacy and security of patient health information (PHI)", "C. To set reimbursement rates for services", "D. To standardize coding manuals"],
                    answer: "B",
                    explanation: "HIPAA's Privacy Rule and Security Rule mandate that Protected Health Information (PHI) is kept confidential and secure."
                },
                {
                    question: "Submitting a claim with codes that you know are wrong to get a higher payment is a violation of which law?",
                    options: ["A. Stark Law", "B. Anti-Kickback Statute", "C. False Claims Act (FCA)", "D. OIG Exclusions"],
                    answer: "C",
                    explanation: "The False Claims Act (FCA) imposes liability on persons and companies who knowingly submit false claims to the government."
                },
                // Add more Healthcare Laws questions here
            ],
            "Coding Ethics": [
                {
                    question: "Your boss tells you to change a code to one that provides higher reimbursement, even though the documentation doesn't support it. What is the most ethical action?",
                    options: ["A. Do what your boss says to avoid conflict", "B. Report the incident to a compliance officer", "C. Change the code but make a note in your personal records", "D. Tell the patient to file a complaint"],
                    answer: "B",
                    explanation: "The most ethical and legally compliant action is to report fraudulent activities, such as upcoding, to a designated compliance officer or legal department. This protects you and the organization."
                },
                // Add more Coding Ethics questions here
            ],
            "Denials & Appeals": [
                {
                    question: "A claim is denied because the diagnosis code does not justify the procedure code. What is this denial reason called?",
                    options: ["A. Medical necessity denial", "B. Bundling issue", "C. Payer policy change", "D. Inconsistent patient information"],
                    answer: "A",
                    explanation: "A denial for 'lack of medical necessity' means the payer believes the procedure performed was not necessary to treat the patient's documented diagnosis. The diagnosis code must support the procedure code."
                },
                {
                    question: "What is the first step in appealing a denied claim?",
                    options: ["A. Resubmit the claim with a new code", "B. Send a letter of protest to the payer's legal department", "C. Review the patient's chart and the denial reason", "D. Bill the patient directly for the full amount"],
                    answer: "C",
                    explanation: "The crucial first step in any appeal is to thoroughly review the patient‚Äôs documentation and compare it against the denial reason provided by the payer. This helps you identify if the issue is a simple coding error or a more complex medical necessity dispute."
                },
                // Add more Denials & Appeals questions here
            ],
            // Insurance Nuances Quiz Module
            "Insurance Nuances": [
                {
                    question: "Which type of insurance plan typically requires a referral from a Primary Care Provider (PCP) to see a specialist?",
                    options: ["A. PPO", "B. HMO", "C. Medicare Part B", "D. Fee-for-Service"],
                    answer: "B",
                    explanation: "HMO (Health Maintenance Organization) plans generally require a referral from a PCP to see a specialist, as they focus on managed care within a network."
                },
                {
                    question: "When a patient has both active Medicare and Medicaid, which payer is usually considered primary?",
                    options: ["A. Medicaid", "B. Medicare", "C. The patient's choice", "D. Whichever plan has been active longer"],
                    answer: "B",
                    explanation: "Medicare is almost always the primary payer when a patient has both Medicare and Medicaid. Medicaid then acts as the payer of last resort, covering what Medicare doesn't."
                },
                {
                    question: "Medicare Part B typically covers what percentage of approved physician services after the deductible is met?",
                    options: ["A. 100%", "B. 50%", "C. 80%", "D. 20%"],
                    answer: "C",
                    explanation: "Medicare Part B covers 80% of approved physician services after the annual deductible is met, with the patient responsible for the remaining 20% (coinsurance)."
                }
            ]
        };

        // Global Data Storage (Patient Balance Calculator)
        let currentBalanceScenarioData = null;
        const patientBalanceScenarios = [
            {
                patient: "Alex Green",
                plan: {
                    copay: 0,
                    deductible: 1000,
                    deductibleMetToDate: 700,
                    coinsurance: 0.15, // 15%
                },
                visit: {
                    service: "Office visit with minor procedure",
                    allowedAmount: 300,
                },
                correct: {
                    copay: 0,
                    deductibleApplied: 300,
                    coinsurance: 0, // No coinsurance applied as allowed amount only covers deductible
                    totalBalance: 300,
                },
                calculationSteps: `
1. Remaining Deductible: $1,000 (total) - $700 (met) = $300.
2. Apply Allowed Amount to Deductible: The full $300 allowed amount for this visit goes towards meeting the remaining $300 deductible.
3. Deductible is now fully met. No amount remains for coinsurance from this visit.
4. Total Patient Balance: $300 (deductible portion met by this visit).
                `.trim(),
            },
            {
                patient: "Brenda White",
                plan: {
                    copay: 35,
                    deductible: 500,
                    deductibleMetToDate: 0,
                    coinsurance: 0.20, // 20%
                },
                visit: {
                    service: "Specialist Consultation",
                    allowedAmount: 250,
                },
                correct: {
                    copay: 35,
                    deductibleApplied: 250,
                    coinsurance: 0, // Deductible not fully met, so no coinsurance yet
                    totalBalance: 285, // Copay + Deductible Applied
                },
                calculationSteps: `
1. Collect Copay: $35.
2. Apply Allowed Amount ($250) to Deductible ($500). $250 is applied to deductible.
3. Remaining Deductible: $500 - $250 = $250.
4. Since deductible is not fully met, no coinsurance applies from this visit.
5. Total Patient Balance: $35 (copay) + $250 (deductible portion) = $285.
                `.trim(),
            },
            {
                patient: "Chris Johnson",
                plan: {
                    copay: 0,
                    deductible: 1500,
                    deductibleMetToDate: 1500, // Deductible already met
                    coinsurance: 0.10, // 10%
                },
                visit: {
                    service: "Follow-up Lab Tests",
                    allowedAmount: 100,
                },
                correct: {
                    copay: 0,
                    deductibleApplied: 0,
                    coinsurance: 10, // 10% of $100
                    totalBalance: 10,
                },
                calculationSteps: `
1. Copay: $0.
2. Deductible: Already met. $0 applied.
3. Coinsurance: 10% of $100 (Allowed Amount) = $10.
4. Total Patient Balance: $10 (coinsurance).
                `.trim(),
            },
            {
                patient: "Diana Smith",
                plan: {
                    copay: 20,
                    deductible: 750,
                    deductibleMetToDate: 750, // Deductible already met
                    coinsurance: 0.25, // 25%
                },
                visit: {
                    service: "Primary Care Office Visit",
                    allowedAmount: 90,
                },
                correct: {
                    copay: 20,
                    deductibleApplied: 0,
                    coinsurance: 22.50, // 25% of $90
                    totalBalance: 42.50, // Copay + Coinsurance
                },
                calculationSteps: `
1. Collect Copay: $20.
2. Deductible: Already met. $0 applied.
3. Coinsurance: 25% of $90 (Allowed Amount) = $22.50.
4. Total Patient Balance: $20 (copay) + $22.50 (coinsurance) = $42.50.
                `.trim(),
            },
        ];

        // Global Data Storage (Modifier Application Challenge)
        let currentModifierChallenge = null;
        const modifierScenarios = [
            {
                id: "Scenario 1: E/M with Minor Procedure",
                scenario: "A patient comes in for a routine follow-up for their diabetes (E/M service). During the same visit, the physician also performs a minor skin tag removal (separate procedure) that is distinct from the diabetes management.",
                cptCodeToInput: "99213", // E/M code
                correctModifier: "25",
                explanation: "Modifier -25 is used when a significant, separately identifiable evaluation and management (E/M) service is performed on the same day as another procedure or service by the same physician. The diabetes follow-up is separate from the skin tag removal."
            },
            {
                id: "Scenario 2: Professional Component of Imaging",
                scenario: "A hospital provides an X-ray service (technical component), but the radiologist (physician) from a separate group reads and interprets the X-ray (professional component). Your billing office is for the radiologist's group.",
                cptCodeToInput: "71045", // Chest X-ray, single view
                correctModifier: "26",
                explanation: "Modifier -26 indicates that only the professional component of a service was performed. The radiologist's group is billing for the interpretation, not the technical aspects (equipment, tech time) of the X-ray."
            },
            {
                id: "Scenario 3: Repeat Procedure by Same Physician",
                scenario: "A patient received an injection in their left knee earlier today. Later in the same day, due to continued severe pain, the same physician performs another, distinct injection in the *same* left knee.",
                cptCodeToInput: "20610", // Arthrocentesis, aspiration and/or injection, major joint
                correctModifier: "76",
                explanation: "Modifier -76 indicates a repeat procedure by the same physician on the same date of service. This clarifies that the second injection was not a duplicate but a medically necessary, distinct service."
            },
            {
                id: "Scenario 4: E/M during Global Post-Op Period",
                scenario: "A patient had a hernia repair (surgical procedure with a 90-day global period) 30 days ago. Today, the patient comes in for a completely unrelated visit for acute bronchitis, seen by the same surgeon who performed the hernia repair.",
                cptCodeToInput: "99213", // Established patient E/M
                correctModifier: "24",
                explanation: "Modifier -24 is used for an unrelated evaluation and management (E/M) service by the same physician during a post-operative global period. The bronchitis is entirely separate from the hernia repair."
            },
            {
                id: "Scenario 5: Telehealth Visit",
                scenario: "A patient has a scheduled follow-up for chronic hypertension with their primary care physician. Due to their busy schedule, the patient conducts the visit via a real-time, two-way audio and video telemedicine platform.",
                cptCodeToInput: "99213", // Established patient E/M
                correctModifier: "95",
                explanation: "Modifier -95 indicates that the service was provided via synchronous telemedicine, where both audio and video are used for a real-time interactive encounter. This is critical for billing telehealth services."
            }
        ];

        // Global Data Storage (Matching Game)
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let gameActive = false;

        const termPairs = [
            { term: "EOB", definition: "Explanation of Benefits" },
            { term: "HIPAA", definition: "Health Insurance Portability and Accountability Act" },
            { term: "CPT", definition: "Current Procedural Terminology" },
            { term: "ICD-10-CM", definition: "International Classification of Diseases, 10th Revision, Clinical Modification" },
            { term: "HMO", definition: "Health Maintenance Organization" },
            { term: "PPO", definition: "Preferred Provider Organization" },
            { term: "NPI", definition: "National Provider Identifier" },
            { term: "PHI", definition: "Protected Health Information" },
            { term: "ERA", definition: "Electronic Remittance Advice" },
            { term: "POS", definition: "Place of Service" },
            { term: "UB-04", definition: "Institutional Claim Form" },
            { term: "CMS-1500", definition: "Professional Claim Form" },
            { term: "PA", definition: "Prior Authorization" },
            { term: "AR", definition: "Accounts Receivable" },
            { term: "RCM", definition: "Revenue Cycle Management" }
        ];

        // Global Data Storage (Claim Scrubber)
        let currentScrubberScenarioData = null;
        const claimScrubberScenarios = [
            {
                title: "Scenario 1: Missing Modifier for Separate E/M",
                description: "A patient saw their PCP for a routine check-up and also had a mole removed during the same visit. The claim was submitted without a modifier.",
                presentedClaim: {
                    notes: "Patient had annual physical and also requested removal of a bothering mole on arm. Exam for physical normal. Mole removal performed.",
                    diagnosis: "Z00.00 (Annual Physical), D22.31 (Benign neoplasm of skin, right arm)",
                    cpt: "99395, 11400", // Preventive visit, Excision benign lesion
                    modifier: "NONE" // Incorrect - should have a modifier on 99395 or 99213 if a problem was also addressed.
                },
                errors: [
                    { type: "modifier", explanation: "When an E/M service (like an annual physical which is coded with a preventive CPT 99395) and a separate, distinct procedure (like mole removal CPT 11400) are performed on the same day by the same provider, the E/M code requires a modifier -25 if a significant, separately identifiable E/M service was performed (or, if it was a problem-focused E/M in addition to the preventive, then 9921x with -25). In this case, since an annual physical (preventive) was done, and a separate procedure, a modifier is often used on the procedure if the visit was primarily for the preventive service and the procedure was incidental or vice-versa. For simplicity in this simulator, assume the E/M would typically be 99213 and need a -25 if a problem was also addressed that day, separate from the preventive. Given the prompt's simplicity, the main issue is a missing modifier for separate services." }
                ],
                expectedInputs: {
                    correctedICD: "Z00.00, D22.31", // Both diagnoses are correct.
                    correctedCPT: "99395, 11400", // CPTs are correct for the services.
                    correctedModifier: "25" // Modifier for the E/M or procedure depending on primary service/payer. Assuming 99395, for *this* example, let's say 99213 would also be billed with 25. Let's simplify and imply a modifier is needed. Let's make it 99213-25 and 11400. The prompt states "99395, 11400".
                },
                 explanation: "The initial claim was missing a modifier to indicate that the mole removal was a separate, distinct procedure from the annual physical. Modifier -25 should be appended to the E/M code (99395 in this case, or if a separate problem was managed, a 9921x code) to signify a significant, separately identifiable service was provided on the same day as another procedure. The simulator focuses on the *concept* of the missing modifier."
            },
            {
                title: "Scenario 2: Diagnosis-Procedure Mismatch",
                description: "A claim for a chest X-ray was submitted with a diagnosis code for a common cold, but the notes indicate potential pneumonia. The payer denied for lack of medical necessity.",
                presentedClaim: {
                    notes: "Patient with cough, fever, and congestion. Suspicion of common cold. Chest X-ray performed.",
                    diagnosis: "J00 (Common Cold)",
                    cpt: "71045 (Chest X-ray, single view)",
                    modifier: "NONE"
                },
                errors: [
                    { type: "diagnosis-medical-necessity", explanation: "A common cold (J00) typically does not justify a chest X-ray. The documentation suggests pneumonia, which would medically necessitate the X-ray. The diagnosis should be changed to reflect the true medical necessity for the X-ray." }
                ],
                expectedInputs: {
                    correctedICD: "J18.9", // Pneumonia, unspecified
                    correctedCPT: "71045",
                    correctedModifier: "NONE"
                },
                explanation: "The original diagnosis (J00 Common Cold) did not provide medical necessity for the Chest X-ray (71045). A diagnosis like J18.9 (Pneumonia, unspecified organism) would justify the imaging study, making it a medically necessary service. This is a common denial reason."
            },
            {
                title: "Scenario 3: Incorrect CPT for Service Rendered",
                description: "A claim was submitted for a complex office visit (99215), but the documentation only supports a moderate complexity visit.",
                presentedClaim: {
                    notes: "Established patient. Follow-up for stable hypertension. BP good. Meds refilled. Quick review, no new complaints.",
                    diagnosis: "I10 (Essential hypertension)",
                    cpt: "99215 (Established patient office or other outpatient visit, 40-54 minutes)",
                    modifier: "NONE"
                },
                errors: [
                    { type: "cpt", explanation: "CPT code 99215 is for a high-complexity established patient visit, typically requiring extensive history, exam, and medical decision making. The documentation provided (routine follow-up for stable hypertension, quick review) only supports a lower level E/M code like 99213 (moderate complexity) or 99212 (low complexity). This is an example of upcoding." }
                ],
                expectedInputs: {
                    correctedICD: "I10",
                    correctedCPT: "99213", // Or even 99212, but 99213 is a common correction.
                    correctedModifier: "NONE"
                },
                explanation: "The CPT code 99215 was an 'upcode' as the documentation did not support the highest level of office visit. The visit description fits CPT 99213, which is for an established patient office visit requiring a moderate level of medical decision making. Always ensure the CPT code accurately reflects the complexity and time/elements documented."
            }
        ];

        // Global Data Storage (Denial Code Interpreter)
        let currentDenialScenarioData = null;
        const denialScenarios = [
            {
                denialCode: "CO-45 / M80",
                context: "A Medicare claim for a routine annual physical (CPT 99395) was submitted, but it was denied with 'Contractual Obligation - Charge exceeds fee schedule/maximum allowable or contracted maximum' and 'Not covered when performed in this setting/type of service'.",
                interpretations: [
                    { text: "The service was not medically necessary.", correct: false },
                    { text: "The provider is not in-network with Medicare.", correct: false },
                    { text: "The claim was denied because it was a preventive service, and Medicare only covers problem-focused visits.", correct: false },
                    { text: "Medicare does not pay for routine annual physicals using this CPT code (99395) under Part B; it covers Annual Wellness Visits (AWV) with different codes.", correct: true }
                ],
                correctActionPlanKeywords: ["Medicare", "Annual Wellness Visit", "AWV", "G0438", "G0439", "Rebill"],
                explanation: "Medicare Part B does not cover routine annual physicals (CPT 99395). Instead, it covers an Annual Wellness Visit (AWV), which focuses on preventive care and health planning. The correct CPT codes for an AWV are G0438 (initial) or G0439 (subsequent). If the documentation supports an AWV, the claim should be rebilled with the appropriate G-code. If it was a standard physical, it might be non-covered. The M80 remark code ('Not covered when performed in this setting/type of service') further points to this policy difference.",
            },
            {
                denialCode: "PR-1 / N1",
                context: "A claim for an office visit (CPT 99213) was denied with 'Patient Responsibility - Deductible Amount' and a remark code 'Patient eligibility for the service date is not confirmed'.",
                interpretations: [
                    { text: "The patient did not pay their copay.", correct: false },
                    { text: "The patient's deductible has not been met, but also their insurance was not active for that date of service.", correct: true },
                    { text: "The CPT code was incorrect for the services rendered.", correct: false },
                    { text: "The claim was filed outside the timely filing limit.", correct: false }
                ],
                correctActionPlanKeywords: ["Verify Eligibility", "Payer Portal", "Call Payer", "Patient Responsibility", "Bill Patient"],
                explanation: "PR-1 means the patient owes the deductible. However, the N1 remark code (Patient eligibility for service date not confirmed) is critical here. It indicates a primary issue: the patient may not have had active insurance on the date of service, or their benefits changed. The first step is to **verify the patient's eligibility and benefits** with the payer for the date of service. If confirmed ineligible, the patient is responsible for the full balance. If eligible but deductible not met, bill the patient.",
            },
            {
                denialCode: "CO-97",
                context: "A claim for a laceration repair (CPT 12001) performed in the ED was denied with 'Contractual Obligation - Payment adjusted because the benefit for this service is included in the payment/allowance for another service'.",
                interpretations: [
                    { text: "The laceration repair was not medically necessary.", correct: false },
                    { text: "The service was bundled into another payment and cannot be billed separately.", correct: true },
                    { text: "The patient's deductible was not met for this service.", correct: false },
                    { text: "The claim was missing a required modifier.", correct: false }
                ],
                correctActionPlanKeywords: ["Bundling", "Review NCCI Edits", "Payer Policy", "Appeal if appropriate"],
                explanation: "CO-97 indicates a **bundling issue**. This means the laceration repair (12001) is considered part of a larger service or procedure that was also billed (e.g., an Evaluation and Management (E/M) service for the ED visit). Medicare's National Correct Coding Initiative (NCCI) edits often bundle certain minor procedures into E/M services. Review the full claim to see if an E/M code was also billed. If it's truly a separate, distinct service, a modifier (like -59) might be needed, but for many minor procedures, bundling is expected. **Do not rebill without a modifier unless documentation clearly supports it and is compliant with payer rules.**",
            }
        ];

        // Global Data Storage (SOAP Note Coder & Extractor)
        let currentSoapScenarioData = null;
        const soapNoteScenarios = [
            {
                title: "Acute Pharyngitis (Strep Throat) Encounter",
                description: "Extract the Chief Complaint, ICD-10, CPT, Modifier, and Key Plan elements.",
                soapNote: `
S:
Chief Complaint: "Sore throat and difficulty swallowing for 3 days."
HPI: Ms. Davis reports onset of severe sore throat 3 days ago, which has progressively worsened, making it painful to swallow liquids and solids. Associated with mild fever (up to 100.5¬∞F at home), body aches, and fatigue. Denies cough, runny nose, congestion, or rash. No known sick contacts. Has been taking Tylenol for fever with minimal relief.
ROS: No recent strep exposure. Denies nausea, vomiting, abdominal pain, or dysuria.

O:
Vitals: BP: 118/78 mmHg, HR: 88 bpm, RR: 18 bpm, Temp: 100.8¬∞F, Wt: 130 lbs
Physical Exam:
General: Appears tired, mild distress due to throat pain.
HEENT: Throat: Erythematous pharynx. Tonsils 2+ enlarged, with white exudates bilaterally. No peritonsillar swelling. Neck: Anterior cervical lymphadenopathy, tender to palpation.
Lungs: Clear to auscultation bilaterally.
Rapid Strep Test: Positive

A:
1. Acute streptococcal pharyngitis (J02.0): Confirmed by positive rapid strep test and classic Centor criteria symptoms.

P:
1. Acute streptococcal pharyngitis:
   - Medication: Prescribed Amoxicillin 500mg, 2 tabs po BID x 10 days. Advised to complete full course.
   - Symptomatic Relief: Advised warm salt water gargles, lozenges, Tylenol/ibuprofen as needed.
   - Education: Discussed contagiousness, hand hygiene, stay home from work/school 24h after starting abx and once afebrile.
   - Complications: Educated on potential complications of untreated strep throat.
Follow-up: Return to clinic if symptoms worsen or no improvement in 48-72 hours.
                `.trim(),
                expected: {
                    chiefComplaint: "Sore throat and difficulty swallowing",
                    icd10: "J02.0",
                    cpt: "99213, 87880", // 99213 for established visit, 87880 for rapid strep test
                    modifier: "NONE", // Assuming no specific modifiers for this basic scenario
                    planKeywords: ["Amoxicillin", "10 days", "gargles", "lozenge", "Tylenol", "hygiene", "stay home", "return if worse"],
                },
                explanation: `
- Chief Complaint is directly from the 'S' section.
- ICD-10 code J02.0 is provided in the 'A' (Assessment) section, confirmed by positive rapid strep and symptoms.
- CPT 99213 is for an established patient office visit (implied by the follow-up). CPT 87880 is for the rapid strep test performed.
- No specific modifier is needed for this simple, direct encounter.
- Key plan elements are extracted from the 'P' section, focusing on medication, symptomatic relief, education, and follow-up instructions.
                `.trim(),
            },
            {
                title: "Hypertension Follow-up and Medication Refill",
                description: "Extract the Chief Complaint, ICD-10, CPT, Modifier, and Key Plan elements.",
                soapNote: `
S:
Chief Complaint: "Follow-up for blood pressure."
HPI: Mr. Doe reports his home blood pressure readings have been consistently in the range of 130-140/80-90 mmHg daily since his last visit. Denies headaches, dizziness, chest pain, or vision changes. Reports adherence to prescribed Lisinopril 20mg daily. States he has been walking 30 minutes, 4 times a week, and trying to reduce sodium intake. Denies any side effects from medication.
ROS: No new complaints. Denies fever, cough, shortness of breath, nausea, vomiting, diarrhea, constipation, or urinary symptoms.

O:
Vitals: BP: 138/86 mmHg, HR: 72 bpm, RR: 16 bpm, Temp: 98.6¬∞F, Wt: 185 lbs (down 2 lbs from last visit)
Physical Exam:
General: Alert, oriented, appears comfortable.
CV: Regular rhythm, no murmurs, rubs, or gallops.
Pulmonary: Lungs clear to auscultation bilaterally.
Labs (from 2 weeks prior): BMP: Na 140, K 4.1, Cr 0.9, Glucose 102; HbA1c: 5.7%; Lipid Panel: Total Chol 180, HDL 55, LDL 90, Trig 120

A:
1. Essential Hypertension (I10): Stable blood pressure readings at target.
2. Prediabetes (R73.03): HbA1c remains stable.
3. Hyperlipidemia (E78.5): LDL well-controlled.

P:
1. Essential Hypertension: Continue Lisinopril 20mg daily. Encourage continued home BP monitoring; bring log to next visit. Continue DASH diet and regular exercise.
2. Prediabetes: Continue emphasizing diet and exercise. Recheck HbA1c in 6 months.
3. Hyperlipidemia: Continue current diet and exercise. Recheck Lipid Panel in 1 year.
Follow-up: Return to clinic in 3 months for recheck of BP and overall health.
                `.trim(),
                expected: {
                    chiefComplaint: "Follow-up for blood pressure",
                    icd10: "I10, R73.03, E78.5",
                    cpt: "99213", // Established patient office visit, assuming moderate complexity
                    modifier: "NONE",
                    planKeywords: ["Lisinopril", "BP monitoring", "DASH diet", "exercise", "HbA1c", "Lipid Panel", "3 months"],
                },
                explanation: `
- Chief Complaint is directly from the 'S' section.
- ICD-10 codes I10, R73.03, E78.5 are all listed in the 'A' (Assessment) section.
- CPT 99213 is an appropriate code for an established patient office visit managing stable chronic conditions.
- No modifiers are needed for this straightforward follow-up.
- Key plan elements involve medication continuation, lifestyle advice, upcoming lab work, and the next follow-up schedule.
                `.trim(),
            },
            {
                title: "Acute Knee Pain and X-ray",
                description: "Extract the Chief Complaint, ICD-10, CPT, Modifier, and Key Plan elements.",
                soapNote: `
S:
Chief Complaint: "Right knee pain after fall."
HPI: Patient reports falling down stairs 2 days ago, landing on right knee. Immediate severe pain and swelling. Unable to bear full weight. No numbness or tingling. Has been icing and taking ibuprofen with minimal relief.
ROS: No fever, chills. No other injuries from fall.

O:
Vitals: BP: 120/80 mmHg, HR: 70 bpm, RR: 16 bpm, Temp: 98.2¬∞F
Physical Exam:
Right Knee: Moderate swelling over patella. Tenderness to palpation along medial joint line. Pain with range of motion, especially flexion and extension. Effusion present. Stable to valgus/varus stress. Distal pulses intact. No neurological deficits.
X-ray Right Knee: Ordered.

A:
1. Right Knee Sprain (S83.91XA - Sprain of unspecified ligament of right knee, initial encounter)
2. Traumatic Effusion, right knee (M25.461) - if applicable, otherwise omit.

P:
1. Right Knee Sprain:
   - Immobilization: Knee immobilizer prescribed.
   - Pain Management: Continue Ibuprofen 600mg every 6 hours as needed.
   - RICE therapy: Rest, Ice, Compression, Elevation.
   - Imaging: X-ray of right knee performed today, results pending. Will notify patient once read.
   - Activity: Non-weight bearing on right leg, crutches provided.
   - Follow-up: Orthopedic referral placed. Return to clinic in 1 week for re-evaluation or sooner if worsening.
                `.trim(),
                expected: {
                    chiefComplaint: "Right knee pain after fall",
                    icd10: "S83.91XA",
                    cpt: "99213, 73560", // 99213 established visit, 73560 for knee X-ray
                    modifier: "RT", // Right side
                    planKeywords: ["immobilizer", "Ibuprofen", "RICE", "X-ray", "non-weight bearing", "crutches", "orthopedic referral", "1 week"],
                },
                explanation: `
- Chief Complaint is clear from the 'S' section.
- ICD-10 code S83.91XA is provided in the 'A' (Assessment) section. If a traumatic effusion was also explicitly diagnosed, M25.461 could be added.
- CPT 99213 is for the established patient office visit. CPT 73560 is for the X-ray of the knee.
- Modifier RT is crucial to indicate the service was performed on the Right side.
- Key plan elements involve immobilization, pain management, RICE therapy, imaging details, activity restrictions, and follow-up/referral.
                `.trim(),
            }
        ];

        // Global Data Storage (Code Lookup Tool)
        const codeDatabase = {
            "J02.0": "Acute pharyngitis, unspecified",
            "J02.9": "Acute pharyngitis, unspecified",
            "I10": "Essential (primary) hypertension",
            "R05": "Cough",
            "R53.83": "Other fatigue",
            "B07.0": "Plantar wart",
            "B07.9": "Viral wart, unspecified",
            "J11.1": "Influenza with gastrointestinal manifestations, virus identified",
            "Z00.00": "Encounter for general adult medical examination without abnormal findings",
            "R73.03": "Prediabetes",
            "E78.5": "Hyperlipidemia, unspecified",
            "S83.91XA": "Sprain of unspecified ligament of right knee, initial encounter",
            "M25.461": "Effusion, right knee",
            "J18.9": "Pneumonia, unspecified organism",

            "99203": "Office or other outpatient visit for the evaluation and management of a new patient, which requires a medically appropriate history and/or examination and high complexity medical decision making. When counseling and/or coordination of care with other physicians, other qualified health care professionals, or agencies are provided consistent with the nature of the problem(s) and the patient's and/or family's needs, time is a key factor to qualify for reporting this code. (30-44 minutes)",
            "99213": "Office or other outpatient visit for the evaluation and management of an established patient, which requires a medically appropriate history and/or examination and moderate complexity medical decision making. When counseling and/or coordination of care with other physicians, other qualified health care professionals, or agencies are provided consistent with the nature of the problem(s) and the patient's and/or family's needs, time is a key factor to qualify for reporting this code. (20-29 minutes)",
            "99395": "Periodic comprehensive preventive medicine reevaluation and management of an individual including an age and gender appropriate history, examination, counseling/anticipatory guidance/risk factor reduction interventions, and the ordering of laboratory/diagnostic procedures, established patient; 40-64 years.",
            "17110": "Destruction (e.g., laser surgery, electrosurgery, cryosurgery, chemosurgery, surgical curettement), of benign lesions other than skin tags or cutaneous vascular proliferative lesions; up to 14 lesions",
            "87804": "Influenza virus antigen detection, immunoassay, with direct optical observation; with optical instrument analysis",
            "71045": "Radiologic examination, chest; single view",
            "20610": "Arthrocentesis, aspiration and/or injection; major joint or bursa (e.g., shoulder, hip, knee, subacromial bursa)",
            "73560": "Radiologic examination, knee; 1 or 2 views",
            "G0438": "Annual wellness visit; includes a personalized prevention plan of service (pps), initial visit",
            "G0439": "Annual wellness visit, subsequent"
            // Add more common codes here as needed
        };

        // Global Data Storage (A/R Aging Simulation)
        let currentArScenarioClaims = [];
        const arAgingScenarios = [
            {
                scenarioId: "Scenario A: Mixed Aging",
                claims: [
                    { claimId: "C9001", patient: "Alice", payer: "BCBS", amount: 150.00, daysOld: 15, correctAction: "Monitor claim status", explanation: "Claims under 30 days old are typically still within the payer's initial processing time. Continue to monitor the status online before calling." },
                    { claimId: "C9002", patient: "Bob", payer: "Aetna", amount: 320.00, daysOld: 45, correctAction: "Check claim status online", explanation: "For claims 31-60 days old, check the payer's online portal first. If details are not available or it's stuck, call payer services." },
                    { claimId: "C9003", patient: "Charlie", payer: "UnitedHealthcare", amount: 75.00, daysOld: 70, correctAction: "Call payer (provider services) for status/details", explanation: "Claims 61-90 days old often require a direct call to payer services to identify specific issues or denials not yet communicated via EOB/ERA." },
                    { claimId: "C9004", patient: "Dana", payer: "Medicare", amount: 200.00, daysOld: 100, correctAction: "Review EOB/ERA for denial reason/details", explanation: "For claims over 90 days, there's a high probability of denial. Locate the EOB/ERA to understand the denial code and reason before planning an appeal or correction." },
                    { claimId: "C9005", patient: "Eve", payer: "Cigna", amount: 50.00, daysOld: 65, correctAction: "Review EOB/ERA for denial reason/details", explanation: "If an EOB/ERA is available for a claim over 60 days, always review it first to pinpoint the exact reason for non-payment or underpayment. This guides your next action." },
                    { claimId: "C9006", patient: "Frank", payer: "Humana", amount: 450.00, daysOld: 95, correctAction: "Submit an appeal", explanation: "For older denied claims where the service was medically necessary and supported by documentation, an appeal is often required. Ensure you have all necessary clinical notes." },
                ]
            },
            {
                scenarioId: "Scenario B: Denial Focus",
                claims: [
                    { claimId: "D1001", patient: "Grace", payer: "BCBS", amount: 120.00, daysOld: 80, correctAction: "Review EOB/ERA for denial reason/details", explanation: "This claim is old enough that it's likely been processed. Check for EOB/ERA to find a specific denial reason." },
                    { claimId: "D1002", patient: "Henry", payer: "Aetna", amount: 25.00, daysOld: 40, correctAction: "Check claim status online", explanation: "For a claim 31-60 days old, start with an online status check. It's too early for an appeal unless a denial is confirmed." },
                    { claimId: "D1003", patient: "Ivy", payer: "UnitedHealthcare", amount: 600.00, daysOld: 150, correctAction: "Write off balance", explanation: "A very old claim (150 days) with no resolution might be uncollectible, especially if it's past timely filing limits or payer response periods. Consider writing off after all other avenues are exhausted." },
                    { claimId: "D1004", patient: "Jack", payer: "Medicare", amount: 80.00, daysOld: 20, correctAction: "Monitor claim status", explanation: "This claim is still very new. Monitor its progress, no immediate action required." },
                    { claimId: "D1005", patient: "Karen", payer: "Cigna", amount: 180.00, daysOld: 75, correctAction: "Correct simple errors and resubmit claim", explanation: "If initial review (EOB/ERA or call) reveals a simple administrative error (e.g., typo, missing info), correct and resubmit promptly. This is faster than an appeal." },
                    { claimId: "D1006", patient: "Liam", payer: "Humana", amount: 100.00, daysOld: 50, correctAction: "Bill patient", explanation: "If the EOB/ERA clearly indicates the patient is responsible (e.g., deductible, coinsurance, non-covered service), send a patient statement. This claim is mature enough for patient billing." },
                ]
            }
        ];

        // You can also expose db, auth, and userId globally if needed for your existing script,
        // but better practice is to pass them to functions or encapsulate logic.
        // For simplicity in this direct integration, we'll use them directly within this script block.
        // window.db = db; // Not recommended for large apps, but can simplify initial integration
        // window.auth = auth;
        // window.userId = userId;


        // DOM Element References (existing sections)
        const patientNameInput = document.getElementById('patientName');
        const patientDOBInput = document.getElementById('patientDOB');
        const insuranceIDInput = document.getElementById('insuranceID');
        const registerPatientBtn = document.getElementById('registerPatientBtn');

        const encounterDateInput = document.getElementById('encounterDate');
        const chiefComplaintInput = document.getElementById('chiefComplaint');
        const diagnosisList = document.getElementById('diagnosisList');
        const addDiagnosisBtn = document.getElementById('addDiagnosisBtn');
        const procedureList = document.getElementById('procedureList');
        const addProcedureBtn = document.getElementById('addProcedureBtn');

        const chargeList = document.getElementById('chargeList');
        const addChargeBtn = document.getElementById('addChargeBtn');

        const generateClaimBtn = document.getElementById('generateClaimBtn');
        const claimOutput = document.getElementById('claimOutput');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const messageBox = document.getElementById('messageBox');

        // DOM Element References (Medical Billing Walkthrough)
        const billingWalkthroughContent = document.getElementById('billingWalkthroughContent');
        const walkthroughStepTitle = document.getElementById('walkthroughStepTitle');
        const walkthroughStepInstructions = document.getElementById('walkthroughStepInstructions');
        const startBillingWalkthroughBtn = document.getElementById('startBillingWalkthroughBtn');
        const nextBillingWalkthroughBtn = document.getElementById('nextBillingWalkthroughBtn');
        const resetBillingWalkthroughBtn = document.getElementById('resetBillingWalkthroughBtn');

        // DOM Element References (Prior Authorization Walkthrough)
        const paWalkthroughContent = document.getElementById('paWalkthroughContent');
        const paWalkthroughStepTitle = document.getElementById('paWalkthroughStepTitle');
        const paWalkthroughStepInstructions = document.getElementById('paWalkthroughStepInstructions');
        const startPaWalkthroughBtn = document.getElementById('startPaWalkthroughBtn');
        const nextPaWalkthroughBtn = document.getElementById('nextPaWalkthroughBtn');
        const resetPaWalkthroughBtn = document.getElementById('resetPaWalkthroughBtn');

        // DOM Element References (Knowledge Quizzes)
        const quizGuidelinesBtn = document.getElementById('quizGuidelinesBtn');
        const quizLawsBtn = document.getElementById('quizLawsBtn');
        const quizEthicsBtn = document.getElementById('quizEthicsBtn');
        const quizDenialsBtn = document.getElementById('quizDenialsBtn');
        const quizInsuranceNuanceBtn = document.getElementById('quizInsuranceNuanceBtn');
        const quizContent = document.getElementById('quizContent');
        const quizQuestionTitle = document.getElementById('quizQuestionTitle');
        const quizOptions = document.getElementById('quizOptions');
        const submitAnswerBtn = document.getElementById('submitAnswerBtn');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const resetQuizBtn = document.getElementById('resetQuizBtn');
        const quizFeedback = document.getElementById('quizFeedback');

        // DOM Element References (Patient Balance Calculator)
        const loadBalanceScenarioBtn = document.getElementById('loadBalanceScenarioBtn');
        const balanceCalculatorContent = document.getElementById('balanceCalculatorContent');
        const balanceScenarioTitle = document.getElementById('balanceScenarioTitle');
        const balanceScenarioDetails = document.getElementById('balanceScenarioDetails');
        const userCopayInput = document.getElementById('userCopay');
        const userDeductibleInput = document.getElementById('userDeductibleInput'); // Corrected ID
        const userCoinsuranceInput = document.getElementById('userCoinsurance');
        const userTotalBalanceInput = document.getElementById('userTotalBalance');
        const checkBalanceBtn = document.getElementById('checkBalanceBtn');
        const resetBalanceBtn = document.getElementById('resetBalanceBtn');
        const balanceFeedback = document.getElementById('balanceFeedback');

        // DOM Element References (Modifier Application Challenge)
        const loadModifierScenarioBtn = document.getElementById('loadModifierScenarioBtn');
        const modifierChallengeContent = document.getElementById('modifierChallengeContent');
        const modifierScenarioTitle = document.getElementById('modifierScenarioTitle');
        const modifierScenarioDetails = document.getElementById('modifierScenarioDetails');
        const userModifierCPTInput = document.getElementById('userModifierCPT');
        const userModifierInput = document.getElementById('userModifier');
        const checkModifierBtn = document.getElementById('checkModifierBtn');
        const resetModifierBtn = document.getElementById('resetModifierBtn');
        const modifierFeedback = document.getElementById('modifierFeedback');

        // DOM Element References (Matching Game)
        const startGameBtn = document.getElementById('startGameBtn');
        const matchingGameContent = document.getElementById('matchingGameContent');
        const cardGrid = document.getElementById('cardGrid');
        const gameMessage = document.getElementById('gameMessage');
        const resetGameBtn = document.getElementById('resetGameBtn');

        // DOM Element References (Claim Scrubber)
        const loadScrubberScenarioBtn = document.getElementById('loadScrubberScenarioBtn');
        const scrubberChallengeContent = document.getElementById('scrubberChallengeContent');
        const scrubberScenarioTitle = document.getElementById('scrubberScenarioTitle');
        const scrubberScenarioDetails = document.getElementById('scrubberScenarioDetails');
        const presentedClaimOutput = document.getElementById('presentedClaimOutput');
        const userScrubberICDInput = document.getElementById('userScrubberICD');
        const userScrubberCPTInput = document.getElementById('userScrubberCPT');
        const userScrubberModifierInput = document.getElementById('userScrubberModifier');
        const checkScrubberBtn = document.getElementById('checkScrubberBtn');
        const resetScrubberBtn = document.getElementById('resetScrubberBtn');
        const scrubberFeedback = document.getElementById('scrubberFeedback');

        // DOM Element References (Denial Code Interpreter)
        const loadDenialScenarioBtn = document.getElementById('loadDenialScenarioBtn');
        const denialChallengeContent = document.getElementById('denialChallengeContent');
        const denialScenarioTitle = document.getElementById('denialScenarioTitle');
        const denialScenarioDetails = document.getElementById('denialScenarioDetails');
        const denialInterpretationOptions = document.getElementById('denialInterpretationOptions');
        const userActionPlanInput = document.getElementById('userActionPlan');
        const checkDenialBtn = document.getElementById('checkDenialBtn');
        const resetDenialBtn = document.getElementById('resetDenialBtn');
        const denialFeedback = document.getElementById('denialFeedback');

        // DOM Element References (SOAP Note Challenge)
        const loadSoapScenarioBtn = document.getElementById('loadSoapScenarioBtn');
        const soapChallengeContent = document.getElementById('soapChallengeContent');
        const soapScenarioTitle = document.getElementById('soapScenarioTitle');
        const soapScenarioDescription = document.getElementById('soapScenarioDescription');
        const soapNoteDisplay = document.getElementById('soapNoteDisplay');
        const userSoapChiefComplaintInput = document.getElementById('userSoapChiefComplaint');
        const userSoapICDInput = document.getElementById('userSoapICD');
        const userSoapCPTInput = document.getElementById('userSoapCPT');
        const userSoapModifierInput = document.getElementById('userSoapModifier');
        const userSoapPlanInput = document.getElementById('userSoapPlan');
        const checkSoapBtn = document.getElementById('checkSoapBtn');
        const resetSoapBtn = document.getElementById('resetSoapBtn');
        const soapFeedback = document.getElementById('soapFeedback');

        // Code Lookup Tool DOM Elements
        const codeLookupInput = document.getElementById('codeLookupInput');
        const lookupCodeBtn = document.getElementById('lookupCodeBtn');
        const codeLookupResult = document.getElementById('codeLookupResult');
        const codeLookupContent = document.getElementById('codeLookupContent');

        // NEW: A/R Aging Simulation DOM Elements
        const loadArScenarioBtn = document.getElementById('loadArScenarioBtn');
        const arAgingContent = document.getElementById('arAgingContent');
        const arClaimList = document.getElementById('arClaimList');
        const checkArActionsBtn = document.getElementById('checkArActionsBtn');
        const resetArScenarioBtn = document.getElementById('resetArScenarioBtn');
        const arFeedback = document.getElementById('arFeedback');

        // NEW: Form Repository DOM Elements (no dynamic parts, just content)
        const formRepositoryContent = document.getElementById('formRepositoryContent');


        // --- FUNCTION DEFINITIONS (FOR EXISTING SIMULATION SECTIONS) ---

        // Function to display messages to the user
        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = `message-box ${type}`; // Reset classes and add new type
            messageBox.style.display = 'block'; // Make it visible

            // Automatically hide after 5 seconds
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }

        // Add/Remove Diagnosis and Procedure Fields
        function addInputGroup(containerId, inputClass, placeholder, type = 'text') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2'; // Tailwind classes for flex and gap

            const input = document.createElement('input');
            input.type = type;
            input.className = `${inputClass} flex-grow-1 focus:ring-green-500 focus:border-green-500`;
            input.name = inputClass.replace(/-/g, ''); // Convert class to name attribute
            input.placeholder = placeholder;

            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'btn-secondary remove-item-btn';
            removeButton.textContent = 'Remove';
            removeButton.onclick = function() {
                div.remove();
            };

            div.appendChild(input);
            div.appendChild(removeButton);
            container.appendChild(div);
        }

        function addServiceInputGroup() {
            const container = document.getElementById('chargeList');
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-3 gap-2 service-item';

            const descriptionInput = document.createElement('input');
            descriptionInput.type = 'text';
            descriptionInput.className = 'service-description col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500';
            descriptionInput.name = 'serviceDescription';
            descriptionInput.placeholder = 'Service Description';

            const cptCodeInput = document.createElement('input');
            cptCodeInput.type = 'text';
            cptCodeInput.className = 'service-cpt-code col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500';
            cptCodeInput.name = 'serviceCptCode';
            cptCodeInput.placeholder = 'CPT Code';

            const priceDiv = document.createElement('div');
            priceDiv.className = 'flex gap-2 col-span-1 md:col-span-1';

            const priceInput = document.createElement('input');
            priceInput.type = 'number';
            priceInput.className = 'service-price flex-grow-1 focus:ring-purple-500 focus:border-purple-500';
            priceInput.name = 'servicePrice';
            priceInput.placeholder = 'Price ($)';
            priceInput.min = "0";
            priceInput.step = "0.01";

            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'btn-secondary remove-item-btn';
            removeButton.textContent = 'Remove';
            removeButton.onclick = function() {
                div.remove();
            };

            priceDiv.appendChild(priceInput);
            priceDiv.appendChild(removeButton);

            div.appendChild(descriptionInput);
            div.appendChild(cptCodeInput);
            div.appendChild(priceDiv);
            container.appendChild(div);
        }

        // --- Medical Billing Walkthrough Logic ---
        startBillingWalkthroughBtn.addEventListener('click', () => {
            currentBillingStep = 0;
            billingWalkthroughContent.classList.remove('hidden');
            startBillingWalkthroughBtn.classList.add('hidden');
            nextBillingWalkthroughBtn.classList.remove('hidden');
            resetBillingWalkthroughBtn.classList.remove('hidden');
            displayBillingStep();
        });

        nextBillingWalkthroughBtn.addEventListener('click', () => {
            currentBillingStep++;
            if (currentBillingStep < billingSteps.length) {
                displayBillingStep();
            } else {
                walkthroughStepTitle.textContent = "Walkthrough Complete!";
                walkthroughStepInstructions.innerHTML = "<p>You've walked through the entire medical billing revenue cycle. Great job!</p>";
                nextBillingWalkthroughBtn.classList.add('hidden');
                showMessage('Medical Billing Walkthrough Complete!', 'success');
            }
        });

        resetBillingWalkthroughBtn.addEventListener('click', () => {
            currentBillingStep = 0;
            billingWalkthroughContent.classList.add('hidden');
            startBillingWalkthroughBtn.classList.remove('hidden');
            nextBillingWalkthroughBtn.classList.add('hidden');
            resetBillingWalkthroughBtn.classList.add('hidden');
            showMessage('Medical Billing Walkthrough Reset.', 'success');
        });

        function displayBillingStep() {
            const step = billingSteps[currentBillingStep];
            walkthroughStepTitle.textContent = step.title;
            walkthroughStepInstructions.innerHTML = step.instructions;
        }

        // --- Prior Authorization Walkthrough Logic ---
        startPaWalkthroughBtn.addEventListener('click', () => {
            currentPaStep = 0;
            paWalkthroughContent.classList.remove('hidden');
            startPaWalkthroughBtn.classList.add('hidden');
            nextPaWalkthroughBtn.classList.remove('hidden');
            resetPaWalkthroughBtn.classList.remove('hidden');
            displayPaStep();
        });

        nextPaWalkthroughBtn.addEventListener('click', () => {
            currentPaStep++;
            if (currentPaStep < paSteps.length) {
                displayPaStep();
            } else {
                paWalkthroughStepTitle.textContent = "PA Walkthrough Complete!";
                paWalkthroughStepInstructions.innerHTML = "<p>You've walked through the Prior Authorization process. Great job!</p>";
                nextPaWalkthroughBtn.classList.add('hidden');
                showMessage('Prior Authorization Walkthrough Complete!', 'success');
            }
        });

        resetPaWalkthroughBtn.addEventListener('click', () => {
            currentPaStep = 0;
            paWalkthroughContent.classList.add('hidden');
            startPaWalkthroughBtn.classList.remove('hidden');
            nextPaWalkthroughBtn.classList.add('hidden');
            resetPaWalkthroughBtn.classList.add('hidden');
            showMessage('PA Walkthrough Reset.', 'success');
        });

        function displayPaStep() {
            const step = paSteps[currentPaStep];
            paWalkthroughStepTitle.textContent = step.title;
            paWalkthroughStepInstructions.innerHTML = step.instructions;
        }

        // --- Knowledge Quizzes Logic ---
        function loadQuiz(moduleName) {
            selectedQuizModule = quizModules[moduleName];
            currentQuizQuestionIndex = 0;
            quizContent.classList.remove('hidden');
            submitAnswerBtn.classList.remove('hidden');
            nextQuestionBtn.classList.add('hidden');
            resetQuizBtn.classList.remove('hidden');
            displayQuizQuestion();
            quizFeedback.innerHTML = '<p class="text-gray-500 quiz-feedback-text">Your feedback will appear here.</p>';
        }

        function displayQuizQuestion() {
            if (!selectedQuizModule || currentQuizQuestionIndex >= selectedQuizModule.length) {
                quizQuestionTitle.textContent = "Quiz Complete!";
                quizOptions.innerHTML = '<p class="text-lg text-center text-gray-700">You\'ve finished this quiz module!</p>';
                submitAnswerBtn.classList.add('hidden');
                nextQuestionBtn.classList.add('hidden');
                showMessage('Quiz Module Complete!', 'success');
                return;
            }

            const questionData = selectedQuizModule[currentQuizQuestionIndex];
            quizQuestionTitle.textContent = `Question ${currentQuizQuestionIndex + 1}: ${questionData.question}`;
            quizOptions.innerHTML = ''; // Clear previous options

            questionData.options.forEach((option, index) => {
                const label = document.createElement('label');
                label.className = 'quiz-option';
                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'quizOption';
                input.value = option.charAt(0); // Value is A, B, C, D
                label.appendChild(input);
                label.appendChild(document.createTextNode(option));
                quizOptions.appendChild(label);
            });
            submitAnswerBtn.classList.remove('hidden');
            nextQuestionBtn.classList.add('hidden');
            quizFeedback.innerHTML = '<p class="text-gray-500 quiz-feedback-text">Your feedback will appear here.</p>';
            // Re-enable radio buttons
            quizOptions.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = false);
        }

        submitAnswerBtn.addEventListener('click', () => {
            const selectedOption = document.querySelector('input[name="quizOption"]:checked');
            if (!selectedOption) {
                quizFeedback.innerHTML = '<p class="text-red-700 quiz-feedback-text">Please select an answer.</p>';
                quizFeedback.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
                return;
            }

            const questionData = selectedQuizModule[currentQuizQuestionIndex];
            if (selectedOption.value === questionData.answer) {
                quizFeedback.innerHTML = `<p class="text-green-700 font-bold">Correct! üéâ</p><p class="quiz-feedback-text">${questionData.explanation}</p>`;
                quizFeedback.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
            } else {
                quizFeedback.innerHTML = `<p class="text-red-700 font-bold">Incorrect. üòî</p><p class="quiz-feedback-text">The correct answer was **${questionData.answer}**. ${questionData.explanation}</p>`;
                quizFeedback.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
            }
            submitAnswerBtn.classList.add('hidden');
            nextQuestionBtn.classList.remove('hidden');
            // Disable radio buttons after submission
            quizOptions.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = true);
        });

        nextQuestionBtn.addEventListener('click', () => {
            currentQuizQuestionIndex++;
            displayQuizQuestion();
        });

        resetQuizBtn.addEventListener('click', () => {
            selectedQuizModule = null;
            currentQuizQuestionIndex = 0;
            quizContent.classList.add('hidden');
            quizFeedback.innerHTML = '<p class="text-gray-500 quiz-feedback-text">Your feedback will appear here.</p>';
            quizFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
            submitAnswerBtn.classList.add('hidden');
            nextQuestionBtn.classList.add('hidden');
            resetQuizBtn.classList.add('hidden');
            showMessage('Quiz Reset.', 'success');
        });

        quizGuidelinesBtn.addEventListener('click', () => loadQuiz("Coding Guidelines"));
        quizLawsBtn.addEventListener('click', () => loadQuiz("Healthcare Laws"));
        quizEthicsBtn.addEventListener('click', () => loadQuiz("Coding Ethics"));
        quizDenialsBtn.addEventListener('click', () => loadQuiz("Denials & Appeals"));
        quizInsuranceNuanceBtn.addEventListener('click', () => loadQuiz("Insurance Nuances"));

        // --- EVENT LISTENERS (MAIN SIMULATOR SECTIONS) ---

        registerPatientBtn.addEventListener('click', async () => {
            patientData = {
                name: patientNameInput.value,
                dob: patientDOBInput.value,
                insuranceID: insuranceIDInput.value
            };

            if (patientData.name && patientData.dob && patientData.insuranceID) {
                showMessage('Patient Registered Successfully!', 'success');
                // Save patient data to Firestore
                if (db && userId) {
                    try {
                        // Using a unique ID for the patient document based on their name and DOB
                        const patientDocRef = doc(db, `artifacts/${appId}/users/${userId}/patients`, `${patientData.name.replace(/\s/g, '-')}-${patientData.dob}`);
                        await setDoc(patientDocRef, patientData, { merge: true });
                        console.log("Patient data saved to Firestore:", patientData);
                    } catch (e) {
                        console.error("Error saving patient data to Firestore:", e);
                        showMessage('Error saving patient data.', 'error');
                    }
                }
            } else {
                showMessage('Please fill in all patient registration fields.', 'error');
            }
        });

        addDiagnosisBtn.addEventListener('click', () => addInputGroup('diagnosisList', 'diagnosis-code', 'e.g., J02.9 (Acute pharyngitis)'));
        addProcedureBtn.addEventListener('click', () => addInputGroup('procedureList', 'procedure-code', 'e.g., 99213 (Office visit)'));
        addChargeBtn.addEventListener('click', addServiceInputGroup);

        generateClaimBtn.addEventListener('click', async () => {
            const currentDiagnoses = Array.from(document.querySelectorAll('.diagnosis-code')).map(input => input.value.trim()).filter(Boolean);
            const currentProcedures = Array.from(document.querySelectorAll('.procedure-code')).map(input => input.value.trim()).filter(Boolean);
            const currentCharges = Array.from(document.querySelectorAll('.service-item')).map(item => {
                const description = item.querySelector('.service-description').value.trim();
                const cptCode = item.querySelector('.service-cpt-code').value.trim();
                const price = parseFloat(item.querySelector('.service-price').value);
                return { description, cptCode, price: isNaN(price) ? 0 : price };
            }).filter(item => item.description || item.cptCode || item.price > 0);

            if (!patientData.name) {
                showMessage('Please register a patient first.', 'error');
                return;
            }
            if (!encounterDateInput.value || !chiefComplaintInput.value) {
                showMessage('Please fill in encounter date and chief complaint.', 'error');
                return;
            }
            if (currentDiagnoses.length === 0 || currentProcedures.length === 0 || currentCharges.length === 0) {
                showMessage('Please add at least one diagnosis, procedure, and service charge.', 'error');
                return;
            }

            const claim = {
                patient: patientData,
                encounter: {
                    date: encounterDateInput.value,
                    chiefComplaint: chiefComplaintInput.value,
                },
                diagnoses: currentDiagnoses,
                procedures: currentProcedures,
                charges: currentCharges,
                totalCharge: currentCharges.reduce((sum, item) => sum + item.price, 0)
            };

            let claimText = `--- CMS-1500 Claim (Simulated) ---\n\n`;
            claimText += `Patient Name: ${claim.patient.name}\n`;
            claimText += `Patient DOB: ${claim.patient.dob}\n`;
            claimText += `Insurance ID: ${claim.patient.insuranceID}\n`;
            claimText += `\nEncounter Date: ${claim.encounter.date}\n`;
            claimText += `Chief Complaint: ${claim.encounter.chiefComplaint}\n`;
            claimText += `\nDiagnoses (ICD-10): ${claim.diagnoses.join(', ')}\n`;
            claimText += `Procedures (CPT/HCPCS): ${claim.procedures.join(', ')}\n`;
            claimText += `\nServices & Charges:\n`;
            claim.charges.forEach(charge => {
                claimText += `- ${charge.description} (CPT: ${charge.cptCode}): $${charge.price.toFixed(2)}\n`;
            });
            claimText += `\nTotal Billed: $${claim.totalCharge.toFixed(2)}\n`;
            claimText += `------------------------------------\n`;

            claimOutput.textContent = claimText;
            showMessage('Simulated Claim Generated!', 'success');

            // Save claim data to Firestore
            if (db && userId) {
                try {
                    const claimsCollection = collection(db, `artifacts/${appId}/users/${userId}/claims`);
                    await addDoc(claimsCollection, claim);
                    console.log("Claim data saved to Firestore:", claim);
                } catch (e) {
                    console.error("Error saving claim data to Firestore:", e);
                    showMessage('Error saving claim data.', 'error');
                }
            }
        });

        clearAllBtn.addEventListener('click', () => {
            patientNameInput.value = '';
            patientDOBInput.value = '';
            insuranceIDInput.value = '';
            encounterDateInput.value = '';
            chiefComplaintInput.value = '';
            diagnosisList.innerHTML = `
                <label class="block text-gray-700 text-sm font-bold mb-2">Diagnoses (ICD Codes):</label>
                <div class="flex items-center gap-2">
                    <input type="text" class="diagnosis-code flex-grow-1 focus:ring-green-500 focus:border-green-500" name="diagnosisCode" placeholder="e.g., J02.9 (Acute pharyngitis)">
                    <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                </div>
            `;
            procedureList.innerHTML = `
                <label class="block text-gray-700 text-sm font-bold mb-2">Procedures (CPT/HCPCS Codes):</label>
                <div class="flex items-center gap-2">
                    <input type="text" class="procedure-code flex-grow-1 focus:ring-green-500 focus:border-green-500" name="procedureCode" placeholder="e.g., 99213 (Office visit)">
                    <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                </div>
            `;
            chargeList.innerHTML = `
                <label class="block text-gray-700 text-sm font-bold mb-2">Services Rendered:</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 service-item">
                    <input type="text" class="service-description col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500" name="serviceDescription" placeholder="Service Description">
                    <input type="text" class="service-cpt-code col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500" name="serviceCptCode" placeholder="CPT Code">
                    <div class="flex gap-2 col-span-1 md:col-span-1">
                        <input type="number" class="service-price flex-grow-1 focus:ring-purple-500 focus:border-purple-500" name="servicePrice" placeholder="Price ($)" min="0" step="0.01">
                        <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                    </div>
                </div>
            `;
            claimOutput.textContent = '';
            patientData = {};
            diagnoses = [];
            procedures = [];
            charges = [];
            showMessage('All data cleared!', 'success');
        });

    </script>
</body>
</html>
