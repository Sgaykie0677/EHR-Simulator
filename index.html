<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EHR Simulator</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f9; color: #333; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 8px; }
        .header { background-color: #2c3e50; color: #fff; padding: 15px; text-align: center; border-radius: 8px 8px 0 0; }
        .header h1 { margin: 0; font-size: 24px; }
        .tabs { display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px; }
        .tab-button { background-color: #eee; border: none; padding: 10px 20px; cursor: pointer; font-size: 16px; transition: background-color 0.3s, color 0.3s; }
        .tab-button.active { background-color: #2c3e50; color: #fff; }
        .tab-content { display: none; padding-top: 20px; }
        .tab-content.active { display: block; }
        .section { margin-bottom: 20px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 6px; }
        .section h2 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 5px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        .btn { background-color: #3498db; color: #fff; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .btn:hover { background-color: #2980b9; }
        #patient-list, #billing-list, #pa-list, #soap-notes-list, #denial-list, .ar-list { list-style-type: none; padding: 0; }
        .patient-card, .bill-card, .pa-card, .soap-card, .denial-card { background-color: #f9f9f9; padding: 15px; border: 1px solid #e0e0e0; border-radius: 6px; margin-bottom: 10px; }
        .patient-card h3, .bill-card h3, .pa-card h3, .soap-card h3, .denial-card h3 { margin-top: 0; }
        /* Calendar Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day-cell { padding: 10px; border: 1px solid #ccc; text-align: center; cursor: pointer; position: relative; }
        .day-cell.current-month { background-color: #f0f4f7; }
        .day-cell.other-month { background-color: #e9e9e9; color: #aaa; }
        .appointment { background-color: #3498db; color: #fff; border-radius: 3px; padding: 2px 5px; font-size: 10px; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .calendar-header button { background: none; border: none; font-size: 24px; cursor: pointer; }
        .calendar-date-display { font-size: 18px; font-weight: bold; }
        .days-of-week { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: bold; margin-bottom: 5px; }
        /* Quiz Styles */
        .quiz-question { margin-bottom: 20px; }
        .quiz-question h3 { margin-top: 0; }
        .quiz-question label { display: block; margin-bottom: 10px; cursor: pointer; }
        .quiz-question input[type="radio"] { margin-right: 10px; }
        #quiz-result { margin-top: 20px; font-size: 18px; font-weight: bold; }
        /* Calculator Styles */
        .calculator-input { display: flex; flex-direction: column; }
        .calculator-input label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calculator-input input { width: 60%; }
        #calculator-result { margin-top: 20px; font-size: 18px; font-weight: bold; }
        /* Code Match Styles */
        #code-match-term { font-size: 20px; font-weight: bold; text-align: center; margin-bottom: 20px; }
        .code-match-options { display: flex; flex-direction: column; align-items: center; }
        .code-match-option { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px; background-color: #f0f0f0; cursor: pointer; text-align: center; transition: background-color 0.2s; }
        .code-match-option:hover { background-color: #ddd; }
        .code-match-option.correct { background-color: #d4edda; border-color: #c3e6cb; }
        .code-match-option.incorrect { background-color: #f8d7da; border-color: #f5c6cb; }
        /* A/R Aging Styles */
        .ar-category { margin-bottom: 30px; }
        .ar-category h3 { margin-top: 0; color: #2c3e50; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        .ar-item { background-color: #fff; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 8px; font-size: 14px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>EHR Simulator</h1>
    </div>

    <div class="tabs">
        <button class="tab-button active" onclick="showTab('dashboard')">Dashboard</button>
        <button class="tab-button" onclick="showTab('billing')">Medical Billing</button>
        <button class="tab-button" onclick="showTab('prior-auth')">Prior Authorization</button>
        <button class="tab-button" onclick="showTab('calendar')">Calendar</button>
        <button class="tab-button" onclick="showTab('quiz')">Medical Coding Quiz</button>
        <button class="tab-button" onclick="showTab('calculator')">Balance Calculator</button>
        <button class="tab-button" onclick="showTab('soap')">SOAP Note</button>
        <button class="tab-button" onclick="showTab('denial')">Denial Management</button>
        <button class="tab-button" onclick="showTab('code-match')">Code Match</button>
        <button class="tab-button" onclick="showTab('ar-aging')">A/R Aging</button>
    </div>

    <div id="dashboard" class="tab-content active">
        <div class="section">
            <h2>Patient Registry</h2>
            <form id="patient-form">
                <div class="form-group">
                    <label for="patient-name">Patient Name:</label>
                    <input type="text" id="patient-name" required>
                </div>
                <div class="form-group">
                    <label for="patient-dob">Date of Birth:</label>
                    <input type="date" id="patient-dob" required>
                </div>
                <div class="form-group">
                    <label for="patient-diagnosis">Diagnosis (ICD-10):</label>
                    <input type="text" id="patient-diagnosis" required>
                </div>
                <button type="submit" class="btn">Add Patient</button>
            </form>
        </div>
        <div class="section">
            <h2>Active Patients</h2>
            <ul id="patient-list"></ul>
        </div>
    </div>

    <div id="billing" class="tab-content">
        <div class="section">
            <h2>Create a Claim</h2>
            <form id="billing-form">
                <div class="form-group">
                    <label for="billing-patient">Patient:</label>
                    <select id="billing-patient" required></select>
                </div>
                <div class="form-group">
                    <label for="service-date">Date of Service:</label>
                    <input type="date" id="service-date" required>
                </div>
                <div class="form-group">
                    <label for="cpt-code">CPT Code:</label>
                    <input type="text" id="cpt-code" placeholder="e.g., 99213" required>
                </div>
                <div class="form-group">
                    <label for="billing-diagnosis">Diagnosis Code (ICD-10):</label>
                    <input type="text" id="billing-diagnosis" placeholder="e.g., J01.90" required>
                </div>
                <div class="form-group">
                    <label for="insurance-payer">Insurance Payer:</label>
                    <input type="text" id="insurance-payer" placeholder="e.g., Blue Cross Blue Shield" required>
                </div>
                <div class="form-group">
                    <label for="claim-status">Claim Status:</label>
                    <select id="claim-status">
                        <option value="pending">Pending</option>
                        <option value="accepted">Accepted</option>
                        <option value="denied">Denied</option>
                    </select>
                </div>
                <button type="submit" class="btn">Submit Claim</button>
            </form>
        </div>
        <div class="section">
            <h2>Claims Tracker</h2>
            <ul id="billing-list"></ul>
        </div>
    </div>

    <div id="prior-auth" class="tab-content">
        <div class="section">
            <h2>Submit Prior Authorization</h2>
            <form id="pa-form">
                <div class="form-group">
                    <label for="pa-patient">Patient:</label>
                    <select id="pa-patient" required></select>
                </div>
                <div class="form-group">
                    <label for="pa-service">Service or Medication:</label>
                    <input type="text" id="pa-service" placeholder="e.g., MRI of the Knee" required>
                </div>
                <div class="form-group">
                    <label for="pa-reason">Medical Necessity Reason:</label>
                    <textarea id="pa-reason" rows="4" placeholder="Briefly explain why this service is medically necessary." required></textarea>
                </div>
                <div class="form-group">
                    <label for="pa-status">Authorization Status:</label>
                    <select id="pa-status">
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="denied">Denied</option>
                    </select>
                </div>
                <button type="submit" class="btn">Request Authorization</button>
            </form>
        </div>
        <div class="section">
            <h2>Prior Authorization Tracker</h2>
            <ul id="pa-list"></ul>
        </div>
    </div>

    <div id="calendar" class="tab-content">
        <div class="section">
            <h2>Practice Scheduling Appointments</h2>
            <div class="calendar-header">
                <button onclick="changeMonth(-1)">&#9664;</button>
                <div class="calendar-date-display" id="current-month-year"></div>
                <button onclick="changeMonth(1)">&#9654;</button>
            </div>
            <div class="days-of-week">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
        <div class="section">
            <h2>Add New Appointment</h2>
            <form id="appointment-form">
                <div class="form-group">
                    <label for="appointment-patient">Patient:</label>
                    <select id="appointment-patient" required></select>
                </div>
                <div class="form-group">
                    <label for="appointment-date">Appointment Date:</label>
                    <input type="date" id="appointment-date" required>
                </div>
                <div class="form-group">
                    <label for="appointment-time">Appointment Time:</label>
                    <input type="time" id="appointment-time" required>
                </div>
                <button type="submit" class="btn">Schedule Appointment</button>
            </form>
        </div>
    </div>

    <div id="quiz" class="tab-content">
        <div class="section">
            <h2>Medical Coding Quiz</h2>
            <p>Test your knowledge of common ICD-10 and CPT codes.</p>
            <form id="quiz-form">
                <div class="quiz-question">
                    <h3>1. What is the correct ICD-10 code for 'Influenza with pneumonia'?</h3>
                    <label><input type="radio" name="q1" value="A"> J11.0</label>
                    <label><input type="radio" name="q1" value="B"> J10.0</label>
                    <label><input type="radio" name="q1" value="C"> J11.1</label>
                    <label><input type="radio" name="q1" value="D"> J10.1</label>
                </div>
                <div class="quiz-question">
                    <h3>2. What CPT code is typically used for a simple, new patient office visit?</h3>
                    <label><input type="radio" name="q2" value="A"> 99213</label>
                    <label><input type="radio" name="q2" value="B"> 99203</label>
                    <label><input type="radio" name="q2" value="C"> 99201</label>
                    <label><input type="radio" name="q2" value="D"> 99214</label>
                </div>
                <div class="quiz-question">
                    <h3>3. The CPT code for a routine venipuncture is:</h3>
                    <label><input type="radio" name="q3" value="A"> 36415</label>
                    <label><input type="radio" name="q3" value="B"> 99211</label>
                    <label><input type="radio" name="q3" value="C"> 88305</label>
                    <label><input type="radio" name="q3" value="D"> 36410</label>
                </div>
                <button type="submit" class="btn">Submit Quiz</button>
            </form>
            <div id="quiz-result"></div>
        </div>
    </div>

    <div id="calculator" class="tab-content">
        <div class="section">
            <h2>Patient Balance Calculator</h2>
            <p>Calculate the patient's remaining balance after insurance payment.</p>
            <form id="balance-form">
                <div class="form-group calculator-input">
                    <label for="charged-amount">Total Charged Amount ($):</label>
                    <input type="number" id="charged-amount" step="0.01" required>
                </div>
                <div class="form-group calculator-input">
                    <label for="allowed-amount">Allowed Amount ($):</label>
                    <input type="number" id="allowed-amount" step="0.01" required>
                </div>
                <div class="form-group calculator-input">
                    <label for="insurance-paid">Insurance Paid ($):</label>
                    <input type="number" id="insurance-paid" step="0.01" required>
                </div>
                <div class="form-group calculator-input">
                    <label for="copay">Patient Copay ($):</label>
                    <input type="number" id="copay" step="0.01" value="0.00">
                </div>
                <button type="submit" class="btn">Calculate Balance</button>
            </form>
            <div id="calculator-result"></div>
        </div>
    </div>
    
    <div id="soap" class="tab-content">
        <div class="section">
            <h2>Create SOAP Note</h2>
            <p>Use the following fields to practice creating a clinical note.</p>
            <form id="soap-form">
                <div class="form-group">
                    <label for="soap-patient">Patient:</label>
                    <select id="soap-patient" required></select>
                </div>
                <div class="form-group">
                    <label for="soap-subjective">S - Subjective:</label>
                    <textarea id="soap-subjective" rows="4" placeholder="Patient's chief complaint, symptoms, and health history." required></textarea>
                </div>
                <div class="form-group">
                    <label for="soap-objective">O - Objective:</label>
                    <textarea id="soap-objective" rows="4" placeholder="Objective data: physical exam findings, lab results, and vitals." required></textarea>
                </div>
                <div class="form-group">
                    <label for="soap-assessment">A - Assessment:</label>
                    <textarea id="soap-assessment" rows="4" placeholder="Medical diagnosis and a summary of the patient's condition." required></textarea>
                </div>
                <div class="form-group">
                    <label for="soap-plan">P - Plan:</label>
                    <textarea id="soap-plan" rows="4" placeholder="Treatment plan, next steps, and follow-up instructions." required></textarea>
                </div>
                <button type="submit" class="btn">Save SOAP Note</button>
            </form>
        </div>
        <div class="section">
            <h2>Saved Notes</h2>
            <ul id="soap-notes-list"></ul>
        </div>
    </div>

    <div id="denial" class="tab-content">
        <div class="section">
            <h2>Manage Claim Denials</h2>
            <p>Practice documenting and tracking denied claims.</p>
            <form id="denial-form">
                <div class="form-group">
                    <label for="denial-patient">Patient:</label>
                    <select id="denial-patient" required></select>
                </div>
                <div class="form-group">
                    <label for="claim-cpt">Associated CPT Code (e.g., 99213):</label>
                    <input type="text" id="claim-cpt" required>
                </div>
                <div class="form-group">
                    <label for="denial-reason">Reason for Denial:</label>
                    <textarea id="denial-reason" rows="4" placeholder="E.g., Missing modifier, not medically necessary, etc." required></textarea>
                </div>
                <div class="form-group">
                    <label for="appeal-status">Appeal Status:</label>
                    <select id="appeal-status">
                        <option value="pending">Pending Review</option>
                        <option value="appealed">Appealed</option>
                        <option value="overturned">Overturned (Payment Received)</option>
                        <option value="denied-final">Final Denial</option>
                    </select>
                </div>
                <button type="submit" class="btn">Submit Denial</button>
            </form>
        </div>
        <div class="section">
            <h2>Denied Claims Tracker</h2>
            <ul id="denial-list"></ul>
        </div>
    </div>

    <div id="code-match" class="tab-content">
        <div class="section">
            <h2>Code Matching Practice</h2>
            <p>Match the description to the correct code.</p>
            <h3 id="code-match-term"></h3>
            <div id="code-match-options" class="code-match-options"></div>
            <button class="btn" onclick="nextCodeMatch()">Next</button>
        </div>
    </div>

    <div id="ar-aging" class="tab-content">
        <div class="section">
            <h2>Accounts Receivable Aging Report</h2>
            <p>Claims sorted by the number of days they are outstanding. Click "Refresh Report" to update.</p>
            <button class="btn" onclick="renderARAging()">Refresh Report</button>
            <div id="ar-aging-report">
                <div class="ar-category">
                    <h3>Current (0-30 days)</h3>
                    <ul id="ar-list-30" class="ar-list"></ul>
                </div>
                <div class="ar-category">
                    <h3>31-60 days</h3>
                    <ul id="ar-list-60" class="ar-list"></ul>
                </div>
                <div class="ar-category">
                    <h3>61-90 days</h3>
                    <ul id="ar-list-90" class="ar-list"></ul>
                </div>
                <div class="ar-category">
                    <h3>91+ days</h3>
                    <ul id="ar-list-91" class="ar-list"></ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const patientForm = document.getElementById('patient-form');
    const patientList = document.getElementById('patient-list');
    const billingForm = document.getElementById('billing-form');
    const billingList = document.getElementById('billing-list');
    const paForm = document.getElementById('pa-form');
    const paList = document.getElementById('pa-list');
    const appointmentForm = document.getElementById('appointment-form');
    const calendarGrid = document.getElementById('calendar-grid');
    const currentMonthYear = document.getElementById('current-month-year');
    const quizForm = document.getElementById('quiz-form');
    const quizResult = document.getElementById('quiz-result');
    const balanceForm = document.getElementById('balance-form');
    const calculatorResult = document.getElementById('calculator-result');
    const soapForm = document.getElementById('soap-form');
    const soapNotesList = document.getElementById('soap-notes-list');
    const denialForm = document.getElementById('denial-form');
    const denialList = document.getElementById('denial-list');
    const codeMatchTerm = document.getElementById('code-match-term');
    const codeMatchOptions = document.getElementById('code-match-options');

    let patients = JSON.parse(localStorage.getItem('patients')) || [];
    let claims = JSON.parse(localStorage.getItem('claims')) || [];
    let authorizations = JSON.parse(localStorage.getItem('authorizations')) || [];
    let appointments = JSON.parse(localStorage.getItem('appointments')) || [];
    let soapNotes = JSON.parse(localStorage.getItem('soapNotes')) || [];
    let denials = JSON.parse(localStorage.getItem('denials')) || [];
    
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    const quizAnswers = {
        q1: 'A',
        q2: 'B',
        q3: 'A'
    };

    const codeMatchData = [
        { term: 'Office visit, new patient, level 3', code: '99203', options: ['99213', '99201', '99203', '99214'] },
        { term: 'Influenza with pneumonia', code: 'J11.0', options: ['J10.0', 'J11.0', 'J18.9', 'J01.90'] },
        { term: 'Routine venipuncture', code: '36415', options: ['36410', '99211', '88305', '36415'] },
        { term: 'Type 2 diabetes mellitus with diabetic neuropathy', code: 'E11.40', options: ['E10.40', 'E11.40', 'E11.9', 'G63'] },
        { term: 'Annual wellness visit, Medicare', code: 'G0439', options: ['G0439', '99385', '99204', '99490'] }
    ];
    let currentCodeMatchIndex = 0;

    // Event listeners
    patientForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const patientName = document.getElementById('patient-name').value;
        const patientDob = document.getElementById('patient-dob').value;
        const patientDiagnosis = document.getElementById('patient-diagnosis').value;
        addPatient(patientName, patientDob, patientDiagnosis);
        patientForm.reset();
        renderPatients();
        updatePatientDropdowns();
    });

    billingForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const patientId = document.getElementById('billing-patient').value;
        const serviceDate = document.getElementById('service-date').value;
        const cptCode = document.getElementById('cpt-code').value;
        const billingDiagnosis = document.getElementById('billing-diagnosis').value;
        const insurancePayer = document.getElementById('insurance-payer').value;
        const claimStatus = document.getElementById('claim-status').value;
        addClaim(patientId, serviceDate, cptCode, billingDiagnosis, insurancePayer, claimStatus);
        billingForm.reset();
        renderClaims();
        renderARAging();
    });

    paForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const patientId = document.getElementById('pa-patient').value;
        const service = document.getElementById('pa-service').value;
        const reason = document.getElementById('pa-reason').value;
        const status = document.getElementById('pa-status').value;
        addAuthorization(patientId, service, reason, status);
        paForm.reset();
        renderAuthorizations();
    });

    appointmentForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const patientId = document.getElementById('appointment-patient').value;
        const date = document.getElementById('appointment-date').value;
        const time = document.getElementById('appointment-time').value;
        addAppointment(patientId, date, time);
        appointmentForm.reset();
        renderCalendar();
    });
    
    quizForm.addEventListener('submit', function(e) {
        e.preventDefault();
        let score = 0;
        let totalQuestions = Object.keys(quizAnswers).length;

        for (const question in quizAnswers) {
            const selectedOption = document.querySelector(`input[name="${question}"]:checked`);
            if (selectedOption && selectedOption.value === quizAnswers[question]) {
                score++;
            }
        }
        
        quizResult.textContent = `You scored ${score} out of ${totalQuestions}.`;
    });

    balanceForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const charged = parseFloat(document.getElementById('charged-amount').value);
        const allowed = parseFloat(document.getElementById('allowed-amount').value);
        const paid = parseFloat(document.getElementById('insurance-paid').value);
        const copay = parseFloat(document.getElementById('copay').value);

        if (isNaN(charged) || isNaN(allowed) || isNaN(paid) || isNaN(copay)) {
            calculatorResult.textContent = "Please enter valid numbers in all fields.";
            return;
        }

        const patientResponsibility = allowed - paid + copay;
        
        calculatorResult.innerHTML = `
            <p><strong>Total Charged Amount:</strong> $${charged.toFixed(2)}</p>
            <p><strong>Allowed Amount:</strong> $${allowed.toFixed(2)}</p>
            <p><strong>Insurance Paid:</strong> $${paid.toFixed(2)}</p>
            <p><strong>Patient's Copay:</strong> $${copay.toFixed(2)}</p>
            <p><strong>Patient's Final Balance:</strong> $${patientResponsibility.toFixed(2)}</p>
        `;
    });

    soapForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const patientId = document.getElementById('soap-patient').value;
        const subjective = document.getElementById('soap-subjective').value;
        const objective = document.getElementById('soap-objective').value;
        const assessment = document.getElementById('soap-assessment').value;
        const plan = document.getElementById('soap-plan').value;
        addSOAPNote(patientId, subjective, objective, assessment, plan);
        soapForm.reset();
        renderSOAPNotes();
    });

    denialForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const patientId = document.getElementById('denial-patient').value;
        const claimCpt = document.getElementById('claim-cpt').value;
        const denialReason = document.getElementById('denial-reason').value;
        const appealStatus = document.getElementById('appeal-status').value;
        addDenial(patientId, claimCpt, denialReason, appealStatus);
        denialForm.reset();
        renderDenials();
    });


    // Data Management
    function addPatient(name, dob, diagnosis) {
        const patient = {
            id: Date.now().toString(),
            name,
            dob,
            diagnosis
        };
        patients.push(patient);
        localStorage.setItem('patients', JSON.stringify(patients));
    }

    function addClaim(patientId, serviceDate, cptCode, diagnosis, insurance, status) {
        const patient = patients.find(p => p.id === patientId);
        if (!patient) return;
        const claim = {
            id: Date.now().toString(),
            patientName: patient.name,
            serviceDate,
            cptCode,
            diagnosis,
            insurance,
            status
        };
        claims.push(claim);
        localStorage.setItem('claims', JSON.stringify(claims));
    }

    function addAuthorization(patientId, service, reason, status) {
        const patient = patients.find(p => p.id === patientId);
        if (!patient) return;
        const auth = {
            id: Date.now().toString(),
            patientName: patient.name,
            service,
            reason,
            status
        };
        authorizations.push(auth);
        localStorage.setItem('authorizations', JSON.stringify(authorizations));
    }

    function addAppointment(patientId, date, time) {
        const patient = patients.find(p => p.id === patientId);
        if (!patient) return;
        const appointment = {
            id: Date.now().toString(),
            patientName: patient.name,
            date,
            time
        };
        appointments.push(appointment);
        localStorage.setItem('appointments', JSON.stringify(appointments));
    }

    function addSOAPNote(patientId, subjective, objective, assessment, plan) {
        const patient = patients.find(p => p.id === patientId);
        if (!patient) return;
        const note = {
            id: Date.now().toString(),
            patientName: patient.name,
            date: new Date().toLocaleDateString(),
            subjective,
            objective,
            assessment,
            plan
        };
        soapNotes.push(note);
        localStorage.setItem('soapNotes', JSON.stringify(soapNotes));
    }

    function addDenial(patientId, claimCpt, denialReason, appealStatus) {
        const patient = patients.find(p => p.id === patientId);
        if (!patient) return;
        const denial = {
            id: Date.now().toString(),
            patientName: patient.name,
            claimCpt,
            denialReason,
            appealStatus
        };
        denials.push(denial);
        localStorage.setItem('denials', JSON.stringify(denials));
    }


    // Rendering functions
    function renderPatients() {
        patientList.innerHTML = '';
        patients.forEach(patient => {
            const li = document.createElement('li');
            li.className = 'patient-card';
            li.innerHTML = `
                <h3>${patient.name}</h3>
                <p><strong>DOB:</strong> ${patient.dob}</p>
                <p><strong>Diagnosis:</strong> ${patient.diagnosis}</p>
            `;
            patientList.appendChild(li);
        });
    }

    function renderClaims() {
        billingList.innerHTML = '';
        claims.forEach(claim => {
            const li = document.createElement('li');
            li.className = 'bill-card';
            li.innerHTML = `
                <h3>Claim for: ${claim.patientName}</h3>
                <p><strong>Date of Service:</strong> ${claim.serviceDate}</p>
                <p><strong>CPT Code:</strong> ${claim.cptCode}</p>
                <p><strong>Payer:</strong> ${claim.insurance}</p>
                <p><strong>Status:</strong> <span style="color: ${claim.status === 'denied' ? 'red' : claim.status === 'accepted' ? 'green' : 'orange'}; font-weight: bold;">${claim.status.toUpperCase()}</span></p>
            `;
            billingList.appendChild(li);
        });
    }

    function renderAuthorizations() {
        paList.innerHTML = '';
        authorizations.forEach(auth => {
            const li = document.createElement('li');
            li.className = 'pa-card';
            li.innerHTML = `
                <h3>PA for: ${auth.patientName}</h3>
                <p><strong>Service:</strong> ${auth.service}</p>
                <p><strong>Status:</strong> <span style="color: ${auth.status === 'denied' ? 'red' : auth.status === 'approved' ? 'green' : 'orange'}; font-weight: bold;">${auth.status.toUpperCase()}</span></p>
            `;
            paList.appendChild(li);
        });
    }

    function renderCalendar() {
        calendarGrid.innerHTML = '';
        const date = new Date(currentYear, currentMonth, 1);
        const firstDayOfMonth = date.getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const prevMonthDays = new Date(currentYear, currentMonth, 0).getDate();
        currentMonthYear.textContent = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

        for (let i = firstDayOfMonth; i > 0; i--) {
            const cell = document.createElement('div');
            cell.className = 'day-cell other-month';
            cell.textContent = prevMonthDays - i + 1;
            calendarGrid.appendChild(cell);
        }

        for (let i = 1; i <= daysInMonth; i++) {
            const cell = document.createElement('div');
            cell.className = 'day-cell current-month';
            cell.textContent = i;
            const fullDate = new Date(currentYear, currentMonth, i).toISOString().split('T')[0];
            cell.dataset.date = fullDate;
            cell.onclick = () => document.getElementById('appointment-date').value = fullDate;

            const dayAppointments = appointments.filter(a => a.date === fullDate);
            dayAppointments.forEach(appt => {
                const apptDiv = document.createElement('div');
                apptDiv.className = 'appointment';
                apptDiv.dataset.id = appt.id;
                apptDiv.textContent = `${appt.time} - ${appt.patientName}`;
                apptDiv.onclick = (e) => {
                    e.stopPropagation(); // Prevents the day cell's onclick from firing
                    handleAppointmentClick(appt.id);
                };
                cell.appendChild(apptDiv);
            });
            calendarGrid.appendChild(cell);
        }
    }
    
    function renderSOAPNotes() {
        soapNotesList.innerHTML = '';
        soapNotes.forEach(note => {
            const li = document.createElement('li');
            li.className = 'soap-card';
            li.innerHTML = `
                <h3>Note for: ${note.patientName} (${note.date})</h3>
                <p><strong>S:</strong> ${note.subjective}</p>
                <p><strong>O:</strong> ${note.objective}</p>
                <p><strong>A:</strong> ${note.assessment}</p>
                <p><strong>P:</strong> ${note.plan}</p>
            `;
            soapNotesList.appendChild(li);
        });
    }

    function renderDenials() {
        denialList.innerHTML = '';
        denials.forEach(denial => {
            const li = document.createElement('li');
            li.className = 'denial-card';
            li.innerHTML = `
                <h3>Denial for: ${denial.patientName}</h3>
                <p><strong>CPT Code:</strong> ${denial.claimCpt}</p>
                <p><strong>Reason:</strong> ${denial.denialReason}</p>
                <p><strong>Appeal Status:</strong> <span style="color: ${denial.appealStatus === 'overturned' ? 'green' : denial.appealStatus === 'denied-final' ? 'red' : 'orange'}; font-weight: bold;">${denial.appealStatus.toUpperCase()}</span></p>
            `;
            denialList.appendChild(li);
        });
    }

    function renderCodeMatch() {
        const matchData = codeMatchData[currentCodeMatchIndex];
        codeMatchTerm.textContent = matchData.term;
        codeMatchOptions.innerHTML = '';

        matchData.options.sort(() => Math.random() - 0.5); // Shuffle options

        matchData.options.forEach(option => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'code-match-option';
            optionDiv.textContent = option;
            optionDiv.onclick = () => checkCodeMatch(option, matchData.code, optionDiv);
            codeMatchOptions.appendChild(optionDiv);
        });
    }

    function checkCodeMatch(selectedCode, correctCode, element) {
        const options = document.querySelectorAll('.code-match-option');
        options.forEach(option => option.onclick = null); // Disable clicks after first selection

        if (selectedCode === correctCode) {
            element.classList.add('correct');
        } else {
            element.classList.add('incorrect');
            const correctElement = Array.from(options).find(opt => opt.textContent === correctCode);
            if (correctElement) {
                correctElement.classList.add('correct');
            }
        }
    }

    function nextCodeMatch() {
        currentCodeMatchIndex = (currentCodeMatchIndex + 1) % codeMatchData.length;
        renderCodeMatch();
    }

    function renderARAging() {
        const today = new Date();
        const buckets = {
            'ar-list-30': [],
            'ar-list-60': [],
            'ar-list-90': [],
            'ar-list-91': []
        };

        const pendingClaims = claims.filter(claim => claim.status === 'pending');

        pendingClaims.forEach(claim => {
            const serviceDate = new Date(claim.serviceDate);
            const diffTime = Math.abs(today - serviceDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            let bucketId;
            if (diffDays <= 30) {
                bucketId = 'ar-list-30';
            } else if (diffDays <= 60) {
                bucketId = 'ar-list-60';
            } else if (diffDays <= 90) {
                bucketId = 'ar-list-90';
            } else {
                bucketId = 'ar-list-91';
            }
            
            buckets[bucketId].push({ ...claim, daysOutstanding: diffDays });
        });

        document.getElementById('ar-list-30').innerHTML = '';
        document.getElementById('ar-list-60').innerHTML = '';
        document.getElementById('ar-list-90').innerHTML = '';
        document.getElementById('ar-list-91').innerHTML = '';

        for (const bucket in buckets) {
            const list = document.getElementById(bucket);
            if (buckets[bucket].length > 0) {
                buckets[bucket].forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'ar-item';
                    li.innerHTML = `
                        <strong>Patient:</strong> ${item.patientName} | 
                        <strong>CPT:</strong> ${item.cptCode} | 
                        <strong>Payer:</strong> ${item.insurance} | 
                        <strong>Days Outstanding:</strong> ${item.daysOutstanding}
                    `;
                    list.appendChild(li);
                });
            } else {
                 const li = document.createElement('li');
                 li.className = 'ar-item';
                 li.textContent = 'No claims in this bucket.';
                 list.appendChild(li);
            }
        }
    }

    function changeMonth(direction) {
        currentMonth += direction;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        } else if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        renderCalendar();
    }
    
    function updatePatientDropdowns() {
        const patientDropdowns = document.querySelectorAll('#billing-patient, #pa-patient, #appointment-patient, #soap-patient, #denial-patient');
        patientDropdowns.forEach(select => {
            select.innerHTML = '<option value="">Select Patient</option>';
            patients.forEach(patient => {
                const option = document.createElement('option');
                option.value = patient.id;
                option.textContent = patient.name;
                select.appendChild(option);
            });
        });
    }

    function handleAppointmentClick(id) {
        const appt = appointments.find(a => a.id === id);
        if (!appt) return;

        const action = prompt(`Appointment for ${appt.patientName} at ${appt.time} on ${appt.date}.\n\nWhat would you like to do?\n\n1. Reschedule\n2. Cancel\n\nEnter '1' or '2':`);

        if (action === '1') {
            rescheduleAppointment(id);
        } else if (action === '2') {
            cancelAppointment(id);
        }
    }

    function rescheduleAppointment(id) {
        const appt = appointments.find(a => a.id === id);
        if (!appt) return;

        const newDate = prompt(`Enter new date (YYYY-MM-DD) for ${appt.patientName}:`);
        const newTime = prompt(`Enter new time (HH:MM) for ${appt.patientName}:`);
        
        if (newDate && newTime) {
            const apptIndex = appointments.findIndex(a => a.id === id);
            if (apptIndex !== -1) {
                appointments[apptIndex].date = newDate;
                appointments[apptIndex].time = newTime;
                localStorage.setItem('appointments', JSON.stringify(appointments));
                renderCalendar();
                alert('Appointment successfully rescheduled!');
            }
        } else {
            alert('Reschedule canceled or invalid input.');
        }
    }

    function cancelAppointment(id) {
        const confirmed = confirm("Are you sure you want to cancel this appointment?");
        if (confirmed) {
            appointments = appointments.filter(a => a.id !== id);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            renderCalendar();
            alert('Appointment successfully canceled!');
        }
    }

    // Tab functionality
    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
        document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
        if (tabId === 'code-match') {
            renderCodeMatch();
        }
        if (tabId === 'ar-aging') {
            renderARAging();
        }
    }

    // Initial render
    document.addEventListener('DOMContentLoaded', () => {
        renderPatients();
        renderClaims();
        renderAuthorizations();
        renderCalendar();
        renderSOAPNotes();
        renderDenials();
        updatePatientDropdowns();
        showTab('dashboard');
    });
</script>

</body>
</html>













