<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EHR Simulator for Medical Billing Practice</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }
        input[type="text"], input[type="date"], input[type="number"], textarea {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
            padding: 8px 14px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.875rem; /* text-sm */
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .message-box {
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
            display: none; /* Hidden by default */
        }
        .message-box.success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .message-box.error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .flex-grow-1 { /* Custom utility to make item grow */
            flex-grow: 1;
        }
        .hidden {
            display: none;
        }
        .walkthrough-step-content, .quiz-content, .balance-calculator-content, .modifier-challenge-content {
            background-color: #f8fafc; /* bg-blue-50 alternative */
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0; /* border-gray-200 alternative */
            margin-top: 1rem;
        }
        .walkthrough-step-title, .quiz-question-title, .balance-scenario-title, .modifier-challenge-title {
            font-weight: 600; /* font-semibold */
            color: #1a202c; /* text-gray-900 */
            margin-bottom: 0.5rem;
        }
        .walkthrough-instructions, .quiz-instructions, .quiz-feedback-text, .balance-scenario-text, .balance-feedback-text, .modifier-scenario-text, .modifier-feedback-text {
            font-size: 0.875rem; /* text-sm */
            color: #4a5568; /* text-gray-700 */
        }
        .quiz-option {
            display: block;
            padding: 8px 0;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 4px;
        }
        .quiz-option:hover {
            background-color: #f0f4f8;
        }
        .quiz-option input[type="radio"] {
            margin-right: 8px;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container">
        <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-8">EHR Practice System</h1>

        <!-- Message Box for user feedback -->
        <div id="messageBox" class="message-box"></div>

        <!-- Patient Registration Section -->
        <section class="mb-8 p-6 bg-blue-50 rounded-lg">
            <h2 class="section-title text-blue-800">1. Patient Registration üìù</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="patientName" class="block text-gray-700 text-sm font-bold mb-2">Patient Name:</label>
                    <input type="text" id="patientName" placeholder="John Doe" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="patientDOB" class="block text-gray-700 text-sm font-bold mb-2">Date of Birth:</label>
                    <input type="date" id="patientDOB" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label for="insuranceID" class="block text-gray-700 text-sm font-bold mb-2">Insurance ID:</label>
                    <input type="text" id="insuranceID" placeholder="ABC123456789" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <button id="registerPatientBtn" class="btn-primary w-full">Register Patient</button>
        </section>

        <!-- Encounter Documentation Section -->
        <section class="mb-8 p-6 bg-green-50 rounded-lg">
            <h2 class="section-title text-green-800">2. Encounter Documentation ü©∫</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="encounterDate" class="block text-gray-700 text-sm font-bold mb-2">Encounter Date:</label>
                    <input type="date" id="encounterDate" class="focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="md:col-span-2">
                    <label for="chiefComplaint" class="block text-gray-700 text-sm font-bold mb-2">Chief Complaint:</label>
                    <input type="text" id="chiefComplaint" placeholder="Patient reports sore throat and fever" class="focus:ring-green-500 focus:border-green-500">
                </div>
            </div>

            <div id="diagnosisList" class="mb-4 space-y-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Diagnoses (ICD Codes):</label>
                <div class="flex items-center gap-2">
                    <input type="text" class="diagnosis-code flex-grow-1 focus:ring-green-500 focus:border-green-500" placeholder="e.g., J02.9 (Acute pharyngitis)">
                    <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                </div>
            </div>
            <button id="addDiagnosisBtn" class="btn-primary mb-6 w-full bg-green-600 hover:bg-green-700">Add Another Diagnosis</button>

            <div id="procedureList" class="mb-4 space-y-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Procedures (CPT/HCPCS Codes):</label>
                <div class="flex items-center gap-2">
                    <input type="text" class="procedure-code flex-grow-1 focus:ring-green-500 focus:border-green-500" placeholder="e.g., 99213 (Office visit)">
                    <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                </div>
            </div>
            <button id="addProcedureBtn" class="btn-primary w-full bg-green-600 hover:bg-green-700">Add Another Procedure</button>
        </section>

        <!-- Charge Entry Section -->
        <section class="mb-8 p-6 bg-purple-50 rounded-lg">
            <h2 class="section-title text-purple-800">3. Charge Entry & Services üí≤</h2>
            <div id="chargeList" class="mb-4 space-y-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Services Rendered:</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 service-item">
                    <input type="text" class="service-description col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500" placeholder="Service Description">
                    <input type="text" class="service-cpt-code col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500" placeholder="CPT Code">
                    <div class="flex gap-2 col-span-1 md:col-span-1">
                        <input type="number" class="service-price flex-grow-1 focus:ring-purple-500 focus:border-purple-500" placeholder="Price ($)" min="0" step="0.01">
                        <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                    </div>
                </div>
            </div>
            <button id="addChargeBtn" class="btn-primary w-full bg-purple-600 hover:bg-purple-700">Add Another Service</button>
        </section>

        <!-- Generate Claim Section -->
        <section class="p-6 bg-red-50 rounded-lg mb-8">
            <h2 class="section-title text-red-800">4. Generate & View Claim üìÑ</h2>
            <button id="generateClaimBtn" class="btn-primary w-full mb-6 bg-red-600 hover:bg-red-700">Generate Simulated Claim</button>

            <div id="claimOutput" class="bg-gray-50 p-4 border border-gray-200 rounded-lg min-h-[150px] overflow-auto text-sm text-gray-800 whitespace-pre-wrap">
                <!-- Claim data will appear here -->
                <p class="text-gray-500">Your simulated claim details will appear here after generation.</p>
            </div>
            <button id="clearAllBtn" class="btn-secondary w-full mt-4">Clear All Data</button>
        </section>

        <!-- Medical Billing Walkthrough Section -->
        <section class="p-6 bg-indigo-50 rounded-lg mb-8">
            <h2 class="section-title text-indigo-800">5. Medical Billing Process Walkthrough üö∂‚Äç‚ôÄÔ∏è</h2>
            <p class="text-gray-700 mb-4">Click "Start Step" or "Next Step" to walk through the revenue cycle.</p>

            <div id="billingWalkthroughContent" class="hidden">
                <h3 id="walkthroughStepTitle" class="walkthrough-step-title text-indigo-700"></h3>
                <div id="walkthroughStepInstructions" class="walkthrough-instructions"></div>
            </div>
           
            <button id="startBillingWalkthroughBtn" class="btn-primary w-full mb-4 bg-indigo-600 hover:bg-indigo-700">Start Billing Walkthrough</button>
            <button id="nextBillingWalkthroughBtn" class="btn-primary w-full mb-4 bg-indigo-600 hover:bg-indigo-700 hidden">Next Step</button>
            <button id="resetBillingWalkthroughBtn" class="btn-secondary w-full hidden">Reset Walkthrough</button>
        </section>

        <!-- Prior Authorization Walkthrough Section -->
        <section class="p-6 bg-orange-50 rounded-lg mb-8">
            <h2 class="section-title text-orange-800">6. Prior Authorization (PA) Walkthrough üö¶</h2>
            <p class="text-gray-700 mb-4">Follow the steps to understand a PA scenario.</p>

            <div id="paWalkthroughContent" class="hidden">
                <h3 id="paWalkthroughStepTitle" class="walkthrough-step-title text-orange-700"></h3>
                <div id="paWalkthroughStepInstructions" class="walkthrough-instructions"></div>
            </div>
           
            <button id="startPaWalkthroughBtn" class="btn-primary w-full mb-4 bg-orange-600 hover:bg-orange-700">Start PA Walkthrough</button>
            <button id="nextPaWalkthroughBtn" class="btn-primary w-full mb-4 bg-orange-600 hover:bg-orange-700 hidden">Next Step</button>
            <button id="resetPaWalkthroughBtn" class="btn-secondary w-full hidden">Reset PA Walkthrough</button>
        </section>

        <!-- Knowledge Quizzes Section -->
        <section class="p-6 bg-pink-50 rounded-lg mb-8">
            <h2 class="section-title text-pink-800">7. Knowledge Quizzes! üìö</h2>
            <p class="text-gray-700 mb-4">Test your understanding of coding guidelines, healthcare laws, ethics, and denials & appeals!</p>

            <div class="flex flex-wrap gap-3 mb-6">
                <button id="quizGuidelinesBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Coding Guidelines</button>
                <button id="quizLawsBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Healthcare Laws</button>
                <button id="quizEthicsBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Coding Ethics</button>
                <button id="quizDenialsBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Denials & Appeals</button>
                <button id="quizInsuranceNuanceBtn" class="btn-primary bg-pink-600 hover:bg-pink-700">Insurance Nuances</button> <!-- NEW BUTTON -->
            </div>

            <div id="quizContent" class="quiz-content hidden">
                <h3 id="quizQuestionTitle" class="quiz-question-title text-pink-700"></h3>
                <div id="quizOptions" class="mb-4">
                    <!-- Options will be dynamically inserted here -->
                </div>
                
                <button id="submitAnswerBtn" class="btn-primary bg-pink-600 hover:bg-pink-700 mb-4">Submit Answer</button>
                <button id="nextQuestionBtn" class="btn-secondary hidden">Next Question</button>
                <button id="resetQuizBtn" class="btn-secondary hidden">Reset Quiz</button>

                <div id="quizFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 quiz-feedback-text">Your feedback will appear here.</p>
                </div>
            </div>
        </section>

        <!-- Patient Balance Calculator Section -->
        <section class="p-6 bg-teal-50 rounded-lg mb-8">
            <h2 class="section-title text-teal-800">8. Patient Balance Calculator üí∞</h2>
            <p class="text-gray-700 mb-4">Practice calculating patient responsibility based on common scenarios.</p>

            <button id="loadBalanceScenarioBtn" class="btn-primary w-full mb-6 bg-teal-600 hover:bg-teal-700">Load New Scenario</button>

            <div id="balanceCalculatorContent" class="balance-calculator-content hidden">
                <h3 id="balanceScenarioTitle" class="balance-scenario-title text-teal-700"></h3>
                <div id="balanceScenarioDetails" class="balance-scenario-text mb-4"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="userCopay" class="block text-gray-700 text-sm font-bold mb-2">Your Calculated Copay ($):</label>
                        <input type="number" id="userCopay" placeholder="0.00" min="0" step="0.01" class="focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="userDeductible" class="block text-gray-700 text-sm font-bold mb-2">Your Calculated Deductible Applied ($):</label>
                        <input type="number" id="userDeductible" placeholder="0.00" min="0" step="0.01" class="focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="userCoinsurance" class="block text-gray-700 text-sm font-bold mb-2">Your Calculated Coinsurance ($):</label>
                        <input type="number" id="userCoinsurance" placeholder="0.00" min="0" step="0.01" class="focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="userTotalBalance" class="block text-gray-700 text-sm font-bold mb-2">Your Calculated Total Patient Balance ($):</label>
                        <input type="number" id="userTotalBalance" placeholder="0.00" min="0" step="0.01" class="font-bold focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                
                <button id="checkBalanceBtn" class="btn-primary bg-teal-600 hover:bg-teal-700 mb-4">Check My Calculation</button>
                <button id="resetBalanceBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="balanceFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 balance-feedback-text">Feedback on your calculation will appear here.</p>
                </div>
            </div>
        </section>

        <!-- NEW: Advanced Modifier Application Challenge Section -->
        <section class="p-6 bg-yellow-50 rounded-lg mb-8">
            <h2 class="section-title text-yellow-800">9. Advanced Modifier Application Challenge üåü</h2>
            <p class="text-gray-700 mb-4">Analyze the scenario and apply the appropriate CPT code and modifier.</p>

            <button id="loadModifierScenarioBtn" class="btn-primary w-full mb-6 bg-yellow-600 hover:bg-yellow-700">Load New Scenario</button>

            <div id="modifierChallengeContent" class="modifier-challenge-content hidden">
                <h3 id="modifierScenarioTitle" class="modifier-challenge-title text-yellow-700"></h3>
                <div id="modifierScenarioDetails" class="modifier-scenario-text mb-4"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="userModifierCPT" class="block text-gray-700 text-sm font-bold mb-2">Your CPT Code:</label>
                        <input type="text" id="userModifierCPT" placeholder="e.g., 99213" class="focus:ring-yellow-500 focus:border-yellow-500 uppercase">
                    </div>
                    <div>
                        <label for="userModifier" class="block text-gray-700 text-sm font-bold mb-2">Your Modifier(s) (e.g., 25, 59):</label>
                        <input type="text" id="userModifier" placeholder="e.g., 25" class="focus:ring-yellow-500 focus:border-yellow-500 uppercase">
                    </div>
                </div>
                
                <button id="checkModifierBtn" class="btn-primary bg-yellow-600 hover:bg-yellow-700 mb-4">Check My Modifier</button>
                <button id="resetModifierBtn" class="btn-secondary hidden">Reset Scenario</button>

                <div id="modifierFeedback" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]">
                    <p class="text-gray-500 modifier-feedback-text">Feedback on your modifier application will appear here.</p>
                </div>
            </div>
        </section>


    </div>

    <script>
        // DOM Element References (existing sections)
        const patientNameInput = document.getElementById('patientName');
        const patientDOBInput = document.getElementById('patientDOB');
        const insuranceIDInput = document.getElementById('insuranceID');
        const registerPatientBtn = document.getElementById('registerPatientBtn');

        const encounterDateInput = document.getElementById('encounterDate');
        const chiefComplaintInput = document.getElementById('chiefComplaint');
        const diagnosisList = document.getElementById('diagnosisList');
        const addDiagnosisBtn = document.getElementById('addDiagnosisBtn');
        const procedureList = document.getElementById('procedureList');
        const addProcedureBtn = document.getElementById('addProcedureBtn');

        const chargeList = document.getElementById('chargeList');
        const addChargeBtn = document.getElementById('addChargeBtn');

        const generateClaimBtn = document.getElementById('generateClaimBtn');
        const claimOutput = document.getElementById('claimOutput');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const messageBox = document.getElementById('messageBox');

        // DOM Element References (Medical Billing Walkthrough)
        const billingWalkthroughContent = document.getElementById('billingWalkthroughContent');
        const walkthroughStepTitle = document.getElementById('walkthroughStepTitle');
        const walkthroughStepInstructions = document.getElementById('walkthroughStepInstructions');
        const startBillingWalkthroughBtn = document.getElementById('startBillingWalkthroughBtn');
        const nextBillingWalkthroughBtn = document.getElementById('nextBillingWalkthroughBtn');
        const resetBillingWalkthroughBtn = document.getElementById('resetBillingWalkthroughBtn');

        // DOM Element References (Prior Authorization Walkthrough)
        const paWalkthroughContent = document.getElementById('paWalkthroughContent');
        const paWalkthroughStepTitle = document.getElementById('paWalkthroughStepTitle');
        const paWalkthroughStepInstructions = document.getElementById('paWalkthroughStepInstructions');
        const startPaWalkthroughBtn = document.getElementById('startPaWalkthroughBtn');
        const nextPaWalkthroughBtn = document.getElementById('nextPaWalkthroughBtn');
        const resetPaWalkthroughBtn = document.getElementById('resetPaWalkthroughBtn');

        // DOM Element References (Knowledge Quizzes)
        const quizGuidelinesBtn = document.getElementById('quizGuidelinesBtn');
        const quizLawsBtn = document.getElementById('quizLawsBtn');
        const quizEthicsBtn = document.getElementById('quizEthicsBtn');
        const quizDenialsBtn = document.getElementById('quizDenialsBtn');
        const quizInsuranceNuanceBtn = document.getElementById('quizInsuranceNuanceBtn'); // NEW
        const quizContent = document.getElementById('quizContent');
        const quizQuestionTitle = document.getElementById('quizQuestionTitle');
        const quizOptions = document.getElementById('quizOptions');
        const submitAnswerBtn = document.getElementById('submitAnswerBtn');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const resetQuizBtn = document.getElementById('resetQuizBtn');
        const quizFeedback = document.getElementById('quizFeedback');

        // DOM Element References (Patient Balance Calculator)
        const loadBalanceScenarioBtn = document.getElementById('loadBalanceScenarioBtn');
        const balanceCalculatorContent = document.getElementById('balanceCalculatorContent');
        const balanceScenarioTitle = document.getElementById('balanceScenarioTitle');
        const balanceScenarioDetails = document.getElementById('balanceScenarioDetails');
        const userCopayInput = document.getElementById('userCopay');
        const userDeductibleInput = document.getElementById('userDeductible');
        const userCoinsuranceInput = document.getElementById('userCoinsurance');
        const userTotalBalanceInput = document.getElementById('userTotalBalance');
        const checkBalanceBtn = document.getElementById('checkBalanceBtn');
        const resetBalanceBtn = document.getElementById('resetBalanceBtn');
        const balanceFeedback = document.getElementById('balanceFeedback');

        // DOM Element References (NEW Modifier Application Challenge)
        const loadModifierScenarioBtn = document.getElementById('loadModifierScenarioBtn');
        const modifierChallengeContent = document.getElementById('modifierChallengeContent');
        const modifierScenarioTitle = document.getElementById('modifierScenarioTitle');
        const modifierScenarioDetails = document.getElementById('modifierScenarioDetails');
        const userModifierCPTInput = document.getElementById('userModifierCPT');
        const userModifierInput = document.getElementById('userModifier');
        const checkModifierBtn = document.getElementById('checkModifierBtn');
        const resetModifierBtn = document.getElementById('resetModifierBtn');
        const modifierFeedback = document.getElementById('modifierFeedback');


        // --- Global Data Storage (for existing simulation) ---
        let patientData = {};
        let diagnoses = [];
        let procedures = [];
        let charges = [];

        // --- Global Data Storage (Medical Billing Walkthrough) ---
        let currentBillingStep = 0;
        const billingSteps = [
            {
                title: "Step 1: Patient Registration & Insurance Verification",
                instructions: `**Action:** Begin by gathering the patient's full demographics and insurance details. **On the simulator:** Fill in the 'Patient Registration' section (Name, DOB, Insurance ID) and click 'Register Patient'. In a real scenario, you'd also call the payer to verify eligibility and benefits.`,
            },
            {
                title: "Step 2: Patient Encounter Documentation",
                instructions: `**Action:** This is where the provider records the visit details. **On the simulator:** Fill in the 'Encounter Documentation' section (Encounter Date, Chief Complaint, and add at least one Diagnosis and one Procedure). This mirrors the clinical notes that inform coding.`,
            },
            {
                title: "Step 3: Medical Coding",
                instructions: `**Action:** Translate the documentation into standardized ICD-10 and CPT codes. **On the simulator:** Ensure your Diagnosis and Procedure inputs in Section 2 are correctly formatted codes. This is a critical skill for accurate billing.`,
            },
            {
                title: "Step 4: Charge Entry & Superbill Creation",
                instructions: `**Action:** Enter the charges for the services provided. **On the simulator:** Go to 'Charge Entry & Services', add descriptions, CPT codes (ensure they match your procedures from step 2), and prices for the services. This creates the financial record.`,
            },
            {
                title: "Step 5: Claim Generation & Submission",
                instructions: `**Action:** Compile all data into a standardized claim (CMS-1500 for professional, UB-04 for institutional) and send it to the payer. **On the simulator:** Click 'Generate Simulated Claim' in Section 4. This is the official request for payment.`,
            },
            {
                title: "Step 6: Claim Adjudication",
                instructions: `**Understanding:** The insurance company reviews the claim. They'll either pay, deny, or reject it, sending an EOB (for patient) or ERA (for provider). **Think:** What common reasons lead to denials at this stage? (e.g., medical necessity, timely filing)`,
            },
            {
                title: "Step 7: Payment Posting",
                instructions: `**Action:** Once paid, the payment is recorded in the billing system. **Understanding:** This updates the patient's balance and the provider's accounts. Accurate posting prevents overbilling or outstanding balances.`,
            },
            {
                title: "Step 8: Patient Billing & Collections",
                instructions: `**Action:** If a balance remains after insurance pays, the patient is billed. **Understanding:** This involves sending statements and following up on overdue payments. Clear communication with patients is key.`,
            },
            {
                title: "Step 9: Reporting & Analysis",
                instructions: `**Understanding:** Continuously analyze billing data to identify trends, improve efficiency, and reduce denials. This step helps optimize the entire revenue cycle. **You've completed the walkthrough!**`,
            },
        ];

        // --- Global Data Storage (Prior Authorization Walkthrough) ---
        let currentPaStep = 0;
        const paSteps = [
            {
                title: "PA Step 1: Identify Need for Prior Authorization",
                instructions: `**Scenario:** A patient needs an MRI of the knee.
                **Action:** The first step is to check the patient's insurance plan and the specific CPT code (e.g., CPT 73721 for MRI knee without contrast) against the payer's policy to determine if a Prior Authorization (PA) is required. Many high-cost imaging services or specialty medications require PA.`,
            },
            {
                title: "PA Step 2: Gather Necessary Information",
                instructions: `**Action:** If PA is required, you must collect all relevant clinical and administrative information.
                **Required Info:** Patient demographics, insurance details, referring and rendering provider NPIs, **exact CPT code(s) with modifiers**, **supporting ICD-10 diagnosis code(s) demonstrating medical necessity**, date of service, and any clinical notes (e.g., physician's order, previous treatments tried and failed).`,
            },
            {
                title: "PA Step 3: Submit the Request",
                instructions: `**Action:** Submit the PA request to the insurance company. This is usually done online via a payer portal, fax, or phone.
                **Key Point:** Ensure all fields are accurately completed and all required supporting documentation is attached. Incomplete requests are a common cause of delays or denials.`,
            },
            {
                title: "PA Step 4: Follow-up and Await Decision",
                instructions: `**Action:** After submission, monitor the status of the request. Payers have specific turnaround times (e.g., 7-14 business days for routine, 24-72 hours for urgent).
                **Outcome:** The PA will either be **Approved**, **Denied**, or sent back for **More Information**.`,
            },
            {
                title: "PA Step 5: Handle Approved Authorization",
                instructions: `**Action:** If approved, carefully note the **authorization number**, the **approved CPT codes**, the **number of units/visits approved**, and the **valid date range**.
                **Next:** Ensure this authorization number is included on the claim when submitted to prevent denials. Inform the patient and scheduling department.`,
            },
            {
                title: "PA Step 6: Handle Denied Authorization",
                instructions: `**Action:** If denied, review the denial reason code carefully (often found on an EOB/ERA from the PA department). Common reasons include 'not medically necessary' or 'incorrect information'.
                **Next:** If denied for medical necessity, discuss with the provider if an appeal (with additional clinical documentation or a peer-to-peer review) is warranted. If denied for administrative reasons, correct and resubmit. **You've completed the PA walkthrough!**`,
            },
        ];

        // --- Global Data Storage (Knowledge Quizzes) ---
        let selectedQuizModule = null; // Stores the array of questions for the current module
        let currentQuizQuestionIndex = 0; // Tracks the current question in the module
        const quizModules = {
            "Coding Guidelines": [
                {
                    question: "What does a CPT code modifier indicate?",
                    options: ["A. A new diagnosis", "B. The code has been altered in some way", "C. The patient has insurance", "D. The service was performed in a hospital"],
                    answer: "B",
                    explanation: "A CPT modifier is a two-digit code appended to a CPT code to provide additional information about the procedure or service, such as that it was altered or performed by more than one physician."
                },
                {
                    question: "Which coding system is used for diagnosis codes?",
                    options: ["A. CPT", "B. HCPCS Level II", "C. ICD-10-CM", "D. E&M"],
                    answer: "C",
                    explanation: "ICD-10-CM (International Classification of Diseases, 10th Revision, Clinical Modification) is the standard system for diagnosis codes in the U.S."
                },
                // Add more Coding Guidelines questions here
            ],
            "Healthcare Laws": [
                {
                    question: "What is the primary purpose of HIPAA for medical coders?",
                    options: ["A. To ensure patients get timely appointments", "B. To protect the privacy and security of patient health information (PHI)", "C. To set reimbursement rates for services", "D. To standardize coding manuals"],
                    answer: "B",
                    explanation: "HIPAA's Privacy Rule and Security Rule mandate that Protected Health Information (PHI) is kept confidential and secure."
                },
                {
                    question: "Submitting a claim with codes that you know are wrong to get a higher payment is a violation of which law?",
                    options: ["A. Stark Law", "B. Anti-Kickback Statute", "C. False Claims Act (FCA)", "D. OIG Exclusions"],
                    answer: "C",
                    explanation: "The False Claims Act (FCA) imposes liability on persons and companies who knowingly submit false claims to the government."
                },
                // Add more Healthcare Laws questions here
            ],
            "Coding Ethics": [
                {
                    question: "Your boss tells you to change a code to one that provides higher reimbursement, even though the documentation doesn't support it. What is the most ethical action?",
                    options: ["A. Do what your boss says to avoid conflict", "B. Report the incident to a compliance officer", "C. Change the code but make a note in your personal records", "D. Tell the patient to file a complaint"],
                    answer: "B",
                    explanation: "The most ethical and legally compliant action is to report fraudulent activities, such as upcoding, to a designated compliance officer or legal department. This protects you and the organization."
                },
                // Add more Coding Ethics questions here
            ],
            "Denials & Appeals": [
                {
                    question: "A claim is denied because the diagnosis code does not justify the procedure code. What is this denial reason called?",
                    options: ["A. Medical necessity denial", "B. Bundling issue", "C. Payer policy change", "D. Inconsistent patient information"],
                    answer: "A",
                    explanation: "A denial for 'lack of medical necessity' means the payer believes the procedure performed was not necessary to treat the patient's documented diagnosis. The diagnosis code must support the procedure code."
                },
                {
                    question: "What is the first step in appealing a denied claim?",
                    options: ["A. Resubmit the claim with a new code", "B. Send a letter of protest to the payer's legal department", "C. Review the patient's chart and the denial reason", "D. Bill the patient directly for the full amount"],
                    answer: "C",
                    explanation: "The crucial first step in any appeal is to thoroughly review the patient‚Äôs documentation and compare it against the denial reason provided by the payer. This helps you identify if the issue is a simple coding error or a more complex medical necessity dispute."
                },
                // Add more Denials & Appeals questions here
            ],
            // NEW: Insurance Nuances Quiz Module
            "Insurance Nuances": [
                {
                    question: "Which type of insurance plan typically requires a referral from a Primary Care Provider (PCP) to see a specialist?",
                    options: ["A. PPO", "B. HMO", "C. Medicare Part B", "D. Fee-for-Service"],
                    answer: "B",
                    explanation: "HMO (Health Maintenance Organization) plans generally require a referral from a PCP to see a specialist, as they focus on managed care within a network."
                },
                {
                    question: "When a patient has both active Medicare and Medicaid, which payer is usually considered primary?",
                    options: ["A. Medicaid", "B. Medicare", "C. The patient's choice", "D. Whichever plan has been active longer"],
                    answer: "B",
                    explanation: "Medicare is almost always the primary payer when a patient has both Medicare and Medicaid. Medicaid then acts as the payer of last resort, covering what Medicare doesn't."
                },
                {
                    question: "Medicare Part B typically covers what percentage of approved physician services after the deductible is met?",
                    options: ["A. 100%", "B. 50%", "C. 80%", "D. 20%"],
                    answer: "C",
                    explanation: "Medicare Part B covers 80% of approved physician services after the annual deductible is met, with the patient responsible for the remaining 20% (coinsurance)."
                }
            ]
        };

        // --- Global Data Storage (Patient Balance Calculator) ---
        let currentBalanceScenario = null;
        const patientBalanceScenarios = [
            {
                id: 1,
                patient: "Alex Green",
                plan: {
                    copay: 0,
                    deductible: 1000,
                    deductibleMetToDate: 700,
                    coinsurance: 0.15 // 15%
                },
                visit: {
                    service: "Office visit with minor procedure",
                    allowedAmount: 300
                },
                correct: {
                    copay: 0,
                    deductibleApplied: 300,
                    coinsurance: 0,
                    totalBalance: 300
                },
                calculationSteps: `
                    1. Remaining Deductible: $1,000 (Initial) - $700 (Met to Date) = $300.
                    2. Apply Allowed Amount ($300) to Remaining Deductible ($300). Deductible is now fully met.
                    3. No amount remaining for coinsurance from this visit.
                    4. Total Patient Balance: $300 (Deductible Applied).
                `
            },
            {
                id: 2,
                patient: "Brenda White",
                plan: {
                    copay: 35, // for specialist
                    deductible: 500,
                    deductibleMetToDate: 0,
                    coinsurance: 0.20 // 20%
                },
                visit: {
                    service: "Specialist Consultation",
                    allowedAmount: 250
                },
                correct: {
                    copay: 35,
                    deductibleApplied: 250,
                    coinsurance: 0, // Deductible not fully met, no coinsurance applies yet
                    totalBalance: 285
                },
                calculationSteps: `
                    1. Collect Copay: $35.
                    2. Apply Allowed Amount ($250) to Deductible. Remaining Deductible: $500 - $250 = $250.
                    3. Deductible is not fully met, so no coinsurance applies from this visit.
                    4. Total Patient Balance: $35 (Copay) + $250 (Deductible Applied) = $285.
                `
            },
            {
                id: 3,
                patient: "Chris Johnson",
                plan: {
                    copay: 0,
                    deductible: 1500,
                    deductibleMetToDate: 1500, // Deductible fully met
                    coinsurance: 0.10 // 10%
                },
                visit: {
                    service: "Follow-up Lab Tests",
                    allowedAmount: 100
                },
                correct: {
                    copay: 0,
                    deductibleApplied: 0,
                    coinsurance: 10,
                    totalBalance: 10
                },
                calculationSteps: `
                    1. No Copay.
                    2. Deductible is already fully met. No amount applies to deductible.
                    3. Calculate Coinsurance: $100 (Allowed Amount) * 10% = $10.
                    4. Total Patient Balance: $10 (Coinsurance).
                `
            },
             {
                id: 4,
                patient: "Diana Smith",
                plan: {
                    copay: 20, // for PCP
                    deductible: 750,
                    deductibleMetToDate: 750, // Deductible fully met
                    coinsurance: 0.25 // 25%
                },
                visit: {
                    service: "Primary Care Office Visit",
                    allowedAmount: 90
                },
                correct: {
                    copay: 20,
                    deductibleApplied: 0,
                    coinsurance: 22.50,
                    totalBalance: 42.50
                },
                calculationSteps: `
                    1. Collect Copay: $20.
                    2. Deductible is already fully met. No amount applies to deductible.
                    3. Calculate Coinsurance: $90 (Allowed Amount) * 25% = $22.50.
                    4. Total Patient Balance: $20 (Copay) + $22.50 (Coinsurance) = $42.50.
                `
            }
        ];

        // --- Global Data Storage (NEW Modifier Application Challenge) ---
        let currentModifierScenario = null;
        const modifierScenarios = [
            {
                id: 1,
                scenario: `Patient presents for a routine annual physical exam (CPT 99395). During the same visit, the patient expresses concern about a new, painful mole on their arm. The physician performs a separate, distinct evaluation and management (E/M) service to assess and manage the mole. The E/M service for the mole is significant and separately identifiable from the preventive exam.`,
                cptCodeToInput: "99213", // Problem-focused E/M (e.g., 99213 for mole evaluation)
                correctModifier: "25",
                explanation: "Modifier -25 is used when a significant, separately identifiable Evaluation and Management (E/M) service is performed on the same day as a preventive service or other procedure by the same physician. In this case, the mole evaluation (99213) is separate from the routine physical (99395)."
            },
            {
                id: 2,
                scenario: `A patient undergoes a complex surgical procedure (e.g., CPT 20680 - Removal of implant; deep (e.g., buried) bone fixation material; knee). During the post-operative period (global period) of this surgery, the patient comes back to the office for an E/M visit due to a severe, acute upper respiratory infection, which is completely unrelated to the knee surgery.`,
                cptCodeToInput: "99213", // E/M service for URI
                correctModifier: "24",
                explanation: "Modifier -24 is appended to an E/M service code to indicate that the E/M service was performed during a post-operative global period for a procedure, and the E/M service was unrelated to the original surgical procedure. Here, the URI (99213) is unrelated to the knee surgery (20680)."
            },
            {
                id: 3,
                scenario: `A surgeon performs a diagnostic arthroscopy of the knee (CPT 29870). During the same surgical session, they identify a torn meniscus and immediately perform a meniscectomy (CPT 29881). The diagnostic procedure leads directly to the therapeutic procedure. You should use a modifier that indicates a distinct procedural service.`,
                cptCodeToInput: "29870", // Diagnostic Arthroscopy
                correctModifier: "59",
                explanation: "Modifier -59 (Distinct Procedural Service) is used to identify a procedure or service as distinct or independent from other non-E/M services performed on the same day. In this case, the diagnostic arthroscopy (29870) was distinct and necessary to identify the need for the meniscectomy (29881), even though it was performed in the same session. Many payers bundle diagnostic into therapeutic without -59."
            },
            {
                id: 4,
                scenario: `A patient has a scheduled ultrasound (CPT 76801) for the abdomen. The technical component (use of equipment, technician time) is provided by the facility, but the radiologist provides the professional interpretation of the images. You are billing for the radiologist's service.`,
                cptCodeToInput: "76801", // Ultrasound code
                correctModifier: "26",
                explanation: "Modifier -26 (Professional Component) is used when billing for only the professional (physician‚Äôs) portion of a service that has both technical and professional components, such as radiology or pathology services. The radiologist's interpretation is the professional component."
            },
            {
                id: 5,
                scenario: `A patient is seen for an office visit. During the visit, a minor surgical procedure (CPT 17110 - destruction of benign lesions) is performed. The office visit (CPT 99213) is separate and significant from the procedure performed.`,
                cptCodeToInput: "99213", // E/M service
                correctModifier: "25",
                explanation: "Modifier -25 indicates a significant, separately identifiable evaluation and management service by the same physician on the same day of a procedure. The office visit for general symptoms is distinct from the minor procedure."
            }
        ];


        // --- Utility Functions (general) ---

        /**
         * Displays a message to the user in the message box.
         * @param {string} message - The message to display.
         * @param {string} type - 'success' or 'error' to style the message.
         */
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = `message-box ${type}`; // Reset and apply new classes
            messageBox.style.display = 'block'; // Make visible
            setTimeout(() => {
                messageBox.style.display = 'none'; // Hide after 5 seconds
            }, 5000);
        }

        /**
         * Adds a new input row for diagnoses or procedures.
         */
        function addInputRow(parentList, className, placeholder) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex items-center gap-2';
           
            const input = document.createElement('input');
            input.type = 'text';
            input.className = `${className} flex-grow-1 focus:ring-${parentList.id.includes('diagnosis') ? 'green' : 'green'}-500 focus:border-${parentList.id.includes('diagnosis') ? 'green' : 'green'}-500`;
            input.placeholder = placeholder;
           
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn-secondary remove-item-btn';
            removeBtn.textContent = 'Remove';
            removeBtn.onclick = () => wrapper.remove(); // Remove the entire row when clicked

            wrapper.appendChild(input);
            wrapper.appendChild(removeBtn);
            parentList.appendChild(wrapper);
        }

        /**
         * Adds a new input row for charges (description, CPT, price).
         */
        function addChargeRow() {
            const wrapper = document.createElement('div');
            wrapper.className = 'grid grid-cols-1 md:grid-cols-3 gap-2 service-item';

            const descriptionInput = document.createElement('input');
            descriptionInput.type = 'text';
            descriptionInput.className = 'service-description col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500';
            descriptionInput.placeholder = 'Service Description';

            const cptInput = document.createElement('input');
            cptInput.type = 'text';
            cptInput.className = 'service-cpt-code col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500';
            cptInput.placeholder = 'CPT Code';

            const priceWrapper = document.createElement('div');
            priceWrapper.className = 'flex gap-2 col-span-1 md:col-span-1';

            const priceInput = document.createElement('input');
            priceInput.type = 'number';
            priceInput.className = 'service-price flex-grow-1 focus:ring-purple-500 focus:border-purple-500';
            priceInput.placeholder = 'Price ($)';
            priceInput.min = "0";
            priceInput.step = "0.01";

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn-secondary remove-item-btn';
            removeBtn.textContent = 'Remove';
            removeBtn.onclick = () => wrapper.remove();

            priceWrapper.appendChild(priceInput);
            priceWrapper.appendChild(removeBtn);

            wrapper.appendChild(descriptionInput);
            wrapper.appendChild(cptInput);
            wrapper.appendChild(priceWrapper);
            chargeList.appendChild(wrapper);
        }

        /**
         * Clears all input fields and stored data for the main EHR simulation.
         */
        function clearAllData() {
            // Clear patient data inputs
            patientNameInput.value = '';
            patientDOBInput.value = '';
            insuranceIDInput.value = '';

            // Clear encounter data inputs
            encounterDateInput.value = '';
            chiefComplaintInput.value = '';

            // Remove all dynamically added rows for diagnosis, procedure, and charges
            // Keep one initial empty row for each for user convenience
            diagnosisList.querySelectorAll('.flex.items-center.gap-2').forEach((row, index) => {
                if (index > 0) row.remove();
                else row.querySelector('input').value = '';
            });
            procedureList.querySelectorAll('.flex.items-center.gap-2').forEach((row, index) => {
                if (index > 0) row.remove();
                else row.querySelector('input').value = '';
            });
            chargeList.querySelectorAll('.service-item').forEach((row, index) => {
                if (index > 0) row.remove();
                else {
                    row.querySelector('.service-description').value = '';
                    row.querySelector('.service-cpt-code').value = '';
                    row.querySelector('.service-price').value = '';
                }
            });

            // Clear stored data
            patientData = {};
            diagnoses = [];
            procedures = [];
            charges = {};

            // Clear claim output
            claimOutput.innerHTML = '<p class="text-gray-500">Your simulated claim details will appear here after generation.</p>';
            showMessage('All data cleared!', 'success');
        }


        // --- Event Listeners (existing sections) ---

        registerPatientBtn.addEventListener('click', () => {
            const name = patientNameInput.value.trim();
            const dob = patientDOBInput.value;
            const insurance = insuranceIDInput.value.trim();

            if (!name || !dob || !insurance) {
                showMessage('Please fill in all patient registration fields.', 'error');
                return;
            }

            patientData = {
                name: name,
                dob: dob,
                insuranceID: insurance
            };
            showMessage('Patient registered successfully!', 'success');
        });

        addDiagnosisBtn.addEventListener('click', () => {
            addInputRow(diagnosisList, 'diagnosis-code', 'e.g., J02.9 (Acute pharyngitis)');
        });

        addProcedureBtn.addEventListener('click', () => {
            addInputRow(procedureList, 'procedure-code', 'e.g., 99213 (Office visit)');
        });

        addChargeBtn.addEventListener('click', addChargeRow);

        generateClaimBtn.addEventListener('click', () => {
            // 1. Validate Patient Data
            if (Object.keys(patientData).length === 0 || !patientData.name) {
                showMessage('Please register patient data first.', 'error');
                return;
            }

            // 2. Collect Encounter Data
            const encounterDate = encounterDateInput.value.trim();
            const chiefComplaint = chiefComplaintInput.value.trim();

            if (!encounterDate || !chiefComplaint) {
                showMessage('Please fill in encounter date and chief complaint.', 'error');
                return;
            }

            diagnoses = Array.from(diagnosisList.querySelectorAll('.diagnosis-code'))
                             .map(input => input.value.trim())
                             .filter(value => value !== '');

            procedures = Array.from(procedureList.querySelectorAll('.procedure-code'))
                               .map(input => input.value.trim())
                               .filter(value => value !== '');

            if (diagnoses.length === 0 || procedures.length === 0) {
                showMessage('Please add at least one diagnosis and one procedure.', 'error');
                return;
            }

            // 3. Collect Charge Data
            charges = Array.from(chargeList.querySelectorAll('.service-item')).map(row => {
                return {
                    description: row.querySelector('.service-description').value.trim(),
                    cpt: row.querySelector('.service-cpt-code').value.trim(),
                    price: parseFloat(row.querySelector('.service-price').value) || 0
                };
            }).filter(charge => charge.description !== '' && charge.cpt !== '' && charge.price > 0);

            if (charges.length === 0) {
                showMessage('Please add at least one service with description, CPT, and price.', 'error');
                return;
            }

            // 4. Construct Simulated Claim Output
            let claimText = `--- Simulated Medical Claim ---\n\n`;
            claimText += `PATIENT INFORMATION:\n`;
            claimText += `  Name: ${patientData.name}\n`;
            claimText += `  DOB: ${patientData.dob}\n`;
            claimText += `  Insurance ID: ${patientData.insuranceID}\n\n`;

            claimText += `ENCOUNTER DETAILS:\n`;
            claimText += `  Date: ${encounterDate}\n`;
            claimText += `  Chief Complaint: ${chiefComplaint}\n\n`;

            claimText += `DIAGNOSES (ICD CODES):\n`;
            if (diagnoses.length > 0) {
                diagnoses.forEach(diag => claimText += `  - ${diag}\n`);
            } else {
                claimText += `  (No diagnoses entered)\n`;
            }
            claimText += `\n`;

            claimText += `PROCEDURES (CPT/HCPCS CODES):\n`;
            if (procedures.length > 0) {
                procedures.forEach(proc => claimText += `  - ${proc}\n`);
            } else {
                claimText += `  (No procedures entered)\n`;
            }
            claimText += `\n`;

            claimText += `SERVICES & CHARGES:\n`;
            let totalAmount = 0;
            if (charges.length > 0) {
                charges.forEach(charge => {
                    claimText += `  - ${charge.description} (CPT: ${charge.cpt}) - $${charge.price.toFixed(2)}\n`;
                    totalAmount += charge.price;
                });
            } else {
                claimText += `  (No charges entered)\n`;
            }
            claimText += `\nTOTAL CHARGE: $${totalAmount.toFixed(2)}\n`;
            claimText += `\n--- End of Claim ---`;

            claimOutput.textContent = claimText;
            showMessage('Claim generated successfully!', 'success');
        });

        clearAllBtn.addEventListener('click', clearAllData);

        // Initial setup to ensure one input row is always present for existing sections
        window.onload = () => {
            if (diagnosisList.querySelectorAll('.diagnosis-code').length === 0) {
                addInputRow(diagnosisList, 'diagnosis-code', 'e.g., J02.9 (Acute pharyngitis)');
            }
            if (procedureList.querySelectorAll('.procedure-code').length === 0) {
                addInputRow(procedureList, 'procedure-code', 'e.g., 99213 (Office visit)');
            }
            if (chargeList.querySelectorAll('.service-item').length === 0) {
                addChargeRow();
            }
            // Initialize walkthroughs
            resetBillingWalkthrough();
            resetPaWalkthrough();
            // Hide quiz content by default
            quizContent.classList.add('hidden');
            // Hide balance calculator content by default
            balanceCalculatorContent.classList.add('hidden');
            // Hide modifier challenge content by default
            modifierChallengeContent.classList.add('hidden');
        };

        // --- Medical Billing Walkthrough Logic ---
        startBillingWalkthroughBtn.addEventListener('click', () => {
            currentBillingStep = 0; // Start from the first step
            displayBillingStep();
            startBillingWalkthroughBtn.classList.add('hidden');
            nextBillingWalkthroughBtn.classList.remove('hidden');
            resetBillingWalkthroughBtn.classList.remove('hidden');
            billingWalkthroughContent.classList.remove('hidden');
        });

        nextBillingWalkthroughBtn.addEventListener('click', () => {
            currentBillingStep++;
            if (currentBillingStep < billingSteps.length) {
                displayBillingStep();
            } else {
                walkthroughStepTitle.textContent = "Walkthrough Complete!";
                walkthroughStepInstructions.innerHTML = `<p class="text-green-700 font-bold">You've successfully reviewed all steps of the Medical Billing Revenue Cycle. Click 'Reset Walkthrough' to start again.</p>`;
                nextBillingWalkthroughBtn.classList.add('hidden');
            }
        });

        resetBillingWalkthroughBtn.addEventListener('click', resetBillingWalkthrough);

        function displayBillingStep() {
            const step = billingSteps[currentBillingStep];
            walkthroughStepTitle.textContent = step.title;
            walkthroughStepInstructions.innerHTML = step.instructions;
        }

        function resetBillingWalkthrough() {
            currentBillingStep = 0;
            billingWalkthroughContent.classList.add('hidden');
            startBillingWalkthroughBtn.classList.remove('hidden');
            nextBillingWalkthroughBtn.classList.add('hidden');
            resetBillingWalkthroughBtn.classList.add('hidden');
            walkthroughStepTitle.textContent = '';
            walkthroughStepInstructions.innerHTML = '';
            showMessage('Medical Billing Walkthrough Reset.', 'success');
        }

        // --- Prior Authorization Walkthrough Logic ---
        startPaWalkthroughBtn.addEventListener('click', () => {
            currentPaStep = 0; // Start from the first step
            displayPaStep();
            startPaWalkthroughBtn.classList.add('hidden');
            nextPaWalkthroughBtn.classList.remove('hidden');
            resetPaWalkthroughBtn.classList.remove('hidden');
            paWalkthroughContent.classList.remove('hidden');
        });

        nextPaWalkthroughBtn.addEventListener('click', () => {
            currentPaStep++;
            if (currentPaStep < paSteps.length) {
                displayPaStep();
            } else {
                paWalkthroughStepTitle.textContent = "PA Walkthrough Complete!";
                paWalkthroughStepInstructions.innerHTML = `<p class="text-green-700 font-bold">You've successfully reviewed the Prior Authorization process. Click 'Reset Walkthrough' to start again.</p>`;
                nextPaWalkthroughBtn.classList.add('hidden');
            }
        });

        resetPaWalkthroughBtn.addEventListener('click', resetPaWalkthrough);

        function displayPaStep() {
            const step = paSteps[currentPaStep];
            paWalkthroughStepTitle.textContent = step.title;
            paWalkthroughStepInstructions.innerHTML = step.instructions;
        }

        function resetPaWalkthrough() {
            currentPaStep = 0;
            paWalkthroughContent.classList.add('hidden');
            startPaWalkthroughBtn.classList.remove('hidden');
            nextPaWalkthroughBtn.classList.add('hidden');
            resetPaWalkthroughBtn.classList.add('hidden');
            paWalkthroughStepTitle.textContent = '';
            paWalkthroughStepInstructions.innerHTML = '';
            showMessage('Prior Authorization Walkthrough Reset.', 'success');
        }

        // --- Knowledge Quizzes Logic ---
        let selectedQuizModule = null; // Stores the array of questions for the current module
        let currentQuizQuestionIndex = 0; // Tracks the current question in the module

        // Function to load a specific quiz module
        function loadQuizModule(moduleName) {
            quizContent.classList.remove('hidden');
            quizFeedback.innerHTML = '<p class="text-gray-500 quiz-feedback-text">Your feedback will appear here.</p>';
            currentQuizModule = quizModules[moduleName];
            currentQuizQuestionIndex = 0;
            displayQuizQuestion();
            submitAnswerBtn.classList.remove('hidden');
            nextQuestionBtn.classList.add('hidden');
            resetQuizBtn.classList.remove('hidden');
        }

        // Function to display the current quiz question
        function displayQuizQuestion() {
            if (!currentQuizModule || currentQuizQuestionIndex >= currentQuizModule.length) {
                quizQuestionTitle.textContent = "Quiz Complete!";
                quizOptions.innerHTML = `<p class="text-green-700 font-bold">You've completed this quiz module! Click 'Reset Quiz' or select another module.</p>`;
                submitAnswerBtn.classList.add('hidden');
                nextQuestionBtn.classList.add('hidden');
                return;
            }

            const questionData = currentQuizModule[currentQuizQuestionIndex];
            quizQuestionTitle.textContent = `Question ${currentQuizQuestionIndex + 1}: ${questionData.question}`;
            quizOptions.innerHTML = ''; // Clear previous options
            quizFeedback.innerHTML = '<p class="text-gray-500 quiz-feedback-text">Your feedback will appear here.</p>'; // Clear feedback for new question

            questionData.options.forEach((option, index) => {
                const label = document.createElement('label');
                label.className = 'quiz-option';
                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'quizAnswer';
                input.value = option.charAt(0); // Get the A, B, C, D part
                label.appendChild(input);
                label.appendChild(document.createTextNode(option));
                quizOptions.appendChild(label);
            });

            submitAnswerBtn.classList.remove('hidden');
            nextQuestionBtn.classList.add('hidden');
        }

        // Function to check the user's answer
        submitAnswerBtn.addEventListener('click', () => {
            const selectedOption = document.querySelector('input[name="quizAnswer"]:checked');
            if (!selectedOption) {
                quizFeedback.innerHTML = '<p class="text-red-700 quiz-feedback-text">Please select an answer.</p>';
                return;
            }

            const userAnswer = selectedOption.value;
            const correctAnswer = currentQuizModule[currentQuizQuestionIndex].answer;
            const explanation = currentQuizModule[currentQuizQuestionIndex].explanation;

            if (userAnswer === correctAnswer) {
                quizFeedback.innerHTML = `<p class="text-green-700 font-bold">Correct! Excellent job.</p><p class="quiz-feedback-text">Explanation: ${explanation}</p>`;
            } else {
                quizFeedback.innerHTML = `<p class="text-red-700 font-bold">Incorrect. Here's why:</p><p class="quiz-feedback-text">Explanation: ${explanation}</p>`;
            }

            submitAnswerBtn.classList.add('hidden');
            nextQuestionBtn.classList.remove('hidden');

            // Disable all radio buttons after submission
            quizOptions.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = true);
        });

        // Function to move to the next question
        nextQuestionBtn.addEventListener('click', () => {
            currentQuizQuestionIndex++;
            displayQuizQuestion();
        });

        // Function to reset the current quiz module
        resetQuizBtn.addEventListener('click', () => {
            currentQuizQuestionIndex = 0;
            displayQuizQuestion(); // Start from the beginning of the current module
            quizFeedback.innerHTML = '<p class="text-gray-500 quiz-feedback-text">Your feedback will appear here.</p>';
            submitAnswerBtn.classList.remove('hidden');
            nextQuestionBtn.classList.add('hidden');
            // Re-enable radio buttons for the new question
            quizOptions.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = false);
        });

        // Event listeners for quiz module selection buttons
        quizGuidelinesBtn.addEventListener('click', () => loadQuizModule("Coding Guidelines"));
        quizLawsBtn.addEventListener('click', () => loadQuizModule("Healthcare Laws"));
        quizEthicsBtn.addEventListener('click', () => loadQuizModule("Coding Ethics"));
        quizDenialsBtn.addEventListener('click', () => loadQuizModule("Denials & Appeals"));
        quizInsuranceNuanceBtn.addEventListener('click', () => loadQuizModule("Insurance Nuances")); // NEW

        // --- Patient Balance Calculator Logic ---
        let currentBalanceScenarioData = null;

        loadBalanceScenarioBtn.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * patientBalanceScenarios.length);
            currentBalanceScenarioData = patientBalanceScenarios[randomIndex];
            
            balanceCalculatorContent.classList.remove('hidden');
            balanceScenarioTitle.textContent = `Scenario for ${currentBalanceScenarioData.patient}:`;
            balanceScenarioDetails.innerHTML = `
                <p><strong>Plan Details:</strong></p>
                <ul>
                    <li>Copay: $${currentBalanceScenarioData.plan.copay.toFixed(2)}</li>
                    <li>Deductible: $${currentBalanceScenarioData.plan.deductible.toFixed(2)}</li>
                    <li>Deductible Met to Date: $${currentBalanceScenarioData.plan.deductibleMetToDate.toFixed(2)}</li>
                    <li>Coinsurance: ${(currentBalanceScenarioData.plan.coinsurance * 100).toFixed(0)}%</li>
                </ul>
                <p><strong>Visit Details:</strong></p>
                <ul>
                    <li>Service: ${currentBalanceScenarioData.visit.service}</li>
                    <li>Total Allowed Amount by Insurance: $${currentBalanceScenarioData.visit.allowedAmount.toFixed(2)}</li>
                </ul>
                <p class="font-bold mt-2">Calculate the Patient's Responsibility:</p>
            `;
            resetBalanceCalculator(); // Reset inputs and feedback
            checkBalanceBtn.classList.remove('hidden');
            resetBalanceBtn.classList.remove('hidden');
        });

        checkBalanceBtn.addEventListener('click', () => {
            if (!currentBalanceScenarioData) {
                balanceFeedback.innerHTML = '<p class="text-red-700 balance-feedback-text">Please load a scenario first!</p>';
                return;
            }

            const userCopay = parseFloat(userCopayInput.value);
            const userDeductibleApplied = parseFloat(userDeductibleInput.value);
            const userCoinsurance = parseFloat(userCoinsuranceInput.value);
            const userTotalBalance = parseFloat(userTotalBalanceInput.value);

            let feedbackHtml = '';
            let allCorrect = true;

            // Check Copay
            if (userCopay === currentBalanceScenarioData.correct.copay) {
                feedbackHtml += `<p class="text-green-700">Copay: Correct! ($${currentBalanceScenarioData.correct.copay.toFixed(2)})</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Copay: Incorrect. Expected $${currentBalanceScenarioData.correct.copay.toFixed(2)}.</p>`;
                allCorrect = false;
            }

            // Check Deductible Applied
            if (userDeductibleApplied === currentBalanceScenarioData.correct.deductibleApplied) {
                feedbackHtml += `<p class="text-green-700">Deductible Applied: Correct! ($${currentBalanceScenarioData.correct.deductibleApplied.toFixed(2)})</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Deductible Applied: Incorrect. Expected $${currentBalanceScenarioData.correct.deductibleApplied.toFixed(2)}.</p>`;
                allCorrect = false;
            }

            // Check Coinsurance
            if (userCoinsurance === currentBalanceScenarioData.correct.coinsurance) {
                feedbackHtml += `<p class="text-green-700">Coinsurance: Correct! ($${currentBalanceScenarioData.correct.coinsurance.toFixed(2)})</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700">Coinsurance: Incorrect. Expected $${currentBalanceScenarioData.correct.coinsurance.toFixed(2)}.</p>`;
                allCorrect = false;
            }

            // Check Total Patient Balance
            if (userTotalBalance === currentBalanceScenarioData.correct.totalBalance) {
                feedbackHtml += `<p class="text-green-700 font-bold mt-2">Total Patient Balance: Correct! ($${currentBalanceScenarioData.correct.totalBalance.toFixed(2)})</p>`;
            } else {
                feedbackHtml += `<p class="text-red-700 font-bold mt-2">Total Patient Balance: Incorrect. Expected $${currentBalanceScenarioData.correct.totalBalance.toFixed(2)}.</p>`;
                allCorrect = false;
            }

            // Overall feedback and detailed steps if incorrect
            if (!allCorrect) {
                feedbackHtml += `<p class="text-gray-700 mt-4 font-bold">Here's a breakdown of the correct calculation:</p>`;
                feedbackHtml += `<pre class="bg-gray-100 p-2 rounded text-xs mt-1 whitespace-pre-wrap">${currentBalanceScenarioData.calculationSteps.trim()}</pre>`;
                balanceFeedback.className = 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
            } else {
                 balanceFeedback.className = 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]';
            }
            
            balanceFeedback.innerHTML = feedbackHtml;
        });

        resetBalanceBtn.addEventListener('click', resetBalanceCalculator);

        function resetBalanceCalculator() {
            userCopayInput.value = '';
            userDeductibleInput.value = '';
            userCoinsuranceInput.value = '';
            userTotalBalanceInput.value = '';
            balanceFeedback.innerHTML = '<p class="text-gray-500 balance-feedback-text">Feedback on your calculation will appear here.</p>';
            balanceFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
        }

        // --- NEW Modifier Application Challenge Logic ---
        let currentModifierChallenge = null;

        loadModifierScenarioBtn.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * modifierScenarios.length);
            currentModifierChallenge = modifierScenarios[randomIndex];
            
            modifierChallengeContent.classList.remove('hidden');
            modifierScenarioTitle.textContent = `Scenario: ${currentModifierChallenge.id}`;
            modifierScenarioDetails.innerHTML = `<p class="text-sm text-yellow-800 italic">${currentModifierChallenge.scenario}</p>
                <p class="mt-2"><strong>Required CPT Code to Input:</strong> ${currentModifierChallenge.cptCodeToInput}</p>
                <p class="font-bold mt-2">Enter the CPT Code (if different from the required) and the appropriate Modifier(s).</p>
            `;
            userModifierCPTInput.value = '';
            userModifierInput.value = '';
            modifierFeedback.innerHTML = '<p class="text-gray-500 modifier-feedback-text">Feedback on your modifier application will appear here.</p>';
            modifierFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
            checkModifierBtn.classList.remove('hidden');
            resetModifierBtn.classList.remove('hidden');
        });

        checkModifierBtn.addEventListener('click', () => {
            if (!currentModifierChallenge) {
                modifierFeedback.innerHTML = '<p class="text-red-700 modifier-feedback-text">Please load a scenario first!</p>';
                return;
            }

            const userCPT = userModifierCPTInput.value.trim().toUpperCase();
            const userMod = userModifierInput.value.trim().toUpperCase();

            let feedbackHtml = '';
            let isCorrect = true;

            // Check CPT code
            if (userCPT !== currentModifierChallenge.cptCodeToInput.trim().toUpperCase()) {
                feedbackHtml += `<p class="text-red-700">CPT Code: Incorrect. Expected "${currentModifierChallenge.cptCodeToInput}".</p>`;
                isCorrect = false;
            } else {
                feedbackHtml += `<p class="text-green-700">CPT Code: Correct! ("${currentModifierChallenge.cptCodeToInput}")</p>`;
            }

            // Check Modifier
            if (userMod !== currentModifierChallenge.correctModifier.trim().toUpperCase()) {
                feedbackHtml += `<p class="text-red-700">Modifier: Incorrect. Expected "${currentModifierChallenge.correctModifier}".</p>`;
                isCorrect = false;
            } else {
                feedbackHtml += `<p class="text-green-700">Modifier: Correct! ("${currentModifierChallenge.correctModifier}")</p>`;
            }

            if (isCorrect) {
                modifierFeedback.innerHTML = `<p class="text-green-700 font-bold">Excellent! Your CPT code and modifier application are correct.</p>`;
            } else {
                modifierFeedback.innerHTML += `<p class="text-gray-700 mt-4 font-bold">Explanation:</p><p class="modifier-feedback-text">${currentModifierChallenge.explanation}</p>`;
            }
            modifierFeedback.className = isCorrect ? 'bg-green-50 p-3 rounded-lg border border-green-200 mt-4 min-h-[80px]' : 'bg-red-50 p-3 rounded-lg border border-red-200 mt-4 min-h-[80px]';
        });

        resetModifierBtn.addEventListener('click', () => {
            userModifierCPTInput.value = '';
            userModifierInput.value = '';
            modifierFeedback.innerHTML = '<p class="text-gray-500 modifier-feedback-text">Feedback on your modifier application will appear here.</p>';
            modifierFeedback.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 mt-4 min-h-[80px]'; // Reset styling
            checkModifierBtn.classList.remove('hidden');
            resetModifierBtn.classList.remove('hidden');
        });

    </script>
</body>
</html>
