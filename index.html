<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EHR Simulator for Medical Billing Practice</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }
        input[type="text"], input[type="date"], input[type="number"], textarea {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
            padding: 8px 14px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.875rem; /* text-sm */
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .message-box {
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
            display: none; /* Hidden by default */
        }
        .message-box.success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .message-box.error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .flex-grow-1 { /* Custom utility to make item grow */
            flex-grow: 1;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }

        /* Safari */
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container">
        <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-8">EHR Practice System</h1>

        <!-- Message Box for user feedback -->
        <div id="messageBox" class="message-box"></div>

        <!-- Patient Registration Section -->
        <section class="mb-8 p-6 bg-blue-50 rounded-lg">
            <h2 class="section-title text-blue-800">1. Patient Registration üìù</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="patientName" class="block text-gray-700 text-sm font-bold mb-2">Patient Name:</label>
                    <input type="text" id="patientName" placeholder="John Doe" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="patientDOB" class="block text-gray-700 text-sm font-bold mb-2">Date of Birth:</label>
                    <input type="date" id="patientDOB" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label for="insuranceID" class="block text-gray-700 text-sm font-bold mb-2">Insurance ID:</label>
                    <input type="text" id="insuranceID" placeholder="ABC123456789" class="focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <button id="registerPatientBtn" class="btn-primary w-full">Register Patient</button>
        </section>

        <!-- Encounter Documentation Section -->
        <section class="mb-8 p-6 bg-green-50 rounded-lg">
            <h2 class="section-title text-green-800">2. Encounter Documentation ü©∫</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="encounterDate" class="block text-gray-700 text-sm font-bold mb-2">Encounter Date:</label>
                    <input type="date" id="encounterDate" class="focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="md:col-span-2">
                    <label for="chiefComplaint" class="block text-gray-700 text-sm font-bold mb-2">Chief Complaint:</label>
                    <input type="text" id="chiefComplaint" placeholder="Patient reports sore throat and fever" class="focus:ring-green-500 focus:border-green-500">
                </div>
            </div>

            <div id="diagnosisList" class="mb-4 space-y-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Diagnoses (ICD Codes):</label>
                <div class="flex items-center gap-2">
                    <input type="text" class="diagnosis-code flex-grow-1 focus:ring-green-500 focus:border-green-500" placeholder="e.g., J02.9 (Acute pharyngitis)">
                    <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                </div>
            </div>
            <button id="addDiagnosisBtn" class="btn-primary mb-6 w-full bg-green-600 hover:bg-green-700">Add Another Diagnosis</button>

            <div id="procedureList" class="mb-4 space-y-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Procedures (CPT/HCPCS Codes):</label>
                <div class="flex items-center gap-2">
                    <input type="text" class="procedure-code flex-grow-1 focus:ring-green-500 focus:border-green-500" placeholder="e.g., 99213 (Office visit)">
                    <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                </div>
            </div>
            <button id="addProcedureBtn" class="btn-primary w-full bg-green-600 hover:bg-green-700">Add Another Procedure</button>
        </section>

        <!-- Charge Entry Section -->
        <section class="mb-8 p-6 bg-purple-50 rounded-lg">
            <h2 class="section-title text-purple-800">3. Charge Entry & Services üí≤</h2>
            <div id="chargeList" class="mb-4 space-y-3">
                <label class="block text-gray-700 text-sm font-bold mb-2">Services Rendered:</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 service-item">
                    <input type="text" class="service-description col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500" placeholder="Service Description">
                    <input type="text" class="service-cpt-code col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500" placeholder="CPT Code">
                    <div class="flex gap-2 col-span-1 md:col-span-1">
                        <input type="number" class="service-price flex-grow-1 focus:ring-purple-500 focus:border-purple-500" placeholder="Price ($)" min="0" step="0.01">
                        <button type="button" class="btn-secondary remove-item-btn">Remove</button>
                    </div>
                </div>
            </div>
            <button id="addChargeBtn" class="btn-primary w-full bg-purple-600 hover:bg-purple-700">Add Another Service</button>
        </section>

        <!-- Generate Claim Section -->
        <section class="p-6 bg-red-50 rounded-lg mb-8">
            <h2 class="section-title text-red-800">4. Generate & View Claim üìÑ</h2>
            <button id="generateClaimBtn" class="btn-primary w-full mb-6 bg-red-600 hover:bg-red-700">Generate Simulated Claim</button>

            <div id="claimOutput" class="bg-gray-50 p-4 border border-gray-200 rounded-lg min-h-[150px] overflow-auto text-sm text-gray-800 whitespace-pre-wrap">
                <!-- Claim data will appear here -->
                <p class="text-gray-500">Your simulated claim details will appear here after generation.</p>
            </div>
            <button id="clearAllBtn" class="btn-secondary w-full mt-4">Clear All Data</button>
        </section>

        <!-- New: Coding Challenge Section -->
        <section class="p-6 bg-yellow-50 rounded-lg">
            <h2 class="section-title text-yellow-800">5. Coding Challenge! üß†</h2>
            <p class="text-gray-700 mb-4">Read the medical report below and enter the appropriate ICD-10 and CPT codes. Then click "Check My Codes" for feedback!</p>

            <div class="bg-yellow-100 p-4 rounded-lg border border-yellow-200 mb-6">
                <h3 class="font-bold text-yellow-900 mb-2">Medical Report Scenario:</h3>
                <p id="medicalReportScenario" class="text-sm text-yellow-800 min-h-[100px] italic">
                    Click "Load New Challenge" to begin.
                </p>
            </div>

            <button id="loadChallengeBtn" class="btn-primary w-full mb-6 bg-yellow-600 hover:bg-yellow-700">Load New Challenge</button>

            <div class="mb-4">
                <label for="userICDCodes" class="block text-gray-700 text-sm font-bold mb-2">Your ICD-10 Codes (comma-separated):</label>
                <input type="text" id="userICDCodes" placeholder="e.g., J02.9, R05" class="focus:ring-yellow-500 focus:border-yellow-500">
            </div>
            <div class="mb-6">
                <label for="userCPTCodes" class="block text-gray-700 text-sm font-bold mb-2">Your CPT Codes (comma-separated):</label>
                <input type="text" id="userCPTCodes" placeholder="e.g., 99213" class="focus:ring-yellow-500 focus:border-yellow-500">
            </div>

            <button id="checkCodesBtn" class="btn-primary w-full mb-6 bg-yellow-600 hover:bg-yellow-700 flex items-center justify-center gap-2">
                <span id="checkCodesText">Check My Codes</span>
                <div id="loadingSpinner" class="loading-spinner hidden"></div>
            </button>

            <div id="codingFeedback" class="bg-gray-50 p-4 border border-gray-200 rounded-lg min-h-[150px] overflow-auto text-sm text-gray-800 whitespace-pre-wrap">
                <!-- Coding feedback will appear here -->
                <p class="text-gray-500">Feedback on your coding will appear here.</p>
            </div>
        </section>
    </div>

    <script>
        // DOM Element References (existing sections)
        const patientNameInput = document.getElementById('patientName');
        const patientDOBInput = document.getElementById('patientDOB');
        const insuranceIDInput = document.getElementById('insuranceID');
        const registerPatientBtn = document.getElementById('registerPatientBtn');

        const encounterDateInput = document.getElementById('encounterDate');
        const chiefComplaintInput = document.getElementById('chiefComplaint');
        const diagnosisList = document.getElementById('diagnosisList');
        const addDiagnosisBtn = document.getElementById('addDiagnosisBtn');
        const procedureList = document.getElementById('procedureList');
        const addProcedureBtn = document.getElementById('addProcedureBtn');

        const chargeList = document.getElementById('chargeList');
        const addChargeBtn = document.getElementById('addChargeBtn');

        const generateClaimBtn = document.getElementById('generateClaimBtn');
        const claimOutput = document.getElementById('claimOutput');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const messageBox = document.getElementById('messageBox');

        // DOM Element References (NEW Coding Challenge section)
        const medicalReportScenarioEl = document.getElementById('medicalReportScenario');
        const loadChallengeBtn = document.getElementById('loadChallengeBtn');
        const userICDCodesInput = document.getElementById('userICDCodes');
        const userCPTCodesInput = document.getElementById('userCPTCodes');
        const checkCodesBtn = document.getElementById('checkCodesBtn');
        const checkCodesText = document.getElementById('checkCodesText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const codingFeedbackEl = document.getElementById('codingFeedback');

        // --- Global Data Storage (for existing simulation) ---
        let patientData = {};
        let diagnoses = [];
        let procedures = [];
        let charges = [];

        // --- Global Data Storage (NEW Coding Challenge) ---
        let currentChallenge = null;
        const medicalReportScenarios = [
            {
                id: 1,
                reportText: `Patient presents with a persistent cough and sore throat for 5 days. Patient denies fever or shortness of breath. On examination, pharynx is red, tonsils are mildly swollen. Lungs clear to auscultation. Diagnosis: Acute pharyngitis. Management: Advised rest, fluids, and over-the-counter pain relievers.`,
                correctICD: ['J02.9'], // Acute pharyngitis, unspecified
                correctCPT: ['99213']  // Established patient office visit, 20-29 minutes
            },
            {
                id: 2,
                reportText: `New patient appointment. Chief complaint: Severe headache, pulsatile, located on left side of head. Associated with photophobia and phonophobia. Nausea present. Duration: 3 hours. Patient states this is typical for her migraines. No focal neurological deficits noted. Diagnosis: Migraine without aura.`,
                correctICD: ['G43.009'], // Migraine without aura, not intractable, without status migrainosus
                correctCPT: ['99203']  // New patient office visit, 30-44 minutes
            },
            {
                id: 3,
                reportText: `Established patient here for annual wellness visit. Patient denies any new concerns. Comprehensive preventative counseling provided. Blood pressure 120/80. No abnormal findings on exam. Patient also reports mild knee pain for 2 weeks after a fall, but states it's improving. Exam of knee shows mild tenderness, no swelling. X-ray of knee ordered.`,
                correctICD: ['Z00.00', 'M25.569'], // Z00.00: Encounter for general adult medical examination without abnormal findings; M25.569: Pain in unspecified knee
                correctCPT: ['99396', '99213-25'] // 99396: Preventive medicine reevaluation; 99213-25: Established patient E/M for separate problem
            },
            {
                id: 4,
                reportText: `Patient seen via telehealth (audio/video). Chief complaint: Follow-up for uncontrolled Type 2 Diabetes Mellitus. Patient reports difficulty managing blood sugar levels despite current medication regimen. Medication dosages adjusted. Education provided on diet and exercise. Next follow-up in 3 months.`,
                correctICD: ['E11.9'], // Type 2 diabetes mellitus without complications
                correctCPT: ['99214-95'] // Established patient office visit (30-39 min) via telehealth
            }
        ];

        // --- Utility Functions ---

        /**
         * Displays a message to the user in the message box.
         * @param {string} message - The message to display.
         * @param {string} type - 'success' or 'error' to style the message.
         */
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = `message-box ${type}`; // Reset and apply new classes
            messageBox.style.display = 'block'; // Make visible
            setTimeout(() => {
                messageBox.style.display = 'none'; // Hide after 5 seconds
            }, 5000);
        }

        /**
         * Adds a new input row for diagnoses or procedures.
         * @param {HTMLElement} parentList - The parent container (diagnosisList or procedureList).
         * @param {string} className - The class for the input element (e.g., 'diagnosis-code').
         * @param {string} placeholder - Placeholder text for the input.
         */
        function addInputRow(parentList, className, placeholder) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex items-center gap-2';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = `${className} flex-grow-1 focus:ring-${parentList.id.includes('diagnosis') ? 'green' : 'green'}-500 focus:border-${parentList.id.includes('diagnosis') ? 'green' : 'green'}-500`;
            input.placeholder = placeholder;
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn-secondary remove-item-btn';
            removeBtn.textContent = 'Remove';
            removeBtn.onclick = () => wrapper.remove(); // Remove the entire row when clicked

            wrapper.appendChild(input);
            wrapper.appendChild(removeBtn);
            parentList.appendChild(wrapper);
        }

        /**
         * Adds a new input row for charges (description, CPT, price).
         */
        function addChargeRow() {
            const wrapper = document.createElement('div');
            wrapper.className = 'grid grid-cols-1 md:grid-cols-3 gap-2 service-item';

            const descriptionInput = document.createElement('input');
            descriptionInput.type = 'text';
            descriptionInput.className = 'service-description col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500';
            descriptionInput.placeholder = 'Service Description';

            const cptInput = document.createElement('input');
            cptInput.type = 'text';
            cptInput.className = 'service-cpt-code col-span-1 md:col-span-1 focus:ring-purple-500 focus:border-purple-500';
            cptInput.placeholder = 'CPT Code';

            const priceWrapper = document.createElement('div');
            priceWrapper.className = 'flex gap-2 col-span-1 md:col-span-1';

            const priceInput = document.createElement('input');
            priceInput.type = 'number';
            priceInput.className = 'service-price flex-grow-1 focus:ring-purple-500 focus:border-purple-500';
            priceInput.placeholder = 'Price ($)';
            priceInput.min = "0";
            priceInput.step = "0.01";

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn-secondary remove-item-btn';
            removeBtn.textContent = 'Remove';
            removeBtn.onclick = () => wrapper.remove();

            priceWrapper.appendChild(priceInput);
            priceWrapper.appendChild(removeBtn);

            wrapper.appendChild(descriptionInput);
            wrapper.appendChild(cptInput);
            wrapper.appendChild(priceWrapper);
            chargeList.appendChild(wrapper);
        }

        /**
         * Clears all input fields and stored data for the main EHR simulation.
         */
        function clearAllData() {
            // Clear patient data inputs
            patientNameInput.value = '';
            patientDOBInput.value = '';
            insuranceIDInput.value = '';

            // Clear encounter data inputs
            encounterDateInput.value = '';
            chiefComplaintInput.value = '';

            // Remove all dynamically added rows for diagnosis, procedure, and charges
            // Keep one initial empty row for each for user convenience
            diagnosisList.querySelectorAll('.flex.items-center.gap-2').forEach((row, index) => {
                if (index > 0) row.remove();
                else row.querySelector('input').value = '';
            });
            procedureList.querySelectorAll('.flex.items-center.gap-2').forEach((row, index) => {
                if (index > 0) row.remove();
                else row.querySelector('input').value = '';
            });
            chargeList.querySelectorAll('.service-item').forEach((row, index) => {
                if (index > 0) row.remove();
                else {
                    row.querySelector('.service-description').value = '';
                    row.querySelector('.service-cpt-code').value = '';
                    row.querySelector('.service-price').value = '';
                }
            });

            // Clear stored data
            patientData = {};
            diagnoses = [];
            procedures = [];
            charges = [];

            // Clear claim output
            claimOutput.innerHTML = '<p class="text-gray-500">Your simulated claim details will appear here after generation.</p>';
            showMessage('All data cleared!', 'success');
        }

        /**
         * Compares two arrays of strings, ignoring order and case, and trims whitespace.
         * @param {string[]} arr1
         * @param {string[]} arr2
         * @returns {boolean} True if arrays contain the same elements (ignoring order/case), false otherwise.
         */
        function compareCodeArrays(arr1, arr2) {
            const normalize = (arr) => arr.map(s => s.trim().toUpperCase()).sort();
            const n1 = normalize(arr1);
            const n2 = normalize(arr2);
            return n1.length === n2.length && n1.every((value, index) => value === n2[index]);
        }

        /**
         * Exponential backoff for API calls.
         * @param {function} fn - The function to retry.
         * @param {number} retries - Number of retries remaining.
         * @param {number} delay - Current delay in milliseconds.
         */
        async function exponentialBackoff(fn, retries = 5, delay = 1000) {
            try {
                return await fn();
            } catch (error) {
                if (retries > 0) {
                    // console.warn(`Retrying in ${delay / 1000}s... Attempts left: ${retries}`);
                    await new Promise(res => setTimeout(res, delay));
                    return exponentialBackoff(fn, retries - 1, delay * 2);
                } else {
                    throw error;
                }
            }
        }


        // --- Event Listeners (existing sections) ---

        registerPatientBtn.addEventListener('click', () => {
            const name = patientNameInput.value.trim();
            const dob = patientDOBInput.value;
            const insurance = insuranceIDInput.value.trim();

            if (!name || !dob || !insurance) {
                showMessage('Please fill in all patient registration fields.', 'error');
                return;
            }

            patientData = {
                name: name,
                dob: dob,
                insuranceID: insurance
            };
            showMessage('Patient registered successfully!', 'success');
        });

        addDiagnosisBtn.addEventListener('click', () => {
            addInputRow(diagnosisList, 'diagnosis-code', 'e.g., J02.9 (Acute pharyngitis)');
        });

        addProcedureBtn.addEventListener('click', () => {
            addInputRow(procedureList, 'procedure-code', 'e.g., 99213 (Office visit)');
        });

        addChargeBtn.addEventListener('click', addChargeRow);

        generateClaimBtn.addEventListener('click', () => {
            // 1. Validate Patient Data
            if (Object.keys(patientData).length === 0 || !patientData.name) {
                showMessage('Please register patient data first.', 'error');
                return;
            }

            // 2. Collect Encounter Data
            const encounterDate = encounterDateInput.value.trim();
            const chiefComplaint = chiefComplaintInput.value.trim();

            if (!encounterDate || !chiefComplaint) {
                showMessage('Please fill in encounter date and chief complaint.', 'error');
                return;
            }

            diagnoses = Array.from(diagnosisList.querySelectorAll('.diagnosis-code'))
                             .map(input => input.value.trim())
                             .filter(value => value !== '');

            procedures = Array.from(procedureList.querySelectorAll('.procedure-code'))
                               .map(input => input.value.trim())
                               .filter(value => value !== '');

            if (diagnoses.length === 0 || procedures.length === 0) {
                showMessage('Please add at least one diagnosis and one procedure.', 'error');
                return;
            }

            // 3. Collect Charge Data
            charges = Array.from(chargeList.querySelectorAll('.service-item')).map(row => {
                return {
                    description: row.querySelector('.service-description').value.trim(),
                    cpt: row.querySelector('.service-cpt-code').value.trim(),
                    price: parseFloat(row.querySelector('.service-price').value) || 0
                };
            }).filter(charge => charge.description !== '' && charge.cpt !== '' && charge.price > 0);

            if (charges.length === 0) {
                showMessage('Please add at least one service with description, CPT, and price.', 'error');
                return;
            }

            // 4. Construct Simulated Claim Output
            let claimText = `--- Simulated Medical Claim ---\n\n`;
            claimText += `PATIENT INFORMATION:\n`;
            claimText += `  Name: ${patientData.name}\n`;
            claimText += `  DOB: ${patientData.dob}\n`;
            claimText += `  Insurance ID: ${patientData.insuranceID}\n\n`;

            claimText += `ENCOUNTER DETAILS:\n`;
            claimText += `  Date: ${encounterDate}\n`;
            claimText += `  Chief Complaint: ${chiefComplaint}\n\n`;

            claimText += `DIAGNOSES (ICD CODES):\n`;
            if (diagnoses.length > 0) {
                diagnoses.forEach(diag => claimText += `  - ${diag}\n`);
            } else {
                claimText += `  (No diagnoses entered)\n`;
            }
            claimText += `\n`;

            claimText += `PROCEDURES (CPT/HCPCS CODES):\n`;
            if (procedures.length > 0) {
                procedures.forEach(proc => claimText += `  - ${proc}\n`);
            } else {
                claimText += `  (No procedures entered)\n`;
            }
            claimText += `\n`;

            claimText += `SERVICES & CHARGES:\n`;
            let totalAmount = 0;
            if (charges.length > 0) {
                charges.forEach(charge => {
                    claimText += `  - ${charge.description} (CPT: ${charge.cpt}) - $${charge.price.toFixed(2)}\n`;
                    totalAmount += charge.price;
                });
            } else {
                claimText += `  (No charges entered)\n`;
            }
            claimText += `\nTOTAL CHARGE: $${totalAmount.toFixed(2)}\n`;
            claimText += `\n--- End of Claim ---`;

            claimOutput.textContent = claimText;
            showMessage('Claim generated successfully!', 'success');
        });

        clearAllBtn.addEventListener('click', clearAllData);

        // --- Event Listeners (NEW Coding Challenge section) ---
        loadChallengeBtn.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * medicalReportScenarios.length);
            currentChallenge = medicalReportScenarios[randomIndex];
            medicalReportScenarioEl.textContent = currentChallenge.reportText;
            userICDCodesInput.value = ''; // Clear previous user input
            userCPTCodesInput.value = ''; // Clear previous user input
            codingFeedbackEl.innerHTML = '<p class="text-gray-500">Feedback on your coding will appear here.</p>'; // Clear previous feedback
        });

        checkCodesBtn.addEventListener('click', async () => {
            if (!currentChallenge) {
                codingFeedbackEl.textContent = 'Please load a new challenge first!';
                codingFeedbackEl.style.color = '#991b1b'; // Red text for error
                return;
            }

            const userICDs = userICDCodesInput.value.split(',').filter(s => s.trim() !== '');
            const userCPTs = userCPTCodesInput.value.split(',').filter(s => s.trim() !== '');

            const isICDCorrect = compareCodeArrays(userICDs, currentChallenge.correctICD);
            const isCPTCorrect = compareCodeArrays(userCPTs, currentChallenge.correctCPT);

            if (isICDCorrect && isCPTCorrect) {
                codingFeedbackEl.innerHTML = '<p class="text-green-700 font-bold">üéâ Excellent! Your codes are correct! You\'ve accurately identified the diagnoses and procedures for this report.</p>';
            } else {
                // Generate detailed feedback using LLM
                checkCodesText.textContent = 'Generating Feedback...';
                loadingSpinner.classList.remove('hidden');
                checkCodesBtn.disabled = true; // Disable button during API call

                const prompt = `As a medical coding expert, analyze the following medical report and the user's submitted codes compared to the correct codes.
                
                Medical Report: ${currentChallenge.reportText}
                
                User's Submitted ICD Codes: [${userICDs.join(', ')}]
                User's Submitted CPT Codes: [${userCPTs.join(', ')}]
                
                Correct ICD Codes: [${currentChallenge.correctICD.join(', ')}]
                Correct CPT Codes: [${currentChallenge.correctCPT.join(', ')}]
                
                Explain to a medical biller why their submitted codes might be incorrect or incomplete for this scenario. Focus on the discrepancies between the user's codes and the correct codes. Provide a clear explanation of what the correct codes mean and why they are appropriate based on the medical report. Offer specific tips for accurate coding in similar situations. Structure your response as helpful, educational feedback, starting with whether their ICDs and CPTs were correct or incorrect, and then explaining why.`;

                try {
                    const apiKey = ""; // Canvas will automatically provide the API key here at runtime.
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                    const fetchFn = async () => {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`API error: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                        }
                        return response.json();
                    };

                    const result = await exponentialBackoff(fetchFn);

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        codingFeedbackEl.innerHTML = `<p class="text-gray-800">${result.candidates[0].content.parts[0].text}</p>`;
                        codingFeedbackEl.style.color = '#333'; // Reset color
                    } else {
                        codingFeedbackEl.innerHTML = '<p class="text-red-700">Error: Could not retrieve detailed feedback. Please try again.</p>';
                    }
                } catch (error) {
                    console.error("Error calling LLM API:", error);
                    codingFeedbackEl.innerHTML = `<p class="text-red-700">An error occurred while getting feedback: ${error.message}. Please try again later.</p>`;
                } finally {
                    checkCodesText.textContent = 'Check My Codes';
                    loadingSpinner.classList.add('hidden');
                    checkCodesBtn.disabled = false; // Re-enable button
                }
            }
        });

        // Initial setup to ensure one input row is always present for existing sections
        window.onload = () => {
            if (diagnosisList.querySelectorAll('.diagnosis-code').length === 0) {
                addInputRow(diagnosisList, 'diagnosis-code', 'e.g., J02.9 (Acute pharyngitis)');
            }
            if (procedureList.querySelectorAll('.procedure-code').length === 0) {
                addInputRow(procedureList, 'procedure-code', 'e.g., 99213 (Office visit)');
            }
            if (chargeList.querySelectorAll('.service-item').length === 0) {
                addChargeRow();
            }
            // Load the first challenge automatically on page load
            loadChallengeBtn.click();
        };
    </script>
</body>
</html>
